---
title: Rediså¸¸è§é¢è¯•é¢˜æ€»ç»“
description: æœ€æ–°Redisé¢è¯•é¢˜å…¨è§£æï¼šæ¶µç›–Redisäº‹åŠ¡åŸç†ã€æ€§èƒ½ä¼˜åŒ–pipelineä¸Luaè„šæœ¬ã€bigkeyä¸hotkeyå¤„ç†ã€ç¼“å­˜ç©¿é€å‡»ç©¿é›ªå´©åº”å¯¹æ–¹æ¡ˆã€æ…¢æŸ¥è¯¢ä¸å†…å­˜ç¢ç‰‡ã€Redis Sentinelå“¨å…µä¸Clusteré›†ç¾¤è¯¦è§£ï¼ŒåŠ©ä½ é«˜åˆ†é€šè¿‡åç«¯é¢è¯•ã€‚
category: æ•°æ®åº“
tag:
  - Redis
head:
  - - meta
    - name: keywords
      content: Redisé¢è¯•é¢˜,Redisæ•°æ®ç±»å‹,RedisæŒä¹…åŒ–,RDB,AOF,Redisäº‹åŠ¡,Redisæ€§èƒ½ä¼˜åŒ–,ç¼“å­˜ç©¿é€,ç¼“å­˜å‡»ç©¿,ç¼“å­˜é›ªå´©,Redis bigkey,Redis hotkey,Redis Sentinel,Redis Cluster,åˆ†å¸ƒå¼é”
---

<!-- @include: @small-advertisement.snippet.md -->

## å‰è¨€

ç”±äºå¾ˆå¤šè¯»è€…éƒ½æœ‰çªå‡»é¢è¯•çš„éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘åœ¨å‡ å¹´å‰å°±å¼„äº† **JavaGuide é¢è¯•çªå‡»ç‰ˆæœ¬**ï¼ˆJavaGuide å†…å®¹ç²¾ç®€ç‰ˆï¼Œåªä¿ç•™é‡ç‚¹ï¼‰ï¼Œå¹¶æŒç»­å®Œå–„è·Ÿè¿›ã€‚å¯¹äºå–œæ¬¢çº¸è´¨é˜…è¯»çš„æœ‹å‹æ¥è¯´ï¼Œä¹Ÿå¯ä»¥æ‰“å°å‡ºæ¥ï¼Œæ•´ä½“é˜…è¯»ä½“éªŒéå¸¸é«˜ï¼

é™¤äº†åªä¿ç•™æœ€å¸¸é—®çš„é¢è¯•é¢˜ä¹‹å¤–ï¼Œæˆ‘è¿˜è¿›ä¸€æ­¥å¯¹é‡ç‚¹ä¸­çš„é‡ç‚¹è¿›è¡Œäº†â­ï¸æ ‡æ³¨ã€‚å¹¶ä¸”ï¼Œæœ‰äº®è‰²ï¼ˆç™½å¤©ï¼‰å’Œæš—è‰²ï¼ˆå¤œé—´ï¼‰ä¸¤ä¸ªä¸»é¢˜é€‰æ‹©ï¼Œéœ€è¦æ‰“å°å‡ºæ¥çš„æœ‹å‹è®°å¾—é€‰æ‹©äº®è‰²ç‰ˆæœ¬ã€‚

å¯¹äºæ—¶é—´æ¯”è¾ƒå……è£•çš„æœ‹å‹ï¼Œæˆ‘ä¸ªäººè¿˜æ˜¯æ›´æ¨è [JavaGuide](https://javaguide.cn/) ç½‘ç«™ç³»ç»Ÿå­¦ä¹ ï¼Œå†…å®¹æ›´å…¨é¢ï¼Œæ›´æ·±å…¥ã€‚

JavaGuide å·²ç»æŒç»­ç»´æŠ¤ 6 å¹´å¤šäº†ï¼Œç´¯è®¡æäº¤äº†æ¥è¿‘ **6000** commit ï¼Œå…±æœ‰ **570+** å¤šä½è´¡çŒ®è€…å…±åŒå‚ä¸ç»´æŠ¤å’Œå®Œå–„ã€‚ç”¨å¿ƒåšåŸåˆ›ä¼˜è´¨å†…å®¹ï¼Œå¦‚æœè§‰å¾—æœ‰å¸®åŠ©çš„è¯ï¼Œæ¬¢è¿ç‚¹èµåˆ†äº«ï¼ä¼ é€é—¨ï¼š[GitHub](https://github.com/Snailclimb/JavaGuide) | [Gitee](https://gitee.com/SnailClimb/JavaGuide)ã€‚

å¯¹äºéœ€è¦æ›´è¿›ä¸€æ­¥é¢è¯•è¾…å¯¼æœåŠ¡çš„è¯»è€…ï¼Œæ¬¢è¿åŠ å…¥ **[JavaGuide å®˜æ–¹çŸ¥è¯†æ˜Ÿçƒ](https://javaguide.cn/about-the-author/zhishixingqiu-two-years.html)**(æŠ€æœ¯ä¸“æ /ä¸€å¯¹ä¸€æé—®/ç®€å†ä¿®æ”¹/æ±‚èŒæŒ‡å—/é¢è¯•æ‰“å¡)ï¼Œç»å¯¹ç‰©è¶…æ‰€å€¼ï¼

é¢è¯•çªå‡»æœ€æ–°ç‰ˆæœ¬å¯ä»¥åœ¨æˆ‘çš„å…¬ä¼—å·å›å¤â€œ**PDF**â€è·å–ï¼ˆ[JavaGuide å®˜æ–¹çŸ¥è¯†æ˜Ÿçƒ](https://javaguide.cn/about-the-author/zhishixingqiu-two-years.html)ä¼šæå‰åŒæ­¥æœ€æ–°ç‰ˆï¼Œé’ˆå¯¹çƒå‹çš„ä¸€ä¸ªå°ç¦åˆ©ï¼‰ã€‚

![JavaGuide å®˜æ–¹å…¬ä¼—å·](https://oss.javaguide.cn/github/javaguide/gongzhonghaoxuanchuan.png)

è¿™éƒ¨åˆ†å†…å®¹æ‘˜è‡ª [JavaGuide](https://javaguide.cn/) ä¸‹é¢å‡ ç¯‡æ–‡ç« ä¸­çš„é‡ç‚¹ï¼š

- [Redis å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸Šï¼‰](https://javaguide.cn/database/redis/redis-questions-01.html)ï¼ˆRedis åŸºç¡€ã€åº”ç”¨ã€æ•°æ®ç±»å‹ã€æŒä¹…åŒ–æœºåˆ¶ã€çº¿ç¨‹æ¨¡å‹ç­‰ï¼‰
- [Redis å¸¸è§é¢è¯•é¢˜æ€»ç»“(ä¸‹)](https://javaguide.cn/database/redis/redis-questions-02.html)ï¼ˆRedis äº‹åŠ¡ã€æ€§èƒ½ä¼˜åŒ–ã€ç”Ÿäº§é—®é¢˜ã€é›†ç¾¤ã€ä½¿ç”¨è§„èŒƒç­‰ï¼‰
- [å¦‚ä½•åŸºäºRediså®ç°å»¶æ—¶ä»»åŠ¡](https://javaguide.cn/database/redis/redis-delayed-task.html)
- [Redis 5 ç§åŸºæœ¬æ•°æ®ç±»å‹è¯¦è§£](https://javaguide.cn/database/redis/redis-data-structures-01.html)
- [Redis 3 ç§ç‰¹æ®Šæ•°æ®ç±»å‹è¯¦è§£](https://javaguide.cn/database/redis/redis-data-structures-02.html)
- [Redisä¸ºä»€ä¹ˆç”¨è·³è¡¨å®ç°æœ‰åºé›†åˆ](https://javaguide.cn/database/redis/redis-skiplist.html)
- [Redis æŒä¹…åŒ–æœºåˆ¶è¯¦è§£](https://javaguide.cn/database/redis/redis-persistence.html)
- [Redis å†…å­˜ç¢ç‰‡è¯¦è§£](https://javaguide.cn/database/redis/redis-memory-fragmentation.html)
- [Redis å¸¸è§é˜»å¡åŸå› æ€»ç»“](https://javaguide.cn/database/redis/redis-common-blocking-problems-summary.html)

<!-- @include: @small-advertisement.snippet.md -->

## Redis åŸºç¡€

### ä»€ä¹ˆæ˜¯ Redisï¼Ÿ

[Redis](https://redis.io/) ï¼ˆ**RE**mote **DI**ctionary **S**erverï¼‰æ˜¯ä¸€ä¸ªåŸºäº C è¯­è¨€å¼€å‘çš„å¼€æº NoSQL æ•°æ®åº“ï¼ˆBSD è®¸å¯ï¼‰ã€‚ä¸ä¼ ç»Ÿæ•°æ®åº“ä¸åŒçš„æ˜¯ï¼ŒRedis çš„æ•°æ®æ˜¯ä¿å­˜åœ¨å†…å­˜ä¸­çš„ï¼ˆå†…å­˜æ•°æ®åº“ï¼Œæ”¯æŒæŒä¹…åŒ–ï¼‰ï¼Œå› æ­¤è¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œè¢«å¹¿æ³›åº”ç”¨äºåˆ†å¸ƒå¼ç¼“å­˜æ–¹å‘ã€‚å¹¶ä¸”ï¼ŒRedis å­˜å‚¨çš„æ˜¯ KV é”®å€¼å¯¹æ•°æ®ã€‚

ä¸ºäº†æ»¡è¶³ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼ŒRedis å†…ç½®äº†å¤šç§æ•°æ®ç±»å‹å®ç°ï¼ˆæ¯”å¦‚ Stringã€Hashã€Sorted Setã€Bitmapã€HyperLogLogã€GEOï¼‰ã€‚å¹¶ä¸”ï¼ŒRedis è¿˜æ”¯æŒäº‹åŠ¡ã€æŒä¹…åŒ–ã€Lua è„šæœ¬ã€å‘å¸ƒè®¢é˜…æ¨¡å‹ã€å¤šç§å¼€ç®±å³ç”¨çš„é›†ç¾¤æ–¹æ¡ˆï¼ˆRedis Sentinelã€Redis Clusterï¼‰ã€‚

![Redis æ•°æ®ç±»å‹æ¦‚è§ˆ](https://oss.javaguide.cn/github/javaguide/database/redis/redis-overview-of-data-types-2023-09-28.jpg)

Redis æ²¡æœ‰å¤–éƒ¨ä¾èµ–ï¼ŒLinux å’Œ OS X æ˜¯ Redis å¼€å‘å’Œæµ‹è¯•æœ€å¤šçš„ä¸¤ä¸ªæ“ä½œç³»ç»Ÿï¼Œå®˜æ–¹æ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Linux éƒ¨ç½² Redisã€‚

ä¸ªäººå­¦ä¹ çš„è¯ï¼Œä½ å¯ä»¥è‡ªå·±æœ¬æœºå®‰è£… Redis æˆ–è€…é€šè¿‡ Redis å®˜ç½‘æä¾›çš„[åœ¨çº¿ Redis ç¯å¢ƒ](https://try.redis.io/)ï¼ˆå°‘éƒ¨åˆ†å‘½ä»¤æ— æ³•ä½¿ç”¨ï¼‰æ¥å®é™…ä½“éªŒ Redisã€‚

![try-redis](https://oss.javaguide.cn/github/javaguide/database/redis/try.redis.io.png)

å…¨ä¸–ç•Œæœ‰éå¸¸å¤šçš„ç½‘ç«™ä½¿ç”¨åˆ°äº† Redisï¼Œ[techstacks.io](https://techstacks.io/) ä¸“é—¨ç»´æŠ¤äº†ä¸€ä¸ª[ä½¿ç”¨ Redis çš„çƒ­é—¨ç«™ç‚¹åˆ—è¡¨](https://techstacks.io/tech/redis)ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹çœ‹ã€‚

### â­ï¸Redis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ

Redis å†…éƒ¨åšäº†éå¸¸å¤šçš„æ€§èƒ½ä¼˜åŒ–ï¼Œæ¯”è¾ƒé‡è¦çš„æœ‰ä¸‹é¢ 4 ç‚¹ï¼š

1. **çº¯å†…å­˜æ“ä½œ (Memory-Based Storage)** ï¼šè¿™æ˜¯æœ€ä¸»è¦çš„åŸå› ã€‚Redis æ•°æ®è¯»å†™æ“ä½œéƒ½å‘ç”Ÿåœ¨å†…å­˜ä¸­ï¼Œè®¿é—®é€Ÿåº¦æ˜¯çº³ç§’çº§åˆ«ï¼Œè€Œä¼ ç»Ÿæ•°æ®åº“é¢‘ç¹è¯»å†™ç£ç›˜çš„é€Ÿåº¦æ˜¯æ¯«ç§’çº§åˆ«ï¼Œä¸¤è€…ç›¸å·®æ•°ä¸ªæ•°é‡çº§ã€‚
2. **é«˜æ•ˆçš„ I/O æ¨¡å‹ (I/O Multiplexing & Single-Threaded Event Loop)** ï¼šRedis ä½¿ç”¨å•çº¿ç¨‹äº‹ä»¶å¾ªç¯é…åˆ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œè®©å•ä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªç½‘ç»œè¿æ¥ä¸Šçš„ I/O äº‹ä»¶ï¼ˆå¦‚è¯»å†™ï¼‰ï¼Œé¿å…äº†å¤šçº¿ç¨‹æ¨¡å‹ä¸­çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œé”ç«äº‰é—®é¢˜ã€‚è™½ç„¶æ˜¯å•çº¿ç¨‹ï¼Œä½†ç»“åˆå†…å­˜æ“ä½œçš„é«˜æ•ˆæ€§å’Œ I/O å¤šè·¯å¤ç”¨ï¼Œä½¿å¾— Redis èƒ½è½»æ¾å¤„ç†å¤§é‡å¹¶å‘è¯·æ±‚ï¼ˆRedis çº¿ç¨‹æ¨¡å‹ä¼šåœ¨åæ–‡ä¸­è¯¦ç»†ä»‹ç»åˆ°ï¼‰ã€‚
3. **ä¼˜åŒ–çš„å†…éƒ¨æ•°æ®ç»“æ„ (Optimized Data Structures)** ï¼šRedis æä¾›å¤šç§æ•°æ®ç±»å‹ï¼ˆå¦‚ String, List, Hash, Set, Sorted Set ç­‰ï¼‰ï¼Œå…¶å†…éƒ¨å®ç°é‡‡ç”¨é«˜åº¦ä¼˜åŒ–çš„ç¼–ç æ–¹å¼ï¼ˆå¦‚ ziplist, quicklist, skiplist, hashtable ç­‰ï¼‰ã€‚Redis ä¼šæ ¹æ®æ•°æ®å¤§å°å’Œç±»å‹åŠ¨æ€é€‰æ‹©æœ€åˆé€‚çš„å†…éƒ¨ç¼–ç ï¼Œä»¥åœ¨æ€§èƒ½å’Œç©ºé—´æ•ˆç‡ä¹‹é—´å–å¾—æœ€ä½³å¹³è¡¡ã€‚
4. **ç®€æ´é«˜æ•ˆçš„é€šä¿¡åè®® (Simple Protocol - RESP)** ï¼šRedis ä½¿ç”¨çš„æ˜¯è‡ªå·±è®¾è®¡çš„ RESP (REdis Serialization Protocol) åè®®ã€‚è¿™ä¸ªåè®®å®ç°ç®€å•ã€è§£ææ€§èƒ½å¥½ï¼Œå¹¶ä¸”æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´é€šä¿¡çš„åºåˆ—åŒ–/ååºåˆ—åŒ–å¼€é”€å¾ˆå°ï¼Œæœ‰åŠ©äºæå‡æ•´ä½“çš„äº¤äº’é€Ÿåº¦ã€‚

> ä¸‹é¢è¿™å¼ å›¾ç‰‡æ€»ç»“çš„æŒºä¸é”™çš„ï¼Œåˆ†äº«ä¸€ä¸‹ï¼Œå‡ºè‡ª [Why is Redis so fast?](https://twitter.com/alexxubyte/status/1498703822528544770)ã€‚

![why-redis-so-fast](https://oss.javaguide.cn/github/javaguide/database/redis/why-redis-so-fast.png)

é‚£æ—¢ç„¶éƒ½è¿™ä¹ˆå¿«äº†ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ Redis å½“ä¸»æ•°æ®åº“å‘¢ï¼Ÿä¸»è¦æ˜¯å› ä¸ºå†…å­˜æˆæœ¬å¤ªé«˜ï¼Œå¹¶ä¸” Redis æä¾›çš„æ•°æ®æŒä¹…åŒ–ä»ç„¶æœ‰æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚

### é™¤äº† Redisï¼Œä½ è¿˜çŸ¥é“å…¶ä»–åˆ†å¸ƒå¼ç¼“å­˜æ–¹æ¡ˆå—ï¼Ÿ

å¦‚æœé¢è¯•ä¸­è¢«é—®åˆ°è¿™ä¸ªé—®é¢˜çš„è¯ï¼Œé¢è¯•å®˜ä¸»è¦æƒ³çœ‹çœ‹ï¼š

1. ä½ åœ¨é€‰æ‹© Redis ä½œä¸ºåˆ†å¸ƒå¼ç¼“å­˜æ–¹æ¡ˆæ—¶ï¼Œæ˜¯å¦æ˜¯ç»è¿‡ä¸¥è°¨çš„è°ƒç ”å’Œæ€è€ƒï¼Œè¿˜æ˜¯åªæ˜¯å› ä¸º Redis æ˜¯å½“å‰çš„â€œçƒ­é—¨â€æŠ€æœ¯ã€‚
2. ä½ åœ¨åˆ†å¸ƒå¼ç¼“å­˜æ–¹å‘çš„æŠ€æœ¯å¹¿åº¦ã€‚

å¦‚æœä½ äº†è§£å…¶ä»–æ–¹æ¡ˆï¼Œå¹¶ä¸”èƒ½è§£é‡Šä¸ºä»€ä¹ˆæœ€ç»ˆé€‰æ‹©äº† Redisï¼ˆæ›´è¿›ä¸€æ­¥ï¼ï¼‰ï¼Œè¿™ä¼šå¯¹ä½ é¢è¯•è¡¨ç°åŠ åˆ†ä¸å°‘ï¼

ä¸‹é¢ç®€å•èŠèŠå¸¸è§çš„åˆ†å¸ƒå¼ç¼“å­˜æŠ€æœ¯é€‰å‹ã€‚

åˆ†å¸ƒå¼ç¼“å­˜çš„è¯ï¼Œæ¯”è¾ƒè€ç‰ŒåŒæ—¶ä¹Ÿæ˜¯ä½¿ç”¨çš„æ¯”è¾ƒå¤šçš„è¿˜æ˜¯ **Memcached** å’Œ **Redis**ã€‚ä¸è¿‡ï¼Œç°åœ¨åŸºæœ¬æ²¡æœ‰çœ‹è¿‡è¿˜æœ‰é¡¹ç›®ä½¿ç”¨ **Memcached** æ¥åšç¼“å­˜ï¼Œéƒ½æ˜¯ç›´æ¥ç”¨ **Redis**ã€‚

Memcached æ˜¯åˆ†å¸ƒå¼ç¼“å­˜æœ€å¼€å§‹å…´èµ·çš„é‚£ä¼šï¼Œæ¯”è¾ƒå¸¸ç”¨çš„ã€‚åæ¥ï¼Œéšç€ Redis çš„å‘å±•ï¼Œå¤§å®¶æ…¢æ…¢éƒ½è½¬è€Œä½¿ç”¨æ›´åŠ å¼ºå¤§çš„ Redis äº†ã€‚

æœ‰ä¸€äº›å¤§å‚ä¹Ÿå¼€æºäº†ç±»ä¼¼äº Redis çš„åˆ†å¸ƒå¼é«˜æ€§èƒ½ KV å­˜å‚¨æ•°æ®åº“ï¼Œä¾‹å¦‚ï¼Œè…¾è®¯å¼€æºçš„ [**Tendis**](https://github.com/Tencent/Tendis)ã€‚Tendis åŸºäºçŸ¥åå¼€æºé¡¹ç›® [RocksDB](https://github.com/facebook/rocksdb) ä½œä¸ºå­˜å‚¨å¼•æ“ ï¼Œ100% å…¼å®¹ Redis åè®®å’Œ Redis4.0 æ‰€æœ‰æ•°æ®æ¨¡å‹ã€‚å…³äº Redis å’Œ Tendis çš„å¯¹æ¯”ï¼Œè…¾è®¯å®˜æ–¹æ›¾ç»å‘è¿‡ä¸€ç¯‡æ–‡ç« ï¼š[Redis vs Tendisï¼šå†·çƒ­æ··åˆå­˜å‚¨ç‰ˆæ¶æ„æ­ç§˜](https://mp.weixin.qq.com/s/MeYkfOIdnU6LYlsGb24KjQ)ï¼Œå¯ä»¥ç®€å•å‚è€ƒä¸€ä¸‹ã€‚

ä¸è¿‡ï¼Œä» Tendis è¿™ä¸ªé¡¹ç›®çš„ Github æäº¤è®°å½•å¯ä»¥çœ‹å‡ºï¼ŒTendis å¼€æºç‰ˆå‡ ä¹å·²ç»æ²¡æœ‰è¢«ç»´æŠ¤æ›´æ–°äº†ï¼ŒåŠ ä¸Šå…¶å…³æ³¨åº¦å¹¶ä¸é«˜ï¼Œä½¿ç”¨çš„å…¬å¸ä¹Ÿæ¯”è¾ƒå°‘ã€‚å› æ­¤ï¼Œä¸å»ºè®®ä½ ä½¿ç”¨ Tendis æ¥å®ç°åˆ†å¸ƒå¼ç¼“å­˜ã€‚

ç›®å‰ï¼Œæ¯”è¾ƒä¸šç•Œè®¤å¯çš„ Redis æ›¿ä»£å“è¿˜æ˜¯ä¸‹é¢è¿™ä¸¤ä¸ªå¼€æºåˆ†å¸ƒå¼ç¼“å­˜ï¼ˆéƒ½æ˜¯é€šè¿‡ç¢°ç“· Redis ç«çš„ï¼‰ï¼š

- [Dragonfly](https://github.com/dragonflydb/dragonfly)ï¼šä¸€ç§é’ˆå¯¹ç°ä»£åº”ç”¨ç¨‹åºè´Ÿè·éœ€æ±‚è€Œæ„å»ºçš„å†…å­˜æ•°æ®åº“ï¼Œå®Œå…¨å…¼å®¹ Redis å’Œ Memcached çš„ APIï¼Œè¿ç§»æ—¶æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç ï¼Œå·ç§°å…¨ä¸–ç•Œæœ€å¿«çš„å†…å­˜æ•°æ®åº“ã€‚
- [KeyDB](https://github.com/Snapchat/KeyDB)ï¼šRedis çš„ä¸€ä¸ªé«˜æ€§èƒ½åˆ†æ”¯ï¼Œä¸“æ³¨äºå¤šçº¿ç¨‹ã€å†…å­˜æ•ˆç‡å’Œé«˜ååé‡ã€‚

ä¸è¿‡ï¼Œä¸ªäººè¿˜æ˜¯å»ºè®®åˆ†å¸ƒå¼ç¼“å­˜é¦–é€‰ Redisï¼Œæ¯•ç«Ÿç»è¿‡äº†è¿™ä¹ˆå¤šå¹´çš„è€ƒéªŒï¼Œç”Ÿæ€éå¸¸ä¼˜ç§€ï¼Œèµ„æ–™ä¹Ÿå¾ˆå…¨é¢ï¼

PSï¼šç¯‡å¹…é—®é¢˜ï¼Œæˆ‘è¿™å¹¶æ²¡æœ‰å¯¹ä¸Šé¢æåˆ°çš„åˆ†å¸ƒå¼ç¼“å­˜é€‰å‹åšè¯¦ç»†ä»‹ç»å’Œå¯¹æ¯”ï¼Œæ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥è‡ªè¡Œç ”ç©¶ä¸€ä¸‹ã€‚

### è¯´ä¸€ä¸‹ Redis å’Œ Memcached çš„åŒºåˆ«å’Œå…±åŒç‚¹

ç°åœ¨å…¬å¸ä¸€èˆ¬éƒ½æ˜¯ç”¨ Redis æ¥å®ç°ç¼“å­˜ï¼Œè€Œä¸” Redis è‡ªèº«ä¹Ÿè¶Šæ¥è¶Šå¼ºå¤§äº†ï¼ä¸è¿‡ï¼Œäº†è§£ Redis å’Œ Memcached çš„åŒºåˆ«å’Œå…±åŒç‚¹ï¼Œæœ‰åŠ©äºæˆ‘ä»¬åœ¨åšç›¸åº”çš„æŠ€æœ¯é€‰å‹çš„æ—¶å€™ï¼Œèƒ½å¤Ÿåšåˆ°æœ‰ç†æœ‰æ®ï¼

**å…±åŒç‚¹**ï¼š

1. éƒ½æ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œä¸€èˆ¬éƒ½ç”¨æ¥å½“åšç¼“å­˜ä½¿ç”¨ã€‚
2. éƒ½æœ‰è¿‡æœŸç­–ç•¥ã€‚
3. ä¸¤è€…çš„æ€§èƒ½éƒ½éå¸¸é«˜ã€‚

**åŒºåˆ«**ï¼š

1. **æ•°æ®ç±»å‹**ï¼šRedis æ”¯æŒæ›´ä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼ˆæ”¯æŒæ›´å¤æ‚çš„åº”ç”¨åœºæ™¯ï¼‰ã€‚Redis ä¸ä»…ä»…æ”¯æŒç®€å•çš„ k/v ç±»å‹çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜æä¾› listã€setã€zsetã€hash ç­‰æ•°æ®ç»“æ„çš„å­˜å‚¨ï¼›è€Œ Memcached åªæ”¯æŒæœ€ç®€å•çš„ k/v æ•°æ®ç±»å‹ã€‚
2. **æ•°æ®æŒä¹…åŒ–**ï¼šRedis æ”¯æŒæ•°æ®çš„æŒä¹…åŒ–ï¼Œå¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®ä¿æŒåœ¨ç£ç›˜ä¸­ï¼Œé‡å¯çš„æ—¶å€™å¯ä»¥å†æ¬¡åŠ è½½è¿›è¡Œä½¿ç”¨ï¼›è€Œ Memcached æŠŠæ•°æ®å…¨éƒ¨å­˜åœ¨å†…å­˜ä¹‹ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒRedis æœ‰ç¾éš¾æ¢å¤æœºåˆ¶ï¼Œè€Œ Memcached æ²¡æœ‰ã€‚
3. **é›†ç¾¤æ¨¡å¼æ”¯æŒ**ï¼šMemcached æ²¡æœ‰åŸç”Ÿçš„é›†ç¾¤æ¨¡å¼ï¼Œéœ€è¦ä¾é å®¢æˆ·ç«¯æ¥å®ç°å¾€é›†ç¾¤ä¸­åˆ†ç‰‡å†™å…¥æ•°æ®ï¼›è€Œ Redis è‡ª 3.0 ç‰ˆæœ¬èµ·æ˜¯åŸç”Ÿæ”¯æŒé›†ç¾¤æ¨¡å¼çš„ã€‚
4. **çº¿ç¨‹æ¨¡å‹**ï¼šMemcached æ˜¯å¤šçº¿ç¨‹ã€éé˜»å¡ IO å¤ç”¨çš„ç½‘ç»œæ¨¡å‹ï¼›è€Œ Redis ä½¿ç”¨å•çº¿ç¨‹çš„å¤šè·¯ IO å¤ç”¨æ¨¡å‹ï¼ˆRedis 6.0 é’ˆå¯¹ç½‘ç»œæ•°æ®çš„è¯»å†™å¼•å…¥äº†å¤šçº¿ç¨‹ï¼‰ã€‚
5. **ç‰¹æ€§æ”¯æŒ**ï¼šRedis æ”¯æŒå‘å¸ƒè®¢é˜…æ¨¡å‹ã€Lua è„šæœ¬ã€äº‹åŠ¡ç­‰åŠŸèƒ½ï¼Œè€Œ Memcached ä¸æ”¯æŒã€‚å¹¶ä¸”ï¼ŒRedis æ”¯æŒæ›´å¤šçš„ç¼–ç¨‹è¯­è¨€ã€‚
6. **è¿‡æœŸæ•°æ®åˆ é™¤**ï¼šMemcached è¿‡æœŸæ•°æ®çš„åˆ é™¤ç­–ç•¥åªç”¨äº†æƒ°æ€§åˆ é™¤ï¼Œè€Œ Redis åŒæ—¶ä½¿ç”¨äº†æƒ°æ€§åˆ é™¤ä¸å®šæœŸåˆ é™¤ã€‚

ç›¸ä¿¡çœ‹äº†ä¸Šé¢çš„å¯¹æ¯”ä¹‹åï¼Œæˆ‘ä»¬å·²ç»æ²¡æœ‰ä»€ä¹ˆç†ç”±å¯ä»¥é€‰æ‹©ä½¿ç”¨ Memcached æ¥ä½œä¸ºè‡ªå·±é¡¹ç›®çš„åˆ†å¸ƒå¼ç¼“å­˜äº†ã€‚

### â­ï¸ä¸ºä»€ä¹ˆè¦ç”¨ Redisï¼Ÿ

**1ã€è®¿é—®é€Ÿåº¦æ›´å¿«**

ä¼ ç»Ÿæ•°æ®åº“æ•°æ®ä¿å­˜åœ¨ç£ç›˜ï¼Œè€Œ Redis åŸºäºå†…å­˜ï¼Œå†…å­˜çš„è®¿é—®é€Ÿåº¦æ¯”ç£ç›˜å¿«å¾ˆå¤šã€‚å¼•å…¥ Redis ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸€äº›é«˜é¢‘è®¿é—®çš„æ•°æ®æ”¾åˆ° Redis ä¸­ï¼Œè¿™æ ·ä¸‹æ¬¡å°±å¯ä»¥ç›´æ¥ä»å†…å­˜ä¸­è¯»å–ï¼Œé€Ÿåº¦å¯ä»¥æå‡å‡ åå€ç”šè‡³ä¸Šç™¾å€ã€‚

**2ã€é«˜å¹¶å‘**

ä¸€èˆ¬åƒ MySQL è¿™ç±»çš„æ•°æ®åº“çš„ QPS å¤§æ¦‚éƒ½åœ¨ 4k å·¦å³ï¼ˆ4 æ ¸ 8gï¼‰ï¼Œä½†æ˜¯ä½¿ç”¨ Redis ç¼“å­˜ä¹‹åå¾ˆå®¹æ˜“è¾¾åˆ° 5w+ï¼Œç”šè‡³èƒ½è¾¾åˆ° 10w+ï¼ˆå°±å•æœº Redis çš„æƒ…å†µï¼ŒRedis é›†ç¾¤çš„è¯ä¼šæ›´é«˜ï¼‰ã€‚

> QPSï¼ˆQuery Per Secondï¼‰ï¼šæœåŠ¡å™¨æ¯ç§’å¯ä»¥æ‰§è¡Œçš„æŸ¥è¯¢æ¬¡æ•°ï¼›

ç”±æ­¤å¯è§ï¼Œç›´æ¥æ“ä½œç¼“å­˜èƒ½å¤Ÿæ‰¿å—çš„æ•°æ®åº“è¯·æ±‚æ•°é‡æ˜¯è¿œè¿œå¤§äºç›´æ¥è®¿é—®æ•°æ®åº“çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘æŠŠæ•°æ®åº“ä¸­çš„éƒ¨åˆ†æ•°æ®è½¬ç§»åˆ°ç¼“å­˜ä¸­å»ï¼Œè¿™æ ·ç”¨æˆ·çš„ä¸€éƒ¨åˆ†è¯·æ±‚ä¼šç›´æ¥åˆ°ç¼“å­˜è¿™é‡Œè€Œä¸ç”¨ç»è¿‡æ•°æ®åº“ã€‚è¿›è€Œï¼Œæˆ‘ä»¬ä¹Ÿå°±æé«˜äº†ç³»ç»Ÿæ•´ä½“çš„å¹¶å‘ã€‚

**3ã€åŠŸèƒ½å…¨é¢**

Redis é™¤äº†å¯ä»¥ç”¨ä½œç¼“å­˜ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ç”¨äºåˆ†å¸ƒå¼é”ã€é™æµã€æ¶ˆæ¯é˜Ÿåˆ—ã€å»¶æ—¶é˜Ÿåˆ—ç­‰åœºæ™¯ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼

### â­ï¸ä¸ºä»€ä¹ˆç”¨ Redis è€Œä¸ç”¨æœ¬åœ°ç¼“å­˜å‘¢ï¼Ÿ

| ç‰¹æ€§         | æœ¬åœ°ç¼“å­˜                             | Redis                            |
| ------------ | ------------------------------------ | -------------------------------- |
| æ•°æ®ä¸€è‡´æ€§   | å¤šæœåŠ¡å™¨éƒ¨ç½²æ—¶å­˜åœ¨æ•°æ®ä¸ä¸€è‡´é—®é¢˜     | æ•°æ®ä¸€è‡´                         |
| å†…å­˜é™åˆ¶     | å—é™äºå•å°æœåŠ¡å™¨å†…å­˜                 | ç‹¬ç«‹éƒ¨ç½²ï¼Œå†…å­˜ç©ºé—´æ›´å¤§           |
| æ•°æ®ä¸¢å¤±é£é™© | æœåŠ¡å™¨å®•æœºæ•°æ®ä¸¢å¤±                   | å¯æŒä¹…åŒ–ï¼Œæ•°æ®ä¸æ˜“ä¸¢å¤±           |
| ç®¡ç†ç»´æŠ¤     | åˆ†æ•£ï¼Œç®¡ç†ä¸ä¾¿                       | é›†ä¸­ç®¡ç†ï¼Œæä¾›ä¸°å¯Œçš„ç®¡ç†å·¥å…·     |
| åŠŸèƒ½ä¸°å¯Œæ€§   | åŠŸèƒ½æœ‰é™ï¼Œé€šå¸¸åªæä¾›ç®€å•çš„é”®å€¼å¯¹å­˜å‚¨ | åŠŸèƒ½ä¸°å¯Œï¼Œæ”¯æŒå¤šç§æ•°æ®ç»“æ„å’ŒåŠŸèƒ½ |

### å¸¸è§çš„ç¼“å­˜è¯»å†™ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

å…³äºå¸¸è§çš„ç¼“å­˜è¯»å†™ç­–ç•¥çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[3 ç§å¸¸ç”¨çš„ç¼“å­˜è¯»å†™ç­–ç•¥è¯¦è§£](https://javaguide.cn/database/redis/3-commonly-used-cache-read-and-write-strategies.html)ã€‚

### ä»€ä¹ˆæ˜¯ Redis Moduleï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ

Redis ä» 4.0 ç‰ˆæœ¬å¼€å§‹ï¼Œæ”¯æŒé€šè¿‡ Module æ¥æ‰©å±•å…¶åŠŸèƒ½ä»¥æ»¡è¶³ç‰¹æ®Šçš„éœ€æ±‚ã€‚è¿™äº› Module ä»¥åŠ¨æ€é“¾æ¥åº“ï¼ˆso æ–‡ä»¶ï¼‰çš„å½¢å¼è¢«åŠ è½½åˆ° Redis ä¸­ï¼Œè¿™æ˜¯ä¸€ç§éå¸¸çµæ´»çš„åŠ¨æ€æ‰©å±•åŠŸèƒ½çš„å®ç°æ–¹å¼ï¼Œå€¼å¾—å€Ÿé‰´å­¦ä¹ ï¼

æˆ‘ä»¬æ¯ä¸ªäººéƒ½å¯ä»¥åŸºäº Redis å»å®šåˆ¶åŒ–å¼€å‘è‡ªå·±çš„ Moduleï¼Œæ¯”å¦‚å®ç°æœç´¢å¼•æ“åŠŸèƒ½ã€è‡ªå®šä¹‰åˆ†å¸ƒå¼é”å’Œåˆ†å¸ƒå¼é™æµã€‚

ç›®å‰ï¼Œè¢« Redis å®˜æ–¹æ¨èçš„ Module æœ‰ï¼š

- [RediSearch](https://github.com/RediSearch/RediSearch)ï¼šç”¨äºå®ç°æœç´¢å¼•æ“çš„æ¨¡å—ã€‚
- [RedisJSON](https://github.com/RedisJSON/RedisJSON)ï¼šç”¨äºå¤„ç† JSON æ•°æ®çš„æ¨¡å—ã€‚
- [RedisGraph](https://github.com/RedisGraph/RedisGraph)ï¼šç”¨äºå®ç°å›¾å½¢æ•°æ®åº“çš„æ¨¡å—ã€‚
- [RedisTimeSeries](https://github.com/RedisTimeSeries/RedisTimeSeries)ï¼šç”¨äºå¤„ç†æ—¶é—´åºåˆ—æ•°æ®çš„æ¨¡å—ã€‚
- [RedisBloom](https://github.com/RedisBloom/RedisBloom)ï¼šç”¨äºå®ç°å¸ƒéš†è¿‡æ»¤å™¨çš„æ¨¡å—ã€‚
- [RedisAI](https://github.com/RedisAI/RedisAI)ï¼šç”¨äºæ‰§è¡Œæ·±åº¦å­¦ä¹ /æœºå™¨å­¦ä¹ æ¨¡å‹å¹¶ç®¡ç†å…¶æ•°æ®çš„æ¨¡å—ã€‚
- [RedisCell](https://github.com/brandur/redis-cell)ï¼šç”¨äºå®ç°åˆ†å¸ƒå¼é™æµçš„æ¨¡å—ã€‚
- â€¦â€¦

å…³äº Redis æ¨¡å—çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š<https://redis.io/modules>ã€‚

## â­ï¸Redis åº”ç”¨

### Redis é™¤äº†åšç¼“å­˜ï¼Œè¿˜èƒ½åšä»€ä¹ˆï¼Ÿ

- **åˆ†å¸ƒå¼é”**ï¼šé€šè¿‡ Redis æ¥åšåˆ†å¸ƒå¼é”æ˜¯ä¸€ç§æ¯”è¾ƒå¸¸è§çš„æ–¹å¼ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯åŸºäº Redisson æ¥å®ç°åˆ†å¸ƒå¼é”ã€‚å…³äº Redis å®ç°åˆ†å¸ƒå¼é”çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[åˆ†å¸ƒå¼é”è¯¦è§£](https://javaguide.cn/distributed-system/distributed-lock.html)ã€‚
- **é™æµ**ï¼šä¸€èˆ¬æ˜¯é€šè¿‡ Redis + Lua è„šæœ¬çš„æ–¹å¼æ¥å®ç°é™æµã€‚å¦‚æœä¸æƒ³è‡ªå·±å†™ Lua è„šæœ¬çš„è¯ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åˆ©ç”¨ Redisson ä¸­çš„ `RRateLimiter` æ¥å®ç°åˆ†å¸ƒå¼é™æµï¼Œå…¶åº•å±‚å®ç°å°±æ˜¯åŸºäº Lua ä»£ç +ä»¤ç‰Œæ¡¶ç®—æ³•ã€‚
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šRedis è‡ªå¸¦çš„ List æ•°æ®ç»“æ„å¯ä»¥ä½œä¸ºä¸€ä¸ªç®€å•çš„é˜Ÿåˆ—ä½¿ç”¨ã€‚Redis 5.0 ä¸­å¢åŠ çš„ Stream ç±»å‹çš„æ•°æ®ç»“æ„æ›´åŠ é€‚åˆç”¨æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ã€‚å®ƒæ¯”è¾ƒç±»ä¼¼äº Kafkaï¼Œæœ‰ä¸»é¢˜å’Œæ¶ˆè´¹ç»„çš„æ¦‚å¿µï¼Œæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–ä»¥åŠ ACK æœºåˆ¶ã€‚
- **å»¶æ—¶é˜Ÿåˆ—**ï¼šRedisson å†…ç½®äº†å»¶æ—¶é˜Ÿåˆ—ï¼ˆåŸºäº Sorted Set å®ç°çš„ï¼‰ã€‚
- **åˆ†å¸ƒå¼ Session**ï¼šåˆ©ç”¨ String æˆ–è€… Hash æ•°æ®ç±»å‹ä¿å­˜ Session æ•°æ®ï¼Œæ‰€æœ‰çš„æœåŠ¡å™¨éƒ½å¯ä»¥è®¿é—®ã€‚
- **å¤æ‚ä¸šåŠ¡åœºæ™¯**ï¼šé€šè¿‡ Redis ä»¥åŠ Redis æ‰©å±•ï¼ˆæ¯”å¦‚ Redissonï¼‰æä¾›çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®Œæˆå¾ˆå¤šå¤æ‚çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ¯”å¦‚é€šè¿‡ Bitmap ç»Ÿè®¡æ´»è·ƒç”¨æˆ·ã€é€šè¿‡ Sorted Set ç»´æŠ¤æ’è¡Œæ¦œã€é€šè¿‡ HyperLogLog ç»Ÿè®¡ç½‘ç«™ UV å’Œ PVã€‚
- â€¦â€¦

### å¦‚ä½•åŸºäº Redis å®ç°åˆ†å¸ƒå¼é”ï¼Ÿ

å…³äº Redis å®ç°åˆ†å¸ƒå¼é”çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[åˆ†å¸ƒå¼é”è¯¦è§£](https://javaguide.cn/distributed-system/distributed-lock-implementations.html)ã€‚

### Redis å¯ä»¥åšæ¶ˆæ¯é˜Ÿåˆ—ä¹ˆï¼Ÿ

> å®é™…é¡¹ç›®ä¸­ä½¿ç”¨ Redis æ¥åšæ¶ˆæ¯é˜Ÿåˆ—çš„éå¸¸å°‘ï¼Œæ¯•ç«Ÿæœ‰æ›´æˆç†Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶å¯ä»¥ç”¨ã€‚

å…ˆè¯´ç»“è®ºï¼š**å¯ä»¥æ˜¯å¯ä»¥ï¼Œä½†ä¸å»ºè®®ä½¿ç”¨ Redis æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ã€‚å’Œä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸æ¯”ï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤šæ¬ ç¼ºçš„åœ°æ–¹ã€‚**

**Redis 2.0 ä¹‹å‰ï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨ Redis æ¥åšæ¶ˆæ¯é˜Ÿåˆ—çš„è¯ï¼Œåªèƒ½é€šè¿‡ List æ¥å®ç°ã€‚**

é€šè¿‡ `RPUSH/LPOP` æˆ–è€… `LPUSH/RPOP` å³å¯å®ç°ç®€æ˜“ç‰ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼š

```bash
# ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯
> RPUSH myList msg1 msg2
(integer) 2
> RPUSH myList msg3
(integer) 3
# æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯
> LPOP myList
"msg1"
```

ä¸è¿‡ï¼Œé€šè¿‡ `RPUSH/LPOP` æˆ–è€… `LPUSH/RPOP` è¿™æ ·çš„æ–¹å¼å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸æ–­è½®è¯¢å»è°ƒç”¨ `RPOP` æˆ– `LPOP` æ¥æ¶ˆè´¹æ¶ˆæ¯ã€‚å½“ List ä¸ºç©ºæ—¶ï¼Œå¤§éƒ¨åˆ†çš„è½®è¯¢çš„è¯·æ±‚éƒ½æ˜¯æ— æ•ˆè¯·æ±‚ï¼Œè¿™ç§æ–¹å¼å¤§é‡æµªè´¹äº†ç³»ç»Ÿèµ„æºã€‚

å› æ­¤ï¼ŒRedis è¿˜æä¾›äº† `BLPOP`ã€`BRPOP` è¿™ç§é˜»å¡å¼è¯»å–çš„å‘½ä»¤ï¼ˆå¸¦ B-Blocking çš„éƒ½æ˜¯é˜»å¡å¼ï¼‰ï¼Œå¹¶ä¸”è¿˜æ”¯æŒä¸€ä¸ªè¶…æ—¶å‚æ•°ã€‚å¦‚æœ List ä¸ºç©ºï¼ŒRedis æœåŠ¡ç«¯ä¸ä¼šç«‹åˆ»è¿”å›ç»“æœï¼Œå®ƒä¼šç­‰å¾… List ä¸­æœ‰æ–°æ•°æ®åå†è¿”å›æˆ–è€…æ˜¯ç­‰å¾…æœ€å¤šä¸€ä¸ªè¶…æ—¶æ—¶é—´åè¿”å›ç©ºã€‚å¦‚æœå°†è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º 0 æ—¶ï¼Œå³å¯æ— é™ç­‰å¾…ï¼Œç›´åˆ°å¼¹å‡ºæ¶ˆæ¯

```bash
# è¶…æ—¶æ—¶é—´ä¸º 10s
# å¦‚æœæœ‰æ•°æ®ç«‹åˆ»è¿”å›ï¼Œå¦åˆ™æœ€å¤šç­‰å¾…10ç§’
> BRPOP myList 10
null
```

**List å®ç°æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½å¤ªç®€å•ï¼Œåƒæ¶ˆæ¯ç¡®è®¤æœºåˆ¶ç­‰åŠŸèƒ½è¿˜éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°ï¼Œæœ€è¦å‘½çš„æ˜¯æ²¡æœ‰å¹¿æ’­æœºåˆ¶ï¼Œæ¶ˆæ¯ä¹Ÿåªèƒ½è¢«æ¶ˆè´¹ä¸€æ¬¡ã€‚**

**Redis 2.0 å¼•å…¥äº†å‘å¸ƒè®¢é˜… (pub/sub) åŠŸèƒ½ï¼Œè§£å†³äº† List å®ç°æ¶ˆæ¯é˜Ÿåˆ—æ²¡æœ‰å¹¿æ’­æœºåˆ¶çš„é—®é¢˜ã€‚**

![Redis å‘å¸ƒè®¢é˜… (pub/sub) åŠŸèƒ½](https://oss.javaguide.cn/github/javaguide/database/redis/redis-pub-sub.png)

pub/sub ä¸­å¼•å…¥äº†ä¸€ä¸ªæ¦‚å¿µå« **channelï¼ˆé¢‘é“ï¼‰**ï¼Œå‘å¸ƒè®¢é˜…æœºåˆ¶çš„å®ç°å°±æ˜¯åŸºäºè¿™ä¸ª channel æ¥åšçš„ã€‚

pub/sub æ¶‰åŠå‘å¸ƒè€…ï¼ˆPublisherï¼‰å’Œè®¢é˜…è€…ï¼ˆSubscriberï¼Œä¹Ÿå«æ¶ˆè´¹è€…ï¼‰ä¸¤ä¸ªè§’è‰²ï¼š

- å‘å¸ƒè€…é€šè¿‡ `PUBLISH` æŠ•é€’æ¶ˆæ¯ç»™æŒ‡å®š channelã€‚
- è®¢é˜…è€…é€šè¿‡`SUBSCRIBE`è®¢é˜…å®ƒå…³å¿ƒçš„ channelã€‚å¹¶ä¸”ï¼Œè®¢é˜…è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–è€…å¤šä¸ª channelã€‚

æˆ‘ä»¬è¿™é‡Œå¯åŠ¨ 3 ä¸ª Redis å®¢æˆ·ç«¯æ¥ç®€å•æ¼”ç¤ºä¸€ä¸‹ï¼š

![pub/sub å®ç°æ¶ˆæ¯é˜Ÿåˆ—æ¼”ç¤º](https://oss.javaguide.cn/github/javaguide/database/redis/redis-pubsub-message-queue.png)

pub/sub æ—¢èƒ½å•æ’­åˆèƒ½å¹¿æ’­ï¼Œè¿˜æ”¯æŒ channel çš„ç®€å•æ­£åˆ™åŒ¹é…ã€‚ä¸è¿‡ï¼Œæ¶ˆæ¯ä¸¢å¤±ï¼ˆå®¢æˆ·ç«¯æ–­å¼€è¿æ¥æˆ–è€… Redis å®•æœºéƒ½ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼‰ã€æ¶ˆæ¯å †ç§¯ï¼ˆå‘å¸ƒè€…å‘å¸ƒæ¶ˆæ¯çš„æ—¶å€™ä¸ä¼šç®¡æ¶ˆè´¹è€…çš„å…·ä½“æ¶ˆè´¹èƒ½åŠ›å¦‚ä½•ï¼‰ç­‰é—®é¢˜ä¾ç„¶æ²¡æœ‰ä¸€ä¸ªæ¯”è¾ƒå¥½çš„è§£å†³åŠæ³•ã€‚

ä¸ºæ­¤ï¼ŒRedis 5.0 æ–°å¢åŠ çš„ä¸€ä¸ªæ•°æ®ç»“æ„ `Stream` æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ã€‚`Stream` æ”¯æŒï¼š

- å‘å¸ƒ / è®¢é˜…æ¨¡å¼ï¼›
- æŒ‰ç…§æ¶ˆè´¹è€…ç»„è¿›è¡Œæ¶ˆè´¹ï¼ˆå€Ÿé‰´äº† Kafka æ¶ˆè´¹è€…ç»„çš„æ¦‚å¿µï¼‰ï¼›
- æ¶ˆæ¯æŒä¹…åŒ–ï¼ˆ RDB å’Œ AOFï¼‰ï¼›
- ACK æœºåˆ¶ï¼ˆé€šè¿‡ç¡®è®¤æœºåˆ¶æ¥å‘ŠçŸ¥å·²ç»æˆåŠŸå¤„ç†äº†æ¶ˆæ¯ï¼‰ï¼›
- é˜»å¡å¼è·å–æ¶ˆæ¯ã€‚

`Stream` çš„ç»“æ„å¦‚ä¸‹ï¼š

![](https://oss.javaguide.cn/github/javaguide/database/redis/redis-stream-structure.png)

è¿™æ˜¯ä¸€ä¸ªæœ‰åºçš„æ¶ˆæ¯é“¾è¡¨ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ ID å’Œå¯¹åº”çš„å†…å®¹ã€‚ID æ˜¯ä¸€ä¸ªæ—¶é—´æˆ³å’Œåºåˆ—å·çš„ç»„åˆï¼Œç”¨æ¥ä¿è¯æ¶ˆæ¯çš„å”¯ä¸€æ€§å’Œé€’å¢æ€§ã€‚å†…å®¹æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªé”®å€¼å¯¹ï¼ˆç±»ä¼¼ Hash åŸºæœ¬æ•°æ®ç±»å‹ï¼‰ï¼Œç”¨æ¥å­˜å‚¨æ¶ˆæ¯çš„æ•°æ®ã€‚

è¿™é‡Œå†å¯¹å›¾ä¸­æ¶‰åŠåˆ°çš„ä¸€äº›æ¦‚å¿µï¼Œè¿›è¡Œç®€å•è§£é‡Šï¼š

- `Consumer Group`ï¼šæ¶ˆè´¹è€…ç»„ç”¨äºç»„ç»‡å’Œç®¡ç†å¤šä¸ªæ¶ˆè´¹è€…ã€‚æ¶ˆè´¹è€…ç»„æœ¬èº«ä¸å¤„ç†æ¶ˆæ¯ï¼Œè€Œæ˜¯å†å°†æ¶ˆæ¯åˆ†å‘ç»™æ¶ˆè´¹è€…ï¼Œç”±æ¶ˆè´¹è€…è¿›è¡ŒçœŸæ­£çš„æ¶ˆè´¹ã€‚
- `last_delivered_id`ï¼šæ ‡è¯†æ¶ˆè´¹è€…ç»„å½“å‰æ¶ˆè´¹ä½ç½®çš„æ¸¸æ ‡ï¼Œæ¶ˆè´¹è€…ç»„ä¸­ä»»æ„ä¸€ä¸ªæ¶ˆè´¹è€…è¯»å–äº†æ¶ˆæ¯éƒ½ä¼šä½¿ last_delivered_id å¾€å‰ç§»åŠ¨ã€‚
- `pending_ids`ï¼šè®°å½•å·²ç»è¢«å®¢æˆ·ç«¯æ¶ˆè´¹ä½†æ²¡æœ‰ ack çš„æ¶ˆæ¯çš„ IDã€‚

ä¸‹é¢æ˜¯`Stream` ç”¨ä½œæ¶ˆæ¯é˜Ÿåˆ—æ—¶å¸¸ç”¨çš„å‘½ä»¤ï¼š

- `XADD`ï¼šå‘æµä¸­æ·»åŠ æ–°çš„æ¶ˆæ¯ã€‚
- `XREAD`ï¼šä»æµä¸­è¯»å–æ¶ˆæ¯ã€‚
- `XREADGROUP`ï¼šä»æ¶ˆè´¹ç»„ä¸­è¯»å–æ¶ˆæ¯ã€‚
- `XRANGE`ï¼šæ ¹æ®æ¶ˆæ¯ ID èŒƒå›´è¯»å–æµä¸­çš„æ¶ˆæ¯ã€‚
- `XREVRANGE`ï¼šä¸ `XRANGE` ç±»ä¼¼ï¼Œä½†ä»¥ç›¸åé¡ºåºè¿”å›ç»“æœã€‚
- `XDEL`ï¼šä»æµä¸­åˆ é™¤æ¶ˆæ¯ã€‚
- `XTRIM`ï¼šä¿®å‰ªæµçš„é•¿åº¦ï¼Œå¯ä»¥æŒ‡å®šä¿®å»ºç­–ç•¥ï¼ˆ`MAXLEN`/`MINID`ï¼‰ã€‚
- `XLEN`ï¼šè·å–æµçš„é•¿åº¦ã€‚
- `XGROUP CREATE`ï¼šåˆ›å»ºæ¶ˆè´¹è€…ç»„ã€‚
- `XGROUP DESTROY`ï¼šåˆ é™¤æ¶ˆè´¹è€…ç»„ã€‚
- `XGROUP DELCONSUMER`ï¼šä»æ¶ˆè´¹è€…ç»„ä¸­åˆ é™¤ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚
- `XGROUP SETID`ï¼šä¸ºæ¶ˆè´¹è€…ç»„è®¾ç½®æ–°çš„æœ€åé€’é€æ¶ˆæ¯ IDã€‚
- `XACK`ï¼šç¡®è®¤æ¶ˆè´¹ç»„ä¸­çš„æ¶ˆæ¯å·²è¢«å¤„ç†ã€‚
- `XPENDING`ï¼šæŸ¥è¯¢æ¶ˆè´¹ç»„ä¸­æŒ‚èµ·ï¼ˆæœªç¡®è®¤ï¼‰çš„æ¶ˆæ¯ã€‚
- `XCLAIM`ï¼šå°†æŒ‚èµ·çš„æ¶ˆæ¯ä»ä¸€ä¸ªæ¶ˆè´¹è€…è½¬ç§»åˆ°å¦ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚
- `XINFO`ï¼šè·å–æµï¼ˆ`XINFO STREAM`ï¼‰ã€æ¶ˆè´¹ç»„ï¼ˆ`XINFO GROUPS`ï¼‰æˆ–æ¶ˆè´¹è€…ï¼ˆ`XINFO CONSUMERS`ï¼‰çš„è¯¦ç»†ä¿¡æ¯ã€‚

`Stream` ä½¿ç”¨èµ·æ¥ç›¸å¯¹è¦éº»çƒ¦ä¸€äº›ï¼Œè¿™é‡Œå°±ä¸æ¼”ç¤ºäº†ã€‚

æ€»çš„æ¥è¯´ï¼Œ`Stream` å·²ç»å¯ä»¥æ»¡è¶³ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„åŸºæœ¬è¦æ±‚äº†ã€‚ä¸è¿‡ï¼Œ`Stream` åœ¨å®é™…ä½¿ç”¨ä¸­ä¾ç„¶ä¼šæœ‰ä¸€äº›å°é—®é¢˜ä¸å¤ªå¥½è§£å†³ï¼Œæ¯”å¦‚åœ¨ Redis å‘ç”Ÿæ•…éšœæ¢å¤åä¸èƒ½ä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡ã€‚

ç»¼ä¸Šï¼Œå’Œä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸æ¯”ï¼Œä½¿ç”¨ Redis æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—è¿˜æ˜¯æœ‰å¾ˆå¤šæ¬ ç¼ºçš„åœ°æ–¹ï¼Œæ¯”å¦‚æ¶ˆæ¯ä¸¢å¤±å’Œå †ç§¯é—®é¢˜ä¸å¥½è§£å†³ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€šå¸¸å»ºè®®ä¸è¦ä½¿ç”¨ Redis æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½ å®Œå…¨å¯ä»¥é€‰æ‹©å¸‚é¢ä¸Šæ¯”è¾ƒæˆç†Ÿçš„ä¸€äº›æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯”å¦‚ RocketMQã€Kafkaã€‚ä¸è¿‡ï¼Œå¦‚æœä½ å°±æ˜¯æƒ³è¦ç”¨ Redis æ¥åšæ¶ˆæ¯é˜Ÿåˆ—çš„è¯ï¼Œé‚£æˆ‘å»ºè®®ä½ ä¼˜å…ˆè€ƒè™‘ `Stream`ï¼Œè¿™æ˜¯ç›®å‰ç›¸å¯¹æœ€ä¼˜çš„ Redis æ¶ˆæ¯é˜Ÿåˆ—å®ç°ã€‚

ç›¸å…³é˜…è¯»ï¼š[Redis æ¶ˆæ¯é˜Ÿåˆ—å‘å±•å†ç¨‹ - é˜¿é‡Œå¼€å‘è€… - 2022](https://mp.weixin.qq.com/s/gCUT5TcCQRAxYkTJfTRjJw)ã€‚

### Redis å¯ä»¥åšæœç´¢å¼•æ“ä¹ˆï¼Ÿ

Redis æ˜¯å¯ä»¥å®ç°å…¨æ–‡æœç´¢å¼•æ“åŠŸèƒ½çš„ï¼Œéœ€è¦å€ŸåŠ© **RediSearch**ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäº Redis çš„æœç´¢å¼•æ“æ¨¡å—ã€‚

RediSearch æ”¯æŒä¸­æ–‡åˆ†è¯ã€èšåˆç»Ÿè®¡ã€åœç”¨è¯ã€åŒä¹‰è¯ã€æ‹¼å†™æ£€æŸ¥ã€æ ‡ç­¾æŸ¥è¯¢ã€å‘é‡ç›¸ä¼¼åº¦æŸ¥è¯¢ã€å¤šå…³é”®è¯æœç´¢ã€åˆ†é¡µæœç´¢ç­‰åŠŸèƒ½ï¼Œç®—æ˜¯ä¸€ä¸ªåŠŸèƒ½æ¯”è¾ƒå®Œå–„çš„å…¨æ–‡æœç´¢å¼•æ“äº†ã€‚

ç›¸æ¯”è¾ƒäº Elasticsearch æ¥è¯´ï¼ŒRediSearch ä¸»è¦åœ¨ä¸‹é¢ä¸¤ç‚¹ä¸Šè¡¨ç°æ›´ä¼˜å¼‚ä¸€äº›ï¼š

1. æ€§èƒ½æ›´ä¼˜ç§€ï¼šä¾èµ– Redis è‡ªèº«çš„é«˜æ€§èƒ½ï¼ŒåŸºäºå†…å­˜æ“ä½œï¼ˆElasticsearch åŸºäºç£ç›˜ï¼‰ã€‚
2. è¾ƒä½å†…å­˜å ç”¨å®ç°å¿«é€Ÿç´¢å¼•ï¼šRediSearch å†…éƒ¨ä½¿ç”¨å‹ç¼©çš„å€’æ’ç´¢å¼•ï¼Œæ‰€ä»¥å¯ä»¥ç”¨è¾ƒä½çš„å†…å­˜å ç”¨æ¥å®ç°ç´¢å¼•çš„å¿«é€Ÿæ„å»ºã€‚

å¯¹äºå°å‹é¡¹ç›®çš„ç®€å•æœç´¢åœºæ™¯æ¥è¯´ï¼Œä½¿ç”¨ RediSearch æ¥ä½œä¸ºæœç´¢å¼•æ“è¿˜æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼ˆæ­é… RedisJSON ä½¿ç”¨ï¼‰ã€‚

å¯¹äºæ¯”è¾ƒå¤æ‚æˆ–è€…æ•°æ®è§„æ¨¡è¾ƒå¤§çš„æœç´¢åœºæ™¯ï¼Œè¿˜æ˜¯ä¸å¤ªå»ºè®®ä½¿ç”¨ RediSearch æ¥ä½œä¸ºæœç´¢å¼•æ“ï¼Œä¸»è¦æ˜¯å› ä¸ºä¸‹é¢è¿™äº›é™åˆ¶å’Œé—®é¢˜ï¼š

1. æ•°æ®é‡é™åˆ¶ï¼šElasticsearch å¯ä»¥æ”¯æŒ PB çº§åˆ«çš„æ•°æ®é‡ï¼Œå¯ä»¥è½»æ¾æ‰©å±•åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œåˆ©ç”¨åˆ†ç‰‡æœºåˆ¶æé«˜å¯ç”¨æ€§å’Œæ€§èƒ½ã€‚RedisSearch æ˜¯åŸºäº Redis å®ç°çš„ï¼Œå…¶èƒ½å­˜å‚¨çš„æ•°æ®é‡å—é™äº Redis çš„å†…å­˜å®¹é‡ï¼Œä¸å¤ªé€‚åˆå­˜å‚¨å¤§è§„æ¨¡çš„æ•°æ®ï¼ˆå†…å­˜æ˜‚è´µï¼Œæ‰©å±•èƒ½åŠ›è¾ƒå·®ï¼‰ã€‚
2. åˆ†å¸ƒå¼èƒ½åŠ›è¾ƒå·®ï¼šElasticsearch æ˜¯ä¸ºåˆ†å¸ƒå¼ç¯å¢ƒè®¾è®¡çš„ï¼Œå¯ä»¥è½»æ¾æ‰©å±•åˆ°å¤šä¸ªèŠ‚ç‚¹ã€‚è™½ç„¶ RedisSearch æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­å¯èƒ½ä¼šé¢ä¸´ä¸€äº›æŒ‘æˆ˜ï¼Œå¦‚æ•°æ®åˆ†ç‰‡ã€èŠ‚ç‚¹é—´é€šä¿¡ã€æ•°æ®ä¸€è‡´æ€§ç­‰é—®é¢˜ã€‚
3. èšåˆåŠŸèƒ½è¾ƒå¼±ï¼šElasticsearch æä¾›äº†ä¸°å¯Œçš„èšåˆåŠŸèƒ½ï¼Œè€Œ RediSearch çš„èšåˆåŠŸèƒ½ç›¸å¯¹è¾ƒå¼±ï¼Œåªæ”¯æŒç®€å•çš„èšåˆæ“ä½œã€‚
4. ç”Ÿæ€è¾ƒå·®ï¼šElasticsearch å¯ä»¥è½»æ¾å’Œå¸¸è§çš„ä¸€äº›ç³»ç»Ÿ/è½¯ä»¶é›†æˆæ¯”å¦‚ Hadoopã€Sparkã€Kibanaï¼Œè€Œ RedisSearch åˆ™ä¸å…·å¤‡è¯¥ä¼˜åŠ¿ã€‚

Elasticsearch é€‚ç”¨äºå…¨æ–‡æœç´¢ã€å¤æ‚æŸ¥è¯¢ã€å®æ—¶æ•°æ®åˆ†æå’Œèšåˆçš„åœºæ™¯ï¼Œè€Œ RediSearch é€‚ç”¨äºå¿«é€Ÿæ•°æ®å­˜å‚¨ã€ç¼“å­˜å’Œç®€å•æŸ¥è¯¢çš„åœºæ™¯ã€‚

### å¦‚ä½•åŸºäº Redis å®ç°å»¶æ—¶ä»»åŠ¡ï¼Ÿ

> ç±»ä¼¼çš„é—®é¢˜ï¼š
>
> - è®¢å•åœ¨ 10 åˆ†é’Ÿåæœªæ”¯ä»˜å°±å¤±æ•ˆï¼Œå¦‚ä½•ç”¨ Redis å®ç°ï¼Ÿ
> - çº¢åŒ… 24 å°æ—¶æœªè¢«æŸ¥æ”¶è‡ªåŠ¨é€€è¿˜ï¼Œå¦‚ä½•ç”¨ Redis å®ç°ï¼Ÿ

åŸºäº Redis å®ç°å»¶æ—¶ä»»åŠ¡çš„åŠŸèƒ½æ— éå°±ä¸‹é¢ä¸¤ç§æ–¹æ¡ˆï¼š

1. Redis è¿‡æœŸäº‹ä»¶ç›‘å¬ã€‚
2. Redisson å†…ç½®çš„å»¶æ—¶é˜Ÿåˆ—ã€‚

Redis è¿‡æœŸäº‹ä»¶ç›‘å¬å­˜åœ¨æ—¶æ•ˆæ€§è¾ƒå·®ã€ä¸¢æ¶ˆæ¯ã€å¤šæœåŠ¡å®ä¾‹ä¸‹æ¶ˆæ¯é‡å¤æ¶ˆè´¹ç­‰é—®é¢˜ï¼Œä¸è¢«æ¨èä½¿ç”¨ã€‚

Redisson å†…ç½®çš„å»¶æ—¶é˜Ÿåˆ—å…·å¤‡ä¸‹é¢è¿™äº›ä¼˜åŠ¿ï¼š

1. **å‡å°‘äº†ä¸¢æ¶ˆæ¯çš„å¯èƒ½**ï¼šDelayedQueue ä¸­çš„æ¶ˆæ¯ä¼šè¢«æŒä¹…åŒ–ï¼Œå³ä½¿ Redis å®•æœºäº†ï¼Œæ ¹æ®æŒä¹…åŒ–æœºåˆ¶ï¼Œä¹Ÿåªå¯èƒ½ä¸¢å¤±ä¸€ç‚¹æ¶ˆæ¯ï¼Œå½±å“ä¸å¤§ã€‚å½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ‰«ææ•°æ®åº“çš„æ–¹æ³•ä½œä¸ºè¡¥å¿æœºåˆ¶ã€‚
2. **æ¶ˆæ¯ä¸å­˜åœ¨é‡å¤æ¶ˆè´¹é—®é¢˜**ï¼šæ¯ä¸ªå®¢æˆ·ç«¯éƒ½æ˜¯ä»åŒä¸€ä¸ªç›®æ ‡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡çš„ï¼Œä¸å­˜åœ¨é‡å¤æ¶ˆè´¹çš„é—®é¢˜ã€‚

å…³äº Redis å®ç°å»¶æ—¶ä»»åŠ¡çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š[å¦‚ä½•åŸºäº Redis å®ç°å»¶æ—¶ä»»åŠ¡ï¼Ÿ](https://javaguide.cn/database/redis/redis-delayed-task.html)ã€‚

## â­ï¸Redis æ•°æ®ç±»å‹

å…³äº Redis 5 ç§åŸºç¡€æ•°æ®ç±»å‹å’Œ 3 ç§ç‰¹æ®Šæ•°æ®ç±»å‹çš„è¯¦ç»†ä»‹ç»è¯·çœ‹ä¸‹é¢è¿™ä¸¤ç¯‡æ–‡ç« ä»¥åŠ [Redis å®˜æ–¹æ–‡æ¡£](https://redis.io/docs/data-types/)ï¼š

- [Redis 5 ç§åŸºæœ¬æ•°æ®ç±»å‹è¯¦è§£](https://javaguide.cn/database/redis/redis-data-structures-01.html)
- [Redis 3 ç§ç‰¹æ®Šæ•°æ®ç±»å‹è¯¦è§£](https://javaguide.cn/database/redis/redis-data-structures-02.html)

### Redis å¸¸ç”¨çš„æ•°æ®ç±»å‹æœ‰å“ªäº›ï¼Ÿ

Redis ä¸­æ¯”è¾ƒå¸¸è§çš„æ•°æ®ç±»å‹æœ‰ä¸‹é¢è¿™äº›ï¼š

- **5 ç§åŸºç¡€æ•°æ®ç±»å‹**ï¼šStringï¼ˆå­—ç¬¦ä¸²ï¼‰ã€Listï¼ˆåˆ—è¡¨ï¼‰ã€Setï¼ˆé›†åˆï¼‰ã€Hashï¼ˆæ•£åˆ—ï¼‰ã€Zsetï¼ˆæœ‰åºé›†åˆï¼‰ã€‚
- **3 ç§ç‰¹æ®Šæ•°æ®ç±»å‹**ï¼šHyperLogLogï¼ˆåŸºæ•°ç»Ÿè®¡ï¼‰ã€Bitmap ï¼ˆä½å›¾ï¼‰ã€Geospatial (åœ°ç†ä½ç½®)ã€‚

é™¤äº†ä¸Šé¢æåˆ°çš„ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„æ¯”å¦‚ [Bloom filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰](https://javaguide.cn/cs-basics/data-structure/bloom-filter.html)ã€Bitfieldï¼ˆä½åŸŸï¼‰ã€‚

### String çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ

String æ˜¯ Redis ä¸­æœ€ç®€å•åŒæ—¶ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªæ•°æ®ç±»å‹ã€‚å®ƒæ˜¯ä¸€ç§äºŒè¿›åˆ¶å®‰å…¨çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨ä»»ä½•ç±»å‹çš„æ•°æ®æ¯”å¦‚å­—ç¬¦ä¸²ã€æ•´æ•°ã€æµ®ç‚¹æ•°ã€å›¾ç‰‡ï¼ˆå›¾ç‰‡çš„ base64 ç¼–ç æˆ–è€…è§£ç æˆ–è€…å›¾ç‰‡çš„è·¯å¾„ï¼‰ã€åºåˆ—åŒ–åçš„å¯¹è±¡ã€‚

String çš„å¸¸è§åº”ç”¨åœºæ™¯å¦‚ä¸‹ï¼š

- å¸¸è§„æ•°æ®ï¼ˆæ¯”å¦‚ Sessionã€Tokenã€åºåˆ—åŒ–åçš„å¯¹è±¡ã€å›¾ç‰‡çš„è·¯å¾„ï¼‰çš„ç¼“å­˜ï¼›
- è®¡æ•°æ¯”å¦‚ç”¨æˆ·å•ä½æ—¶é—´çš„è¯·æ±‚æ•°ï¼ˆç®€å•é™æµå¯ä»¥ç”¨åˆ°ï¼‰ã€é¡µé¢å•ä½æ—¶é—´çš„è®¿é—®æ•°ï¼›
- åˆ†å¸ƒå¼é”ï¼ˆåˆ©ç”¨ `SETNX key value` å‘½ä»¤å¯ä»¥å®ç°ä¸€ä¸ªæœ€ç®€æ˜“çš„åˆ†å¸ƒå¼é”ï¼‰ï¼›
- â€¦â€¦

å…³äº String çš„è¯¦ç»†ä»‹ç»è¯·çœ‹è¿™ç¯‡æ–‡ç« ï¼š[Redis 5 ç§åŸºæœ¬æ•°æ®ç±»å‹è¯¦è§£](https://javaguide.cn/database/redis/redis-data-structures-01.html)ã€‚

### String è¿˜æ˜¯ Hash å­˜å‚¨å¯¹è±¡æ•°æ®æ›´å¥½å‘¢ï¼Ÿ

ç®€å•å¯¹æ¯”ä¸€ä¸‹äºŒè€…ï¼š

- **å¯¹è±¡å­˜å‚¨æ–¹å¼**ï¼šString å­˜å‚¨çš„æ˜¯åºåˆ—åŒ–åçš„å¯¹è±¡æ•°æ®ï¼Œå­˜æ”¾çš„æ˜¯æ•´ä¸ªå¯¹è±¡ï¼Œæ“ä½œç®€å•ç›´æ¥ã€‚Hash æ˜¯å¯¹å¯¹è±¡çš„æ¯ä¸ªå­—æ®µå•ç‹¬å­˜å‚¨ï¼Œå¯ä»¥è·å–éƒ¨åˆ†å­—æ®µçš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹æˆ–è€…æ·»åŠ éƒ¨åˆ†å­—æ®µï¼ŒèŠ‚çœç½‘ç»œæµé‡ã€‚å¦‚æœå¯¹è±¡ä¸­æŸäº›å­—æ®µéœ€è¦ç»å¸¸å˜åŠ¨æˆ–è€…ç»å¸¸éœ€è¦å•ç‹¬æŸ¥è¯¢å¯¹è±¡ä¸­çš„ä¸ªåˆ«å­—æ®µä¿¡æ¯ï¼ŒHash å°±éå¸¸é€‚åˆã€‚
- **å†…å­˜æ¶ˆè€—**ï¼šHash é€šå¸¸æ¯” String æ›´èŠ‚çœå†…å­˜ï¼Œç‰¹åˆ«æ˜¯åœ¨å­—æ®µè¾ƒå¤šä¸”å­—æ®µé•¿åº¦è¾ƒçŸ­æ—¶ã€‚Redis å¯¹å°å‹ Hash è¿›è¡Œä¼˜åŒ–ï¼ˆå¦‚ä½¿ç”¨ ziplist å­˜å‚¨ï¼‰ï¼Œè¿›ä¸€æ­¥é™ä½å†…å­˜å ç”¨ã€‚
- **å¤æ‚å¯¹è±¡å­˜å‚¨**ï¼šString åœ¨å¤„ç†å¤šå±‚åµŒå¥—æˆ–å¤æ‚ç»“æ„çš„å¯¹è±¡æ—¶æ›´æ–¹ä¾¿ï¼Œå› ä¸ºæ— éœ€å¤„ç†æ¯ä¸ªå­—æ®µçš„ç‹¬ç«‹å­˜å‚¨å’Œæ“ä½œã€‚
- **æ€§èƒ½**ï¼šString çš„æ“ä½œé€šå¸¸å…·æœ‰ O(1) çš„æ—¶é—´å¤æ‚åº¦ï¼Œå› ä¸ºå®ƒå­˜å‚¨çš„æ˜¯æ•´ä¸ªå¯¹è±¡ï¼Œæ“ä½œç®€å•ç›´æ¥ï¼Œæ•´ä½“è¯»å†™çš„æ€§èƒ½è¾ƒå¥½ã€‚Hash ç”±äºéœ€è¦å¤„ç†å¤šä¸ªå­—æ®µçš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œåœ¨å­—æ®µè¾ƒå¤šä¸”ç»å¸¸å˜åŠ¨çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€ã€‚

æ€»ç»“ï¼š

- åœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ**String** æ›´é€‚åˆå­˜å‚¨å¯¹è±¡æ•°æ®ï¼Œå°¤å…¶æ˜¯å½“å¯¹è±¡ç»“æ„ç®€å•ä¸”æ•´ä½“è¯»å†™æ˜¯ä¸»è¦æ“ä½œæ—¶ã€‚
- å¦‚æœä½ éœ€è¦é¢‘ç¹æ“ä½œå¯¹è±¡çš„éƒ¨åˆ†å­—æ®µæˆ–èŠ‚çœå†…å­˜ï¼Œ**Hash** å¯èƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

### String çš„åº•å±‚å®ç°æ˜¯ä»€ä¹ˆï¼Ÿ

Redis æ˜¯åŸºäº C è¯­è¨€ç¼–å†™çš„ï¼Œä½† Redis çš„ String ç±»å‹çš„åº•å±‚å®ç°å¹¶ä¸æ˜¯ C è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²ï¼ˆå³ä»¥ç©ºå­—ç¬¦ `\0` ç»“å°¾çš„å­—ç¬¦æ•°ç»„ï¼‰ï¼Œè€Œæ˜¯è‡ªå·±ç¼–å†™äº† [SDS](https://github.com/antirez/sds)ï¼ˆSimple Dynamic Stringï¼Œç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼‰æ¥ä½œä¸ºåº•å±‚å®ç°ã€‚

SDS æœ€æ—©æ˜¯ Redis ä½œè€…ä¸ºæ—¥å¸¸ C è¯­è¨€å¼€å‘è€Œè®¾è®¡çš„ C å­—ç¬¦ä¸²ï¼Œåæ¥è¢«åº”ç”¨åˆ°äº† Redis ä¸Šï¼Œå¹¶ç»è¿‡äº†å¤§é‡çš„ä¿®æ”¹å®Œå–„ä»¥é€‚åˆé«˜æ€§èƒ½æ“ä½œã€‚

Redis7.0 çš„ SDS çš„éƒ¨åˆ†æºç å¦‚ä¸‹ï¼ˆ<https://github.com/redis/redis/blob/7.0/src/sds.h>ï¼‰ï¼š

```c
/* Note: sdshdr5 is never used, we just access the flags byte directly.
 * However is here to document the layout of type 5 SDS strings. */
struct __attribute__ ((__packed__)) sdshdr5 {
    unsigned char flags; /* 3 lsb of type, and 5 msb of string length */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr8 {
    uint8_t len; /* used */
    uint8_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr16 {
    uint16_t len; /* used */
    uint16_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr32 {
    uint32_t len; /* used */
    uint32_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr64 {
    uint64_t len; /* used */
    uint64_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
```

é€šè¿‡æºç å¯ä»¥çœ‹å‡ºï¼ŒSDS å…±æœ‰äº”ç§å®ç°æ–¹å¼ï¼šSDS_TYPE_5ï¼ˆå¹¶æœªç”¨åˆ°ï¼‰ã€SDS_TYPE_8ã€SDS_TYPE_16ã€SDS_TYPE_32ã€SDS_TYPE_64ï¼Œå…¶ä¸­åªæœ‰åå››ç§å®é™…ç”¨åˆ°ã€‚Redis ä¼šæ ¹æ®åˆå§‹åŒ–çš„é•¿åº¦å†³å®šä½¿ç”¨å“ªç§ç±»å‹ï¼Œä»è€Œå‡å°‘å†…å­˜çš„ä½¿ç”¨ã€‚

| ç±»å‹     | å­—èŠ‚ | ä½   |
| -------- | ---- | ---- |
| sdshdr5  | < 1  | <8   |
| sdshdr8  | 1    | 8    |
| sdshdr16 | 2    | 16   |
| sdshdr32 | 4    | 32   |
| sdshdr64 | 8    | 64   |

å¯¹äºåå››ç§å®ç°éƒ½åŒ…å«äº†ä¸‹é¢è¿™ 4 ä¸ªå±æ€§ï¼š

- `len`ï¼šå­—ç¬¦ä¸²çš„é•¿åº¦ä¹Ÿå°±æ˜¯å·²ç»ä½¿ç”¨çš„å­—èŠ‚æ•°ã€‚
- `alloc`ï¼šæ€»å…±å¯ç”¨çš„å­—ç¬¦ç©ºé—´å¤§å°ï¼Œalloc-len å°±æ˜¯ SDS å‰©ä½™çš„ç©ºé—´å¤§å°ã€‚
- `buf[]`ï¼šå®é™…å­˜å‚¨å­—ç¬¦ä¸²çš„æ•°ç»„ã€‚
- `flags`ï¼šä½ä¸‰ä½ä¿å­˜ç±»å‹æ ‡å¿—ã€‚

SDS ç›¸æ¯”äº C è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²æœ‰å¦‚ä¸‹æå‡ï¼š

1. **å¯ä»¥é¿å…ç¼“å†²åŒºæº¢å‡º**ï¼šC è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²è¢«ä¿®æ”¹ï¼ˆæ¯”å¦‚æ‹¼æ¥ï¼‰æ—¶ï¼Œä¸€æ—¦æ²¡æœ‰åˆ†é…è¶³å¤Ÿé•¿åº¦çš„å†…å­˜ç©ºé—´ï¼Œå°±ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºã€‚SDS è¢«ä¿®æ”¹æ—¶ï¼Œä¼šå…ˆæ ¹æ® len å±æ€§æ£€æŸ¥ç©ºé—´å¤§å°æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œå¦‚æœä¸æ»¡è¶³ï¼Œåˆ™å…ˆæ‰©å±•è‡³æ‰€éœ€å¤§å°å†è¿›è¡Œä¿®æ”¹æ“ä½œã€‚
2. **è·å–å­—ç¬¦ä¸²é•¿åº¦çš„å¤æ‚åº¦è¾ƒä½**ï¼šC è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²çš„é•¿åº¦é€šå¸¸æ˜¯ç»è¿‡éå†è®¡æ•°æ¥å®ç°çš„ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚SDS çš„é•¿åº¦è·å–ç›´æ¥è¯»å– len å±æ€§å³å¯ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚
3. **å‡å°‘å†…å­˜åˆ†é…æ¬¡æ•°**ï¼šä¸ºäº†é¿å…ä¿®æ”¹ï¼ˆå¢åŠ /å‡å°‘ï¼‰å­—ç¬¦ä¸²æ—¶ï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡æ–°åˆ†é…å†…å­˜ï¼ˆC è¯­è¨€çš„å­—ç¬¦ä¸²æ˜¯è¿™æ ·çš„ï¼‰ï¼ŒSDS å®ç°äº†ç©ºé—´é¢„åˆ†é…å’Œæƒ°æ€§ç©ºé—´é‡Šæ”¾ä¸¤ç§ä¼˜åŒ–ç­–ç•¥ã€‚å½“ SDS éœ€è¦å¢åŠ å­—ç¬¦ä¸²æ—¶ï¼ŒRedis ä¼šä¸º SDS åˆ†é…å¥½å†…å­˜ï¼Œå¹¶ä¸”æ ¹æ®ç‰¹å®šçš„ç®—æ³•åˆ†é…å¤šä½™çš„å†…å­˜ï¼Œè¿™æ ·å¯ä»¥å‡å°‘è¿ç»­æ‰§è¡Œå­—ç¬¦ä¸²å¢é•¿æ“ä½œæ‰€éœ€çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°ã€‚å½“ SDS éœ€è¦å‡å°‘å­—ç¬¦ä¸²æ—¶ï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¸ä¼šç«‹å³è¢«å›æ”¶ï¼Œä¼šè¢«è®°å½•ä¸‹æ¥ï¼Œç­‰å¾…åç»­ä½¿ç”¨ï¼ˆæ”¯æŒæ‰‹åŠ¨é‡Šæ”¾ï¼Œæœ‰å¯¹åº”çš„ APIï¼‰ã€‚
4. **äºŒè¿›åˆ¶å®‰å…¨**ï¼šC è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²ä»¥ç©ºå­—ç¬¦ `\0` ä½œä¸ºå­—ç¬¦ä¸²ç»“æŸçš„æ ‡è¯†ï¼Œè¿™å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œåƒä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ¯”å¦‚å›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘ï¼‰å°±å¯èƒ½åŒ…æ‹¬ç©ºå­—ç¬¦ï¼ŒC å­—ç¬¦ä¸²æ— æ³•æ­£ç¡®ä¿å­˜ã€‚SDS ä½¿ç”¨ len å±æ€§åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç»“æŸï¼Œä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚

ğŸ¤ å¤šæä¸€å˜´ï¼Œå¾ˆå¤šæ–‡ç« é‡Œ SDS çš„å®šä¹‰æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

```c
struct sdshdr {
    unsigned int len;
    unsigned int free;
    char buf[];
};
```

è¿™ä¸ªä¹Ÿæ²¡é”™ï¼ŒRedis 3.2 ä¹‹å‰å°±æ˜¯è¿™æ ·å®šä¹‰çš„ã€‚åæ¥ï¼Œç”±äºè¿™ç§æ–¹å¼çš„å®šä¹‰å­˜åœ¨é—®é¢˜ï¼Œ`len` å’Œ `free` çš„å®šä¹‰ç”¨äº† 4 ä¸ªå­—èŠ‚ï¼Œé€ æˆäº†æµªè´¹ã€‚Redis 3.2 ä¹‹åï¼ŒRedis æ”¹è¿›äº† SDS çš„å®šä¹‰ï¼Œå°†å…¶åˆ’åˆ†ä¸ºäº†ç°åœ¨çš„ 5 ç§ç±»å‹ã€‚

### è´­ç‰©è½¦ä¿¡æ¯ç”¨ String è¿˜æ˜¯ Hash å­˜å‚¨æ›´å¥½å‘¢?

ç”±äºè´­ç‰©è½¦ä¸­çš„å•†å“é¢‘ç¹ä¿®æ”¹å’Œå˜åŠ¨ï¼Œè´­ç‰©è½¦ä¿¡æ¯å»ºè®®ä½¿ç”¨ Hash å­˜å‚¨ï¼š

- ç”¨æˆ· id ä¸º key
- å•†å“ id ä¸º fieldï¼Œå•†å“æ•°é‡ä¸º value

![Hashç»´æŠ¤ç®€å•çš„è´­ç‰©è½¦ä¿¡æ¯](https://oss.javaguide.cn/github/javaguide/database/redis/hash-shopping-cart.png)

é‚£ç”¨æˆ·è´­ç‰©è½¦ä¿¡æ¯çš„ç»´æŠ¤å…·ä½“åº”è¯¥æ€ä¹ˆæ“ä½œå‘¢ï¼Ÿ

- ç”¨æˆ·æ·»åŠ å•†å“å°±æ˜¯å¾€ Hash é‡Œé¢å¢åŠ æ–°çš„ field ä¸ valueï¼›
- æŸ¥è¯¢è´­ç‰©è½¦ä¿¡æ¯å°±æ˜¯éå†å¯¹åº”çš„ Hashï¼›
- æ›´æ”¹å•†å“æ•°é‡ç›´æ¥ä¿®æ”¹å¯¹åº”çš„ value å€¼ï¼ˆç›´æ¥ set æˆ–è€…åšè¿ç®—çš†å¯ï¼‰ï¼›
- åˆ é™¤å•†å“å°±æ˜¯åˆ é™¤ Hash ä¸­å¯¹åº”çš„ fieldï¼›
- æ¸…ç©ºè´­ç‰©è½¦ç›´æ¥åˆ é™¤å¯¹åº”çš„ key å³å¯ã€‚

è¿™é‡Œåªæ˜¯ä»¥ä¸šåŠ¡æ¯”è¾ƒç®€å•çš„è´­ç‰©è½¦åœºæ™¯ä¸¾ä¾‹ï¼Œå®é™…ç”µå•†åœºæ™¯ä¸‹ï¼Œfield åªä¿å­˜ä¸€ä¸ªå•†å“ id æ˜¯æ²¡åŠæ³•æ»¡è¶³éœ€æ±‚çš„ã€‚

### ä½¿ç”¨ Redis å®ç°ä¸€ä¸ªæ’è¡Œæ¦œæ€ä¹ˆåšï¼Ÿ

Redis ä¸­æœ‰ä¸€ä¸ªå«åš `Sorted Set`ï¼ˆæœ‰åºé›†åˆï¼‰çš„æ•°æ®ç±»å‹ç»å¸¸è¢«ç”¨åœ¨å„ç§æ’è¡Œæ¦œçš„åœºæ™¯ï¼Œæ¯”å¦‚ç›´æ’­é—´é€ç¤¼ç‰©çš„æ’è¡Œæ¦œã€æœ‹å‹åœˆçš„å¾®ä¿¡æ­¥æ•°æ’è¡Œæ¦œã€ç‹è€…è£è€€ä¸­çš„æ®µä½æ’è¡Œæ¦œã€è¯é¢˜çƒ­åº¦æ’è¡Œæ¦œç­‰ç­‰ã€‚

ç›¸å…³çš„ä¸€äº› Redis å‘½ä»¤ï¼š`ZRANGE`ï¼ˆä»å°åˆ°å¤§æ’åºï¼‰ã€`ZREVRANGE`ï¼ˆä»å¤§åˆ°å°æ’åºï¼‰ã€`ZREVRANK`ï¼ˆæŒ‡å®šå…ƒç´ æ’åï¼‰ã€‚

![](https://oss.javaguide.cn/github/javaguide/database/redis/2021060714195385.png)

[ã€ŠJava é¢è¯•æŒ‡åŒ—ã€‹](https://javaguide.cn/zhuanlan/java-mian-shi-zhi-bei.html) çš„ã€ŒæŠ€æœ¯é¢è¯•é¢˜ç¯‡ã€å°±æœ‰ä¸€ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Sorted Set æ¥è®¾è®¡åˆ¶ä½œä¸€ä¸ªæ’è¡Œæ¦œï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥çœ‹çœ‹ã€‚

![](https://oss.javaguide.cn/github/javaguide/database/redis/image-20220719071115140.png)

### Redis çš„æœ‰åºé›†åˆåº•å±‚ä¸ºä»€ä¹ˆè¦ç”¨è·³è¡¨ï¼Œè€Œä¸ç”¨å¹³è¡¡æ ‘ã€çº¢é»‘æ ‘æˆ–è€… B+ æ ‘ï¼Ÿ

è¿™é“é¢è¯•é¢˜å¾ˆå¤šå¤§å‚æ¯”è¾ƒå–œæ¬¢é—®ï¼Œéš¾åº¦è¿˜æ˜¯æœ‰ç‚¹å¤§çš„ã€‚

- å¹³è¡¡æ ‘ vs è·³è¡¨ï¼šå¹³è¡¡æ ‘çš„æ’å…¥ã€åˆ é™¤å’ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦å’Œè·³è¡¨ä¸€æ ·éƒ½æ˜¯ **O(log n)**ã€‚å¯¹äºèŒƒå›´æŸ¥è¯¢æ¥è¯´ï¼Œå¹³è¡¡æ ‘ä¹Ÿå¯ä»¥é€šè¿‡ä¸­åºéå†çš„æ–¹å¼è¾¾åˆ°å’Œè·³è¡¨ä¸€æ ·çš„æ•ˆæœã€‚ä½†æ˜¯å®ƒçš„æ¯ä¸€æ¬¡æ’å…¥æˆ–è€…åˆ é™¤æ“ä½œéƒ½éœ€è¦ä¿è¯æ•´é¢—æ ‘å·¦å³èŠ‚ç‚¹çš„ç»å¯¹å¹³è¡¡ï¼Œåªè¦ä¸å¹³è¡¡å°±è¦é€šè¿‡æ—‹è½¬æ“ä½œæ¥ä¿æŒå¹³è¡¡ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒè€—æ—¶çš„ã€‚è·³è¡¨è¯ç”Ÿçš„åˆè¡·å°±æ˜¯ä¸ºäº†å…‹æœå¹³è¡¡æ ‘çš„ä¸€äº›ç¼ºç‚¹ã€‚è·³è¡¨ä½¿ç”¨æ¦‚ç‡å¹³è¡¡è€Œä¸æ˜¯ä¸¥æ ¼å¼ºåˆ¶çš„å¹³è¡¡ï¼Œå› æ­¤ï¼Œè·³è¡¨ä¸­çš„æ’å…¥å’Œåˆ é™¤ç®—æ³•æ¯”å¹³è¡¡æ ‘çš„ç­‰æ•ˆç®—æ³•ç®€å•å¾—å¤šï¼Œé€Ÿåº¦ä¹Ÿå¿«å¾—å¤šã€‚
- çº¢é»‘æ ‘ vs è·³è¡¨ï¼šç›¸æ¯”è¾ƒäºçº¢é»‘æ ‘æ¥è¯´ï¼Œè·³è¡¨çš„å®ç°ä¹Ÿæ›´ç®€å•ä¸€äº›ï¼Œä¸éœ€è¦é€šè¿‡æ—‹è½¬å’ŒæŸ“è‰²ï¼ˆçº¢é»‘å˜æ¢ï¼‰æ¥ä¿è¯é»‘å¹³è¡¡ã€‚å¹¶ä¸”ï¼ŒæŒ‰ç…§åŒºé—´æ¥æŸ¥æ‰¾æ•°æ®è¿™ä¸ªæ“ä½œï¼Œçº¢é»‘æ ‘çš„æ•ˆç‡æ²¡æœ‰è·³è¡¨é«˜ã€‚
- B+ æ ‘ vs è·³è¡¨ï¼šB+ æ ‘æ›´é€‚åˆä½œä¸ºæ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿä¸­å¸¸ç”¨çš„ç´¢å¼•ç»“æ„ä¹‹ä¸€ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡å¯èƒ½å°‘çš„ IO å®šä½åˆ°å°½å¯èƒ½å¤šçš„ç´¢å¼•æ¥è·å¾—æŸ¥è¯¢æ•°æ®ã€‚å¯¹äº Redis è¿™ç§å†…å­˜æ•°æ®åº“æ¥è¯´ï¼Œå®ƒå¯¹è¿™äº›å¹¶ä¸æ„Ÿå†’ï¼Œå› ä¸º Redis ä½œä¸ºå†…å­˜æ•°æ®åº“å®ƒä¸å¯èƒ½å­˜å‚¨å¤§é‡çš„æ•°æ®ï¼Œæ‰€ä»¥å¯¹äºç´¢å¼•ä¸éœ€è¦é€šè¿‡ B+ æ ‘è¿™ç§æ–¹å¼è¿›è¡Œç»´æŠ¤ï¼Œåªéœ€æŒ‰ç…§æ¦‚ç‡è¿›è¡Œéšæœºç»´æŠ¤å³å¯ï¼ŒèŠ‚çº¦å†…å­˜ã€‚è€Œä¸”ä½¿ç”¨è·³è¡¨å®ç° zset æ—¶ç›¸è¾ƒå‰è€…æ¥è¯´æ›´ç®€å•ä¸€äº›ï¼Œåœ¨è¿›è¡Œæ’å…¥æ—¶åªéœ€é€šè¿‡ç´¢å¼•å°†æ•°æ®æ’å…¥åˆ°é“¾è¡¨ä¸­åˆé€‚çš„ä½ç½®å†éšæœºç»´æŠ¤ä¸€å®šé«˜åº¦çš„ç´¢å¼•å³å¯ï¼Œä¹Ÿä¸éœ€è¦åƒ B+ æ ‘é‚£æ ·æ’å…¥æ—¶å‘ç°å¤±è¡¡æ—¶è¿˜éœ€è¦å¯¹èŠ‚ç‚¹åˆ†è£‚ä¸åˆå¹¶ã€‚

å¦å¤–ï¼Œæˆ‘è¿˜å•ç‹¬å†™äº†ä¸€ç¯‡æ–‡ç« ä»æœ‰åºé›†åˆçš„åŸºæœ¬ä½¿ç”¨åˆ°è·³è¡¨çš„æºç åˆ†æå’Œå®ç°ï¼Œè®©ä½ ä¼šå¯¹ Redis çš„æœ‰åºé›†åˆåº•å±‚å®ç°çš„è·³è¡¨æœ‰ç€æ›´æ·±åˆ»çš„ç†è§£å’ŒæŒæ¡ï¼š[Redis ä¸ºä»€ä¹ˆç”¨è·³è¡¨å®ç°æœ‰åºé›†åˆ](https://javaguide.cn/database/redis/redis-skiplist.html)ã€‚

### Set çš„åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ

Redis ä¸­ `Set` æ˜¯ä¸€ç§æ— åºé›†åˆï¼Œé›†åˆä¸­çš„å…ƒç´ æ²¡æœ‰å…ˆåé¡ºåºä½†éƒ½å”¯ä¸€ï¼Œæœ‰ç‚¹ç±»ä¼¼äº Java ä¸­çš„ `HashSet` ã€‚

`Set` çš„å¸¸è§åº”ç”¨åœºæ™¯å¦‚ä¸‹ï¼š

- å­˜æ”¾çš„æ•°æ®ä¸èƒ½é‡å¤çš„åœºæ™¯ï¼šç½‘ç«™ UV ç»Ÿè®¡ï¼ˆæ•°æ®é‡å·¨å¤§çš„åœºæ™¯è¿˜æ˜¯ `HyperLogLog` æ›´é€‚åˆä¸€äº›ï¼‰ã€æ–‡ç« ç‚¹èµã€åŠ¨æ€ç‚¹èµç­‰ç­‰ã€‚
- éœ€è¦è·å–å¤šä¸ªæ•°æ®æºäº¤é›†ã€å¹¶é›†å’Œå·®é›†çš„åœºæ™¯ï¼šå…±åŒå¥½å‹ï¼ˆäº¤é›†ï¼‰ã€å…±åŒç²‰ä¸ï¼ˆäº¤é›†ï¼‰ã€å…±åŒå…³æ³¨ï¼ˆäº¤é›†ï¼‰ã€å¥½å‹æ¨èï¼ˆå·®é›†ï¼‰ã€éŸ³ä¹æ¨èï¼ˆå·®é›†ï¼‰ã€è®¢é˜…å·æ¨èï¼ˆå·®é›†+äº¤é›†ï¼‰ç­‰ç­‰ã€‚
- éœ€è¦éšæœºè·å–æ•°æ®æºä¸­çš„å…ƒç´ çš„åœºæ™¯ï¼šæŠ½å¥–ç³»ç»Ÿã€éšæœºç‚¹åç­‰ç­‰ã€‚

### ä½¿ç”¨ Set å®ç°æŠ½å¥–ç³»ç»Ÿæ€ä¹ˆåšï¼Ÿ

å¦‚æœæƒ³è¦ä½¿ç”¨ `Set` å®ç°ä¸€ä¸ªç®€å•çš„æŠ½å¥–ç³»ç»Ÿçš„è¯ï¼Œç›´æ¥ä½¿ç”¨ä¸‹é¢è¿™å‡ ä¸ªå‘½ä»¤å°±å¯ä»¥äº†ï¼š

- `SADD key member1 member2 ...`ï¼šå‘æŒ‡å®šé›†åˆæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ã€‚
- `SPOP key count`ï¼šéšæœºç§»é™¤å¹¶è·å–æŒ‡å®šé›†åˆä¸­ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œé€‚åˆä¸å…è®¸é‡å¤ä¸­å¥–çš„åœºæ™¯ã€‚
- `SRANDMEMBER key count`ï¼šéšæœºè·å–æŒ‡å®šé›†åˆä¸­æŒ‡å®šæ•°é‡çš„å…ƒç´ ï¼Œé€‚åˆå…è®¸é‡å¤ä¸­å¥–çš„åœºæ™¯ã€‚

### ä½¿ç”¨ Bitmap ç»Ÿè®¡æ´»è·ƒç”¨æˆ·æ€ä¹ˆåšï¼Ÿ

Bitmap å­˜å‚¨çš„æ˜¯è¿ç»­çš„äºŒè¿›åˆ¶æ•°å­—ï¼ˆ0 å’Œ 1ï¼‰ï¼Œé€šè¿‡ Bitmapï¼Œåªéœ€è¦ä¸€ä¸ª bit ä½æ¥è¡¨ç¤ºæŸä¸ªå…ƒç´ å¯¹åº”çš„å€¼æˆ–è€…çŠ¶æ€ï¼Œkey å°±æ˜¯å¯¹åº”å…ƒç´ æœ¬èº«ã€‚æˆ‘ä»¬çŸ¥é“ 8 ä¸ª bit å¯ä»¥ç»„æˆä¸€ä¸ª byteï¼Œæ‰€ä»¥ Bitmap æœ¬èº«ä¼šæå¤§çš„èŠ‚çœå‚¨å­˜ç©ºé—´ã€‚

ä½ å¯ä»¥å°† Bitmap çœ‹ä½œæ˜¯ä¸€ä¸ªå­˜å‚¨äºŒè¿›åˆ¶æ•°å­—ï¼ˆ0 å’Œ 1ï¼‰çš„æ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ çš„ä¸‹æ ‡å«åš offsetï¼ˆåç§»é‡ï¼‰ã€‚

![img](https://oss.javaguide.cn/github/javaguide/database/redis/image-20220720194154133.png)

å¦‚æœæƒ³è¦ä½¿ç”¨ Bitmap ç»Ÿè®¡æ´»è·ƒç”¨æˆ·çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨æ—¥æœŸï¼ˆç²¾ç¡®åˆ°å¤©ï¼‰ä½œä¸º keyï¼Œç„¶åç”¨æˆ· ID ä¸º offsetï¼Œå¦‚æœå½“æ—¥æ´»è·ƒè¿‡å°±è®¾ç½®ä¸º 1ã€‚

åˆå§‹åŒ–æ•°æ®ï¼š

```bash
> SETBIT 20210308 1 1
(integer) 0
> SETBIT 20210308 2 1
(integer) 0
> SETBIT 20210309 1 1
(integer) 0
```

ç»Ÿè®¡ 20210308~20210309 æ€»æ´»è·ƒç”¨æˆ·æ•°ï¼š

```bash
> BITOP and desk1 20210308 20210309
(integer) 1
> BITCOUNT desk1
(integer) 1
```

ç»Ÿè®¡ 20210308~20210309 åœ¨çº¿æ´»è·ƒç”¨æˆ·æ•°ï¼š

```bash
> BITOP or desk2 20210308 20210309
(integer) 1
> BITCOUNT desk2
(integer) 2
```

### HyperLogLog é€‚åˆä»€ä¹ˆåœºæ™¯ï¼Ÿ

HyperLogLog (HLL) æ˜¯ä¸€ç§éå¸¸å·§å¦™çš„æ¦‚ç‡æ€§æ•°æ®ç»“æ„ï¼Œå®ƒä¸“é—¨è§£å†³ä¸€ç±»éå¸¸æ£˜æ‰‹çš„å¤§æ•°æ®é—®é¢˜ï¼šåœ¨æµ·é‡æ•°æ®ä¸­ï¼Œç”¨æå°çš„å†…å­˜ï¼Œä¼°ç®—ä¸€ä¸ªé›†åˆä¸­ä¸é‡å¤å…ƒç´ çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„åŸºæ•°ï¼ˆCardinalityï¼‰

HLL åšçš„æœ€æ ¸å¿ƒçš„æƒè¡¡ï¼Œå°±æ˜¯ç”¨ä¸€ç‚¹ç‚¹ç²¾ç¡®åº¦çš„æŸå¤±ï¼Œæ¥æ¢å–å·¨å¤§çš„å†…å­˜ç©ºé—´èŠ‚çœã€‚å®ƒç»™å‡ºçš„ä¸æ˜¯ä¸€ä¸ª 100%ç²¾ç¡®çš„æ•°å­—ï¼Œè€Œæ˜¯ä¸€ä¸ªå¸¦æœ‰å¾ˆå°æ ‡å‡†è¯¯å·®ï¼ˆRedis ä¸­é»˜è®¤æ˜¯ 0.81%ï¼‰çš„è¿‘ä¼¼å€¼ã€‚

**åŸºäºè¿™ä¸ªæ ¸å¿ƒæƒè¡¡ï¼ŒHyperLogLog æœ€é€‚åˆä»¥ä¸‹ç‰¹å¾çš„åœºæ™¯ï¼š**

1. **æ•°æ®é‡å·¨å¤§ï¼Œå†…å­˜æ•æ„Ÿï¼š** è¿™æ˜¯ HLL çš„ä¸»æˆ˜åœºã€‚æ¯”å¦‚ï¼Œè¦ç»Ÿè®¡ä¸€ä¸ªäº¿çº§æ—¥æ´» App çš„æ¯æ—¥ç‹¬ç«‹è®¿å®¢æ•°ã€‚å¦‚æœç”¨ä¼ ç»Ÿçš„ Set æ¥å­˜å‚¨ç”¨æˆ· IDï¼Œä¸€ä¸ª ID å å‡ åä¸ªå­—èŠ‚ï¼Œä¸Šäº¿ä¸ª ID å¯èƒ½éœ€è¦å‡ ä¸ª GB ç”šè‡³å‡ å GB çš„å†…å­˜ï¼Œè¿™åœ¨å¾ˆå¤šåœºæ™¯ä¸‹æ˜¯ä¸å¯æ¥å—çš„ã€‚è€Œ HLLï¼Œåœ¨ Redis ä¸­åªéœ€è¦å›ºå®šçš„ 12KB å†…å­˜ï¼Œå°±èƒ½å¤„ç†å¤©æ–‡æ•°å­—çº§åˆ«çš„åŸºæ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªé¢ è¦†æ€§çš„ä¼˜åŠ¿ã€‚
2. **å¯¹ç»“æœçš„ç²¾ç¡®åº¦è¦æ±‚ä¸æ˜¯ 100%ï¼š** è¿™æ˜¯ä½¿ç”¨ HLL çš„å‰æã€‚æ¯”å¦‚ï¼Œäº§å“ç»ç†æƒ³çŸ¥é“ä¸€ä¸ªçƒ­é—¨å¸–å­çš„ UVï¼ˆç‹¬ç«‹è®¿å®¢æ•°ï¼‰æ˜¯å¤§çº¦ 1000 ä¸‡è¿˜æ˜¯ 1010 ä¸‡ï¼Œè¿™ä¸ªç»†å¾®çš„å·®åˆ«é€šå¸¸ä¸å½±å“å•†ä¸šå†³ç­–ã€‚ä½†å¦‚æœåœºæ™¯æ˜¯ç»Ÿè®¡ä¸€ä¸ªäº¤æ˜“ç³»ç»Ÿçš„å‡†ç¡®äº¤æ˜“ç¬”æ•°ï¼Œé‚£ HLL å°±å®Œå…¨ä¸é€‚ç”¨ï¼Œå› ä¸ºé‡‘èåœºæ™¯è¦æ±‚ 100%çš„ç²¾ç¡®ã€‚

**æ‰€ä»¥ï¼ŒHyperLogLog å…·ä½“çš„åº”ç”¨åœºæ™¯å°±éå¸¸æ¸…æ™°äº†ï¼š**

- **ç½‘ç«™/App çš„ UVï¼ˆUnique Visitorï¼‰ç»Ÿè®¡ï¼š** æ¯”å¦‚ç»Ÿè®¡é¦–é¡µæ¯å¤©æœ‰å¤šå°‘ä¸ªä¸åŒçš„ IP æˆ–ç”¨æˆ· ID è®¿é—®è¿‡ã€‚
- **æœç´¢å¼•æ“å…³é”®è¯ç»Ÿè®¡ï¼š** ç»Ÿè®¡æ¯å¤©æœ‰å¤šå°‘ä¸ªä¸åŒçš„ç”¨æˆ·æœç´¢äº†æŸä¸ªå…³é”®è¯ã€‚
- **ç¤¾äº¤ç½‘ç»œäº’åŠ¨ç»Ÿè®¡ï¼š** æ¯”å¦‚ç»Ÿè®¡ä¸€æ¡å¾®åšè¢«å¤šå°‘ä¸ªä¸åŒçš„ç”¨æˆ·è½¬å‘è¿‡ã€‚

åœ¨è¿™äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å…³å¿ƒçš„æ˜¯æ•°é‡çº§å’Œè¶‹åŠ¿ï¼Œè€Œä¸æ˜¯ä¸ªä½æ•°çš„å·®å¼‚ã€‚

æœ€åï¼ŒRedis çš„å®ç°è¿˜éå¸¸æ™ºèƒ½ï¼Œå®ƒå†…éƒ¨ä¼šæ ¹æ®åŸºæ•°çš„å¤§å°ï¼Œåœ¨**ç¨€ç–çŸ©é˜µ**ï¼ˆå ç”¨ç©ºé—´æ›´å°ï¼‰å’Œ**ç¨ å¯†çŸ©é˜µ**ï¼ˆå›ºå®šçš„ 12KBï¼‰ä¹‹é—´è‡ªåŠ¨åˆ‡æ¢ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–äº†å†…å­˜ä½¿ç”¨ã€‚æ€»è€Œè¨€ä¹‹ï¼Œå½“æ‚¨éœ€è¦å¯¹æµ·é‡æ•°æ®è¿›è¡Œå»é‡è®¡æ•°ï¼Œå¹¶ä¸”å¯ä»¥æ¥å—å¾®å°è¯¯å·®æ—¶ï¼ŒHyperLogLog å°±æ˜¯ä¸äºŒä¹‹é€‰ã€‚

### ä½¿ç”¨ HyperLogLog ç»Ÿè®¡é¡µé¢ UV æ€ä¹ˆåšï¼Ÿ

ä½¿ç”¨ HyperLogLog ç»Ÿè®¡é¡µé¢ UV ä¸»è¦éœ€è¦ç”¨åˆ°ä¸‹é¢è¿™ä¸¤ä¸ªå‘½ä»¤ï¼š

- `PFADD key element1 element2 ...`ï¼šæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ åˆ° HyperLogLog ä¸­ã€‚
- `PFCOUNT key1 key2`ï¼šè·å–ä¸€ä¸ªæˆ–è€…å¤šä¸ª HyperLogLog çš„å”¯ä¸€è®¡æ•°ã€‚

1ã€å°†è®¿é—®æŒ‡å®šé¡µé¢çš„æ¯ä¸ªç”¨æˆ· ID æ·»åŠ åˆ° `HyperLogLog` ä¸­ã€‚

```bash
PFADD PAGE_1:UV USER1 USER2 ...... USERn
```

2ã€ç»Ÿè®¡æŒ‡å®šé¡µé¢çš„ UVã€‚

```bash
PFCOUNT PAGE_1:UV
```

### å¦‚æœæˆ‘æƒ³åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦ä¸åœ¨æµ·é‡å…ƒç´ é›†åˆä¸­ï¼Œç”¨ä»€ä¹ˆæ•°æ®ç±»å‹ï¼Ÿ

è¿™æ˜¯å¸ƒéš†è¿‡æ»¤å™¨çš„ç»å…¸åº”ç”¨åœºæ™¯ã€‚å¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥å‘Šè¯‰ä½ ä¸€ä¸ªå…ƒç´ ä¸€å®šä¸å­˜åœ¨æˆ–è€…å¯èƒ½å­˜åœ¨ï¼Œå®ƒä¹Ÿæœ‰æé«˜çš„ç©ºé—´æ•ˆç‡å’Œä¸€å®šçš„è¯¯åˆ¤ç‡ï¼Œä½†ç»ä¸ä¼šæ¼æŠ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå…ƒç´ å­˜åœ¨ï¼Œå°æ¦‚ç‡ä¼šè¯¯åˆ¤ã€‚å¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå…ƒç´ ä¸åœ¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå…ƒç´ ä¸€å®šä¸åœ¨ã€‚

Bloom Filter çš„ç®€å•åŸç†å›¾å¦‚ä¸‹ï¼š

![Bloom Filter çš„ç®€å•åŸç†ç¤ºæ„å›¾](https://oss.javaguide.cn/github/javaguide/cs-basics/algorithms/bloom-filter-simple-schematic-diagram.png)

å½“å­—ç¬¦ä¸²å­˜å‚¨è¦åŠ å…¥åˆ°å¸ƒéš†è¿‡æ»¤å™¨ä¸­æ—¶ï¼Œè¯¥å­—ç¬¦ä¸²é¦–å…ˆç”±å¤šä¸ªå“ˆå¸Œå‡½æ•°ç”Ÿæˆä¸åŒçš„å“ˆå¸Œå€¼ï¼Œç„¶åå°†å¯¹åº”çš„ä½æ•°ç»„çš„ä¸‹æ ‡è®¾ç½®ä¸º 1ï¼ˆå½“ä½æ•°ç»„åˆå§‹åŒ–æ—¶ï¼Œæ‰€æœ‰ä½ç½®å‡ä¸º 0ï¼‰ã€‚å½“ç¬¬äºŒæ¬¡å­˜å‚¨ç›¸åŒå­—ç¬¦ä¸²æ—¶ï¼Œå› ä¸ºå…ˆå‰çš„å¯¹åº”ä½ç½®å·²è®¾ç½®ä¸º 1ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“çŸ¥é“æ­¤å€¼å·²ç»å­˜åœ¨ï¼ˆå»é‡éå¸¸æ–¹ä¾¿ï¼‰ã€‚

å¦‚æœæˆ‘ä»¬éœ€è¦åˆ¤æ–­æŸä¸ªå­—ç¬¦ä¸²æ˜¯å¦åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­æ—¶ï¼Œåªéœ€è¦å¯¹ç»™å®šå­—ç¬¦ä¸²å†æ¬¡è¿›è¡Œç›¸åŒçš„å“ˆå¸Œè®¡ç®—ï¼Œå¾—åˆ°å€¼ä¹‹ååˆ¤æ–­ä½æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯å¦éƒ½ä¸º 1ï¼Œå¦‚æœå€¼éƒ½ä¸º 1ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªå€¼åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªå€¼ä¸ä¸º 1ï¼Œè¯´æ˜è¯¥å…ƒç´ ä¸åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚

## â­ï¸Redis æŒä¹…åŒ–æœºåˆ¶ï¼ˆé‡è¦ï¼‰

Redis æŒä¹…åŒ–æœºåˆ¶ï¼ˆRDB æŒä¹…åŒ–ã€AOF æŒä¹…åŒ–ã€RDB å’Œ AOF çš„æ··åˆæŒä¹…åŒ–ï¼‰ç›¸å…³çš„é—®é¢˜æ¯”è¾ƒå¤šï¼Œä¹Ÿæ¯”è¾ƒé‡è¦ï¼Œäºæ˜¯æˆ‘å•ç‹¬æŠ½äº†ä¸€ç¯‡æ–‡ç« æ¥æ€»ç»“ Redis æŒä¹…åŒ–æœºåˆ¶ç›¸å…³çš„çŸ¥è¯†ç‚¹å’Œé—®é¢˜ï¼š[Redis æŒä¹…åŒ–æœºåˆ¶è¯¦è§£](https://javaguide.cn/database/redis/redis-persistence.html)ã€‚

## â­ï¸Redis çº¿ç¨‹æ¨¡å‹ï¼ˆé‡è¦ï¼‰

å¯¹äºè¯»å†™å‘½ä»¤æ¥è¯´ï¼ŒRedis ä¸€ç›´æ˜¯å•çº¿ç¨‹æ¨¡å‹ã€‚ä¸è¿‡ï¼Œåœ¨ Redis 4.0 ç‰ˆæœ¬ä¹‹åå¼•å…¥äº†å¤šçº¿ç¨‹æ¥æ‰§è¡Œä¸€äº›å¤§é”®å€¼å¯¹çš„å¼‚æ­¥åˆ é™¤æ“ä½œï¼ŒRedis 6.0 ç‰ˆæœ¬ä¹‹åå¼•å…¥äº†å¤šçº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¯·æ±‚ï¼ˆæé«˜ç½‘ç»œ IO è¯»å†™æ€§èƒ½ï¼‰ã€‚

### Redis å•çº¿ç¨‹æ¨¡å‹äº†è§£å—ï¼Ÿ

**Redis åŸºäº Reactor æ¨¡å¼è®¾è®¡å¼€å‘äº†ä¸€å¥—é«˜æ•ˆçš„äº‹ä»¶å¤„ç†æ¨¡å‹**ï¼ˆNetty çš„çº¿ç¨‹æ¨¡å‹ä¹ŸåŸºäº Reactor æ¨¡å¼ï¼ŒReactor æ¨¡å¼ä¸æ„§æ˜¯é«˜æ€§èƒ½ IO çš„åŸºçŸ³ï¼‰ï¼Œè¿™å¥—äº‹ä»¶å¤„ç†æ¨¡å‹å¯¹åº”çš„æ˜¯ Redis ä¸­çš„æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰ã€‚ç”±äºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰æ˜¯å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬éƒ½è¯´ Redis æ˜¯å•çº¿ç¨‹æ¨¡å‹ã€‚

ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹æœ‰ä¸€æ®µè¯æ˜¯è¿™æ ·ä»‹ç»æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨çš„ï¼Œæˆ‘è§‰å¾—å†™å¾—æŒºä¸é”™ã€‚

> Redis åŸºäº Reactor æ¨¡å¼å¼€å‘äº†è‡ªå·±çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼šè¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰ã€‚
>
> - æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ï¼ˆmultiplexingï¼‰ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—ç›®å‰æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨ã€‚
> - å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­”ï¼ˆacceptï¼‰ã€è¯»å–ï¼ˆreadï¼‰ã€å†™å…¥ï¼ˆwriteï¼‰ã€å…³ é—­ï¼ˆcloseï¼‰ç­‰æ“ä½œæ—¶ï¼Œä¸æ“ä½œç›¸å¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿï¼Œè¿™æ—¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨å°±ä¼šè°ƒç”¨å¥—æ¥å­—ä¹‹å‰å…³è”å¥½çš„äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚
>
> **è™½ç„¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œï¼Œä½†é€šè¿‡ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ç¨‹åºæ¥ç›‘å¬å¤šä¸ªå¥—æ¥å­—**ï¼Œæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ—¢å®ç°äº†é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¨¡å‹ï¼Œåˆå¯ä»¥å¾ˆå¥½åœ°ä¸ Redis æœåŠ¡å™¨ä¸­å…¶ä»–åŒæ ·ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„æ¨¡å—è¿›è¡Œå¯¹æ¥ï¼Œè¿™ä¿æŒäº† Redis å†…éƒ¨å•çº¿ç¨‹è®¾è®¡çš„ç®€å•æ€§ã€‚

**æ—¢ç„¶æ˜¯å•çº¿ç¨‹ï¼Œé‚£æ€ä¹ˆç›‘å¬å¤§é‡çš„å®¢æˆ·ç«¯è¿æ¥å‘¢ï¼Ÿ**

Redis é€šè¿‡ **IO å¤šè·¯å¤ç”¨ç¨‹åº** æ¥ç›‘å¬æ¥è‡ªå®¢æˆ·ç«¯çš„å¤§é‡è¿æ¥ï¼ˆæˆ–è€…è¯´æ˜¯ç›‘å¬å¤šä¸ª socketï¼‰ï¼Œå®ƒä¼šå°†æ„Ÿå…´è¶£çš„äº‹ä»¶åŠç±»å‹ï¼ˆè¯»ã€å†™ï¼‰æ³¨å†Œåˆ°å†…æ ¸ä¸­å¹¶ç›‘å¬æ¯ä¸ªäº‹ä»¶æ˜¯å¦å‘ç”Ÿã€‚

è¿™æ ·çš„å¥½å¤„éå¸¸æ˜æ˜¾ï¼š**I/O å¤šè·¯å¤ç”¨æŠ€æœ¯çš„ä½¿ç”¨è®© Redis ä¸éœ€è¦é¢å¤–åˆ›å»ºå¤šä½™çš„çº¿ç¨‹æ¥ç›‘å¬å®¢æˆ·ç«¯çš„å¤§é‡è¿æ¥ï¼Œé™ä½äº†èµ„æºçš„æ¶ˆè€—**ï¼ˆå’Œ NIO ä¸­çš„ `Selector` ç»„ä»¶å¾ˆåƒï¼‰ã€‚

æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰ä¸»è¦æ˜¯åŒ…å« 4 ä¸ªéƒ¨åˆ†ï¼š

- å¤šä¸ª socketï¼ˆå®¢æˆ·ç«¯è¿æ¥ï¼‰
- IO å¤šè·¯å¤ç”¨ç¨‹åºï¼ˆæ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯è¿æ¥çš„å…³é”®ï¼‰
- æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼ˆå°† socket å…³è”åˆ°ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ï¼‰
- äº‹ä»¶å¤„ç†å™¨ï¼ˆè¿æ¥åº”ç­”å¤„ç†å™¨ã€å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ã€å‘½ä»¤å›å¤å¤„ç†å™¨ï¼‰

![æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰](https://oss.javaguide.cn/github/javaguide/database/redis/redis-event-handler.png)

### Redis6.0 ä¹‹å‰ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ

è™½ç„¶è¯´ Redis æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œä½†å®é™…ä¸Šï¼Œ**Redis åœ¨ 4.0 ä¹‹åçš„ç‰ˆæœ¬ä¸­å°±å·²ç»åŠ å…¥äº†å¯¹å¤šçº¿ç¨‹çš„æ”¯æŒã€‚**

ä¸è¿‡ï¼ŒRedis 4.0 å¢åŠ çš„å¤šçº¿ç¨‹ä¸»è¦æ˜¯é’ˆå¯¹ä¸€äº›å¤§é”®å€¼å¯¹çš„åˆ é™¤æ“ä½œçš„å‘½ä»¤ï¼Œä½¿ç”¨è¿™äº›å‘½ä»¤å°±ä¼šä½¿ç”¨ä¸»çº¿ç¨‹ä¹‹å¤–çš„å…¶ä»–çº¿ç¨‹æ¥â€œå¼‚æ­¥å¤„ç†â€ï¼Œä»è€Œå‡å°‘å¯¹ä¸»çº¿ç¨‹çš„å½±å“ã€‚

ä¸ºæ­¤ï¼ŒRedis 4.0 ä¹‹åæ–°å¢äº†å‡ ä¸ªå¼‚æ­¥å‘½ä»¤ï¼š

- `UNLINK`ï¼šå¯ä»¥çœ‹ä½œæ˜¯ `DEL` å‘½ä»¤çš„å¼‚æ­¥ç‰ˆæœ¬ã€‚
- `FLUSHALL ASYNC`ï¼šç”¨äºæ¸…ç©ºæ‰€æœ‰æ•°æ®åº“çš„æ‰€æœ‰é”®ï¼Œä¸é™äºå½“å‰ `SELECT` çš„æ•°æ®åº“ã€‚
- `FLUSHDB ASYNC`ï¼šç”¨äºæ¸…ç©ºå½“å‰ `SELECT` æ•°æ®åº“ä¸­çš„æ‰€æœ‰é”®ã€‚

![redis4.0 more thread](https://oss.javaguide.cn/github/javaguide/database/redis/redis4.0-more-thread.png)

æ€»çš„æ¥è¯´ï¼Œç›´åˆ° Redis 6.0 ä¹‹å‰ï¼ŒRedis çš„ä¸»è¦æ“ä½œä»ç„¶æ˜¯å•çº¿ç¨‹å¤„ç†çš„ã€‚

**é‚£ Redis6.0 ä¹‹å‰ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ** æˆ‘è§‰å¾—ä¸»è¦åŸå› æœ‰ 3 ç‚¹ï¼š

- å•çº¿ç¨‹ç¼–ç¨‹å®¹æ˜“å¹¶ä¸”æ›´å®¹æ˜“ç»´æŠ¤ï¼›
- Redis çš„æ€§èƒ½ç“¶é¢ˆä¸åœ¨ CPUï¼Œä¸»è¦åœ¨å†…å­˜å’Œç½‘ç»œï¼›
- å¤šçº¿ç¨‹å°±ä¼šå­˜åœ¨æ­»é”ã€çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰é—®é¢˜ï¼Œç”šè‡³ä¼šå½±å“æ€§èƒ½ã€‚

ç›¸å…³é˜…è¯»ï¼š[ä¸ºä»€ä¹ˆ Redis é€‰æ‹©å•çº¿ç¨‹æ¨¡å‹ï¼Ÿ](https://draveness.me/whys-the-design-redis-single-thread/)ã€‚

### Redis6.0 ä¹‹åä¸ºä½•å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Ÿ

**Redis6.0 å¼•å…¥å¤šçº¿ç¨‹ä¸»è¦æ˜¯ä¸ºäº†æé«˜ç½‘ç»œ IO è¯»å†™æ€§èƒ½**ï¼Œå› ä¸ºè¿™ä¸ªç®—æ˜¯ Redis ä¸­çš„ä¸€ä¸ªæ€§èƒ½ç“¶é¢ˆï¼ˆRedis çš„ç“¶é¢ˆä¸»è¦å—é™äºå†…å­˜å’Œç½‘ç»œï¼‰ã€‚

è™½ç„¶ï¼ŒRedis6.0 å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Œä½†æ˜¯ Redis çš„å¤šçº¿ç¨‹åªæ˜¯åœ¨ç½‘ç»œæ•°æ®çš„è¯»å†™è¿™ç±»è€—æ—¶æ“ä½œä¸Šä½¿ç”¨äº†ï¼Œæ‰§è¡Œå‘½ä»¤ä»ç„¶æ˜¯å•çº¿ç¨‹é¡ºåºæ‰§è¡Œã€‚å› æ­¤ï¼Œä½ ä¹Ÿä¸éœ€è¦æ‹…å¿ƒçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

Redis6.0 çš„å¤šçº¿ç¨‹é»˜è®¤æ˜¯ç¦ç”¨çš„ï¼Œåªä½¿ç”¨ä¸»çº¿ç¨‹ã€‚å¦‚éœ€å¼€å¯éœ€è¦è®¾ç½® IO çº¿ç¨‹æ•° > 1ï¼Œéœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ `redis.conf`ï¼š

```bash
io-threads 4 #è®¾ç½®1çš„è¯åªä¼šå¼€å¯ä¸»çº¿ç¨‹ï¼Œå®˜ç½‘å»ºè®®4æ ¸çš„æœºå™¨å»ºè®®è®¾ç½®ä¸º2æˆ–3ä¸ªçº¿ç¨‹ï¼Œ8æ ¸çš„å»ºè®®è®¾ç½®ä¸º6ä¸ªçº¿ç¨‹
```

å¦å¤–ï¼š

- io-threads çš„ä¸ªæ•°ä¸€æ—¦è®¾ç½®ï¼Œä¸èƒ½é€šè¿‡ config åŠ¨æ€è®¾ç½®ã€‚
- å½“è®¾ç½® ssl åï¼Œio-threads å°†ä¸å·¥ä½œã€‚

å¼€å¯å¤šçº¿ç¨‹åï¼Œé»˜è®¤åªä¼šä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œ IO å†™å…¥ writesï¼Œå³å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œå¦‚æœéœ€è¦å¼€å¯å¤šçº¿ç¨‹ IO è¯»å– readsï¼ŒåŒæ ·éœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ `redis.conf`ï¼š

```bash
io-threads-do-reads yes
```

ä½†æ˜¯å®˜ç½‘æè¿°å¼€å¯å¤šçº¿ç¨‹è¯»å¹¶ä¸èƒ½æœ‰å¤ªå¤§æå‡ï¼Œå› æ­¤ä¸€èˆ¬æƒ…å†µä¸‹å¹¶ä¸å»ºè®®å¼€å¯ã€‚

ç›¸å…³é˜…è¯»ï¼š

- [Redis 6.0 æ–°ç‰¹æ€§-å¤šçº¿ç¨‹è¿ç¯ 13 é—®ï¼](https://mp.weixin.qq.com/s/FZu3acwK6zrCBZQ_3HoUgw)
- [Redis å¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹å…¨é¢æ­ç§˜](https://segmentfault.com/a/1190000039223696)ï¼ˆæ¨èï¼‰

### Redis åå°çº¿ç¨‹äº†è§£å—ï¼Ÿ

æˆ‘ä»¬è™½ç„¶ç»å¸¸è¯´ Redis æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼ˆä¸»è¦é€»è¾‘æ˜¯å•çº¿ç¨‹å®Œæˆçš„ï¼‰ï¼Œä½†å®é™…è¿˜æœ‰ä¸€äº›åå°çº¿ç¨‹ç”¨äºæ‰§è¡Œä¸€äº›æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼š

- é€šè¿‡ `bio_close_file` åå°çº¿ç¨‹æ¥é‡Šæ”¾ AOF / RDB ç­‰è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶èµ„æºã€‚
- é€šè¿‡ `bio_aof_fsync` åå°çº¿ç¨‹è°ƒç”¨ `fsync` å‡½æ•°å°†ç³»ç»Ÿå†…æ ¸ç¼“å†²åŒºè¿˜æœªåŒæ­¥åˆ°åˆ°ç£ç›˜çš„æ•°æ®å¼ºåˆ¶åˆ·åˆ°ç£ç›˜ï¼ˆAOF æ–‡ä»¶ï¼‰ã€‚
- é€šè¿‡ `bio_lazy_free` åå°çº¿ç¨‹é‡Šæ”¾å¤§å¯¹è±¡ï¼ˆå·²åˆ é™¤ï¼‰å ç”¨çš„å†…å­˜ç©ºé—´.

åœ¨`bio.h` æ–‡ä»¶ä¸­æœ‰å®šä¹‰ï¼ˆRedis 6.0 ç‰ˆæœ¬ï¼Œæºç åœ°å€ï¼š<https://github.com/redis/redis/blob/6.0/src/bio.h>ï¼‰ï¼š

```java
#ifndef __BIO_H
#define __BIO_H

/* Exported API */
void bioInit(void);
void bioCreateBackgroundJob(int type, void *arg1, void *arg2, void *arg3);
unsigned long long bioPendingJobsOfType(int type);
unsigned long long bioWaitStepOfType(int type);
time_t bioOlderJobOfType(int type);
void bioKillThreads(void);

/* Background job opcodes */
#define BIO_CLOSE_FILE    0 /* Deferred close(2) syscall. */
#define BIO_AOF_FSYNC     1 /* Deferred AOF fsync. */
#define BIO_LAZY_FREE     2 /* Deferred objects freeing. */
#define BIO_NUM_OPS       3

#endif
```

å…³äº Redis åå°çº¿ç¨‹çš„è¯¦ç»†ä»‹ç»å¯ä»¥æŸ¥çœ‹ [Redis 6.0 åå°çº¿ç¨‹æœ‰å“ªäº›ï¼Ÿ](https://juejin.cn/post/7102780434739626014) è¿™ç¯‡å°±æ–‡ç« ã€‚

## â­ï¸Redis å†…å­˜ç®¡ç†

### Redis ç»™ç¼“å­˜æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è®¾ç½®ä¿å­˜çš„ç¼“å­˜æ•°æ®çš„æ—¶å€™éƒ½ä¼šè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

å†…å­˜æ˜¯æœ‰é™ä¸”çè´µçš„ï¼Œå¦‚æœä¸å¯¹ç¼“å­˜æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé‚£å†…å­˜å ç”¨å°±ä¼šä¸€ç›´å¢é•¿ï¼Œæœ€ç»ˆå¯èƒ½ä¼šå¯¼è‡´ OOM é—®é¢˜ã€‚é€šè¿‡è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ŒRedis ä¼šè‡ªåŠ¨åˆ é™¤æš‚æ—¶ä¸éœ€è¦çš„æ•°æ®ï¼Œä¸ºæ–°çš„ç¼“å­˜æ•°æ®è…¾å‡ºç©ºé—´ã€‚

Redis è‡ªå¸¦äº†ç»™ç¼“å­˜æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š

```bash
127.0.0.1:6379> expire key 60 # æ•°æ®åœ¨ 60s åè¿‡æœŸ
(integer) 1
127.0.0.1:6379> setex key 60 value # æ•°æ®åœ¨ 60s åè¿‡æœŸ (setex:[set] + [ex]pire)
OK
127.0.0.1:6379> ttl key # æŸ¥çœ‹æ•°æ®è¿˜æœ‰å¤šä¹…è¿‡æœŸ
(integer) 56
```

æ³¨æ„ âš ï¸ï¼šRedis ä¸­é™¤äº†å­—ç¬¦ä¸²ç±»å‹æœ‰è‡ªå·±ç‹¬æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„å‘½ä»¤ `setex` å¤–ï¼Œå…¶ä»–æ–¹æ³•éƒ½éœ€è¦ä¾é  `expire` å‘½ä»¤æ¥è®¾ç½®è¿‡æœŸæ—¶é—´ ã€‚å¦å¤–ï¼Œ`persist` å‘½ä»¤å¯ä»¥ç§»é™¤ä¸€ä¸ªé”®çš„è¿‡æœŸæ—¶é—´ã€‚

**è¿‡æœŸæ—¶é—´é™¤äº†æœ‰åŠ©äºç¼“è§£å†…å­˜çš„æ¶ˆè€—ï¼Œè¿˜æœ‰ä»€ä¹ˆå…¶ä»–ç”¨ä¹ˆï¼Ÿ**

å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡åœºæ™¯å°±æ˜¯éœ€è¦æŸä¸ªæ•°æ®åªåœ¨æŸä¸€æ—¶é—´æ®µå†…å­˜åœ¨ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„çŸ­ä¿¡éªŒè¯ç å¯èƒ½åªåœ¨ 1 åˆ†é’Ÿå†…æœ‰æ•ˆï¼Œç”¨æˆ·ç™»å½•çš„ Token å¯èƒ½åªåœ¨ 1 å¤©å†…æœ‰æ•ˆã€‚

å¦‚æœä½¿ç”¨ä¼ ç»Ÿçš„æ•°æ®åº“æ¥å¤„ç†çš„è¯ï¼Œä¸€èˆ¬éƒ½æ˜¯è‡ªå·±åˆ¤æ–­è¿‡æœŸï¼Œè¿™æ ·æ›´éº»çƒ¦å¹¶ä¸”æ€§èƒ½è¦å·®å¾ˆå¤šã€‚

### Redis æ˜¯å¦‚ä½•åˆ¤æ–­æ•°æ®æ˜¯å¦è¿‡æœŸçš„å‘¢ï¼Ÿ

Redis é€šè¿‡ä¸€ä¸ªå«åšè¿‡æœŸå­—å…¸ï¼ˆå¯ä»¥çœ‹ä½œæ˜¯ hash è¡¨ï¼‰æ¥ä¿å­˜æ•°æ®è¿‡æœŸçš„æ—¶é—´ã€‚è¿‡æœŸå­—å…¸çš„é”®æŒ‡å‘ Redis æ•°æ®åº“ä¸­çš„æŸä¸ª keyï¼ˆé”®ï¼‰ï¼Œè¿‡æœŸå­—å…¸çš„å€¼æ˜¯ä¸€ä¸ª long long ç±»å‹çš„æ•´æ•°ï¼Œè¿™ä¸ªæ•´æ•°ä¿å­˜äº† key æ‰€æŒ‡å‘çš„æ•°æ®åº“é”®çš„è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ç²¾åº¦çš„ UNIX æ—¶é—´æˆ³ï¼‰ã€‚

![Redis è¿‡æœŸå­—å…¸](https://oss.javaguide.cn/github/javaguide/database/redis/redis-expired-dictionary.png)

è¿‡æœŸå­—å…¸æ˜¯å­˜å‚¨åœ¨ redisDb è¿™ä¸ªç»“æ„é‡Œçš„ï¼š

```c
typedef struct redisDb {
    ...

    dict *dict;     //æ•°æ®åº“é”®ç©ºé—´,ä¿å­˜ç€æ•°æ®åº“ä¸­æ‰€æœ‰é”®å€¼å¯¹
    dict *expires   // è¿‡æœŸå­—å…¸,ä¿å­˜ç€é”®çš„è¿‡æœŸæ—¶é—´
    ...
} redisDb;
```

åœ¨æŸ¥è¯¢ä¸€ä¸ª key çš„æ—¶å€™ï¼ŒRedis é¦–å…ˆæ£€æŸ¥è¯¥ key æ˜¯å¦å­˜åœ¨äºè¿‡æœŸå­—å…¸ä¸­ï¼ˆæ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼‰ï¼Œå¦‚æœä¸åœ¨å°±ç›´æ¥è¿”å›ï¼Œåœ¨çš„è¯éœ€è¦åˆ¤æ–­ä¸€ä¸‹è¿™ä¸ª key æ˜¯å¦è¿‡æœŸï¼Œè¿‡æœŸç›´æ¥åˆ é™¤ key ç„¶åè¿”å› nullã€‚

### Redis è¿‡æœŸ key åˆ é™¤ç­–ç•¥äº†è§£ä¹ˆï¼Ÿ

å¦‚æœå‡è®¾ä½ è®¾ç½®äº†ä¸€æ‰¹ key åªèƒ½å­˜æ´» 1 åˆ†é’Ÿï¼Œé‚£ä¹ˆ 1 åˆ†é’Ÿåï¼ŒRedis æ˜¯æ€ä¹ˆå¯¹è¿™æ‰¹ key è¿›è¡Œåˆ é™¤çš„å‘¢ï¼Ÿ

å¸¸ç”¨çš„è¿‡æœŸæ•°æ®çš„åˆ é™¤ç­–ç•¥å°±ä¸‹é¢è¿™å‡ ç§ï¼š

1. **æƒ°æ€§åˆ é™¤**ï¼šåªä¼šåœ¨å–å‡º/æŸ¥è¯¢ key çš„æ—¶å€™æ‰å¯¹æ•°æ®è¿›è¡Œè¿‡æœŸæ£€æŸ¥ã€‚è¿™ç§æ–¹å¼å¯¹ CPU æœ€å‹å¥½ï¼Œä½†æ˜¯å¯èƒ½ä¼šé€ æˆå¤ªå¤šè¿‡æœŸ key æ²¡æœ‰è¢«åˆ é™¤ã€‚
2. **å®šæœŸåˆ é™¤**ï¼šå‘¨æœŸæ€§åœ°éšæœºä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key ä¸­æŠ½æŸ¥ä¸€æ‰¹ï¼Œç„¶åé€ä¸ªæ£€æŸ¥è¿™äº› key æ˜¯å¦è¿‡æœŸï¼Œè¿‡æœŸå°±åˆ é™¤ keyã€‚ç›¸æ¯”äºæƒ°æ€§åˆ é™¤ï¼Œå®šæœŸåˆ é™¤å¯¹å†…å­˜æ›´å‹å¥½ï¼Œå¯¹ CPU ä¸å¤ªå‹å¥½ã€‚
3. **å»¶è¿Ÿé˜Ÿåˆ—**ï¼šæŠŠè®¾ç½®è¿‡æœŸæ—¶é—´çš„ key æ”¾åˆ°ä¸€ä¸ªå»¶è¿Ÿé˜Ÿåˆ—é‡Œï¼Œåˆ°æœŸä¹‹åå°±åˆ é™¤ keyã€‚è¿™ç§æ–¹å¼å¯ä»¥ä¿è¯æ¯ä¸ªè¿‡æœŸ key éƒ½èƒ½è¢«åˆ é™¤ï¼Œä½†ç»´æŠ¤å»¶è¿Ÿé˜Ÿåˆ—å¤ªéº»çƒ¦ï¼Œé˜Ÿåˆ—æœ¬èº«ä¹Ÿè¦å ç”¨èµ„æºã€‚
4. **å®šæ—¶åˆ é™¤**ï¼šæ¯ä¸ªè®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key éƒ½ä¼šåœ¨è®¾ç½®çš„æ—¶é—´åˆ°è¾¾æ—¶ç«‹å³è¢«åˆ é™¤ã€‚è¿™ç§æ–¹æ³•å¯ä»¥ç¡®ä¿å†…å­˜ä¸­ä¸ä¼šæœ‰è¿‡æœŸçš„é”®ï¼Œä½†æ˜¯å®ƒå¯¹ CPU çš„å‹åŠ›æœ€å¤§ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸ºæ¯ä¸ªé”®éƒ½è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ã€‚

**Redis é‡‡ç”¨çš„æ˜¯é‚£ç§åˆ é™¤ç­–ç•¥å‘¢ï¼Ÿ**

Redis é‡‡ç”¨çš„æ˜¯ **å®šæœŸåˆ é™¤+æƒ°æ€§/æ‡’æ±‰å¼åˆ é™¤** ç»“åˆçš„ç­–ç•¥ï¼Œè¿™ä¹Ÿæ˜¯å¤§éƒ¨åˆ†ç¼“å­˜æ¡†æ¶çš„é€‰æ‹©ã€‚å®šæœŸåˆ é™¤å¯¹å†…å­˜æ›´åŠ å‹å¥½ï¼Œæƒ°æ€§åˆ é™¤å¯¹ CPU æ›´åŠ å‹å¥½ã€‚ä¸¤è€…å„æœ‰åƒç§‹ï¼Œç»“åˆèµ·æ¥ä½¿ç”¨æ—¢èƒ½å…¼é¡¾ CPU å‹å¥½ï¼Œåˆèƒ½å…¼é¡¾å†…å­˜å‹å¥½ã€‚

ä¸‹é¢æ˜¯æˆ‘ä»¬è¯¦ç»†ä»‹ç»ä¸€ä¸‹ Redis ä¸­çš„å®šæœŸåˆ é™¤å…·ä½“æ˜¯å¦‚ä½•åšçš„ã€‚

Redis çš„å®šæœŸåˆ é™¤è¿‡ç¨‹æ˜¯éšæœºçš„ï¼ˆå‘¨æœŸæ€§åœ°éšæœºä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key ä¸­æŠ½æŸ¥ä¸€æ‰¹ï¼‰ï¼Œæ‰€ä»¥å¹¶ä¸ä¿è¯æ‰€æœ‰è¿‡æœŸé”®éƒ½ä¼šè¢«ç«‹å³åˆ é™¤ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆæœ‰çš„ key è¿‡æœŸäº†ï¼Œå¹¶æ²¡æœ‰è¢«åˆ é™¤ã€‚å¹¶ä¸”ï¼ŒRedis åº•å±‚ä¼šé€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡æ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU æ—¶é—´çš„å½±å“ã€‚

å¦å¤–ï¼Œå®šæœŸåˆ é™¤è¿˜ä¼šå—åˆ°æ‰§è¡Œæ—¶é—´å’Œè¿‡æœŸ key çš„æ¯”ä¾‹çš„å½±å“ï¼š

- æ‰§è¡Œæ—¶é—´å·²ç»è¶…è¿‡äº†é˜ˆå€¼ï¼Œé‚£ä¹ˆå°±ä¸­æ–­è¿™ä¸€æ¬¡å®šæœŸåˆ é™¤å¾ªç¯ï¼Œä»¥é¿å…ä½¿ç”¨è¿‡å¤šçš„ CPU æ—¶é—´ã€‚
- å¦‚æœè¿™ä¸€æ‰¹è¿‡æœŸçš„ key æ¯”ä¾‹è¶…è¿‡ä¸€ä¸ªæ¯”ä¾‹ï¼Œå°±ä¼šé‡å¤æ‰§è¡Œæ­¤åˆ é™¤æµç¨‹ï¼Œä»¥æ›´ç§¯æåœ°æ¸…ç†è¿‡æœŸ keyã€‚ç›¸åº”åœ°ï¼Œå¦‚æœè¿‡æœŸçš„ key æ¯”ä¾‹ä½äºè¿™ä¸ªæ¯”ä¾‹ï¼Œå°±ä¼šä¸­æ–­è¿™ä¸€æ¬¡å®šæœŸåˆ é™¤å¾ªç¯ï¼Œé¿å…åšè¿‡å¤šçš„å·¥ä½œè€Œè·å¾—å¾ˆå°‘çš„å†…å­˜å›æ”¶ã€‚

Redis 7.2 ç‰ˆæœ¬çš„æ‰§è¡Œæ—¶é—´é˜ˆå€¼æ˜¯ **25ms**ï¼Œè¿‡æœŸ key æ¯”ä¾‹è®¾å®šå€¼æ˜¯ **10%**ã€‚

```c
#define ACTIVE_EXPIRE_CYCLE_FAST_DURATION 1000 /* Microseconds. */
#define ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC 25 /* Max % of CPU to use. */
#define ACTIVE_EXPIRE_CYCLE_ACCEPTABLE_STALE 10 /* % of stale keys after which
                                                   we do extra efforts. */
```

**æ¯æ¬¡éšæœºæŠ½æŸ¥æ•°é‡æ˜¯å¤šå°‘ï¼Ÿ**

`expire.c` ä¸­å®šä¹‰äº†æ¯æ¬¡éšæœºæŠ½æŸ¥çš„æ•°é‡ï¼ŒRedis 7.2 ç‰ˆæœ¬ä¸º 20ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡ä¼šéšæœºé€‰æ‹© 20 ä¸ªè®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key åˆ¤æ–­æ˜¯å¦è¿‡æœŸã€‚

```c
#define ACTIVE_EXPIRE_CYCLE_KEYS_PER_LOOP 20 /* Keys for each DB loop. */
```

**å¦‚ä½•æ§åˆ¶å®šæœŸåˆ é™¤çš„æ‰§è¡Œé¢‘ç‡ï¼Ÿ**

åœ¨ Redis ä¸­ï¼Œå®šæœŸåˆ é™¤çš„é¢‘ç‡æ˜¯ç”± **hz** å‚æ•°æ§åˆ¶çš„ã€‚hz é»˜è®¤ä¸º 10ï¼Œä»£è¡¨æ¯ç§’æ‰§è¡Œ 10 æ¬¡ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’é’Ÿè¿›è¡Œ 10 æ¬¡å°è¯•æ¥æŸ¥æ‰¾å¹¶åˆ é™¤è¿‡æœŸçš„ keyã€‚

hz çš„å–å€¼èŒƒå›´ä¸º 1~500ã€‚å¢å¤§ hz å‚æ•°çš„å€¼ä¼šæå‡å®šæœŸåˆ é™¤çš„é¢‘ç‡ã€‚å¦‚æœä½ æƒ³è¦æ›´é¢‘ç¹åœ°æ‰§è¡Œå®šæœŸåˆ é™¤ä»»åŠ¡ï¼Œå¯ä»¥é€‚å½“å¢åŠ  hz çš„å€¼ï¼Œä½†è¿™ä¼šå¢åŠ  CPU çš„ä½¿ç”¨ç‡ã€‚æ ¹æ® Redis å®˜æ–¹å»ºè®®ï¼Œhz çš„å€¼ä¸å»ºè®®è¶…è¿‡ 100ï¼Œå¯¹äºå¤§éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨é»˜è®¤çš„ 10 å°±è¶³å¤Ÿäº†ã€‚

ä¸‹é¢æ˜¯ hz å‚æ•°çš„å®˜æ–¹æ³¨é‡Šï¼Œæˆ‘ç¿»è¯‘äº†å…¶ä¸­çš„é‡è¦ä¿¡æ¯ï¼ˆRedis 7.2 ç‰ˆæœ¬ï¼‰ã€‚

![redis.conf å¯¹äº hz çš„æ³¨é‡Š](https://oss.javaguide.cn/github/javaguide/database/redis/redis.conf-hz.png)

ç±»ä¼¼çš„å‚æ•°è¿˜æœ‰ä¸€ä¸ª **dynamic-hz**ï¼Œè¿™ä¸ªå‚æ•°å¼€å¯ä¹‹å Redis å°±ä¼šåœ¨ hz çš„åŸºç¡€ä¸ŠåŠ¨æ€è®¡ç®—ä¸€ä¸ªå€¼ã€‚Redis æä¾›å¹¶é»˜è®¤å¯ç”¨äº†ä½¿ç”¨è‡ªé€‚åº” hz å€¼çš„èƒ½åŠ›ï¼Œ

è¿™ä¸¤ä¸ªå‚æ•°éƒ½åœ¨ Redis é…ç½®æ–‡ä»¶ `redis.conf` ä¸­ï¼š

```properties
# é»˜è®¤ä¸º 10
hz 10
# é»˜è®¤å¼€å¯
dynamic-hz yes
```

å¤šæä¸€å˜´ï¼Œé™¤äº†å®šæœŸåˆ é™¤è¿‡æœŸ key è¿™ä¸ªå®šæœŸä»»åŠ¡ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–å®šæœŸä»»åŠ¡ä¾‹å¦‚å…³é—­è¶…æ—¶çš„å®¢æˆ·ç«¯è¿æ¥ã€æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œè¿™äº›å®šæœŸä»»åŠ¡çš„æ‰§è¡Œé¢‘ç‡ä¹Ÿæ˜¯é€šè¿‡ hz å‚æ•°å†³å®šã€‚

**ä¸ºä»€ä¹ˆå®šæœŸåˆ é™¤ä¸æ˜¯æŠŠæ‰€æœ‰è¿‡æœŸ key éƒ½åˆ é™¤å‘¢ï¼Ÿ**

è¿™æ ·ä¼šå¯¹æ€§èƒ½é€ æˆå¤ªå¤§çš„å½±å“ã€‚å¦‚æœæˆ‘ä»¬ key æ•°é‡éå¸¸åºå¤§çš„è¯ï¼ŒæŒ¨ä¸ªéå†æ£€æŸ¥æ˜¯éå¸¸è€—æ—¶çš„ï¼Œä¼šä¸¥é‡å½±å“æ€§èƒ½ã€‚Redis è®¾è®¡è¿™ç§ç­–ç•¥çš„ç›®çš„æ˜¯ä¸ºäº†å¹³è¡¡å†…å­˜å’Œæ€§èƒ½ã€‚

**ä¸ºä»€ä¹ˆ key è¿‡æœŸä¹‹åä¸ç«‹é©¬æŠŠå®ƒåˆ æ‰å‘¢ï¼Ÿè¿™æ ·ä¸æ˜¯ä¼šæµªè´¹å¾ˆå¤šå†…å­˜ç©ºé—´å—ï¼Ÿ**

å› ä¸ºä¸å¤ªå¥½åŠåˆ°ï¼Œæˆ–è€…è¯´è¿™ç§åˆ é™¤æ–¹å¼çš„æˆæœ¬å¤ªé«˜äº†ã€‚å‡å¦‚æˆ‘ä»¬ä½¿ç”¨å»¶è¿Ÿé˜Ÿåˆ—ä½œä¸ºåˆ é™¤ç­–ç•¥ï¼Œè¿™æ ·å­˜åœ¨ä¸‹é¢è¿™äº›é—®é¢˜ï¼š

1. é˜Ÿåˆ—æœ¬èº«çš„å¼€é”€å¯èƒ½å¾ˆå¤§ï¼škey å¤šçš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå»¶è¿Ÿé˜Ÿåˆ—å¯èƒ½æ— æ³•å®¹çº³ã€‚
2. ç»´æŠ¤å»¶è¿Ÿé˜Ÿåˆ—å¤ªéº»çƒ¦ï¼šä¿®æ”¹ key çš„è¿‡æœŸæ—¶é—´å°±éœ€è¦è°ƒæ•´å…¶åœ¨å»¶è¿Ÿé˜Ÿåˆ—ä¸­çš„ä½ç½®ï¼Œå¹¶ä¸”è¿˜éœ€è¦å¼•å…¥å¹¶å‘æ§åˆ¶ã€‚

### å¤§é‡ key é›†ä¸­è¿‡æœŸæ€ä¹ˆåŠï¼Ÿ

å½“ Redis ä¸­å­˜åœ¨å¤§é‡ key åœ¨åŒä¸€æ—¶é—´ç‚¹é›†ä¸­è¿‡æœŸæ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š

- **è¯·æ±‚å»¶è¿Ÿå¢åŠ **ï¼šRedis åœ¨å¤„ç†è¿‡æœŸ key æ—¶éœ€è¦æ¶ˆè€— CPU èµ„æºï¼Œå¦‚æœè¿‡æœŸ key æ•°é‡åºå¤§ï¼Œä¼šå¯¼è‡´ Redis å®ä¾‹çš„ CPU å ç”¨ç‡å‡é«˜ï¼Œè¿›è€Œå½±å“å…¶ä»–è¯·æ±‚çš„å¤„ç†é€Ÿåº¦ï¼Œé€ æˆå»¶è¿Ÿå¢åŠ ã€‚
- **å†…å­˜å ç”¨è¿‡é«˜**ï¼šè¿‡æœŸçš„ key è™½ç„¶å·²ç»å¤±æ•ˆï¼Œä½†åœ¨ Redis çœŸæ­£åˆ é™¤å®ƒä»¬ä¹‹å‰ï¼Œä»ç„¶ä¼šå ç”¨å†…å­˜ç©ºé—´ã€‚å¦‚æœè¿‡æœŸ key æ²¡æœ‰åŠæ—¶æ¸…ç†ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜å ç”¨è¿‡é«˜ï¼Œç”šè‡³å¼•å‘å†…å­˜æº¢å‡ºã€‚

ä¸ºäº†é¿å…è¿™äº›é—®é¢˜ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹æ–¹æ¡ˆï¼š

1. **å°½é‡é¿å… key é›†ä¸­è¿‡æœŸ**ï¼šåœ¨è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´æ—¶å°½é‡éšæœºä¸€ç‚¹ã€‚
2. **å¼€å¯ lazy free æœºåˆ¶**ï¼šä¿®æ”¹ `redis.conf` é…ç½®æ–‡ä»¶ï¼Œå°† `lazyfree-lazy-expire` å‚æ•°è®¾ç½®ä¸º `yes`ï¼Œå³å¯å¼€å¯ lazy free æœºåˆ¶ã€‚å¼€å¯ lazy free æœºåˆ¶åï¼ŒRedis ä¼šåœ¨åå°å¼‚æ­¥åˆ é™¤è¿‡æœŸçš„ keyï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„è¿è¡Œï¼Œä»è€Œé™ä½å¯¹ Redis æ€§èƒ½çš„å½±å“ã€‚

### Redis å†…å­˜æ·˜æ±°ç­–ç•¥äº†è§£ä¹ˆï¼Ÿ

> ç›¸å…³é—®é¢˜ï¼šMySQL é‡Œæœ‰ 2000w æ•°æ®ï¼ŒRedis ä¸­åªå­˜ 20w çš„æ•°æ®ï¼Œå¦‚ä½•ä¿è¯ Redis ä¸­çš„æ•°æ®éƒ½æ˜¯çƒ­ç‚¹æ•°æ®?

Redis çš„å†…å­˜æ·˜æ±°ç­–ç•¥åªæœ‰åœ¨è¿è¡Œå†…å­˜è¾¾åˆ°äº†é…ç½®çš„æœ€å¤§å†…å­˜é˜ˆå€¼æ—¶æ‰ä¼šè§¦å‘ï¼Œè¿™ä¸ªé˜ˆå€¼æ˜¯é€šè¿‡ `redis.conf` çš„ `maxmemory` å‚æ•°æ¥å®šä¹‰çš„ã€‚64 ä½æ“ä½œç³»ç»Ÿä¸‹ï¼Œ`maxmemory` é»˜è®¤ä¸º 0ï¼Œè¡¨ç¤ºä¸é™åˆ¶å†…å­˜å¤§å°ã€‚32 ä½æ“ä½œç³»ç»Ÿä¸‹ï¼Œé»˜è®¤çš„æœ€å¤§å†…å­˜å€¼æ˜¯ 3GBã€‚

ä½ å¯ä»¥ä½¿ç”¨å‘½ä»¤ `config get maxmemory` æ¥æŸ¥çœ‹ `maxmemory` çš„å€¼ã€‚

```bash
> config get maxmemory
maxmemory
0
```

Redis æä¾›äº† 6 ç§å†…å­˜æ·˜æ±°ç­–ç•¥ï¼š

1. **volatile-lruï¼ˆleast recently usedï¼‰**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆ`server.db[i].expires`ï¼‰ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°ã€‚
2. **volatile-ttl**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆ`server.db[i].expires`ï¼‰ä¸­æŒ‘é€‰å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°ã€‚
3. **volatile-random**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆ`server.db[i].expires`ï¼‰ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°ã€‚
4. **allkeys-lruï¼ˆleast recently usedï¼‰**ï¼šä»æ•°æ®é›†ï¼ˆ`server.db[i].dict`ï¼‰ä¸­ç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°ã€‚
5. **allkeys-random**ï¼šä»æ•°æ®é›†ï¼ˆ`server.db[i].dict`ï¼‰ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°ã€‚
6. **no-eviction**ï¼ˆé»˜è®¤å†…å­˜æ·˜æ±°ç­–ç•¥ï¼‰ï¼šç¦æ­¢é©±é€æ•°æ®ï¼Œå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œæ–°å†™å…¥æ“ä½œä¼šæŠ¥é”™ã€‚

4.0 ç‰ˆæœ¬åå¢åŠ ä»¥ä¸‹ä¸¤ç§ï¼š

7. **volatile-lfuï¼ˆleast frequently usedï¼‰**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆ`server.db[i].expires`ï¼‰ä¸­æŒ‘é€‰æœ€ä¸ç»å¸¸ä½¿ç”¨çš„æ•°æ®æ·˜æ±°ã€‚
8. **allkeys-lfuï¼ˆleast frequently usedï¼‰**ï¼šä»æ•°æ®é›†ï¼ˆ`server.db[i].dict`ï¼‰ä¸­ç§»é™¤æœ€ä¸ç»å¸¸ä½¿ç”¨çš„æ•°æ®æ·˜æ±°ã€‚

`allkeys-xxx` è¡¨ç¤ºä»æ‰€æœ‰çš„é”®å€¼ä¸­æ·˜æ±°æ•°æ®ï¼Œè€Œ `volatile-xxx` è¡¨ç¤ºä»è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼ä¸­æ·˜æ±°æ•°æ®ã€‚

`config.c` ä¸­å®šä¹‰äº†å†…å­˜æ·˜æ±°ç­–ç•¥çš„æšä¸¾æ•°ç»„ï¼š

```c
configEnum maxmemory_policy_enum[] = {
    {"volatile-lru", MAXMEMORY_VOLATILE_LRU},
    {"volatile-lfu", MAXMEMORY_VOLATILE_LFU},
    {"volatile-random",MAXMEMORY_VOLATILE_RANDOM},
    {"volatile-ttl",MAXMEMORY_VOLATILE_TTL},
    {"allkeys-lru",MAXMEMORY_ALLKEYS_LRU},
    {"allkeys-lfu",MAXMEMORY_ALLKEYS_LFU},
    {"allkeys-random",MAXMEMORY_ALLKEYS_RANDOM},
    {"noeviction",MAXMEMORY_NO_EVICTION},
    {NULL, 0}
};
```

ä½ å¯ä»¥ä½¿ç”¨ `config get maxmemory-policy` å‘½ä»¤æ¥æŸ¥çœ‹å½“å‰ Redis çš„å†…å­˜æ·˜æ±°ç­–ç•¥ã€‚

```bash
> config get maxmemory-policy
maxmemory-policy
noeviction
```

å¯ä»¥é€šè¿‡ `config set maxmemory-policy å†…å­˜æ·˜æ±°ç­–ç•¥` å‘½ä»¤ä¿®æ”¹å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Œç«‹å³ç”Ÿæ•ˆï¼Œä½†è¿™ç§æ–¹å¼é‡å¯ Redis ä¹‹åå°±å¤±æ•ˆäº†ã€‚ä¿®æ”¹ `redis.conf` ä¸­çš„ `maxmemory-policy` å‚æ•°ä¸ä¼šå› ä¸ºé‡å¯è€Œå¤±æ•ˆï¼Œä¸è¿‡ï¼Œéœ€è¦é‡å¯ä¹‹åä¿®æ”¹æ‰èƒ½ç”Ÿæ•ˆã€‚

```properties
maxmemory-policy noeviction
```

å…³äºæ·˜æ±°ç­–ç•¥çš„è¯¦ç»†è¯´æ˜å¯ä»¥å‚è€ƒ Redis å®˜æ–¹æ–‡æ¡£ï¼š<https://redis.io/docs/reference/eviction/>ã€‚

## Redis äº‹åŠ¡

### ä»€ä¹ˆæ˜¯ Redis äº‹åŠ¡ï¼Ÿ

ä½ å¯ä»¥å°† Redis ä¸­çš„äº‹åŠ¡ç†è§£ä¸ºï¼š**Redis äº‹åŠ¡æä¾›äº†ä¸€ç§å°†å¤šä¸ªå‘½ä»¤è¯·æ±‚æ‰“åŒ…çš„åŠŸèƒ½ã€‚ç„¶åï¼Œå†æŒ‰é¡ºåºæ‰§è¡Œæ‰“åŒ…çš„æ‰€æœ‰å‘½ä»¤ï¼Œå¹¶ä¸”ä¸ä¼šè¢«ä¸­é€”æ‰“æ–­ã€‚**

Redis äº‹åŠ¡å®é™…å¼€å‘ä¸­ä½¿ç”¨çš„éå¸¸å°‘ï¼ŒåŠŸèƒ½æ¯”è¾ƒé¸¡è‚‹ï¼Œä¸è¦å°†å…¶å’Œæˆ‘ä»¬å¹³æ—¶ç†è§£çš„å…³ç³»å‹æ•°æ®åº“çš„äº‹åŠ¡æ··æ·†äº†ã€‚

é™¤äº†ä¸æ»¡è¶³åŸå­æ€§å’ŒæŒä¹…æ€§ä¹‹å¤–ï¼Œäº‹åŠ¡ä¸­çš„æ¯æ¡å‘½ä»¤éƒ½ä¼šä¸ Redis æœåŠ¡å™¨è¿›è¡Œç½‘ç»œäº¤äº’ï¼Œè¿™æ˜¯æ¯”è¾ƒæµªè´¹èµ„æºçš„è¡Œä¸ºã€‚æ˜æ˜ä¸€æ¬¡æ‰¹é‡æ‰§è¡Œå¤šä¸ªå‘½ä»¤å°±å¯ä»¥äº†ï¼Œè¿™ç§æ“ä½œå®åœ¨æ˜¯çœ‹ä¸æ‡‚ã€‚

å› æ­¤ï¼ŒRedis äº‹åŠ¡æ˜¯ä¸å»ºè®®åœ¨æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨çš„ã€‚

### å¦‚ä½•ä½¿ç”¨ Redis äº‹åŠ¡ï¼Ÿ

Redis å¯ä»¥é€šè¿‡ **`MULTI`ã€`EXEC`ã€`DISCARD` å’Œ `WATCH`** ç­‰å‘½ä»¤æ¥å®ç°äº‹åŠ¡ï¼ˆTransactionï¼‰åŠŸèƒ½ã€‚

```bash
> MULTI
OK
> SET PROJECT "JavaGuide"
QUEUED
> GET PROJECT
QUEUED
> EXEC
1) OK
2) "JavaGuide"
```

[`MULTI`](https://redis.io/commands/multi) å‘½ä»¤åå¯ä»¥è¾“å…¥å¤šä¸ªå‘½ä»¤ï¼ŒRedis ä¸ä¼šç«‹å³æ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œè€Œæ˜¯å°†å®ƒä»¬æ”¾åˆ°é˜Ÿåˆ—ï¼Œå½“è°ƒç”¨äº† [`EXEC`](https://redis.io/commands/exec) å‘½ä»¤åï¼Œå†æ‰§è¡Œæ‰€æœ‰çš„å‘½ä»¤ã€‚

è¿™ä¸ªè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š

1. å¼€å§‹äº‹åŠ¡ï¼ˆ`MULTI`ï¼‰ï¼›
2. å‘½ä»¤å…¥é˜Ÿï¼ˆæ‰¹é‡æ“ä½œ Redis çš„å‘½ä»¤ï¼Œå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„é¡ºåºæ‰§è¡Œï¼‰ï¼›
3. æ‰§è¡Œäº‹åŠ¡ï¼ˆ`EXEC`ï¼‰ã€‚

ä½ ä¹Ÿå¯ä»¥é€šè¿‡ [`DISCARD`](https://redis.io/commands/discard) å‘½ä»¤å–æ¶ˆä¸€ä¸ªäº‹åŠ¡ï¼Œå®ƒä¼šæ¸…ç©ºäº‹åŠ¡é˜Ÿåˆ—ä¸­ä¿å­˜çš„æ‰€æœ‰å‘½ä»¤ã€‚

```bash
> MULTI
OK
> SET PROJECT "JavaGuide"
QUEUED
> GET PROJECT
QUEUED
> DISCARD
OK
```

ä½ å¯ä»¥é€šè¿‡[`WATCH`](https://redis.io/commands/watch) å‘½ä»¤ç›‘å¬æŒ‡å®šçš„ Keyï¼Œå½“è°ƒç”¨ `EXEC` å‘½ä»¤æ‰§è¡Œäº‹åŠ¡æ—¶ï¼Œå¦‚æœä¸€ä¸ªè¢« `WATCH` å‘½ä»¤ç›‘è§†çš„ Key è¢« **å…¶ä»–å®¢æˆ·ç«¯/Session** ä¿®æ”¹çš„è¯ï¼Œæ•´ä¸ªäº‹åŠ¡éƒ½ä¸ä¼šè¢«æ‰§è¡Œã€‚

```bash
# å®¢æˆ·ç«¯ 1
> SET PROJECT "RustGuide"
OK
> WATCH PROJECT
OK
> MULTI
OK
> SET PROJECT "JavaGuide"
QUEUED

# å®¢æˆ·ç«¯ 2
# åœ¨å®¢æˆ·ç«¯ 1 æ‰§è¡Œ EXEC å‘½ä»¤æäº¤äº‹åŠ¡ä¹‹å‰ä¿®æ”¹ PROJECT çš„å€¼
> SET PROJECT "GoGuide"

# å®¢æˆ·ç«¯ 1
# ä¿®æ”¹å¤±è´¥ï¼Œå› ä¸º PROJECT çš„å€¼è¢«å®¢æˆ·ç«¯2ä¿®æ”¹äº†
> EXEC
(nil)
> GET PROJECT
"GoGuide"
```

ä¸è¿‡ï¼Œå¦‚æœ **WATCH** ä¸ **äº‹åŠ¡** åœ¨åŒä¸€ä¸ª Session é‡Œï¼Œå¹¶ä¸”è¢« **WATCH** ç›‘è§†çš„ Key è¢«ä¿®æ”¹çš„æ“ä½œå‘ç”Ÿåœ¨äº‹åŠ¡å†…éƒ¨ï¼Œè¿™ä¸ªäº‹åŠ¡æ˜¯å¯ä»¥è¢«æ‰§è¡ŒæˆåŠŸçš„ï¼ˆç›¸å…³ issueï¼š[WATCH å‘½ä»¤ç¢°åˆ° MULTI å‘½ä»¤æ—¶çš„ä¸åŒæ•ˆæœ](https://github.com/Snailclimb/JavaGuide/issues/1714)ï¼‰ã€‚

äº‹åŠ¡å†…éƒ¨ä¿®æ”¹ WATCH ç›‘è§†çš„ Keyï¼š

```bash
> SET PROJECT "JavaGuide"
OK
> WATCH PROJECT
OK
> MULTI
OK
> SET PROJECT "JavaGuide1"
QUEUED
> SET PROJECT "JavaGuide2"
QUEUED
> SET PROJECT "JavaGuide3"
QUEUED
> EXEC
1) OK
2) OK
3) OK
127.0.0.1:6379> GET PROJECT
"JavaGuide3"
```

äº‹åŠ¡å¤–éƒ¨ä¿®æ”¹ WATCH ç›‘è§†çš„ Keyï¼š

```bash
> SET PROJECT "JavaGuide"
OK
> WATCH PROJECT
OK
> SET PROJECT "JavaGuide2"
OK
> MULTI
OK
> GET USER
QUEUED
> EXEC
(nil)
```

Redis å®˜ç½‘ç›¸å…³ä»‹ç» [https://redis.io/topics/transactions](https://redis.io/topics/transactions) å¦‚ä¸‹ï¼š

![Redis äº‹åŠ¡](https://oss.javaguide.cn/github/javaguide/database/redis/redis-transactions.png)

### Redis äº‹åŠ¡æ”¯æŒåŸå­æ€§å—ï¼Ÿ

Redis çš„äº‹åŠ¡å’Œæˆ‘ä»¬å¹³æ—¶ç†è§£çš„å…³ç³»å‹æ•°æ®åº“çš„äº‹åŠ¡ä¸åŒã€‚æˆ‘ä»¬çŸ¥é“äº‹åŠ¡å…·æœ‰å››å¤§ç‰¹æ€§ï¼š**1. åŸå­æ€§**ï¼Œ**2. éš”ç¦»æ€§**ï¼Œ**3. æŒä¹…æ€§**ï¼Œ**4. ä¸€è‡´æ€§**ã€‚

1. **åŸå­æ€§ï¼ˆAtomicityï¼‰**ï¼šäº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸å…è®¸åˆ†å‰²ã€‚äº‹åŠ¡çš„åŸå­æ€§ç¡®ä¿åŠ¨ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå®Œå…¨ä¸èµ·ä½œç”¨ï¼›
2. **éš”ç¦»æ€§ï¼ˆIsolationï¼‰**ï¼šå¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªç”¨æˆ·çš„äº‹åŠ¡ä¸è¢«å…¶ä»–äº‹åŠ¡æ‰€å¹²æ‰°ï¼Œå„å¹¶å‘äº‹åŠ¡ä¹‹é—´æ•°æ®åº“æ˜¯ç‹¬ç«‹çš„ï¼›
3. **æŒä¹…æ€§ï¼ˆDurabilityï¼‰**ï¼šä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åã€‚å®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ï¼›
4. **ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰**ï¼šæ‰§è¡Œäº‹åŠ¡å‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´ï¼Œå¤šä¸ªäº‹åŠ¡å¯¹åŒä¸€ä¸ªæ•°æ®è¯»å–çš„ç»“æœæ˜¯ç›¸åŒçš„ã€‚

Redis äº‹åŠ¡åœ¨è¿è¡Œé”™è¯¯çš„æƒ…å†µä¸‹ï¼Œé™¤äº†æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯çš„å‘½ä»¤å¤–ï¼Œå…¶ä»–å‘½ä»¤éƒ½èƒ½æ­£å¸¸æ‰§è¡Œã€‚å¹¶ä¸”ï¼ŒRedis äº‹åŠ¡æ˜¯ä¸æ”¯æŒå›æ»šï¼ˆroll backï¼‰æ“ä½œçš„ã€‚å› æ­¤ï¼ŒRedis äº‹åŠ¡å…¶å®æ˜¯ä¸æ»¡è¶³åŸå­æ€§çš„ã€‚

Redis å®˜ç½‘ä¹Ÿè§£é‡Šäº†è‡ªå·±ä¸ºå•¥ä¸æ”¯æŒå›æ»šã€‚ç®€å•æ¥è¯´å°±æ˜¯ Redis å¼€å‘è€…ä»¬è§‰å¾—æ²¡å¿…è¦æ”¯æŒå›æ»šï¼Œè¿™æ ·æ›´ç®€å•ä¾¿æ·å¹¶ä¸”æ€§èƒ½æ›´å¥½ã€‚Redis å¼€å‘è€…è§‰å¾—å³ä½¿å‘½ä»¤æ‰§è¡Œé”™è¯¯ä¹Ÿåº”è¯¥åœ¨å¼€å‘è¿‡ç¨‹ä¸­å°±è¢«å‘ç°è€Œä¸æ˜¯ç”Ÿäº§è¿‡ç¨‹ä¸­ã€‚

![Redis ä¸ºä»€ä¹ˆä¸æ”¯æŒå›æ»š](https://oss.javaguide.cn/github/javaguide/database/redis/redis-rollback.png)

**ç›¸å…³ issue**ï¼š

- [issue#452: å…³äº Redis äº‹åŠ¡ä¸æ»¡è¶³åŸå­æ€§çš„é—®é¢˜](https://github.com/Snailclimb/JavaGuide/issues/452)ã€‚
- [Issue#491:å…³äº Redis æ²¡æœ‰äº‹åŠ¡å›æ»šï¼Ÿ](https://github.com/Snailclimb/JavaGuide/issues/491)ã€‚

### Redis äº‹åŠ¡æ”¯æŒæŒä¹…æ€§å—ï¼Ÿ

Redis ä¸åŒäº Memcached çš„å¾ˆé‡è¦ä¸€ç‚¹å°±æ˜¯ï¼ŒRedis æ”¯æŒæŒä¹…åŒ–ï¼Œè€Œä¸”æ”¯æŒ 3 ç§æŒä¹…åŒ–æ–¹å¼ï¼š

- å¿«ç…§ï¼ˆsnapshottingï¼ŒRDBï¼‰ï¼›
- åªè¿½åŠ æ–‡ä»¶ï¼ˆappend-only fileï¼ŒAOFï¼‰ï¼›
- RDB å’Œ AOF çš„æ··åˆæŒä¹…åŒ–ï¼ˆRedis 4.0 æ–°å¢ï¼‰ã€‚

ä¸ RDB æŒä¹…åŒ–ç›¸æ¯”ï¼ŒAOF æŒä¹…åŒ–çš„å®æ—¶æ€§æ›´å¥½ã€‚åœ¨ Redis çš„é…ç½®æ–‡ä»¶ä¸­å­˜åœ¨ä¸‰ç§ä¸åŒçš„ AOF æŒä¹…åŒ–æ–¹å¼ï¼ˆ`fsync` ç­–ç•¥ï¼‰ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š

```bash
appendfsync always    #æ¯æ¬¡æœ‰æ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶ï¼Œéƒ½ä¼šè°ƒç”¨fsyncå‡½æ•°åŒæ­¥AOFæ–‡ä»¶ï¼Œfsyncå®Œæˆåçº¿ç¨‹è¿”å›ï¼Œè¿™æ ·ä¼šä¸¥é‡é™ä½Redisçš„é€Ÿåº¦
appendfsync everysec  #æ¯ç§’é’Ÿè°ƒç”¨fsyncå‡½æ•°åŒæ­¥ä¸€æ¬¡AOFæ–‡ä»¶
appendfsync no        #è®©æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶è¿›è¡ŒåŒæ­¥ï¼Œä¸€èˆ¬ä¸º30ç§’ä¸€æ¬¡
```

AOF æŒä¹…åŒ–çš„ `fsync` ç­–ç•¥ä¸º noã€everysec æ—¶éƒ½ä¼šå­˜åœ¨æ•°æ®ä¸¢å¤±çš„æƒ…å†µã€‚always ä¸‹å¯ä»¥åŸºæœ¬æ˜¯å¯ä»¥æ»¡è¶³æŒä¹…æ€§è¦æ±‚çš„ï¼Œä½†æ€§èƒ½å¤ªå·®ï¼Œå®é™…å¼€å‘è¿‡ç¨‹ä¸­ä¸ä¼šä½¿ç”¨ã€‚

å› æ­¤ï¼ŒRedis äº‹åŠ¡çš„æŒä¹…æ€§ä¹Ÿæ˜¯æ²¡åŠæ³•ä¿è¯çš„ã€‚

### å¦‚ä½•è§£å†³ Redis äº‹åŠ¡çš„ç¼ºé™·ï¼Ÿ

Redis ä» 2.6 ç‰ˆæœ¬å¼€å§‹æ”¯æŒæ‰§è¡Œ Lua è„šæœ¬ï¼Œå®ƒçš„åŠŸèƒ½å’Œäº‹åŠ¡éå¸¸ç±»ä¼¼ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Lua è„šæœ¬æ¥æ‰¹é‡æ‰§è¡Œå¤šæ¡ Redis å‘½ä»¤ï¼Œè¿™äº› Redis å‘½ä»¤ä¼šè¢«æäº¤åˆ° Redis æœåŠ¡å™¨ä¸€æ¬¡æ€§æ‰§è¡Œå®Œæˆï¼Œå¤§å¹…å‡å°äº†ç½‘ç»œå¼€é”€ã€‚

ä¸€æ®µ Lua è„šæœ¬å¯ä»¥è§†ä½œä¸€æ¡å‘½ä»¤æ‰§è¡Œï¼Œä¸€æ®µ Lua è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šæœ‰å…¶ä»–è„šæœ¬æˆ– Redis å‘½ä»¤åŒæ—¶æ‰§è¡Œï¼Œä¿è¯äº†æ“ä½œä¸ä¼šè¢«å…¶ä»–æŒ‡ä»¤æ’å…¥æˆ–æ‰“æ‰°ã€‚

ä¸è¿‡ï¼Œå¦‚æœ Lua è„šæœ¬è¿è¡Œæ—¶å‡ºé”™å¹¶ä¸­é€”ç»“æŸï¼Œå‡ºé”™ä¹‹åçš„å‘½ä»¤æ˜¯ä¸ä¼šè¢«æ‰§è¡Œçš„ã€‚å¹¶ä¸”ï¼Œå‡ºé”™ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤æ˜¯æ— æ³•è¢«æ’¤é”€çš„ï¼Œæ— æ³•å®ç°ç±»ä¼¼å…³ç³»å‹æ•°æ®åº“æ‰§è¡Œå¤±è´¥å¯ä»¥å›æ»šçš„é‚£ç§åŸå­æ€§æ•ˆæœã€‚å› æ­¤ï¼Œ**ä¸¥æ ¼æ¥è¯´çš„è¯ï¼Œé€šè¿‡ Lua è„šæœ¬æ¥æ‰¹é‡æ‰§è¡Œ Redis å‘½ä»¤å®é™…ä¹Ÿæ˜¯ä¸å®Œå…¨æ»¡è¶³åŸå­æ€§çš„ã€‚**

å¦‚æœæƒ³è¦è®© Lua è„šæœ¬ä¸­çš„å‘½ä»¤å…¨éƒ¨æ‰§è¡Œï¼Œå¿…é¡»ä¿è¯è¯­å¥è¯­æ³•å’Œå‘½ä»¤éƒ½æ˜¯å¯¹çš„ã€‚

å¦å¤–ï¼ŒRedis 7.0 æ–°å¢äº† [Redis functions](https://redis.io/docs/latest/develop/programmability/functions-intro/) ç‰¹æ€§ï¼Œä½ å¯ä»¥å°† Redis functions çœ‹ä½œæ˜¯æ¯” Lua æ›´å¼ºå¤§çš„è„šæœ¬ã€‚

## â­ï¸Redis æ€§èƒ½ä¼˜åŒ–ï¼ˆé‡è¦ï¼‰

é™¤äº†ä¸‹é¢ä»‹ç»çš„å†…å®¹ä¹‹å¤–ï¼Œå†æ¨èä¸¤ç¯‡ä¸é”™çš„æ–‡ç« ï¼š

- [ä½ çš„ Redis çœŸçš„å˜æ…¢äº†å—ï¼Ÿæ€§èƒ½ä¼˜åŒ–å¦‚ä½•åš - é˜¿é‡Œå¼€å‘è€…](https://mp.weixin.qq.com/s/nNEuYw0NlYGhuKKKKoWfcQ)ã€‚
- [Redis å¸¸è§é˜»å¡åŸå› æ€»ç»“ - JavaGuide](https://javaguide.cn/database/redis/redis-common-blocking-problems-summary.html)ã€‚

### ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œä¼ è¾“

ä¸€ä¸ª Redis å‘½ä»¤çš„æ‰§è¡Œå¯ä»¥ç®€åŒ–ä¸ºä»¥ä¸‹ 4 æ­¥ï¼š

1. å‘é€å‘½ä»¤ï¼›
2. å‘½ä»¤æ’é˜Ÿï¼›
3. å‘½ä»¤æ‰§è¡Œï¼›
4. è¿”å›ç»“æœã€‚

å…¶ä¸­ï¼Œç¬¬ 1 æ­¥å’Œç¬¬ 4 æ­¥è€—è´¹æ—¶é—´ä¹‹å’Œç§°ä¸º **Round Trip Timeï¼ˆRTTï¼Œå¾€è¿”æ—¶é—´ï¼‰**ï¼Œä¹Ÿå°±æ˜¯æ•°æ®åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„æ—¶é—´ã€‚

ä½¿ç”¨æ‰¹é‡æ“ä½œå¯ä»¥å‡å°‘ç½‘ç»œä¼ è¾“æ¬¡æ•°ï¼Œè¿›è€Œæœ‰æ•ˆå‡å°ç½‘ç»œå¼€é”€ï¼Œå¤§å¹…å‡å°‘ RTTã€‚

å¦å¤–ï¼Œé™¤äº†èƒ½å‡å°‘ RTT ä¹‹å¤–ï¼Œå‘é€ä¸€æ¬¡å‘½ä»¤çš„ socket I/O æˆæœ¬ä¹Ÿæ¯”è¾ƒé«˜ï¼ˆæ¶‰åŠä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå­˜åœ¨ `read()` å’Œ `write()` ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œæ‰¹é‡æ“ä½œè¿˜å¯ä»¥å‡å°‘ socket I/O æˆæœ¬ã€‚è¿™ä¸ªåœ¨å®˜æ–¹å¯¹ pipeline çš„ä»‹ç»ä¸­æœ‰æåˆ°ï¼š<https://redis.io/docs/manual/pipelining/>ã€‚

#### åŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤

Redis ä¸­æœ‰ä¸€äº›åŸç”Ÿæ”¯æŒæ‰¹é‡æ“ä½œçš„å‘½ä»¤ï¼Œæ¯”å¦‚ï¼š

- `MGET`ï¼ˆè·å–ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å®š key çš„å€¼ï¼‰ã€`MSET`ï¼ˆè®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å®š key çš„å€¼ï¼‰ã€
- `HMGET`ï¼ˆè·å–æŒ‡å®šå“ˆå¸Œè¡¨ä¸­ä¸€ä¸ªæˆ–è€…å¤šä¸ªæŒ‡å®šå­—æ®µçš„å€¼ï¼‰ã€`HMSET`ï¼ˆåŒæ—¶å°†ä¸€ä¸ªæˆ–å¤šä¸ª field-value å¯¹è®¾ç½®åˆ°æŒ‡å®šå“ˆå¸Œè¡¨ä¸­ï¼‰ã€
- `SADD`ï¼ˆå‘æŒ‡å®šé›†åˆæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼‰
- â€¦â€¦

ä¸è¿‡ï¼Œåœ¨ Redis å®˜æ–¹æä¾›çš„åˆ†ç‰‡é›†ç¾¤è§£å†³æ–¹æ¡ˆ Redis Cluster ä¸‹ï¼Œä½¿ç”¨è¿™äº›åŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤å¯èƒ½ä¼šå­˜åœ¨ä¸€äº›å°é—®é¢˜éœ€è¦è§£å†³ã€‚å°±æ¯”å¦‚è¯´ `MGET` æ— æ³•ä¿è¯æ‰€æœ‰çš„ key éƒ½åœ¨åŒä¸€ä¸ª **hash slotï¼ˆå“ˆå¸Œæ§½ï¼‰** ä¸Šï¼Œ`MGET`å¯èƒ½è¿˜æ˜¯éœ€è¦å¤šæ¬¡ç½‘ç»œä¼ è¾“ï¼ŒåŸå­æ“ä½œä¹Ÿæ— æ³•ä¿è¯äº†ã€‚ä¸è¿‡ï¼Œç›¸è¾ƒäºéæ‰¹é‡æ“ä½œï¼Œè¿˜æ˜¯å¯ä»¥èŠ‚çœä¸å°‘ç½‘ç»œä¼ è¾“æ¬¡æ•°ã€‚

æ•´ä¸ªæ­¥éª¤çš„ç®€åŒ–ç‰ˆå¦‚ä¸‹ï¼ˆé€šå¸¸ç”± Redis å®¢æˆ·ç«¯å®ç°ï¼Œæ— éœ€æˆ‘ä»¬è‡ªå·±å†æ‰‹åŠ¨å®ç°ï¼‰ï¼š

1. æ‰¾åˆ° key å¯¹åº”çš„æ‰€æœ‰ hash slotï¼›
2. åˆ†åˆ«å‘å¯¹åº”çš„ Redis èŠ‚ç‚¹å‘èµ· `MGET` è¯·æ±‚è·å–æ•°æ®ï¼›
3. ç­‰å¾…æ‰€æœ‰è¯·æ±‚æ‰§è¡Œç»“æŸï¼Œé‡æ–°ç»„è£…ç»“æœæ•°æ®ï¼Œä¿æŒè·Ÿå…¥å‚ key çš„é¡ºåºä¸€è‡´ï¼Œç„¶åè¿”å›ç»“æœã€‚

å¦‚æœæƒ³è¦è§£å†³è¿™ä¸ªå¤šæ¬¡ç½‘ç»œä¼ è¾“çš„é—®é¢˜ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„åŠæ³•æ˜¯è‡ªå·±ç»´æŠ¤ key ä¸ slot çš„å…³ç³»ã€‚ä¸è¿‡è¿™æ ·ä¸å¤ªçµæ´»ï¼Œè™½ç„¶å¸¦æ¥äº†æ€§èƒ½æå‡ï¼Œä½†åŒæ ·è®©ç³»ç»Ÿå¤æ‚æ€§æå‡ã€‚

> Redis Cluster å¹¶æ²¡æœ‰ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œï¼Œé‡‡ç”¨çš„æ˜¯ **å“ˆå¸Œæ§½åˆ†åŒº**ï¼Œæ¯ä¸€ä¸ªé”®å€¼å¯¹éƒ½å±äºä¸€ä¸ª **hash slotï¼ˆå“ˆå¸Œæ§½ï¼‰**ã€‚å½“å®¢æˆ·ç«¯å‘é€å‘½ä»¤è¯·æ±‚çš„æ—¶å€™ï¼Œéœ€è¦å…ˆæ ¹æ® key é€šè¿‡ä¸Šé¢çš„è®¡ç®—å…¬å¼æ‰¾åˆ°çš„å¯¹åº”çš„å“ˆå¸Œæ§½ï¼Œç„¶åå†æŸ¥è¯¢å“ˆå¸Œæ§½å’ŒèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ï¼Œå³å¯æ‰¾åˆ°ç›®æ ‡ Redis èŠ‚ç‚¹ã€‚
>
> æˆ‘åœ¨ [Redis é›†ç¾¤è¯¦è§£ï¼ˆä»˜è´¹ï¼‰](https://javaguide.cn/database/redis/redis-cluster.html) è¿™ç¯‡æ–‡ç« ä¸­è¯¦ç»†ä»‹ç»äº† Redis Cluster è¿™éƒ¨åˆ†çš„å†…å®¹ï¼Œæ„Ÿå…´è¶£åœ°å¯ä»¥çœ‹çœ‹ã€‚

#### pipeline

å¯¹äºä¸æ”¯æŒæ‰¹é‡æ“ä½œçš„å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ **pipelineï¼ˆæµæ°´çº¿ï¼‰** å°†ä¸€æ‰¹ Redis å‘½ä»¤å°è£…æˆä¸€ç»„ï¼Œè¿™äº› Redis å‘½ä»¤ä¼šè¢«ä¸€æ¬¡æ€§æäº¤åˆ° Redis æœåŠ¡å™¨ï¼Œåªéœ€è¦ä¸€æ¬¡ç½‘ç»œä¼ è¾“ã€‚ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„æ§åˆ¶ä¸€æ¬¡æ‰¹é‡æ“ä½œçš„ **å…ƒç´ ä¸ªæ•°**ï¼ˆä¾‹å¦‚ 500 ä»¥å†…ï¼Œå®é™…ä¹Ÿå’Œå…ƒç´ å­—èŠ‚æ•°æœ‰å…³ï¼‰ï¼Œé¿å…ç½‘ç»œä¼ è¾“çš„æ•°æ®é‡è¿‡å¤§ã€‚

ä¸ `MGET`ã€`MSET` ç­‰åŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤ä¸€æ ·ï¼Œpipeline åŒæ ·åœ¨ Redis Cluster ä¸Šä½¿ç”¨ä¼šå­˜åœ¨ä¸€äº›å°é—®é¢˜ã€‚åŸå› ç±»ä¼¼ï¼Œæ— æ³•ä¿è¯æ‰€æœ‰çš„ key éƒ½åœ¨åŒä¸€ä¸ª **hash slotï¼ˆå“ˆå¸Œæ§½ï¼‰** ä¸Šã€‚å¦‚æœæƒ³è¦ä½¿ç”¨çš„è¯ï¼Œå®¢æˆ·ç«¯éœ€è¦è‡ªå·±ç»´æŠ¤ key ä¸ slot çš„å…³ç³»ã€‚

åŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤å’Œ pipeline çš„æ˜¯æœ‰åŒºåˆ«çš„ï¼Œä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„ï¼š

- åŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤æ˜¯åŸå­æ“ä½œï¼Œpipeline æ˜¯éåŸå­æ“ä½œã€‚
- pipeline å¯ä»¥æ‰“åŒ…ä¸åŒçš„å‘½ä»¤ï¼ŒåŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤ä¸å¯ä»¥ã€‚
- åŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤æ˜¯ Redis æœåŠ¡ç«¯æ”¯æŒå®ç°çš„ï¼Œè€Œ pipeline éœ€è¦æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å…±åŒå®ç°ã€‚

é¡ºå¸¦è¡¥å……ä¸€ä¸‹ pipeline å’Œ Redis äº‹åŠ¡çš„å¯¹æ¯”ï¼š

- äº‹åŠ¡æ˜¯åŸå­æ“ä½œï¼Œpipeline æ˜¯éåŸå­æ“ä½œã€‚ä¸¤ä¸ªä¸åŒçš„äº‹åŠ¡ä¸ä¼šåŒæ—¶è¿è¡Œï¼Œè€Œ pipeline å¯ä»¥åŒæ—¶ä»¥äº¤é”™æ–¹å¼æ‰§è¡Œã€‚
- Redis äº‹åŠ¡ä¸­æ¯ä¸ªå‘½ä»¤éƒ½éœ€è¦å‘é€åˆ°æœåŠ¡ç«¯ï¼Œè€Œ Pipeline åªéœ€è¦å‘é€ä¸€æ¬¡ï¼Œè¯·æ±‚æ¬¡æ•°æ›´å°‘ã€‚

> äº‹åŠ¡å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œä½†å…¶å®å¹¶ä¸æ»¡è¶³åŸå­æ€§ã€‚å½“æˆ‘ä»¬æåˆ° Redis ä¸­çš„åŸå­æ“ä½œæ—¶ï¼Œä¸»è¦æŒ‡çš„æ˜¯è¿™ä¸ªæ“ä½œï¼ˆæ¯”å¦‚äº‹åŠ¡ã€Lua è„šæœ¬ï¼‰ä¸ä¼šè¢«å…¶ä»–æ“ä½œï¼ˆæ¯”å¦‚å…¶ä»–äº‹åŠ¡ã€Lua è„šæœ¬ï¼‰æ‰“æ‰°ï¼Œå¹¶ä¸èƒ½å®Œå…¨ä¿è¯è¿™ä¸ªæ“ä½œä¸­çš„æ‰€æœ‰å†™å‘½ä»¤è¦ä¹ˆéƒ½æ‰§è¡Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚è¿™ä¸»è¦ä¹Ÿæ˜¯å› ä¸º Redis æ˜¯ä¸æ”¯æŒå›æ»šæ“ä½œã€‚

![](https://oss.javaguide.cn/github/javaguide/database/redis/redis-pipeline-vs-transaction.png)

å¦å¤–ï¼Œpipeline ä¸é€‚ç”¨äºæ‰§è¡Œé¡ºåºæœ‰ä¾èµ–å…³ç³»çš„ä¸€æ‰¹å‘½ä»¤ã€‚å°±æ¯”å¦‚è¯´ï¼Œä½ éœ€è¦å°†å‰ä¸€ä¸ªå‘½ä»¤çš„ç»“æœç»™åç»­çš„å‘½ä»¤ä½¿ç”¨ï¼Œpipeline å°±æ²¡åŠæ³•æ»¡è¶³ä½ çš„éœ€æ±‚äº†ã€‚å¯¹äºè¿™ç§éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ **Lua è„šæœ¬**ã€‚

#### Lua è„šæœ¬

Lua è„šæœ¬åŒæ ·æ”¯æŒæ‰¹é‡æ“ä½œå¤šæ¡å‘½ä»¤ã€‚ä¸€æ®µ Lua è„šæœ¬å¯ä»¥è§†ä½œä¸€æ¡å‘½ä»¤æ‰§è¡Œï¼Œå¯ä»¥çœ‹ä½œæ˜¯ **åŸå­æ“ä½œ**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ®µ Lua è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šæœ‰å…¶ä»–è„šæœ¬æˆ– Redis å‘½ä»¤åŒæ—¶æ‰§è¡Œï¼Œä¿è¯äº†æ“ä½œä¸ä¼šè¢«å…¶ä»–æŒ‡ä»¤æ’å…¥æˆ–æ‰“æ‰°ï¼Œè¿™æ˜¯ pipeline æ‰€ä¸å…·å¤‡çš„ã€‚

å¹¶ä¸”ï¼ŒLua è„šæœ¬ä¸­æ”¯æŒä¸€äº›ç®€å•çš„é€»è¾‘å¤„ç†æ¯”å¦‚ä½¿ç”¨å‘½ä»¤è¯»å–å€¼å¹¶åœ¨ Lua è„šæœ¬ä¸­è¿›è¡Œå¤„ç†ï¼Œè¿™åŒæ ·æ˜¯ pipeline æ‰€ä¸å…·å¤‡çš„ã€‚

ä¸è¿‡ï¼Œ Lua è„šæœ¬ä¾ç„¶å­˜åœ¨ä¸‹é¢è¿™äº›ç¼ºé™·ï¼š

- å¦‚æœ Lua è„šæœ¬è¿è¡Œæ—¶å‡ºé”™å¹¶ä¸­é€”ç»“æŸï¼Œä¹‹åçš„æ“ä½œä¸ä¼šè¿›è¡Œï¼Œä½†æ˜¯ä¹‹å‰å·²ç»å‘ç”Ÿçš„å†™æ“ä½œä¸ä¼šæ’¤é”€ï¼Œæ‰€ä»¥å³ä½¿ä½¿ç”¨äº† Lua è„šæœ¬ï¼Œä¹Ÿä¸èƒ½å®ç°ç±»ä¼¼æ•°æ®åº“å›æ»šçš„åŸå­æ€§ã€‚
- Redis Cluster ä¸‹ Lua è„šæœ¬çš„åŸå­æ“ä½œä¹Ÿæ— æ³•ä¿è¯äº†ï¼ŒåŸå› åŒæ ·æ˜¯æ— æ³•ä¿è¯æ‰€æœ‰çš„ key éƒ½åœ¨åŒä¸€ä¸ª **hash slotï¼ˆå“ˆå¸Œæ§½ï¼‰** ä¸Šã€‚

### å¤§é‡ key é›†ä¸­è¿‡æœŸé—®é¢˜

æˆ‘åœ¨å‰é¢æåˆ°è¿‡ï¼šå¯¹äºè¿‡æœŸ keyï¼ŒRedis é‡‡ç”¨çš„æ˜¯ **å®šæœŸåˆ é™¤+æƒ°æ€§/æ‡’æ±‰å¼åˆ é™¤** ç­–ç•¥ã€‚

å®šæœŸåˆ é™¤æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœçªç„¶é‡åˆ°å¤§é‡è¿‡æœŸ key çš„è¯ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å¿…é¡»ç­‰å¾…å®šæœŸæ¸…ç†è¿‡æœŸ key ä»»åŠ¡çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œå› ä¸ºè¿™ä¸ªè¿™ä¸ªå®šæœŸä»»åŠ¡çº¿ç¨‹æ˜¯åœ¨ Redis ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ã€‚è¿™å°±å¯¼è‡´å®¢æˆ·ç«¯è¯·æ±‚æ²¡åŠæ³•è¢«åŠæ—¶å¤„ç†ï¼Œå“åº”é€Ÿåº¦ä¼šæ¯”è¾ƒæ…¢ã€‚

**å¦‚ä½•è§£å†³å‘¢ï¼Ÿ** ä¸‹é¢æ˜¯ä¸¤ç§å¸¸è§çš„æ–¹æ³•ï¼š

1. ç»™ key è®¾ç½®éšæœºè¿‡æœŸæ—¶é—´ã€‚
2. å¼€å¯ lazy-freeï¼ˆæƒ°æ€§åˆ é™¤/å»¶è¿Ÿé‡Šæ”¾ï¼‰ã€‚lazy-free ç‰¹æ€§æ˜¯ Redis 4.0 å¼€å§‹å¼•å…¥çš„ï¼ŒæŒ‡çš„æ˜¯è®© Redis é‡‡ç”¨å¼‚æ­¥æ–¹å¼å»¶è¿Ÿé‡Šæ”¾ key ä½¿ç”¨çš„å†…å­˜ï¼Œå°†è¯¥æ“ä½œäº¤ç»™å•ç‹¬çš„å­çº¿ç¨‹å¤„ç†ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

ä¸ªäººå»ºè®®ä¸ç®¡æ˜¯å¦å¼€å¯ lazy-freeï¼Œæˆ‘ä»¬éƒ½å°½é‡ç»™ key è®¾ç½®éšæœºè¿‡æœŸæ—¶é—´ã€‚

### Redis bigkeyï¼ˆå¤§ Keyï¼‰

#### ä»€ä¹ˆæ˜¯ bigkeyï¼Ÿ

ç®€å•æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ª key å¯¹åº”çš„ value æ‰€å ç”¨çš„å†…å­˜æ¯”è¾ƒå¤§ï¼Œé‚£è¿™ä¸ª key å°±å¯ä»¥çœ‹ä½œæ˜¯ bigkeyã€‚å…·ä½“å¤šå¤§æ‰ç®—å¤§å‘¢ï¼Ÿæœ‰ä¸€ä¸ªä¸æ˜¯ç‰¹åˆ«ç²¾ç¡®çš„å‚è€ƒæ ‡å‡†ï¼š

- String ç±»å‹çš„ value è¶…è¿‡ 1MB
- å¤åˆç±»å‹ï¼ˆListã€Hashã€Setã€Sorted Set ç­‰ï¼‰çš„ value åŒ…å«çš„å…ƒç´ è¶…è¿‡ 5000 ä¸ªï¼ˆä¸è¿‡ï¼Œå¯¹äºå¤åˆç±»å‹çš„ value æ¥è¯´ï¼Œä¸ä¸€å®šåŒ…å«çš„å…ƒç´ è¶Šå¤šï¼Œå ç”¨çš„å†…å­˜å°±è¶Šå¤šï¼‰ã€‚

![bigkey åˆ¤å®šæ ‡å‡†](https://oss.javaguide.cn/github/javaguide/database/redis/bigkey-criterion.png)

#### bigkey æ˜¯æ€ä¹ˆäº§ç”Ÿçš„ï¼Ÿæœ‰ä»€ä¹ˆå±å®³ï¼Ÿ

bigkey é€šå¸¸æ˜¯ç”±äºä¸‹é¢è¿™äº›åŸå› äº§ç”Ÿçš„ï¼š

- ç¨‹åºè®¾è®¡ä¸å½“ï¼Œæ¯”å¦‚ç›´æ¥ä½¿ç”¨ String ç±»å‹å­˜å‚¨è¾ƒå¤§çš„æ–‡ä»¶å¯¹åº”çš„äºŒè¿›åˆ¶æ•°æ®ã€‚
- å¯¹äºä¸šåŠ¡çš„æ•°æ®è§„æ¨¡è€ƒè™‘ä¸å‘¨åˆ°ï¼Œæ¯”å¦‚ä½¿ç”¨é›†åˆç±»å‹çš„æ—¶å€™æ²¡æœ‰è€ƒè™‘åˆ°æ•°æ®é‡çš„å¿«é€Ÿå¢é•¿ã€‚
- æœªåŠæ—¶æ¸…ç†åƒåœ¾æ•°æ®ï¼Œæ¯”å¦‚å“ˆå¸Œä¸­å†—ä½™äº†å¤§é‡çš„æ— ç”¨é”®å€¼å¯¹ã€‚

bigkey é™¤äº†ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ç©ºé—´å’Œå¸¦å®½ï¼Œè¿˜ä¼šå¯¹æ€§èƒ½é€ æˆæ¯”è¾ƒå¤§çš„å½±å“ã€‚

åœ¨ [Redis å¸¸è§é˜»å¡åŸå› æ€»ç»“](https://javaguide.cn/database/redis/redis-common-blocking-problems-summary.html) è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æåˆ°ï¼šå¤§ key è¿˜ä¼šé€ æˆé˜»å¡é—®é¢˜ã€‚å…·ä½“æ¥è¯´ï¼Œä¸»è¦ä½“ç°åœ¨ä¸‹é¢ä¸‰ä¸ªæ–¹é¢ï¼š

1. å®¢æˆ·ç«¯è¶…æ—¶é˜»å¡ï¼šç”±äº Redis æ‰§è¡Œå‘½ä»¤æ˜¯å•çº¿ç¨‹å¤„ç†ï¼Œç„¶ååœ¨æ“ä½œå¤§ key æ—¶ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡ Redisï¼Œä»å®¢æˆ·ç«¯è¿™ä¸€è§†è§’çœ‹ï¼Œå°±æ˜¯å¾ˆä¹…å¾ˆä¹…éƒ½æ²¡æœ‰å“åº”ã€‚
2. ç½‘ç»œé˜»å¡ï¼šæ¯æ¬¡è·å–å¤§ key äº§ç”Ÿçš„ç½‘ç»œæµé‡è¾ƒå¤§ï¼Œå¦‚æœä¸€ä¸ª key çš„å¤§å°æ˜¯ 1 MBï¼Œæ¯ç§’è®¿é—®é‡ä¸º 1000ï¼Œé‚£ä¹ˆæ¯ç§’ä¼šäº§ç”Ÿ 1000MB çš„æµé‡ï¼Œè¿™å¯¹äºæ™®é€šåƒå…†ç½‘å¡çš„æœåŠ¡å™¨æ¥è¯´æ˜¯ç¾éš¾æ€§çš„ã€‚
3. å·¥ä½œçº¿ç¨‹é˜»å¡ï¼šå¦‚æœä½¿ç”¨ del åˆ é™¤å¤§ key æ—¶ï¼Œä¼šé˜»å¡å·¥ä½œçº¿ç¨‹ï¼Œè¿™æ ·å°±æ²¡åŠæ³•å¤„ç†åç»­çš„å‘½ä»¤ã€‚

å¤§ key é€ æˆçš„é˜»å¡é—®é¢˜è¿˜ä¼šè¿›ä¸€æ­¥å½±å“åˆ°ä¸»ä»åŒæ­¥å’Œé›†ç¾¤æ‰©å®¹ã€‚

ç»¼ä¸Šï¼Œå¤§ key å¸¦æ¥çš„æ½œåœ¨é—®é¢˜æ˜¯éå¸¸å¤šçš„ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡é¿å… Redis ä¸­å­˜åœ¨ bigkeyã€‚

#### å¦‚ä½•å‘ç° bigkeyï¼Ÿ

**1ã€ä½¿ç”¨ Redis è‡ªå¸¦çš„ `--bigkeys` å‚æ•°æ¥æŸ¥æ‰¾ã€‚**

```bash
# redis-cli -p 6379 --bigkeys

# Scanning the entire keyspace to find biggest keys as well as
# average sizes per key type.  You can use -i 0.1 to sleep 0.1 sec
# per 100 SCAN commands (not usually needed).

[00.00%] Biggest string found so far '"ballcat:oauth:refresh_auth:f6cdb384-9a9d-4f2f-af01-dc3f28057c20"' with 4437 bytes
[00.00%] Biggest list   found so far '"my-list"' with 17 items

-------- summary -------

Sampled 5 keys in the keyspace!
Total key length in bytes is 264 (avg len 52.80)

Biggest   list found '"my-list"' has 17 items
Biggest string found '"ballcat:oauth:refresh_auth:f6cdb384-9a9d-4f2f-af01-dc3f28057c20"' has 4437 bytes

1 lists with 17 items (20.00% of keys, avg size 17.00)
0 hashs with 0 fields (00.00% of keys, avg size 0.00)
4 strings with 4831 bytes (80.00% of keys, avg size 1207.75)
0 streams with 0 entries (00.00% of keys, avg size 0.00)
0 sets with 0 members (00.00% of keys, avg size 0.00)
0 zsets with 0 members (00.00% of keys, avg size 0.00
```

ä»è¿™ä¸ªå‘½ä»¤çš„è¿è¡Œç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼šè¿™ä¸ªå‘½ä»¤ä¼šæ‰«æï¼ˆScanï¼‰Redis ä¸­çš„æ‰€æœ‰ keyï¼Œä¼šå¯¹ Redis çš„æ€§èƒ½æœ‰ä¸€ç‚¹å½±å“ã€‚å¹¶ä¸”ï¼Œè¿™ç§æ–¹å¼åªèƒ½æ‰¾å‡ºæ¯ç§æ•°æ®ç»“æ„ top 1 bigkeyï¼ˆå ç”¨å†…å­˜æœ€å¤§çš„ String æ•°æ®ç±»å‹ï¼ŒåŒ…å«å…ƒç´ æœ€å¤šçš„å¤åˆæ•°æ®ç±»å‹ï¼‰ã€‚ç„¶è€Œï¼Œä¸€ä¸ª key çš„å…ƒç´ å¤šå¹¶ä¸ä»£è¡¨å ç”¨å†…å­˜ä¹Ÿå¤šï¼Œéœ€è¦æˆ‘ä»¬æ ¹æ®å…·ä½“çš„ä¸šåŠ¡æƒ…å†µæ¥è¿›ä¸€æ­¥åˆ¤æ–­ã€‚

åœ¨çº¿ä¸Šæ‰§è¡Œè¯¥å‘½ä»¤æ—¶ï¼Œä¸ºäº†é™ä½å¯¹ Redis çš„å½±å“ï¼Œéœ€è¦æŒ‡å®š `-i` å‚æ•°æ§åˆ¶æ‰«æçš„é¢‘ç‡ã€‚`redis-cli -p 6379 --bigkeys -i 3` è¡¨ç¤ºæ‰«æè¿‡ç¨‹ä¸­æ¯æ¬¡æ‰«æåä¼‘æ¯çš„æ—¶é—´é—´éš”ä¸º 3 ç§’ã€‚

**2ã€ä½¿ç”¨ Redis è‡ªå¸¦çš„ SCAN å‘½ä»¤**

`SCAN` å‘½ä»¤å¯ä»¥æŒ‰ç…§ä¸€å®šçš„æ¨¡å¼å’Œæ•°é‡è¿”å›åŒ¹é…çš„ keyã€‚è·å–äº† key ä¹‹åï¼Œå¯ä»¥åˆ©ç”¨ `STRLEN`ã€`HLEN`ã€`LLEN` ç­‰å‘½ä»¤è¿”å›å…¶é•¿åº¦æˆ–æˆå‘˜æ•°é‡ã€‚

| æ•°æ®ç»“æ„   | å‘½ä»¤   | å¤æ‚åº¦ | ç»“æœï¼ˆå¯¹åº” keyï¼‰   |
| ---------- | ------ | ------ | ------------------ |
| String     | STRLEN | O(1)   | å­—ç¬¦ä¸²å€¼çš„é•¿åº¦     |
| Hash       | HLEN   | O(1)   | å“ˆå¸Œè¡¨ä¸­å­—æ®µçš„æ•°é‡ |
| List       | LLEN   | O(1)   | åˆ—è¡¨å…ƒç´ æ•°é‡       |
| Set        | SCARD  | O(1)   | é›†åˆå…ƒç´ æ•°é‡       |
| Sorted Set | ZCARD  | O(1)   | æœ‰åºé›†åˆçš„å…ƒç´ æ•°é‡ |

å¯¹äºé›†åˆç±»å‹è¿˜å¯ä»¥ä½¿ç”¨ `MEMORY USAGE` å‘½ä»¤ï¼ˆRedis 4.0+ï¼‰ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šè¿”å›é”®å€¼å¯¹å ç”¨çš„å†…å­˜ç©ºé—´ã€‚

**3ã€å€ŸåŠ©å¼€æºå·¥å…·åˆ†æ RDB æ–‡ä»¶ã€‚**

é€šè¿‡åˆ†æ RDB æ–‡ä»¶æ¥æ‰¾å‡º big keyã€‚è¿™ç§æ–¹æ¡ˆçš„å‰ææ˜¯ä½ çš„ Redis é‡‡ç”¨çš„æ˜¯ RDB æŒä¹…åŒ–ã€‚

ç½‘ä¸Šæœ‰ç°æˆçš„ä»£ç /å·¥å…·å¯ä»¥ç›´æ¥æ‹¿æ¥ä½¿ç”¨ï¼š

- [redis-rdb-tools](https://github.com/sripathikrishnan/redis-rdb-tools)ï¼šPython è¯­è¨€å†™çš„ç”¨æ¥åˆ†æ Redis çš„ RDB å¿«ç…§æ–‡ä»¶ç”¨çš„å·¥å…·ã€‚
- [rdb_bigkeys](https://github.com/weiyanwei412/rdb_bigkeys)ï¼šGo è¯­è¨€å†™çš„ç”¨æ¥åˆ†æ Redis çš„ RDB å¿«ç…§æ–‡ä»¶ç”¨çš„å·¥å…·ï¼Œæ€§èƒ½æ›´å¥½ã€‚

**4ã€å€ŸåŠ©å…¬æœ‰äº‘çš„ Redis åˆ†ææœåŠ¡ã€‚**

å¦‚æœä½ ç”¨çš„æ˜¯å…¬æœ‰äº‘çš„ Redis æœåŠ¡çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹å…¶æ˜¯å¦æä¾›äº† key åˆ†æåŠŸèƒ½ï¼ˆä¸€èˆ¬éƒ½æä¾›äº†ï¼‰ã€‚

è¿™é‡Œä»¥é˜¿é‡Œäº‘ Redis ä¸ºä¾‹è¯´æ˜ï¼Œå®ƒæ”¯æŒ bigkey å®æ—¶åˆ†æã€å‘ç°ï¼Œæ–‡æ¡£åœ°å€ï¼š<https://www.alibabacloud.com/help/zh/apsaradb-for-redis/latest/use-the-real-time-key-statistics-feature>ã€‚

![é˜¿é‡Œäº‘Keyåˆ†æ](https://oss.javaguide.cn/github/javaguide/database/redis/aliyun-key-analysis.png)

#### å¦‚ä½•å¤„ç† bigkeyï¼Ÿ

bigkey çš„å¸¸è§å¤„ç†ä»¥åŠä¼˜åŒ–åŠæ³•å¦‚ä¸‹ï¼ˆè¿™äº›æ–¹æ³•å¯ä»¥é…åˆèµ·æ¥ä½¿ç”¨ï¼‰ï¼š

- **åˆ†å‰² bigkey**ï¼šå°†ä¸€ä¸ª bigkey åˆ†å‰²ä¸ºå¤šä¸ªå° keyã€‚ä¾‹å¦‚ï¼Œå°†ä¸€ä¸ªå«æœ‰ä¸Šä¸‡å­—æ®µæ•°é‡çš„ Hash æŒ‰ç…§ä¸€å®šç­–ç•¥ï¼ˆæ¯”å¦‚äºŒæ¬¡å“ˆå¸Œï¼‰æ‹†åˆ†ä¸ºå¤šä¸ª Hashã€‚
- **æ‰‹åŠ¨æ¸…ç†**ï¼šRedis 4.0+ å¯ä»¥ä½¿ç”¨ `UNLINK` å‘½ä»¤æ¥å¼‚æ­¥åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å®šçš„ keyã€‚Redis 4.0 ä»¥ä¸‹å¯ä»¥è€ƒè™‘ä½¿ç”¨ `SCAN` å‘½ä»¤ç»“åˆ `DEL` å‘½ä»¤æ¥åˆ†æ‰¹æ¬¡åˆ é™¤ã€‚
- **é‡‡ç”¨åˆé€‚çš„æ•°æ®ç»“æ„**ï¼šä¾‹å¦‚ï¼Œæ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®ä¸ä½¿ç”¨ String ä¿å­˜ã€ä½¿ç”¨ HyperLogLog ç»Ÿè®¡é¡µé¢ UVã€Bitmap ä¿å­˜çŠ¶æ€ä¿¡æ¯ï¼ˆ0/1ï¼‰ã€‚
- **å¼€å¯ lazy-freeï¼ˆæƒ°æ€§åˆ é™¤/å»¶è¿Ÿé‡Šæ”¾ï¼‰**ï¼šlazy-free ç‰¹æ€§æ˜¯ Redis 4.0 å¼€å§‹å¼•å…¥çš„ï¼ŒæŒ‡çš„æ˜¯è®© Redis é‡‡ç”¨å¼‚æ­¥æ–¹å¼å»¶è¿Ÿé‡Šæ”¾ key ä½¿ç”¨çš„å†…å­˜ï¼Œå°†è¯¥æ“ä½œäº¤ç»™å•ç‹¬çš„å­çº¿ç¨‹å¤„ç†ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

### Redis hotkeyï¼ˆçƒ­ Keyï¼‰

#### ä»€ä¹ˆæ˜¯ hotkeyï¼Ÿ

å¦‚æœä¸€ä¸ª key çš„è®¿é—®æ¬¡æ•°æ¯”è¾ƒå¤šä¸”æ˜æ˜¾å¤šäºå…¶ä»– key çš„è¯ï¼Œé‚£è¿™ä¸ª key å°±å¯ä»¥çœ‹ä½œæ˜¯ **hotkeyï¼ˆçƒ­ Keyï¼‰**ã€‚ä¾‹å¦‚åœ¨ Redis å®ä¾‹çš„æ¯ç§’å¤„ç†è¯·æ±‚è¾¾åˆ° 5000 æ¬¡ï¼Œè€Œå…¶ä¸­æŸä¸ª key çš„æ¯ç§’è®¿é—®é‡å°±é«˜è¾¾ 2000 æ¬¡ï¼Œé‚£è¿™ä¸ª key å°±å¯ä»¥çœ‹ä½œæ˜¯ hotkeyã€‚

hotkey å‡ºç°çš„åŸå› ä¸»è¦æ˜¯æŸä¸ªçƒ­ç‚¹æ•°æ®è®¿é—®é‡æš´å¢ï¼Œå¦‚é‡å¤§çš„çƒ­æœäº‹ä»¶ã€å‚ä¸ç§’æ€çš„å•†å“ã€‚

#### hotkey æœ‰ä»€ä¹ˆå±å®³ï¼Ÿ

å¤„ç† hotkey ä¼šå ç”¨å¤§é‡çš„ CPU å’Œå¸¦å®½ï¼Œå¯èƒ½ä¼šå½±å“ Redis å®ä¾‹å¯¹å…¶ä»–è¯·æ±‚çš„æ­£å¸¸å¤„ç†ã€‚æ­¤å¤–ï¼Œå¦‚æœçªç„¶è®¿é—® hotkey çš„è¯·æ±‚è¶…å‡ºäº† Redis çš„å¤„ç†èƒ½åŠ›ï¼ŒRedis å°±ä¼šç›´æ¥å®•æœºã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¤§é‡è¯·æ±‚å°†è½åˆ°åé¢çš„æ•°æ®åº“ä¸Šï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®åº“å´©æºƒã€‚

å› æ­¤ï¼Œhotkey å¾ˆå¯èƒ½æˆä¸ºç³»ç»Ÿæ€§èƒ½çš„ç“¶é¢ˆç‚¹ï¼Œéœ€è¦å•ç‹¬å¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§å’Œç¨³å®šæ€§ã€‚

#### å¦‚ä½•å‘ç° hotkeyï¼Ÿ

**1ã€ä½¿ç”¨ Redis è‡ªå¸¦çš„ `--hotkeys` å‚æ•°æ¥æŸ¥æ‰¾ã€‚**

Redis 4.0.3 ç‰ˆæœ¬ä¸­æ–°å¢äº† `hotkeys` å‚æ•°ï¼Œè¯¥å‚æ•°èƒ½å¤Ÿè¿”å›æ‰€æœ‰ key çš„è¢«è®¿é—®æ¬¡æ•°ã€‚

ä½¿ç”¨è¯¥æ–¹æ¡ˆçš„å‰ææ¡ä»¶æ˜¯ Redis Server çš„ `maxmemory-policy` å‚æ•°è®¾ç½®ä¸º LFU ç®—æ³•ï¼Œä¸ç„¶å°±ä¼šå‡ºç°å¦‚ä¸‹æ‰€ç¤ºçš„é”™è¯¯ã€‚

```bash
# redis-cli -p 6379 --hotkeys

# Scanning the entire keyspace to find hot keys as well as
# average sizes per key type.  You can use -i 0.1 to sleep 0.1 sec
# per 100 SCAN commands (not usually needed).

Error: ERR An LFU maxmemory policy is not selected, access frequency not tracked. Please note that when switching between policies at runtime LRU and LFU data will take some time to adjust.
```

Redis ä¸­æœ‰ä¸¤ç§ LFU ç®—æ³•ï¼š

1. **volatile-lfuï¼ˆleast frequently usedï¼‰**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ï¼ˆ`server.db[i].expires`ï¼‰ä¸­æŒ‘é€‰æœ€ä¸ç»å¸¸ä½¿ç”¨çš„æ•°æ®æ·˜æ±°ã€‚
2. **allkeys-lfuï¼ˆleast frequently usedï¼‰**ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€ä¸ç»å¸¸ä½¿ç”¨çš„ keyã€‚

ä»¥ä¸‹æ˜¯é…ç½®æ–‡ä»¶ `redis.conf` ä¸­çš„ç¤ºä¾‹ï¼š

```properties
# ä½¿ç”¨ volatile-lfu ç­–ç•¥
maxmemory-policy volatile-lfu

# æˆ–è€…ä½¿ç”¨ allkeys-lfu ç­–ç•¥
maxmemory-policy allkeys-lfu
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`hotkeys` å‚æ•°å‘½ä»¤ä¹Ÿä¼šå¢åŠ  Redis å®ä¾‹çš„ CPU å’Œå†…å­˜æ¶ˆè€—ï¼ˆå…¨å±€æ‰«æï¼‰ï¼Œå› æ­¤éœ€è¦è°¨æ…ä½¿ç”¨ã€‚

**2ã€ä½¿ç”¨ `MONITOR` å‘½ä»¤ã€‚**

`MONITOR` å‘½ä»¤æ˜¯ Redis æä¾›çš„ä¸€ç§å®æ—¶æŸ¥çœ‹ Redis çš„æ‰€æœ‰æ“ä½œçš„æ–¹å¼ï¼Œå¯ä»¥ç”¨äºä¸´æ—¶ç›‘æ§ Redis å®ä¾‹çš„æ“ä½œæƒ…å†µï¼ŒåŒ…æ‹¬è¯»å†™ã€åˆ é™¤ç­‰æ“ä½œã€‚

ç”±äºè¯¥å‘½ä»¤å¯¹ Redis æ€§èƒ½çš„å½±å“æ¯”è¾ƒå¤§ï¼Œå› æ­¤ç¦æ­¢é•¿æ—¶é—´å¼€å¯ `MONITOR`ï¼ˆç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®è°¨æ…ä½¿ç”¨è¯¥å‘½ä»¤ï¼‰ã€‚

```bash
# redis-cli
127.0.0.1:6379> MONITOR
OK
1683638260.637378 [0 172.17.0.1:61516] "ping"
1683638267.144236 [0 172.17.0.1:61518] "smembers" "mySet"
1683638268.941863 [0 172.17.0.1:61518] "smembers" "mySet"
1683638269.551671 [0 172.17.0.1:61518] "smembers" "mySet"
1683638270.646256 [0 172.17.0.1:61516] "ping"
1683638270.849551 [0 172.17.0.1:61518] "smembers" "mySet"
1683638271.926945 [0 172.17.0.1:61518] "smembers" "mySet"
1683638274.276599 [0 172.17.0.1:61518] "smembers" "mySet2"
1683638276.327234 [0 172.17.0.1:61518] "smembers" "mySet"
```

åœ¨å‘ç”Ÿç´§æ€¥æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©åœ¨åˆé€‚çš„æ—¶æœºçŸ­æš‚æ‰§è¡Œ `MONITOR` å‘½ä»¤å¹¶å°†è¾“å‡ºé‡å®šå‘è‡³æ–‡ä»¶ï¼Œåœ¨å…³é—­ `MONITOR` å‘½ä»¤åé€šè¿‡å¯¹æ–‡ä»¶ä¸­è¯·æ±‚è¿›è¡Œå½’ç±»åˆ†æå³å¯æ‰¾å‡ºè¿™æ®µæ—¶é—´ä¸­çš„ hotkeyã€‚

**3ã€å€ŸåŠ©å¼€æºé¡¹ç›®ã€‚**

äº¬ä¸œé›¶å”®çš„ [hotkey](https://gitee.com/jd-platform-opensource/hotkey) è¿™ä¸ªé¡¹ç›®ä¸å…‰æ”¯æŒ hotkey çš„å‘ç°ï¼Œè¿˜æ”¯æŒ hotkey çš„å¤„ç†ã€‚

![äº¬ä¸œé›¶å”®å¼€æºçš„ hotkey](https://oss.javaguide.cn/github/javaguide/database/redis/jd-hotkey.png)

**4ã€æ ¹æ®ä¸šåŠ¡æƒ…å†µæå‰é¢„ä¼°ã€‚**

å¯ä»¥æ ¹æ®ä¸šåŠ¡æƒ…å†µæ¥é¢„ä¼°ä¸€äº› hotkeyï¼Œæ¯”å¦‚å‚ä¸ç§’æ€æ´»åŠ¨çš„å•†å“æ•°æ®ç­‰ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬æ— æ³•é¢„ä¼°æ‰€æœ‰ hotkey çš„å‡ºç°ï¼Œæ¯”å¦‚çªå‘çš„çƒ­ç‚¹æ–°é—»äº‹ä»¶ç­‰ã€‚

**5ã€ä¸šåŠ¡ä»£ç ä¸­è®°å½•åˆ†æã€‚**

åœ¨ä¸šåŠ¡ä»£ç ä¸­æ·»åŠ ç›¸åº”çš„é€»è¾‘å¯¹ key çš„è®¿é—®æƒ…å†µè¿›è¡Œè®°å½•åˆ†æã€‚ä¸è¿‡ï¼Œè¿™ç§æ–¹å¼ä¼šè®©ä¸šåŠ¡ä»£ç çš„å¤æ‚æ€§å¢åŠ ï¼Œä¸€èˆ¬ä¹Ÿä¸ä¼šé‡‡ç”¨ã€‚

**6ã€å€ŸåŠ©å…¬æœ‰äº‘çš„ Redis åˆ†ææœåŠ¡ã€‚**

å¦‚æœä½ ç”¨çš„æ˜¯å…¬æœ‰äº‘çš„ Redis æœåŠ¡çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹å…¶æ˜¯å¦æä¾›äº† key åˆ†æåŠŸèƒ½ï¼ˆä¸€èˆ¬éƒ½æä¾›äº†ï¼‰ã€‚

è¿™é‡Œä»¥é˜¿é‡Œäº‘ Redis ä¸ºä¾‹è¯´æ˜ï¼Œå®ƒæ”¯æŒ hotkey å®æ—¶åˆ†æã€å‘ç°ï¼Œæ–‡æ¡£åœ°å€ï¼š<https://www.alibabacloud.com/help/zh/apsaradb-for-redis/latest/use-the-real-time-key-statistics-feature>ã€‚

![é˜¿é‡Œäº‘Keyåˆ†æ](https://oss.javaguide.cn/github/javaguide/database/redis/aliyun-key-analysis.png)

#### å¦‚ä½•è§£å†³ hotkeyï¼Ÿ

hotkey çš„å¸¸è§å¤„ç†ä»¥åŠä¼˜åŒ–åŠæ³•å¦‚ä¸‹ï¼ˆè¿™äº›æ–¹æ³•å¯ä»¥é…åˆèµ·æ¥ä½¿ç”¨ï¼‰ï¼š

- **è¯»å†™åˆ†ç¦»**ï¼šä¸»èŠ‚ç‚¹å¤„ç†å†™è¯·æ±‚ï¼Œä»èŠ‚ç‚¹å¤„ç†è¯»è¯·æ±‚ã€‚
- **ä½¿ç”¨ Redis Cluster**ï¼šå°†çƒ­ç‚¹æ•°æ®åˆ†æ•£å­˜å‚¨åœ¨å¤šä¸ª Redis èŠ‚ç‚¹ä¸Šã€‚
- **äºŒçº§ç¼“å­˜**ï¼šhotkey é‡‡ç”¨äºŒçº§ç¼“å­˜çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œå°† hotkey å­˜æ”¾ä¸€ä»½åˆ° JVM æœ¬åœ°å†…å­˜ä¸­ï¼ˆå¯ä»¥ç”¨ Caffeineï¼‰ã€‚

é™¤äº†è¿™äº›æ–¹æ³•ä¹‹å¤–ï¼Œå¦‚æœä½ ä½¿ç”¨çš„å…¬æœ‰äº‘çš„ Redis æœåŠ¡è¯ï¼Œè¿˜å¯ä»¥ç•™æ„å…¶æä¾›çš„å¼€ç®±å³ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚

è¿™é‡Œä»¥é˜¿é‡Œäº‘ Redis ä¸ºä¾‹è¯´æ˜ï¼Œå®ƒæ”¯æŒé€šè¿‡ä»£ç†æŸ¥è¯¢ç¼“å­˜åŠŸèƒ½ï¼ˆProxy Query Cacheï¼‰ä¼˜åŒ–çƒ­ç‚¹ Key é—®é¢˜ã€‚

![é€šè¿‡é˜¿é‡Œäº‘çš„Proxy Query Cacheä¼˜åŒ–çƒ­ç‚¹Keyé—®é¢˜](https://oss.javaguide.cn/github/javaguide/database/redis/aliyun-hotkey-proxy-query-cache.png)

### æ…¢æŸ¥è¯¢å‘½ä»¤

#### ä¸ºä»€ä¹ˆä¼šæœ‰æ…¢æŸ¥è¯¢å‘½ä»¤ï¼Ÿ

æˆ‘ä»¬çŸ¥é“ä¸€ä¸ª Redis å‘½ä»¤çš„æ‰§è¡Œå¯ä»¥ç®€åŒ–ä¸ºä»¥ä¸‹ 4 æ­¥ï¼š

1. å‘é€å‘½ä»¤ï¼›
2. å‘½ä»¤æ’é˜Ÿï¼›
3. å‘½ä»¤æ‰§è¡Œï¼›
4. è¿”å›ç»“æœã€‚

Redis æ…¢æŸ¥è¯¢ç»Ÿè®¡çš„æ˜¯å‘½ä»¤æ‰§è¡Œè¿™ä¸€æ­¥éª¤çš„è€—æ—¶ï¼Œæ…¢æŸ¥è¯¢å‘½ä»¤ä¹Ÿå°±æ˜¯é‚£äº›å‘½ä»¤æ‰§è¡Œæ—¶é—´è¾ƒé•¿çš„å‘½ä»¤ã€‚

Redis ä¸ºä»€ä¹ˆä¼šæœ‰æ…¢æŸ¥è¯¢å‘½ä»¤å‘¢ï¼Ÿ

Redis ä¸­çš„å¤§éƒ¨åˆ†å‘½ä»¤éƒ½æ˜¯ O(1) æ—¶é—´å¤æ‚åº¦ï¼Œä½†ä¹Ÿæœ‰å°‘éƒ¨åˆ† O(n) æ—¶é—´å¤æ‚åº¦çš„å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š

- `KEYS *`ï¼šä¼šè¿”å›æ‰€æœ‰ç¬¦åˆè§„åˆ™çš„ keyã€‚
- `HGETALL`ï¼šä¼šè¿”å›ä¸€ä¸ª Hash ä¸­æ‰€æœ‰çš„é”®å€¼å¯¹ã€‚
- `LRANGE`ï¼šä¼šè¿”å› List ä¸­æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ã€‚
- `SMEMBERS`ï¼šè¿”å› Set ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚
- `SINTER`/`SUNION`/`SDIFF`ï¼šè®¡ç®—å¤šä¸ª Set çš„äº¤é›†/å¹¶é›†/å·®é›†ã€‚
- â€¦â€¦

ç”±äºè¿™äº›å‘½ä»¤æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œæœ‰æ—¶å€™ä¹Ÿä¼šå…¨è¡¨æ‰«æï¼Œéšç€ n çš„å¢å¤§ï¼Œæ‰§è¡Œè€—æ—¶ä¹Ÿä¼šè¶Šé•¿ã€‚ä¸è¿‡ï¼Œ è¿™äº›å‘½ä»¤å¹¶ä¸æ˜¯ä¸€å®šä¸èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯éœ€è¦æ˜ç¡® N çš„å€¼ã€‚å¦å¤–ï¼Œæœ‰éå†çš„éœ€æ±‚å¯ä»¥ä½¿ç”¨ `HSCAN`ã€`SSCAN`ã€`ZSCAN` ä»£æ›¿ã€‚

é™¤äº†è¿™äº› O(n) æ—¶é—´å¤æ‚åº¦çš„å‘½ä»¤å¯èƒ½ä¼šå¯¼è‡´æ…¢æŸ¥è¯¢ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ—¶é—´å¤æ‚åº¦å¯èƒ½åœ¨ O(N) ä»¥ä¸Šçš„å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š

- `ZRANGE`/`ZREVRANGE`ï¼šè¿”å›æŒ‡å®š Sorted Set ä¸­æŒ‡å®šæ’åèŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ ã€‚æ—¶é—´å¤æ‚åº¦ä¸º O(log(n)+m)ï¼Œn ä¸ºæ‰€æœ‰å…ƒç´ çš„æ•°é‡ï¼Œm ä¸ºè¿”å›çš„å…ƒç´ æ•°é‡ï¼Œå½“ m å’Œ n ç›¸å½“å¤§æ—¶ï¼ŒO(n) çš„æ—¶é—´å¤æ‚åº¦æ›´å°ã€‚
- `ZREMRANGEBYRANK`/`ZREMRANGEBYSCORE`ï¼šç§»é™¤ Sorted Set ä¸­æŒ‡å®šæ’åèŒƒå›´/æŒ‡å®š score èŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ ã€‚æ—¶é—´å¤æ‚åº¦ä¸º O(log(n)+m)ï¼Œn ä¸ºæ‰€æœ‰å…ƒç´ çš„æ•°é‡ï¼Œm è¢«åˆ é™¤å…ƒç´ çš„æ•°é‡ï¼Œå½“ m å’Œ n ç›¸å½“å¤§æ—¶ï¼ŒO(n) çš„æ—¶é—´å¤æ‚åº¦æ›´å°ã€‚
- â€¦â€¦

#### å¦‚ä½•æ‰¾åˆ°æ…¢æŸ¥è¯¢å‘½ä»¤ï¼Ÿ

Redis æä¾›äº†ä¸€ä¸ªå†…ç½®çš„**æ…¢æŸ¥è¯¢æ—¥å¿— (Slow Log)** åŠŸèƒ½ï¼Œä¸“é—¨ç”¨æ¥è®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡æŒ‡å®šé˜ˆå€¼çš„å‘½ä»¤ã€‚è¿™å¯¹äºæ’æŸ¥æ€§èƒ½ç“¶é¢ˆã€æ‰¾å‡ºå¯¼è‡´ Redis é˜»å¡çš„â€œæ…¢â€æ“ä½œéå¸¸æœ‰å¸®åŠ©ï¼ŒåŸç†å’Œ MySQL çš„æ…¢æŸ¥è¯¢æ—¥å¿—ç±»ä¼¼ã€‚

åœ¨ `redis.conf` æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `slowlog-log-slower-than` å‚æ•°è®¾ç½®è€—æ—¶å‘½ä»¤çš„é˜ˆå€¼ï¼Œå¹¶ä½¿ç”¨ `slowlog-max-len` å‚æ•°è®¾ç½®è€—æ—¶å‘½ä»¤çš„æœ€å¤§è®°å½•æ¡æ•°ã€‚

å½“ Redis æœåŠ¡å™¨æ£€æµ‹åˆ°æ‰§è¡Œæ—¶é—´è¶…è¿‡ `slowlog-log-slower-than` é˜ˆå€¼çš„å‘½ä»¤æ—¶ï¼Œå°±ä¼šå°†è¯¥å‘½ä»¤è®°å½•åœ¨æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆslow logï¼‰ä¸­ï¼Œè¿™ç‚¹å’Œ MySQL è®°å½•æ…¢æŸ¥è¯¢è¯­å¥ç±»ä¼¼ã€‚å½“æ…¢æŸ¥è¯¢æ—¥å¿—è¶…è¿‡è®¾å®šçš„æœ€å¤§è®°å½•æ¡æ•°ä¹‹åï¼ŒRedis ä¼šæŠŠæœ€æ—©çš„æ‰§è¡Œå‘½ä»¤ä¾æ¬¡èˆå¼ƒã€‚

âš ï¸ æ³¨æ„ï¼šç”±äºæ…¢æŸ¥è¯¢æ—¥å¿—ä¼šå ç”¨ä¸€å®šå†…å­˜ç©ºé—´ï¼Œå¦‚æœè®¾ç½®æœ€å¤§è®°å½•æ¡æ•°è¿‡å¤§ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜å ç”¨è¿‡é«˜çš„é—®é¢˜ã€‚

`slowlog-log-slower-than` å’Œ `slowlog-max-len` çš„é»˜è®¤é…ç½®å¦‚ä¸‹ï¼ˆå¯ä»¥è‡ªè¡Œä¿®æ”¹ï¼‰ï¼š

```properties
# The following time is expressed in microseconds, so 1000000 is equivalent
# to one second. Note that a negative number disables the slow log, while
# a value of zero forces the logging of every command.
slowlog-log-slower-than 10000

# There is no limit to this length. Just be aware that it will consume memory.
# You can reclaim memory used by the slow log with SLOWLOG RESET.
slowlog-max-len 128
```

é™¤äº†ä¿®æ”¹é…ç½®æ–‡ä»¶ä¹‹å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ `CONFIG` å‘½ä»¤ç›´æ¥è®¾ç½®ï¼š

```bash
# å‘½ä»¤æ‰§è¡Œè€—æ—¶è¶…è¿‡ 10000 å¾®å¦™ï¼ˆå³10æ¯«ç§’ï¼‰å°±ä¼šè¢«è®°å½•
CONFIG SET slowlog-log-slower-than 10000
# åªä¿ç•™æœ€è¿‘ 128 æ¡è€—æ—¶å‘½ä»¤
CONFIG SET slowlog-max-len 128
```

è·å–æ…¢æŸ¥è¯¢æ—¥å¿—çš„å†…å®¹å¾ˆç®€å•ï¼Œç›´æ¥ä½¿ç”¨ `SLOWLOG GET` å‘½ä»¤å³å¯ã€‚

```bash
127.0.0.1:6379> SLOWLOG GET #æ…¢æ—¥å¿—æŸ¥è¯¢
 1) 1) (integer) 5
   2) (integer) 1684326682
   3) (integer) 12000
   4) 1) "KEYS"
      2) "*"
   5) "172.17.0.1:61152"
   6) ""
  // ...
```

æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­çš„æ¯ä¸ªæ¡ç›®éƒ½ç”±ä»¥ä¸‹å…­ä¸ªå€¼ç»„æˆï¼š

1. **å”¯ä¸€ ID**: æ—¥å¿—æ¡ç›®çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
2. **æ—¶é—´æˆ³ (Timestamp)**: å‘½ä»¤æ‰§è¡Œå®Œæˆæ—¶çš„ Unix æ—¶é—´æˆ³ã€‚
3. **è€—æ—¶ (Duration)**: å‘½ä»¤æ‰§è¡Œæ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œå•ä½æ˜¯**å¾®ç§’**ã€‚
4. **å‘½ä»¤åŠå‚æ•° (Command)**: æ‰§è¡Œçš„å…·ä½“å‘½ä»¤åŠå…¶å‚æ•°æ•°ç»„ã€‚
5. **å®¢æˆ·ç«¯ä¿¡æ¯ (Client IP:Port)**: æ‰§è¡Œå‘½ä»¤çš„å®¢æˆ·ç«¯åœ°å€å’Œç«¯å£ã€‚
6. **å®¢æˆ·ç«¯åç§° (Client Name)**: å¦‚æœå®¢æˆ·ç«¯è®¾ç½®äº†åç§° (CLIENT SETNAME)ã€‚

`SLOWLOG GET` å‘½ä»¤é»˜è®¤è¿”å›æœ€è¿‘ 10 æ¡çš„çš„æ…¢æŸ¥è¯¢å‘½ä»¤ï¼Œä½ ä¹Ÿè‡ªå·±å¯ä»¥æŒ‡å®šè¿”å›çš„æ…¢æŸ¥è¯¢å‘½ä»¤çš„æ•°é‡ `SLOWLOG GET N`ã€‚

ä¸‹é¢æ˜¯å…¶ä»–æ¯”è¾ƒå¸¸ç”¨çš„æ…¢æŸ¥è¯¢ç›¸å…³çš„å‘½ä»¤ï¼š

```bash
# è¿”å›æ…¢æŸ¥è¯¢å‘½ä»¤çš„æ•°é‡
127.0.0.1:6379> SLOWLOG LEN
(integer) 128
# æ¸…ç©ºæ…¢æŸ¥è¯¢å‘½ä»¤
127.0.0.1:6379> SLOWLOG RESET
OK
```

### Redis å†…å­˜ç¢ç‰‡

**ç›¸å…³é—®é¢˜**ï¼š

1. ä»€ä¹ˆæ˜¯å†…å­˜ç¢ç‰‡ï¼Ÿä¸ºä»€ä¹ˆä¼šæœ‰ Redis å†…å­˜ç¢ç‰‡ï¼Ÿ
2. å¦‚ä½•æ¸…ç† Redis å†…å­˜ç¢ç‰‡ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š[Redis å†…å­˜ç¢ç‰‡è¯¦è§£](https://javaguide.cn/database/redis/redis-memory-fragmentation.html)ã€‚

## â­ï¸Redis ç”Ÿäº§é—®é¢˜ï¼ˆé‡è¦ï¼‰

### ç¼“å­˜ç©¿é€

#### ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€ï¼Ÿ

ç¼“å­˜ç©¿é€è¯´ç®€å•ç‚¹å°±æ˜¯å¤§é‡è¯·æ±‚çš„ key æ˜¯ä¸åˆç†çš„ï¼Œ**æ ¹æœ¬ä¸å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œä¹Ÿä¸å­˜åœ¨äºæ•°æ®åº“ä¸­**ã€‚è¿™å°±å¯¼è‡´è¿™äº›è¯·æ±‚ç›´æ¥åˆ°äº†æ•°æ®åº“ä¸Šï¼Œæ ¹æœ¬æ²¡æœ‰ç»è¿‡ç¼“å­˜è¿™ä¸€å±‚ï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ï¼Œå¯èƒ½ç›´æ¥å°±è¢«è¿™ä¹ˆå¤šè¯·æ±‚å¼„å®•æœºäº†ã€‚

![ç¼“å­˜ç©¿é€](https://oss.javaguide.cn/github/javaguide/database/redis/redis-cache-penetration.png)

ä¸¾ä¸ªä¾‹å­ï¼šæŸä¸ªé»‘å®¢æ•…æ„åˆ¶é€ ä¸€äº›éæ³•çš„ key å‘èµ·å¤§é‡è¯·æ±‚ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚è½åˆ°æ•°æ®åº“ï¼Œç»“æœæ•°æ®åº“ä¸Šä¹Ÿæ²¡æœ‰æŸ¥åˆ°å¯¹åº”çš„æ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™äº›è¯·æ±‚æœ€ç»ˆéƒ½è½åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ã€‚

#### æœ‰å“ªäº›è§£å†³åŠæ³•ï¼Ÿ

æœ€åŸºæœ¬çš„å°±æ˜¯é¦–å…ˆåšå¥½å‚æ•°æ ¡éªŒï¼Œä¸€äº›ä¸åˆæ³•çš„å‚æ•°è¯·æ±‚ç›´æ¥æŠ›å‡ºå¼‚å¸¸ä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯ã€‚æ¯”å¦‚æŸ¥è¯¢çš„æ•°æ®åº“ id ä¸èƒ½å°äº 0ã€ä¼ å…¥çš„é‚®ç®±æ ¼å¼ä¸å¯¹çš„æ—¶å€™ç›´æ¥è¿”å›é”™è¯¯æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ç­‰ç­‰ã€‚

**1ï¼‰ç¼“å­˜æ— æ•ˆ key**

å¦‚æœç¼“å­˜å’Œæ•°æ®åº“éƒ½æŸ¥ä¸åˆ°æŸä¸ª key çš„æ•°æ®ï¼Œå°±å†™ä¸€ä¸ªåˆ° Redis ä¸­å»å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼š`SET key value EX 10086`ã€‚è¿™ç§æ–¹å¼å¯ä»¥è§£å†³è¯·æ±‚çš„ key å˜åŒ–ä¸é¢‘ç¹çš„æƒ…å†µï¼Œå¦‚æœé»‘å®¢æ¶æ„æ”»å‡»ï¼Œæ¯æ¬¡æ„å»ºä¸åŒçš„è¯·æ±‚ keyï¼Œä¼šå¯¼è‡´ Redis ä¸­ç¼“å­˜å¤§é‡æ— æ•ˆçš„ keyã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™ç§æ–¹æ¡ˆå¹¶ä¸èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³æ­¤é—®é¢˜ã€‚å¦‚æœéè¦ç”¨è¿™ç§æ–¹å¼æ¥è§£å†³ç©¿é€é—®é¢˜çš„è¯ï¼Œå°½é‡å°†æ— æ•ˆçš„ key çš„è¿‡æœŸæ—¶é—´è®¾ç½®çŸ­ä¸€ç‚¹ï¼Œæ¯”å¦‚ 1 åˆ†é’Ÿã€‚

å¦å¤–ï¼Œè¿™é‡Œå¤šè¯´ä¸€å˜´ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬æ˜¯è¿™æ ·è®¾è®¡ key çš„ï¼š`è¡¨å:åˆ—å:ä¸»é”®å:ä¸»é”®å€¼`ã€‚

å¦‚æœç”¨ Java ä»£ç å±•ç¤ºçš„è¯ï¼Œå·®ä¸å¤šæ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

```java
public Object getObjectInclNullById(Integer id) {
    // ä»ç¼“å­˜ä¸­è·å–æ•°æ®
    Object cacheValue = cache.get(id);
    // ç¼“å­˜ä¸ºç©º
    if (cacheValue == null) {
        // ä»æ•°æ®åº“ä¸­è·å–
        Object storageValue = storage.get(key);
        // ç¼“å­˜ç©ºå¯¹è±¡
        cache.set(key, storageValue);
        // å¦‚æœå­˜å‚¨æ•°æ®ä¸ºç©ºï¼Œéœ€è¦è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´(300ç§’)
        if (storageValue == null) {
            // å¿…é¡»è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¦åˆ™æœ‰è¢«æ”»å‡»çš„é£é™©
            cache.expire(key, 60 * 5);
        }
        return storageValue;
    }
    return cacheValue;
}
```

**2ï¼‰å¸ƒéš†è¿‡æ»¤å™¨**

å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ä¸ªéå¸¸ç¥å¥‡çš„æ•°æ®ç»“æ„ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿åœ°åˆ¤æ–­ä¸€ä¸ªç»™å®šæ•°æ®æ˜¯å¦å­˜åœ¨äºæµ·é‡æ•°æ®ä¸­ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒçœ‹ä½œç”±äºŒè¿›åˆ¶å‘é‡ï¼ˆæˆ–è€…è¯´ä½æ•°ç»„ï¼‰å’Œä¸€ç³»åˆ—éšæœºæ˜ å°„å‡½æ•°ï¼ˆå“ˆå¸Œå‡½æ•°ï¼‰ä¸¤éƒ¨åˆ†ç»„æˆçš„æ•°æ®ç»“æ„ã€‚ç›¸æ¯”äºæˆ‘ä»¬å¹³æ—¶å¸¸ç”¨çš„ Listã€Mapã€Set ç­‰æ•°æ®ç»“æ„ï¼Œå®ƒå ç”¨ç©ºé—´æ›´å°‘å¹¶ä¸”æ•ˆç‡æ›´é«˜ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯å…¶è¿”å›çš„ç»“æœæ˜¯æ¦‚ç‡æ€§çš„ï¼Œè€Œä¸æ˜¯éå¸¸å‡†ç¡®çš„ã€‚ç†è®ºæƒ…å†µä¸‹æ·»åŠ åˆ°é›†åˆä¸­çš„å…ƒç´ è¶Šå¤šï¼Œè¯¯æŠ¥çš„å¯èƒ½æ€§å°±è¶Šå¤§ã€‚å¹¶ä¸”ï¼Œå­˜æ”¾åœ¨å¸ƒéš†è¿‡æ»¤å™¨çš„æ•°æ®ä¸å®¹æ˜“åˆ é™¤ã€‚

![Bloom Filter çš„ç®€å•åŸç†ç¤ºæ„å›¾](https://oss.javaguide.cn/github/javaguide/cs-basics/algorithms/bloom-filter-simple-schematic-diagram.png)

Bloom Filter ä¼šä½¿ç”¨ä¸€ä¸ªè¾ƒå¤§çš„ bit æ•°ç»„æ¥ä¿å­˜æ‰€æœ‰çš„æ•°æ®ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½åªå ç”¨ 1 bit ï¼Œå¹¶ä¸”æ¯ä¸ªå…ƒç´ åªèƒ½æ˜¯ 0 æˆ–è€… 1ï¼ˆä»£è¡¨ false æˆ–è€… trueï¼‰ï¼Œè¿™ä¹Ÿæ˜¯ Bloom Filter èŠ‚çœå†…å­˜çš„æ ¸å¿ƒæ‰€åœ¨ã€‚è¿™æ ·æ¥ç®—çš„è¯ï¼Œç”³è¯·ä¸€ä¸ª 100w ä¸ªå…ƒç´ çš„ä½æ•°ç»„åªå ç”¨ 1000000Bit / 8 = 125000 Byte = 125000/1024 KB â‰ˆ 122KB çš„ç©ºé—´ã€‚

![ä½æ•°ç»„](https://oss.javaguide.cn/github/javaguide/cs-basics/algorithms/bloom-filter-bit-table.png)

å…·ä½“æ˜¯è¿™æ ·åšçš„ï¼šæŠŠæ‰€æœ‰å¯èƒ½å­˜åœ¨çš„è¯·æ±‚çš„å€¼éƒ½å­˜æ”¾åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå½“ç”¨æˆ·è¯·æ±‚è¿‡æ¥ï¼Œå…ˆåˆ¤æ–­ç”¨æˆ·å‘æ¥çš„è¯·æ±‚çš„å€¼æ˜¯å¦å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚ä¸å­˜åœ¨çš„è¯ï¼Œç›´æ¥è¿”å›è¯·æ±‚å‚æ•°é”™è¯¯ä¿¡æ¯ç»™å®¢æˆ·ç«¯ï¼Œå­˜åœ¨çš„è¯æ‰ä¼šèµ°ä¸‹é¢çš„æµç¨‹ã€‚

åŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨ä¹‹åçš„ç¼“å­˜å¤„ç†æµç¨‹å›¾å¦‚ä¸‹ï¼š

![åŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨ä¹‹åçš„ç¼“å­˜å¤„ç†æµç¨‹å›¾](https://oss.javaguide.cn/github/javaguide/database/redis/redis-cache-penetration-bloom-filter.png)

æ›´å¤šå…³äºå¸ƒéš†è¿‡æ»¤å™¨çš„è¯¦ç»†ä»‹ç»å¯ä»¥çœ‹çœ‹æˆ‘çš„è¿™ç¯‡åŸåˆ›ï¼š[ä¸äº†è§£å¸ƒéš†è¿‡æ»¤å™¨ï¼Ÿä¸€æ–‡ç»™ä½ æ•´çš„æ˜æ˜ç™½ç™½ï¼](https://javaguide.cn/cs-basics/data-structure/bloom-filter.html)ï¼Œå¼ºçƒˆæ¨èã€‚

**3ï¼‰æ¥å£é™æµ**

æ ¹æ®ç”¨æˆ·æˆ–è€… IP å¯¹æ¥å£è¿›è¡Œé™æµï¼Œå¯¹äºå¼‚å¸¸é¢‘ç¹çš„è®¿é—®è¡Œä¸ºï¼Œè¿˜å¯ä»¥é‡‡å–é»‘åå•æœºåˆ¶ï¼Œä¾‹å¦‚å°†å¼‚å¸¸ IP åˆ—å…¥é»‘åå•ã€‚

åé¢æåˆ°çš„ç¼“å­˜å‡»ç©¿å’Œé›ªå´©éƒ½å¯ä»¥é…åˆæ¥å£é™æµæ¥è§£å†³ï¼Œæ¯•ç«Ÿè¿™äº›é—®é¢˜çš„å…³é”®éƒ½æ˜¯æœ‰å¾ˆå¤šè¯·æ±‚è½åˆ°äº†æ•°æ®åº“ä¸Šé€ æˆæ•°æ®åº“å‹åŠ›è¿‡å¤§ã€‚

é™æµçš„å…·ä½“æ–¹æ¡ˆå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š[æœåŠ¡é™æµè¯¦è§£](https://javaguide.cn/high-availability/limit-request.html)ã€‚

### ç¼“å­˜å‡»ç©¿

#### ä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿ï¼Ÿ

ç¼“å­˜å‡»ç©¿ä¸­ï¼Œè¯·æ±‚çš„ key å¯¹åº”çš„æ˜¯ **çƒ­ç‚¹æ•°æ®**ï¼Œè¯¥æ•°æ® **å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œä½†ä¸å­˜åœ¨äºç¼“å­˜ä¸­ï¼ˆé€šå¸¸æ˜¯å› ä¸ºç¼“å­˜ä¸­çš„é‚£ä»½æ•°æ®å·²ç»è¿‡æœŸï¼‰**ã€‚è¿™å°±å¯èƒ½ä¼šå¯¼è‡´ç¬æ—¶å¤§é‡çš„è¯·æ±‚ç›´æ¥æ‰“åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ï¼Œå¯èƒ½ç›´æ¥å°±è¢«è¿™ä¹ˆå¤šè¯·æ±‚å¼„å®•æœºäº†ã€‚

![ç¼“å­˜å‡»ç©¿](https://oss.javaguide.cn/github/javaguide/database/redis/redis-cache-breakdown.png)

ä¸¾ä¸ªä¾‹å­ï¼šç§’æ€è¿›è¡Œè¿‡ç¨‹ä¸­ï¼Œç¼“å­˜ä¸­çš„æŸä¸ªç§’æ€å•†å“çš„æ•°æ®çªç„¶è¿‡æœŸï¼Œè¿™å°±å¯¼è‡´ç¬æ—¶å¤§é‡å¯¹è¯¥å•†å“çš„è¯·æ±‚ç›´æ¥è½åˆ°æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ã€‚

#### æœ‰å“ªäº›è§£å†³åŠæ³•ï¼Ÿ

1. **æ°¸ä¸è¿‡æœŸ**ï¼ˆä¸æ¨èï¼‰ï¼šè®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸæˆ–è€…è¿‡æœŸæ—¶é—´æ¯”è¾ƒé•¿ã€‚
2. **æå‰é¢„çƒ­**ï¼ˆæ¨èï¼‰ï¼šé’ˆå¯¹çƒ­ç‚¹æ•°æ®æå‰é¢„çƒ­ï¼Œå°†å…¶å­˜å…¥ç¼“å­˜ä¸­å¹¶è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´æ¯”å¦‚ç§’æ€åœºæ™¯ä¸‹çš„æ•°æ®åœ¨ç§’æ€ç»“æŸä¹‹å‰ä¸è¿‡æœŸã€‚
3. **åŠ é”**ï¼ˆçœ‹æƒ…å†µï¼‰ï¼šåœ¨ç¼“å­˜å¤±æ•ˆåï¼Œé€šè¿‡è®¾ç½®äº’æ–¥é”ç¡®ä¿åªæœ‰ä¸€ä¸ªè¯·æ±‚å»æŸ¥è¯¢æ•°æ®åº“å¹¶æ›´æ–°ç¼“å­˜ã€‚

#### ç¼“å­˜ç©¿é€å’Œç¼“å­˜å‡»ç©¿æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

ç¼“å­˜ç©¿é€ä¸­ï¼Œè¯·æ±‚çš„ key æ—¢ä¸å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œä¹Ÿä¸å­˜åœ¨äºæ•°æ®åº“ä¸­ã€‚

ç¼“å­˜å‡»ç©¿ä¸­ï¼Œè¯·æ±‚çš„ key å¯¹åº”çš„æ˜¯ **çƒ­ç‚¹æ•°æ®** ï¼Œè¯¥æ•°æ® **å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œä½†ä¸å­˜åœ¨äºç¼“å­˜ä¸­ï¼ˆé€šå¸¸æ˜¯å› ä¸ºç¼“å­˜ä¸­çš„é‚£ä»½æ•°æ®å·²ç»è¿‡æœŸï¼‰** ã€‚

### ç¼“å­˜é›ªå´©

#### ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ï¼Ÿ

æˆ‘å‘ç°ç¼“å­˜é›ªå´©è¿™åå­—èµ·çš„æœ‰ç‚¹æ„æ€ï¼Œå“ˆå“ˆã€‚

å®é™…ä¸Šï¼Œç¼“å­˜é›ªå´©æè¿°çš„å°±æ˜¯è¿™æ ·ä¸€ä¸ªç®€å•çš„åœºæ™¯ï¼š**ç¼“å­˜åœ¨åŒä¸€æ—¶é—´å¤§é¢ç§¯çš„å¤±æ•ˆï¼Œå¯¼è‡´å¤§é‡çš„è¯·æ±‚éƒ½ç›´æ¥è½åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ã€‚** è¿™å°±å¥½æ¯”é›ªå´©ä¸€æ ·ï¼Œæ‘§æ¯æ‹‰æœ½ä¹‹åŠ¿ï¼Œæ•°æ®åº“çš„å‹åŠ›å¯æƒ³è€ŒçŸ¥ï¼Œå¯èƒ½ç›´æ¥å°±è¢«è¿™ä¹ˆå¤šè¯·æ±‚å¼„å®•æœºäº†ã€‚

å¦å¤–ï¼Œç¼“å­˜æœåŠ¡å®•æœºä¹Ÿä¼šå¯¼è‡´ç¼“å­˜é›ªå´©ç°è±¡ï¼Œå¯¼è‡´æ‰€æœ‰çš„è¯·æ±‚éƒ½è½åˆ°äº†æ•°æ®åº“ä¸Šã€‚

![ç¼“å­˜é›ªå´©](https://oss.javaguide.cn/github/javaguide/database/redis/redis-cache-avalanche.png)

ä¸¾ä¸ªä¾‹å­ï¼šç¼“å­˜ä¸­çš„å¤§é‡æ•°æ®åœ¨åŒä¸€æ—¶é—´è¿‡æœŸï¼Œè¿™ä¸ªæ—¶å€™çªç„¶æœ‰å¤§é‡çš„è¯·æ±‚éœ€è¦è®¿é—®è¿™äº›è¿‡æœŸçš„æ•°æ®ã€‚è¿™å°±å¯¼è‡´å¤§é‡çš„è¯·æ±‚ç›´æ¥è½åˆ°æ•°æ®åº“ä¸Šï¼Œå¯¹æ•°æ®åº“é€ æˆäº†å·¨å¤§çš„å‹åŠ›ã€‚

#### æœ‰å“ªäº›è§£å†³åŠæ³•ï¼Ÿ

**é’ˆå¯¹ Redis æœåŠ¡ä¸å¯ç”¨çš„æƒ…å†µ**ï¼š

1. **Redis é›†ç¾¤**ï¼šé‡‡ç”¨ Redis é›†ç¾¤ï¼Œé¿å…å•æœºå‡ºç°é—®é¢˜æ•´ä¸ªç¼“å­˜æœåŠ¡éƒ½æ²¡åŠæ³•ä½¿ç”¨ã€‚Redis Cluster å’Œ Redis Sentinel æ˜¯ä¸¤ç§æœ€å¸¸ç”¨çš„ Redis é›†ç¾¤å®ç°æ–¹æ¡ˆï¼Œè¯¦ç»†ä»‹ç»å¯ä»¥å‚è€ƒï¼š[Redis é›†ç¾¤è¯¦è§£(ä»˜è´¹)](https://javaguide.cn/database/redis/redis-cluster.html)ã€‚
2. **å¤šçº§ç¼“å­˜**ï¼šè®¾ç½®å¤šçº§ç¼“å­˜ï¼Œä¾‹å¦‚æœ¬åœ°ç¼“å­˜+Redis ç¼“å­˜çš„äºŒçº§ç¼“å­˜ç»„åˆï¼Œå½“ Redis ç¼“å­˜å‡ºç°é—®é¢˜æ—¶ï¼Œè¿˜å¯ä»¥ä»æœ¬åœ°ç¼“å­˜ä¸­è·å–åˆ°éƒ¨åˆ†æ•°æ®ã€‚

**é’ˆå¯¹å¤§é‡ç¼“å­˜åŒæ—¶å¤±æ•ˆçš„æƒ…å†µ**ï¼š

1. **è®¾ç½®éšæœºå¤±æ•ˆæ—¶é—´**ï¼ˆå¯é€‰ï¼‰ï¼šä¸ºç¼“å­˜è®¾ç½®éšæœºçš„å¤±æ•ˆæ—¶é—´ï¼Œä¾‹å¦‚åœ¨å›ºå®šè¿‡æœŸæ—¶é—´çš„åŸºç¡€ä¸ŠåŠ ä¸Šä¸€ä¸ªéšæœºå€¼ï¼Œè¿™æ ·å¯ä»¥é¿å…å¤§é‡ç¼“å­˜åŒæ—¶åˆ°æœŸï¼Œä»è€Œå‡å°‘ç¼“å­˜é›ªå´©çš„é£é™©ã€‚
2. **æå‰é¢„çƒ­**ï¼ˆæ¨èï¼‰ï¼šé’ˆå¯¹çƒ­ç‚¹æ•°æ®æå‰é¢„çƒ­ï¼Œå°†å…¶å­˜å…¥ç¼“å­˜ä¸­å¹¶è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚ç§’æ€åœºæ™¯ä¸‹çš„æ•°æ®åœ¨ç§’æ€ç»“æŸä¹‹å‰ä¸è¿‡æœŸã€‚
3. **æŒä¹…ç¼“å­˜ç­–ç•¥**ï¼ˆçœ‹æƒ…å†µï¼‰ï¼šè™½ç„¶ä¸€èˆ¬ä¸æ¨èè®¾ç½®ç¼“å­˜æ°¸ä¸è¿‡æœŸï¼Œä½†å¯¹äºæŸäº›å…³é”®æ€§å’Œå˜åŒ–ä¸é¢‘ç¹çš„æ•°æ®ï¼Œå¯ä»¥è€ƒè™‘è¿™ç§ç­–ç•¥ã€‚

#### ç¼“å­˜é¢„çƒ­å¦‚ä½•å®ç°ï¼Ÿ

å¸¸è§çš„ç¼“å­˜é¢„çƒ­æ–¹å¼æœ‰ä¸¤ç§ï¼š

1. ä½¿ç”¨å®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚ xxl-jobï¼Œæ¥å®šæ—¶è§¦å‘ç¼“å­˜é¢„çƒ­çš„é€»è¾‘ï¼Œå°†æ•°æ®åº“ä¸­çš„çƒ­ç‚¹æ•°æ®æŸ¥è¯¢å‡ºæ¥å¹¶å­˜å…¥ç¼“å­˜ä¸­ã€‚
2. ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯”å¦‚ Kafkaï¼Œæ¥å¼‚æ­¥åœ°è¿›è¡Œç¼“å­˜é¢„çƒ­ï¼Œå°†æ•°æ®åº“ä¸­çš„çƒ­ç‚¹æ•°æ®çš„ä¸»é”®æˆ–è€… ID å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç„¶åç”±ç¼“å­˜æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œæ ¹æ®ä¸»é”®æˆ–è€… ID æŸ¥è¯¢æ•°æ®åº“å¹¶æ›´æ–°ç¼“å­˜ã€‚

#### ç¼“å­˜é›ªå´©å’Œç¼“å­˜å‡»ç©¿æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

ç¼“å­˜é›ªå´©å’Œç¼“å­˜å‡»ç©¿æ¯”è¾ƒåƒï¼Œä½†ç¼“å­˜é›ªå´©å¯¼è‡´çš„åŸå› æ˜¯ç¼“å­˜ä¸­çš„å¤§é‡æˆ–è€…æ‰€æœ‰æ•°æ®å¤±æ•ˆï¼Œç¼“å­˜å‡»ç©¿å¯¼è‡´çš„åŸå› ä¸»è¦æ˜¯æŸä¸ªçƒ­ç‚¹æ•°æ®ä¸å­˜åœ¨äºç¼“å­˜ä¸­ï¼ˆé€šå¸¸æ˜¯å› ä¸ºç¼“å­˜ä¸­çš„é‚£ä»½æ•°æ®å·²ç»è¿‡æœŸï¼‰ã€‚

### å¦‚ä½•ä¿è¯ç¼“å­˜å’Œæ•°æ®åº“æ•°æ®çš„ä¸€è‡´æ€§ï¼Ÿ

ç¼“å­˜å’Œæ•°æ®åº“ä¸€è‡´æ€§æ˜¯ä¸ªæŒºå¸¸è§çš„æŠ€æœ¯æŒ‘æˆ˜ã€‚å¼•å…¥ç¼“å­˜ä¸»è¦æ˜¯ä¸ºäº†æå‡æ€§èƒ½ã€å‡è½»æ•°æ®åº“å‹åŠ›ï¼Œä½†ç¡®å®ä¼šå¸¦æ¥æ•°æ®ä¸ä¸€è‡´çš„é£é™©ã€‚ç»å¯¹çš„ä¸€è‡´æ€§å¾€å¾€æ„å‘³ç€æ›´é«˜çš„ç³»ç»Ÿå¤æ‚åº¦å’Œæ€§èƒ½å¼€é”€ï¼Œæ‰€ä»¥å®è·µä¸­æˆ‘ä»¬é€šå¸¸ä¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„ç­–ç•¥ï¼Œåœ¨æ€§èƒ½å’Œä¸€è‡´æ€§ä¹‹é—´æ‰¾åˆ°ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚

ä¸‹é¢å•ç‹¬å¯¹ **Cache Aside Patternï¼ˆæ—è·¯ç¼“å­˜æ¨¡å¼ï¼‰** æ¥èŠèŠã€‚è¿™æ˜¯éå¸¸å¸¸ç”¨çš„ä¸€ç§ç¼“å­˜è¯»å†™ç­–ç•¥ï¼Œå®ƒçš„è¯»å†™é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š

- **è¯»æ“ä½œ**ï¼š
  1. å…ˆå°è¯•ä»ç¼“å­˜è¯»å–æ•°æ®ã€‚
  2. å¦‚æœç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥è¿”å›æ•°æ®ã€‚
  3. å¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®ï¼Œå°†æŸ¥åˆ°çš„æ•°æ®æ”¾å…¥ç¼“å­˜å¹¶è¿”å›æ•°æ®ã€‚
- **å†™æ“ä½œ**ï¼š
  1. å…ˆæ›´æ–°æ•°æ®åº“ã€‚
  2. å†ç›´æ¥åˆ é™¤ç¼“å­˜ä¸­å¯¹åº”çš„æ•°æ®ã€‚

å›¾è§£å¦‚ä¸‹ï¼š

![](https://oss.javaguide.cn/github/javaguide/database/redis/cache-aside-write.png)

![](https://oss.javaguide.cn/github/javaguide/database/redis/cache-aside-read.png)

å¦‚æœæ›´æ–°æ•°æ®åº“æˆåŠŸï¼Œè€Œåˆ é™¤ç¼“å­˜è¿™ä¸€æ­¥å¤±è´¥çš„æƒ…å†µçš„è¯ï¼Œç®€å•è¯´æœ‰ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆï¼š

1. **ç¼“å­˜å¤±æ•ˆæ—¶é—´ï¼ˆTTL - Time To Liveï¼‰å˜çŸ­**ï¼ˆä¸æ¨èï¼Œæ²»æ ‡ä¸æ²»æœ¬ï¼‰ï¼šæˆ‘ä»¬è®©ç¼“å­˜æ•°æ®çš„è¿‡æœŸæ—¶é—´å˜çŸ­ï¼Œè¿™æ ·çš„è¯ç¼“å­˜å°±ä¼šä»æ•°æ®åº“ä¸­åŠ è½½æ•°æ®ã€‚å¦å¤–ï¼Œè¿™ç§è§£å†³åŠæ³•å¯¹äºå…ˆæ“ä½œç¼“å­˜åæ“ä½œæ•°æ®åº“çš„åœºæ™¯ä¸é€‚ç”¨ã€‚
2. **å¢åŠ ç¼“å­˜æ›´æ–°é‡è¯•æœºåˆ¶**ï¼ˆå¸¸ç”¨ï¼‰ï¼šå¦‚æœç¼“å­˜æœåŠ¡å½“å‰ä¸å¯ç”¨å¯¼è‡´ç¼“å­˜åˆ é™¤å¤±è´¥çš„è¯ï¼Œæˆ‘ä»¬å°±éš”ä¸€æ®µæ—¶é—´è¿›è¡Œé‡è¯•ï¼Œé‡è¯•æ¬¡æ•°å¯ä»¥è‡ªå·±å®šã€‚ä¸è¿‡ï¼Œè¿™é‡Œæ›´é€‚åˆå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥é‡è¯•ï¼Œå°†åˆ é™¤ç¼“å­˜é‡è¯•çš„æ¶ˆæ¯æŠ•é€’åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åç”±ä¸“é—¨çš„æ¶ˆè´¹è€…æ¥é‡è¯•ï¼Œç›´åˆ°æˆåŠŸã€‚è™½ç„¶è¯´å¤šå¼•å…¥äº†ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†å…¶æ•´ä½“å¸¦æ¥çš„æ”¶ç›Šè¿˜æ˜¯è¦æ›´é«˜ä¸€äº›ã€‚

ç›¸å…³æ–‡ç« æ¨èï¼š[ç¼“å­˜å’Œæ•°æ®åº“ä¸€è‡´æ€§é—®é¢˜ï¼Œçœ‹è¿™ç¯‡å°±å¤Ÿäº† - æ°´æ»´ä¸é“¶å¼¹](https://mp.weixin.qq.com/s?__biz=MzIyOTYxNDI5OA==&mid=2247487312&idx=1&sn=fa19566f5729d6598155b5c676eee62d&chksm=e8beb8e5dfc931f3e35655da9da0b61c79f2843101c130cf38996446975014f958a6481aacf1&scene=178&cur_album_id=1699766580538032128#rd)ã€‚

### å“ªäº›æƒ…å†µå¯èƒ½ä¼šå¯¼è‡´ Redis é˜»å¡ï¼Ÿ

å¸¸è§çš„å¯¼è‡´ Redis é˜»å¡åŸå› æœ‰ï¼š

- `O(n)` å¤æ‚åº¦å‘½ä»¤æ‰§è¡Œï¼ˆå¦‚ `KEYS *`ã€`HGETALL`ã€`LRANGE`ã€`SMEMBERS` ç­‰ï¼‰ï¼Œéšç€æ•°æ®é‡å¢å¤§å¯¼è‡´æ‰§è¡Œæ—¶é—´è¿‡é•¿ã€‚
- æ‰§è¡Œ `SAVE` å‘½ä»¤ç”Ÿæˆ RDB å¿«ç…§æ—¶åŒæ­¥é˜»å¡ä¸»çº¿ç¨‹ï¼Œè€Œ `BGSAVE` é€šè¿‡ `fork` å­è¿›ç¨‹é¿å…é˜»å¡ã€‚
- AOF è®°å½•æ—¥å¿—åœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œï¼Œå¯èƒ½å› å‘½ä»¤æ‰§è¡Œåå†™æ—¥å¿—è€Œé˜»å¡åç»­å‘½ä»¤ã€‚
- AOF åˆ·ç›˜ï¼ˆfsyncï¼‰æ—¶åå°çº¿ç¨‹åŒæ­¥åˆ°ç£ç›˜ï¼Œç£ç›˜å‹åŠ›å¤§å¯¼è‡´ `fsync` é˜»å¡ï¼Œè¿›è€Œé˜»å¡ä¸»çº¿ç¨‹ `write` æ“ä½œï¼Œå°¤å…¶åœ¨ `appendfsync always` æˆ– `everysec` é…ç½®ä¸‹æ˜æ˜¾ã€‚
- AOF é‡å†™è¿‡ç¨‹ä¸­å°†é‡å†™ç¼“å†²åŒºå†…å®¹è¿½åŠ åˆ°æ–° AOF æ–‡ä»¶æ—¶äº§ç”Ÿé˜»å¡ã€‚
- æ“ä½œå¤§ keyï¼ˆstring > 1MB æˆ–å¤åˆç±»å‹å…ƒç´  > 5000ï¼‰å¯¼è‡´å®¢æˆ·ç«¯è¶…æ—¶ã€ç½‘ç»œé˜»å¡å’Œå·¥ä½œçº¿ç¨‹é˜»å¡ã€‚
- ä½¿ç”¨ `flushdb` æˆ– `flushall` æ¸…ç©ºæ•°æ®åº“æ—¶æ¶‰åŠå¤§é‡é”®å€¼å¯¹åˆ é™¤å’Œå†…å­˜é‡Šæ”¾ï¼Œé€ æˆä¸»çº¿ç¨‹é˜»å¡ã€‚
- é›†ç¾¤æ‰©å®¹ç¼©å®¹æ—¶æ•°æ®è¿ç§»ä¸ºåŒæ­¥æ“ä½œï¼Œå¤§ key è¿ç§»å¯¼è‡´ä¸¤ç«¯èŠ‚ç‚¹é•¿æ—¶é—´é˜»å¡ï¼Œå¯èƒ½è§¦å‘æ•…éšœè½¬ç§»
- å†…å­˜ä¸è¶³è§¦å‘ Swapï¼Œæ“ä½œç³»ç»Ÿå°† Redis å†…å­˜æ¢å‡ºåˆ°ç¡¬ç›˜ï¼Œè¯»å†™æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚
- å…¶ä»–è¿›ç¨‹è¿‡åº¦å ç”¨ CPU å¯¼è‡´ Redis ååé‡ä¸‹é™ã€‚
- ç½‘ç»œé—®é¢˜å¦‚è¿æ¥æ‹’ç»ã€å»¶è¿Ÿé«˜ã€ç½‘å¡è½¯ä¸­æ–­ç­‰å¯¼è‡´ Redis é˜»å¡ã€‚

è¯¦ç»†ä»‹ç»å¯ä»¥é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼š[Redis å¸¸è§é˜»å¡åŸå› æ€»ç»“](https://javaguide.cn/database/redis/redis-common-blocking-problems-summary.html)ã€‚

## Redis é›†ç¾¤

**Redis Sentinel**ï¼š

1. ä»€ä¹ˆæ˜¯ Sentinelï¼Ÿ æœ‰ä»€ä¹ˆç”¨ï¼Ÿ
2. Sentinel å¦‚ä½•æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦ä¸‹çº¿ï¼Ÿä¸»è§‚ä¸‹çº¿ä¸å®¢è§‚ä¸‹çº¿çš„åŒºåˆ«ï¼Ÿ
3. Sentinel æ˜¯å¦‚ä½•å®ç°æ•…éšœè½¬ç§»çš„ï¼Ÿ
4. ä¸ºä»€ä¹ˆå»ºè®®éƒ¨ç½²å¤šä¸ª sentinel èŠ‚ç‚¹ï¼ˆå“¨å…µé›†ç¾¤ï¼‰ï¼Ÿ
5. Sentinel å¦‚ä½•é€‰æ‹©å‡ºæ–°çš„ masterï¼ˆé€‰ä¸¾æœºåˆ¶ï¼‰ï¼Ÿ
6. å¦‚ä½•ä» Sentinel é›†ç¾¤ä¸­é€‰æ‹©å‡º Leaderï¼Ÿ
7. Sentinel å¯ä»¥é˜²æ­¢è„‘è£‚å—ï¼Ÿ

**Redis Cluster**ï¼š

1. ä¸ºä»€ä¹ˆéœ€è¦ Redis Clusterï¼Ÿè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ
2. Redis Cluster æ˜¯å¦‚ä½•åˆ†ç‰‡çš„ï¼Ÿ
3. ä¸ºä»€ä¹ˆ Redis Cluster çš„å“ˆå¸Œæ§½æ˜¯ 16384 ä¸ªï¼Ÿ
4. å¦‚ä½•ç¡®å®šç»™å®š key çš„åº”è¯¥åˆ†å¸ƒåˆ°å“ªä¸ªå“ˆå¸Œæ§½ä¸­ï¼Ÿ
5. Redis Cluster æ”¯æŒé‡æ–°åˆ†é…å“ˆå¸Œæ§½å—ï¼Ÿ
6. Redis Cluster æ‰©å®¹ç¼©å®¹æœŸé—´å¯ä»¥æä¾›æœåŠ¡å—ï¼Ÿ
7. Redis Cluster ä¸­çš„èŠ‚ç‚¹æ˜¯æ€ä¹ˆè¿›è¡Œé€šä¿¡çš„ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š[Redis é›†ç¾¤è¯¦è§£ï¼ˆä»˜è´¹ï¼‰](https://javaguide.cn/database/redis/redis-cluster.html)ã€‚

## Redis ä½¿ç”¨è§„èŒƒ

å®é™…ä½¿ç”¨ Redis çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°½é‡è¦å‡†å®ˆä¸€äº›å¸¸è§çš„è§„èŒƒï¼Œæ¯”å¦‚ï¼š

1. ä½¿ç”¨è¿æ¥æ± ï¼šé¿å…é¢‘ç¹åˆ›å»ºå…³é—­å®¢æˆ·ç«¯è¿æ¥ã€‚
2. å°½é‡ä¸ä½¿ç”¨ O(n) æŒ‡ä»¤ï¼Œä½¿ç”¨ O(n) å‘½ä»¤æ—¶è¦å…³æ³¨ n çš„æ•°é‡ï¼šåƒ `KEYS *`ã€`HGETALL`ã€`LRANGE`ã€`SMEMBERS`ã€`SINTER`/`SUNION`/`SDIFF` ç­‰ O(n) å‘½ä»¤å¹¶éä¸èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯éœ€è¦æ˜ç¡® n çš„å€¼ã€‚å¦å¤–ï¼Œæœ‰éå†çš„éœ€æ±‚å¯ä»¥ä½¿ç”¨ `HSCAN`ã€`SSCAN`ã€`ZSCAN` ä»£æ›¿ã€‚
3. ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œä¼ è¾“ï¼šåŸç”Ÿæ‰¹é‡æ“ä½œå‘½ä»¤ï¼ˆæ¯”å¦‚ `MGET`ã€`MSET` ç­‰ç­‰ï¼‰ã€pipelineã€Lua è„šæœ¬ã€‚
4. å°½é‡ä¸ä½¿ç”¨ Redis äº‹åŠ¡ï¼šRedis äº‹åŠ¡å®ç°çš„åŠŸèƒ½æ¯”è¾ƒé¸¡è‚‹ï¼Œå¯ä»¥ä½¿ç”¨ Lua è„šæœ¬ä»£æ›¿ã€‚
5. ç¦æ­¢é•¿æ—¶é—´å¼€å¯ monitorï¼šå¯¹æ€§èƒ½å½±å“æ¯”è¾ƒå¤§ã€‚
6. æ§åˆ¶ key çš„ç”Ÿå‘½å‘¨æœŸï¼šé¿å… Redis ä¸­å­˜æ”¾äº†å¤ªå¤šä¸ç»å¸¸è¢«è®¿é—®çš„æ•°æ®ã€‚
7. â€¦â€¦

<!-- @include: @article-footer.snippet.md -->

