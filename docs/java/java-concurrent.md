---
title: Javaå¹¶å‘å¸¸è§é¢è¯•é¢˜æ€»ç»“
description: Javaå¹¶å‘ç¼–ç¨‹æ ¸å¿ƒçŸ¥è¯†ç‚¹ä¸é«˜é¢‘é¢è¯•é¢˜æ€»ç»“ï¼šæ¶µç›–çº¿ç¨‹ä¸è¿›ç¨‹ã€å¹¶å‘ä¸å¹¶è¡Œã€çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸã€æ­»é”ã€synchronizedã€ReentrantLockã€volatileã€ThreadLocalã€çº¿ç¨‹æ± ã€CASã€AQSç­‰é‡è¦æ¦‚å¿µä¸å®æˆ˜åº”ç”¨ã€‚
category: Java
tag:
  - Javaå¹¶å‘
head:
  - - meta
    - name: keywords
      content: Javaå¹¶å‘é¢è¯•é¢˜,çº¿ç¨‹å’Œè¿›ç¨‹,å¹¶å‘å’Œå¹¶è¡Œ,å¤šçº¿ç¨‹,æ­»é”,çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ,synchronized,ReentrantLock,volatile,ThreadLocal,çº¿ç¨‹æ± ,CAS,AQS,å¹¶å‘ç¼–ç¨‹,é”æœºåˆ¶
---

<!-- @include: @small-advertisement.snippet.md -->

## å‰è¨€

ç”±äºå¾ˆå¤šè¯»è€…éƒ½æœ‰çªå‡»é¢è¯•çš„éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘åœ¨å‡ å¹´å‰å°±å¼„äº† **JavaGuide é¢è¯•çªå‡»ç‰ˆæœ¬**ï¼ˆJavaGuide å†…å®¹ç²¾ç®€ç‰ˆï¼Œåªä¿ç•™é‡ç‚¹ï¼‰ï¼Œå¹¶æŒç»­å®Œå–„è·Ÿè¿›ã€‚å¯¹äºå–œæ¬¢çº¸è´¨é˜…è¯»çš„æœ‹å‹æ¥è¯´ï¼Œä¹Ÿå¯ä»¥æ‰“å°å‡ºæ¥ï¼Œæ•´ä½“é˜…è¯»ä½“éªŒéå¸¸é«˜ï¼

é™¤äº†åªä¿ç•™æœ€å¸¸é—®çš„é¢è¯•é¢˜ä¹‹å¤–ï¼Œæˆ‘è¿˜è¿›ä¸€æ­¥å¯¹é‡ç‚¹ä¸­çš„é‡ç‚¹è¿›è¡Œäº†â­ï¸æ ‡æ³¨ã€‚å¹¶ä¸”ï¼Œæœ‰äº®è‰²ï¼ˆç™½å¤©ï¼‰å’Œæš—è‰²ï¼ˆå¤œé—´ï¼‰ä¸¤ä¸ªä¸»é¢˜é€‰æ‹©ï¼Œéœ€è¦æ‰“å°å‡ºæ¥çš„æœ‹å‹è®°å¾—é€‰æ‹©äº®è‰²ç‰ˆæœ¬ã€‚

å¯¹äºæ—¶é—´æ¯”è¾ƒå……è£•çš„æœ‹å‹ï¼Œæˆ‘ä¸ªäººè¿˜æ˜¯æ›´æ¨è [JavaGuide](https://javaguide.cn/) ç½‘ç«™ç³»ç»Ÿå­¦ä¹ ï¼Œå†…å®¹æ›´å…¨é¢ï¼Œæ›´æ·±å…¥ã€‚

JavaGuide å·²ç»æŒç»­ç»´æŠ¤ 6 å¹´å¤šäº†ï¼Œç´¯è®¡æäº¤äº†æ¥è¿‘ **6000** commit ï¼Œå…±æœ‰ **570+** å¤šä½è´¡çŒ®è€…å…±åŒå‚ä¸ç»´æŠ¤å’Œå®Œå–„ã€‚ç”¨å¿ƒåšåŸåˆ›ä¼˜è´¨å†…å®¹ï¼Œå¦‚æœè§‰å¾—æœ‰å¸®åŠ©çš„è¯ï¼Œæ¬¢è¿ç‚¹èµåˆ†äº«ï¼ä¼ é€é—¨ï¼š[GitHub](https://github.com/Snailclimb/JavaGuide) | [Gitee](https://gitee.com/SnailClimb/JavaGuide)ã€‚

å¯¹äºéœ€è¦æ›´è¿›ä¸€æ­¥é¢è¯•è¾…å¯¼æœåŠ¡çš„è¯»è€…ï¼Œæ¬¢è¿åŠ å…¥ **[JavaGuide å®˜æ–¹çŸ¥è¯†æ˜Ÿçƒ](https://javaguide.cn/about-the-author/zhishixingqiu-two-years.html)**(æŠ€æœ¯ä¸“æ /ä¸€å¯¹ä¸€æé—®/ç®€å†ä¿®æ”¹/æ±‚èŒæŒ‡å—/é¢è¯•æ‰“å¡)ï¼Œç»å¯¹ç‰©è¶…æ‰€å€¼ï¼

é¢è¯•çªå‡»æœ€æ–°ç‰ˆæœ¬å¯ä»¥åœ¨æˆ‘çš„å…¬ä¼—å·å›å¤â€œ**PDF**â€è·å–ï¼ˆ[JavaGuide å®˜æ–¹çŸ¥è¯†æ˜Ÿçƒ](https://javaguide.cn/about-the-author/zhishixingqiu-two-years.html)ä¼šæå‰åŒæ­¥æœ€æ–°ç‰ˆï¼Œé’ˆå¯¹çƒå‹çš„ä¸€ä¸ªå°ç¦åˆ©ï¼‰ã€‚

![JavaGuide å®˜æ–¹å…¬ä¼—å·](https://oss.javaguide.cn/github/javaguide/gongzhonghaoxuanchuan.png)

è¿™éƒ¨åˆ†å†…å®¹æ‘˜è‡ª [JavaGuide](https://javaguide.cn/) ä¸‹é¢å‡ ç¯‡æ–‡ç« ä¸­çš„é‡ç‚¹ï¼š

- [Javaå¹¶å‘å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸Šï¼‰](https://javaguide.cn/java/concurrent/java-concurrent-questions-01.html)ï¼ˆå¤šçº¿ç¨‹åŸºç¡€çŸ¥è¯†ï¼Œä¾‹å¦‚çº¿ç¨‹å’Œè¿›ç¨‹çš„æ¦‚å¿µã€æ­»é”ï¼‰
- [Javaå¹¶å‘å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸­ï¼‰](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html)ï¼ˆå„ç§é”ï¼Œä¾‹å¦‚ä¹è§‚é”å’Œæ‚²è§‚é”ã€`synchronized`å…³é”®å­—ã€`ReentrantLock`ï¼‰
- [Javaå¹¶å‘å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸‹ï¼‰](https://javaguide.cn/java/concurrent/java-concurrent-questions-03.html)(`ThreadLocal`ã€çº¿ç¨‹æ± ã€`Future`ã€AQSã€è™šæ‹Ÿçº¿ç¨‹ç­‰)

## çº¿ç¨‹

### â­ï¸ä»€ä¹ˆæ˜¯çº¿ç¨‹å’Œè¿›ç¨‹?

#### ä½•ä¸ºè¿›ç¨‹?

è¿›ç¨‹æ˜¯ç¨‹åºçš„ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ï¼Œæ˜¯ç³»ç»Ÿè¿è¡Œç¨‹åºçš„åŸºæœ¬å•ä½ï¼Œå› æ­¤è¿›ç¨‹æ˜¯åŠ¨æ€çš„ã€‚ç³»ç»Ÿè¿è¡Œä¸€ä¸ªç¨‹åºå³æ˜¯ä¸€ä¸ªè¿›ç¨‹ä»åˆ›å»ºï¼Œè¿è¡Œåˆ°æ¶ˆäº¡çš„è¿‡ç¨‹ã€‚

åœ¨ Java ä¸­ï¼Œå½“æˆ‘ä»¬å¯åŠ¨ main å‡½æ•°æ—¶å…¶å®å°±æ˜¯å¯åŠ¨äº†ä¸€ä¸ª JVM çš„è¿›ç¨‹ï¼Œè€Œ main å‡½æ•°æ‰€åœ¨çš„çº¿ç¨‹å°±æ˜¯è¿™ä¸ªè¿›ç¨‹ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿç§°ä¸»çº¿ç¨‹ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨ Windows ä¸­é€šè¿‡æŸ¥çœ‹ä»»åŠ¡ç®¡ç†å™¨çš„æ–¹å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¸…æ¥šçœ‹åˆ° Windows å½“å‰è¿è¡Œçš„è¿›ç¨‹ï¼ˆ`.exe` æ–‡ä»¶çš„è¿è¡Œï¼‰ã€‚

![è¿›ç¨‹ç¤ºä¾‹å›¾ç‰‡-Windows](https://oss.javaguide.cn/github/javaguide/java/%E8%BF%9B%E7%A8%8B%E7%A4%BA%E4%BE%8B%E5%9B%BE%E7%89%87-Windows.png)

#### ä½•ä¸ºçº¿ç¨‹?

çº¿ç¨‹ä¸è¿›ç¨‹ç›¸ä¼¼ï¼Œä½†çº¿ç¨‹æ˜¯ä¸€ä¸ªæ¯”è¿›ç¨‹æ›´å°çš„æ‰§è¡Œå•ä½ã€‚ä¸€ä¸ªè¿›ç¨‹åœ¨å…¶æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å¯ä»¥äº§ç”Ÿå¤šä¸ªçº¿ç¨‹ã€‚ä¸è¿›ç¨‹ä¸åŒçš„æ˜¯åŒç±»çš„å¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„**å †**å’Œ**æ–¹æ³•åŒº**èµ„æºï¼Œä½†æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„**ç¨‹åºè®¡æ•°å™¨**ã€**è™šæ‹Ÿæœºæ ˆ**å’Œ**æœ¬åœ°æ–¹æ³•æ ˆ**ï¼Œæ‰€ä»¥ç³»ç»Ÿåœ¨äº§ç”Ÿä¸€ä¸ªçº¿ç¨‹ï¼Œæˆ–æ˜¯åœ¨å„ä¸ªçº¿ç¨‹ä¹‹é—´åšåˆ‡æ¢å·¥ä½œæ—¶ï¼Œè´Ÿæ‹…è¦æ¯”è¿›ç¨‹å°å¾—å¤šï¼Œä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼Œçº¿ç¨‹ä¹Ÿè¢«ç§°ä¸ºè½»é‡çº§è¿›ç¨‹ã€‚

Java ç¨‹åºå¤©ç”Ÿå°±æ˜¯å¤šçº¿ç¨‹ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ JMX æ¥çœ‹çœ‹ä¸€ä¸ªæ™®é€šçš„ Java ç¨‹åºæœ‰å“ªäº›çº¿ç¨‹ï¼Œä»£ç å¦‚ä¸‹ã€‚

```java
public class MultiThread {
	public static void main(String[] args) {
		// è·å– Java çº¿ç¨‹ç®¡ç† MXBean
	ThreadMXBean threadMXBean = ManagementFactory.getThreadMXBean();
		// ä¸éœ€è¦è·å–åŒæ­¥çš„ monitor å’Œ synchronizer ä¿¡æ¯ï¼Œä»…è·å–çº¿ç¨‹å’Œçº¿ç¨‹å †æ ˆä¿¡æ¯
		ThreadInfo[] threadInfos = threadMXBean.dumpAllThreads(false, false);
		// éå†çº¿ç¨‹ä¿¡æ¯ï¼Œä»…æ‰“å°çº¿ç¨‹ ID å’Œçº¿ç¨‹åç§°ä¿¡æ¯
		for (ThreadInfo threadInfo : threadInfos) {
			System.out.println("[" + threadInfo.getThreadId() + "] " + threadInfo.getThreadName());
		}
	}
}
```

ä¸Šè¿°ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼ˆè¾“å‡ºå†…å®¹å¯èƒ½ä¸åŒï¼Œä¸ç”¨å¤ªçº ç»“ä¸‹é¢æ¯ä¸ªçº¿ç¨‹çš„ä½œç”¨ï¼Œåªç”¨çŸ¥é“ main çº¿ç¨‹æ‰§è¡Œ main æ–¹æ³•å³å¯ï¼‰ï¼š

```plain
[5] Attach Listener //æ·»åŠ äº‹ä»¶
[4] Signal Dispatcher // åˆ†å‘å¤„ç†ç»™ JVM ä¿¡å·çš„çº¿ç¨‹
[3] Finalizer //è°ƒç”¨å¯¹è±¡ finalize æ–¹æ³•çš„çº¿ç¨‹
[2] Reference Handler //æ¸…é™¤ reference çº¿ç¨‹
[1] main //main çº¿ç¨‹,ç¨‹åºå…¥å£
```

ä»ä¸Šé¢çš„è¾“å‡ºå†…å®¹å¯ä»¥çœ‹å‡ºï¼š**ä¸€ä¸ª Java ç¨‹åºçš„è¿è¡Œæ˜¯ main çº¿ç¨‹å’Œå¤šä¸ªå…¶ä»–çº¿ç¨‹åŒæ—¶è¿è¡Œ**ã€‚

### Java çº¿ç¨‹å’Œæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹æœ‰å•¥åŒºåˆ«ï¼Ÿ

JDK 1.2 ä¹‹å‰ï¼ŒJava çº¿ç¨‹æ˜¯åŸºäºç»¿è‰²çº¿ç¨‹ï¼ˆGreen Threadsï¼‰å®ç°çš„ï¼Œè¿™æ˜¯ä¸€ç§ç”¨æˆ·çº§çº¿ç¨‹ï¼ˆç”¨æˆ·çº¿ç¨‹ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ JVM è‡ªå·±æ¨¡æ‹Ÿäº†å¤šçº¿ç¨‹çš„è¿è¡Œï¼Œè€Œä¸ä¾èµ–äºæ“ä½œç³»ç»Ÿã€‚ç”±äºç»¿è‰²çº¿ç¨‹å’ŒåŸç”Ÿçº¿ç¨‹æ¯”èµ·æ¥åœ¨ä½¿ç”¨æ—¶æœ‰ä¸€äº›é™åˆ¶ï¼ˆæ¯”å¦‚ç»¿è‰²çº¿ç¨‹ä¸èƒ½ç›´æ¥ä½¿ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„åŠŸèƒ½å¦‚å¼‚æ­¥ I/Oã€åªèƒ½åœ¨ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ä¸Šè¿è¡Œæ— æ³•åˆ©ç”¨å¤šæ ¸ï¼‰ï¼Œåœ¨ JDK 1.2 åŠä»¥åï¼ŒJava çº¿ç¨‹æ”¹ä¸ºåŸºäºåŸç”Ÿçº¿ç¨‹ï¼ˆNative Threadsï¼‰å®ç°ï¼Œä¹Ÿå°±æ˜¯è¯´ JVM ç›´æ¥ä½¿ç”¨æ“ä½œç³»ç»ŸåŸç”Ÿçš„å†…æ ¸çº§çº¿ç¨‹ï¼ˆå†…æ ¸çº¿ç¨‹ï¼‰æ¥å®ç° Java çº¿ç¨‹ï¼Œç”±æ“ä½œç³»ç»Ÿå†…æ ¸è¿›è¡Œçº¿ç¨‹çš„è°ƒåº¦å’Œç®¡ç†ã€‚

æˆ‘ä»¬ä¸Šé¢æåˆ°äº†ç”¨æˆ·çº¿ç¨‹å’Œå†…æ ¸çº¿ç¨‹ï¼Œè€ƒè™‘åˆ°å¾ˆå¤šè¯»è€…ä¸å¤ªäº†è§£äºŒè€…çš„åŒºåˆ«ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ï¼š

- ç”¨æˆ·çº¿ç¨‹ï¼šç”±ç”¨æˆ·ç©ºé—´ç¨‹åºç®¡ç†å’Œè°ƒåº¦çš„çº¿ç¨‹ï¼Œè¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼ˆä¸“é—¨ç»™åº”ç”¨ç¨‹åºä½¿ç”¨ï¼‰ã€‚
- å†…æ ¸çº¿ç¨‹ï¼šç”±æ“ä½œç³»ç»Ÿå†…æ ¸ç®¡ç†å’Œè°ƒåº¦çš„çº¿ç¨‹ï¼Œè¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼ˆåªæœ‰å†…æ ¸ç¨‹åºå¯ä»¥è®¿é—®ï¼‰ã€‚

é¡ºä¾¿ç®€å•æ€»ç»“ä¸€ä¸‹ç”¨æˆ·çº¿ç¨‹å’Œå†…æ ¸çº¿ç¨‹çš„åŒºåˆ«å’Œç‰¹ç‚¹ï¼šç”¨æˆ·çº¿ç¨‹åˆ›å»ºå’Œåˆ‡æ¢æˆæœ¬ä½ï¼Œä½†ä¸å¯ä»¥åˆ©ç”¨å¤šæ ¸ã€‚å†…æ ¸æ€çº¿ç¨‹ï¼Œåˆ›å»ºå’Œåˆ‡æ¢æˆæœ¬é«˜ï¼Œå¯ä»¥åˆ©ç”¨å¤šæ ¸ã€‚

ä¸€å¥è¯æ¦‚æ‹¬ Java çº¿ç¨‹å’Œæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„å…³ç³»ï¼š**ç°åœ¨çš„ Java çº¿ç¨‹çš„æœ¬è´¨å…¶å®å°±æ˜¯æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹**ã€‚

çº¿ç¨‹æ¨¡å‹æ˜¯ç”¨æˆ·çº¿ç¨‹å’Œå†…æ ¸çº¿ç¨‹ä¹‹é—´çš„å…³è”æ–¹å¼ï¼Œå¸¸è§çš„çº¿ç¨‹æ¨¡å‹æœ‰è¿™ä¸‰ç§ï¼š

1. ä¸€å¯¹ä¸€ï¼ˆä¸€ä¸ªç”¨æˆ·çº¿ç¨‹å¯¹åº”ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼‰
2. å¤šå¯¹ä¸€ï¼ˆå¤šä¸ªç”¨æˆ·çº¿ç¨‹æ˜ å°„åˆ°ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼‰
3. å¤šå¯¹å¤šï¼ˆå¤šä¸ªç”¨æˆ·çº¿ç¨‹æ˜ å°„åˆ°å¤šä¸ªå†…æ ¸çº¿ç¨‹ï¼‰

![å¸¸è§çš„ä¸‰ç§çº¿ç¨‹æ¨¡å‹](https://oss.javaguide.cn/github/javaguide/java/concurrent/three-types-of-thread-models.png)

åœ¨ Windows å’Œ Linux ç­‰ä¸»æµæ“ä½œç³»ç»Ÿä¸­ï¼ŒJava çº¿ç¨‹é‡‡ç”¨çš„æ˜¯ä¸€å¯¹ä¸€çš„çº¿ç¨‹æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª Java çº¿ç¨‹å¯¹åº”ä¸€ä¸ªç³»ç»Ÿå†…æ ¸çº¿ç¨‹ã€‚Solaris ç³»ç»Ÿæ˜¯ä¸€ä¸ªç‰¹ä¾‹ï¼ˆSolaris ç³»ç»Ÿæœ¬èº«å°±æ”¯æŒå¤šå¯¹å¤šçš„çº¿ç¨‹æ¨¡å‹ï¼‰ï¼ŒHotSpot VM åœ¨ Solaris ä¸Šæ”¯æŒå¤šå¯¹å¤šå’Œä¸€å¯¹ä¸€ã€‚å…·ä½“å¯ä»¥å‚è€ƒ R å¤§çš„å›ç­”: [JVM ä¸­çš„çº¿ç¨‹æ¨¡å‹æ˜¯ç”¨æˆ·çº§çš„ä¹ˆï¼Ÿ](https://www.zhihu.com/question/23096638/answer/29617153)ã€‚

### â­ï¸è¯·ç®€è¦æè¿°çº¿ç¨‹ä¸è¿›ç¨‹çš„å…³ç³»,åŒºåˆ«åŠä¼˜ç¼ºç‚¹ï¼Ÿ

ä¸‹å›¾æ˜¯ Java å†…å­˜åŒºåŸŸï¼Œé€šè¿‡ä¸‹å›¾æˆ‘ä»¬ä» JVM çš„è§’åº¦æ¥è¯´ä¸€ä¸‹çº¿ç¨‹å’Œè¿›ç¨‹ä¹‹é—´çš„å…³ç³»ã€‚

![Java è¿è¡Œæ—¶æ•°æ®åŒºåŸŸï¼ˆJDK1.8 ä¹‹åï¼‰](https://oss.javaguide.cn/github/javaguide/java/jvm/java-runtime-data-areas-jdk1.8.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼šä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„**å †**å’Œ**æ–¹æ³•åŒº (JDK1.8 ä¹‹åçš„å…ƒç©ºé—´)**èµ„æºï¼Œä½†æ˜¯æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„**ç¨‹åºè®¡æ•°å™¨**ã€**è™šæ‹Ÿæœºæ ˆ** å’Œ **æœ¬åœ°æ–¹æ³•æ ˆ**ã€‚

**æ€»ç»“ï¼š** çº¿ç¨‹æ˜¯è¿›ç¨‹åˆ’åˆ†æˆçš„æ›´å°çš„è¿è¡Œå•ä½ã€‚çº¿ç¨‹å’Œè¿›ç¨‹æœ€å¤§çš„ä¸åŒåœ¨äºåŸºæœ¬ä¸Šå„è¿›ç¨‹æ˜¯ç‹¬ç«‹çš„ï¼Œè€Œå„çº¿ç¨‹åˆ™ä¸ä¸€å®šï¼Œå› ä¸ºåŒä¸€è¿›ç¨‹ä¸­çš„çº¿ç¨‹ææœ‰å¯èƒ½ä¼šç›¸äº’å½±å“ã€‚çº¿ç¨‹æ‰§è¡Œå¼€é”€å°ï¼Œä½†ä¸åˆ©äºèµ„æºçš„ç®¡ç†å’Œä¿æŠ¤ï¼›è€Œè¿›ç¨‹æ­£ç›¸åã€‚

### å¦‚ä½•åˆ›å»ºçº¿ç¨‹ï¼Ÿ

ä¸€èˆ¬æ¥è¯´ï¼Œåˆ›å»ºçº¿ç¨‹æœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œä¾‹å¦‚ç»§æ‰¿`Thread`ç±»ã€å®ç°`Runnable`æ¥å£ã€å®ç°`Callable`æ¥å£ã€ä½¿ç”¨çº¿ç¨‹æ± ã€ä½¿ç”¨`CompletableFuture`ç±»ç­‰ç­‰ã€‚

ä¸è¿‡ï¼Œè¿™äº›æ–¹å¼å…¶å®å¹¶æ²¡æœ‰çœŸæ­£åˆ›å»ºå‡ºçº¿ç¨‹ã€‚å‡†ç¡®ç‚¹æ¥è¯´ï¼Œè¿™äº›éƒ½å±äºæ˜¯åœ¨ Java ä»£ç ä¸­ä½¿ç”¨å¤šçº¿ç¨‹çš„æ–¹æ³•ã€‚

ä¸¥æ ¼æ¥è¯´ï¼ŒJava å°±åªæœ‰ä¸€ç§æ–¹å¼å¯ä»¥åˆ›å»ºçº¿ç¨‹ï¼Œé‚£å°±æ˜¯é€šè¿‡`new Thread().start()`åˆ›å»ºã€‚ä¸ç®¡æ˜¯å“ªç§æ–¹å¼ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¾èµ–äº`new Thread().start()`ã€‚

å…³äºè¿™ä¸ªé—®é¢˜çš„è¯¦ç»†åˆ†æå¯ä»¥æŸ¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š[å¤§å®¶éƒ½è¯´ Java æœ‰ä¸‰ç§åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼ï¼å¹¶å‘ç¼–ç¨‹ä¸­çš„æƒŠå¤©éª—å±€ï¼](https://mp.weixin.qq.com/s/NspUsyhEmKnJ-4OprRFp9g)ã€‚

### â­ï¸è¯´è¯´çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå’ŒçŠ¶æ€?

Java çº¿ç¨‹åœ¨è¿è¡Œçš„ç”Ÿå‘½å‘¨æœŸä¸­çš„æŒ‡å®šæ—¶åˆ»åªå¯èƒ½å¤„äºä¸‹é¢ 6 ç§ä¸åŒçŠ¶æ€çš„å…¶ä¸­ä¸€ä¸ªçŠ¶æ€ï¼š

- NEW: åˆå§‹çŠ¶æ€ï¼Œçº¿ç¨‹è¢«åˆ›å»ºå‡ºæ¥ä½†æ²¡æœ‰è¢«è°ƒç”¨ `start()` ã€‚
- RUNNABLE: è¿è¡ŒçŠ¶æ€ï¼Œçº¿ç¨‹è¢«è°ƒç”¨äº† `start()`ç­‰å¾…è¿è¡Œçš„çŠ¶æ€ã€‚
- BLOCKEDï¼šé˜»å¡çŠ¶æ€ï¼Œéœ€è¦ç­‰å¾…é”é‡Šæ”¾ã€‚
- WAITINGï¼šç­‰å¾…çŠ¶æ€ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹éœ€è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹åšå‡ºä¸€äº›ç‰¹å®šåŠ¨ä½œï¼ˆé€šçŸ¥æˆ–ä¸­æ–­ï¼‰ã€‚
- TIME_WAITINGï¼šè¶…æ—¶ç­‰å¾…çŠ¶æ€ï¼Œå¯ä»¥åœ¨æŒ‡å®šçš„æ—¶é—´åè‡ªè¡Œè¿”å›è€Œä¸æ˜¯åƒ WAITING é‚£æ ·ä¸€ç›´ç­‰å¾…ã€‚
- TERMINATEDï¼šç»ˆæ­¢çŠ¶æ€ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»è¿è¡Œå®Œæ¯•ã€‚

çº¿ç¨‹åœ¨ç”Ÿå‘½å‘¨æœŸä¸­å¹¶ä¸æ˜¯å›ºå®šå¤„äºæŸä¸€ä¸ªçŠ¶æ€è€Œæ˜¯éšç€ä»£ç çš„æ‰§è¡Œåœ¨ä¸åŒçŠ¶æ€ä¹‹é—´åˆ‡æ¢ã€‚

Java çº¿ç¨‹çŠ¶æ€å˜è¿å›¾(å›¾æºï¼š[æŒ‘é”™ |ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ä¸­å…³äºçº¿ç¨‹çŠ¶æ€çš„ä¸‰å¤„é”™è¯¯](https://mp.weixin.qq.com/s/0UTyrJpRKaKhkhHcQtXAiA))ï¼š

![Java çº¿ç¨‹çŠ¶æ€å˜è¿å›¾](https://oss.javaguide.cn/github/javaguide/java/concurrent/640.png)

ç”±ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼šçº¿ç¨‹åˆ›å»ºä¹‹åå®ƒå°†å¤„äº **NEWï¼ˆæ–°å»ºï¼‰** çŠ¶æ€ï¼Œè°ƒç”¨ `start()` æ–¹æ³•åå¼€å§‹è¿è¡Œï¼Œçº¿ç¨‹è¿™æ—¶å€™å¤„äº **READYï¼ˆå¯è¿è¡Œï¼‰** çŠ¶æ€ã€‚å¯è¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹è·å¾—äº† CPU æ—¶é—´ç‰‡ï¼ˆtimesliceï¼‰åå°±å¤„äº **RUNNINGï¼ˆè¿è¡Œï¼‰** çŠ¶æ€ã€‚

> åœ¨æ“ä½œç³»ç»Ÿå±‚é¢ï¼Œçº¿ç¨‹æœ‰ READY å’Œ RUNNING çŠ¶æ€ï¼›è€Œåœ¨ JVM å±‚é¢ï¼Œåªèƒ½çœ‹åˆ° RUNNABLE çŠ¶æ€ï¼ˆå›¾æºï¼š[HowToDoInJava](https://howtodoinJava.com/ "HowToDoInJava")ï¼š[Java Thread Life Cycle and Thread States](https://howtodoinJava.com/Java/multi-threading/Java-thread-life-cycle-and-thread-states/ "Java Thread Life Cycle and Thread States")ï¼‰ï¼Œæ‰€ä»¥ Java ç³»ç»Ÿä¸€èˆ¬å°†è¿™ä¸¤ä¸ªçŠ¶æ€ç»Ÿç§°ä¸º **RUNNABLEï¼ˆè¿è¡Œä¸­ï¼‰** çŠ¶æ€ ã€‚
>
> **ä¸ºä»€ä¹ˆ JVM æ²¡æœ‰åŒºåˆ†è¿™ä¸¤ç§çŠ¶æ€å‘¢ï¼Ÿ** ï¼ˆæ‘˜è‡ªï¼š[Java çº¿ç¨‹è¿è¡Œæ€ä¹ˆæœ‰ç¬¬å…­ç§çŠ¶æ€ï¼Ÿ - Dawell çš„å›ç­”](https://www.zhihu.com/question/56494969/answer/154053599) ï¼‰ ç°åœ¨çš„æ—¶åˆ†ï¼ˆtime-sharingï¼‰å¤šä»»åŠ¡ï¼ˆmulti-taskï¼‰æ“ä½œç³»ç»Ÿæ¶æ„é€šå¸¸éƒ½æ˜¯ç”¨æ‰€è°“çš„â€œæ—¶é—´åˆ†ç‰‡ï¼ˆtime quantum or time sliceï¼‰â€æ–¹å¼è¿›è¡ŒæŠ¢å å¼ï¼ˆpreemptiveï¼‰è½®è½¬è°ƒåº¦ï¼ˆround-robin å¼ï¼‰ã€‚è¿™ä¸ªæ—¶é—´åˆ†ç‰‡é€šå¸¸æ˜¯å¾ˆå°çš„ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡æœ€å¤šåªèƒ½åœ¨ CPU ä¸Šè¿è¡Œæ¯”å¦‚ 10-20ms çš„æ—¶é—´ï¼ˆæ­¤æ—¶å¤„äº running çŠ¶æ€ï¼‰ï¼Œä¹Ÿå³å¤§æ¦‚åªæœ‰ 0.01 ç§’è¿™ä¸€é‡çº§ï¼Œæ—¶é—´ç‰‡ç”¨åå°±è¦è¢«åˆ‡æ¢ä¸‹æ¥æ”¾å…¥è°ƒåº¦é˜Ÿåˆ—çš„æœ«å°¾ç­‰å¾…å†æ¬¡è°ƒåº¦ã€‚ï¼ˆä¹Ÿå³å›åˆ° ready çŠ¶æ€ï¼‰ã€‚çº¿ç¨‹åˆ‡æ¢çš„å¦‚æ­¤ä¹‹å¿«ï¼ŒåŒºåˆ†è¿™ä¸¤ç§çŠ¶æ€å°±æ²¡ä»€ä¹ˆæ„ä¹‰äº†ã€‚

![RUNNABLE-VS-RUNNING](https://oss.javaguide.cn/github/javaguide/java/RUNNABLE-VS-RUNNING.png)

- å½“çº¿ç¨‹æ‰§è¡Œ `wait()`æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹è¿›å…¥ **WAITINGï¼ˆç­‰å¾…ï¼‰** çŠ¶æ€ã€‚è¿›å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹éœ€è¦ä¾é å…¶ä»–çº¿ç¨‹çš„é€šçŸ¥æ‰èƒ½å¤Ÿè¿”å›åˆ°è¿è¡ŒçŠ¶æ€ã€‚
- **TIMED_WAITING(è¶…æ—¶ç­‰å¾…)** çŠ¶æ€ç›¸å½“äºåœ¨ç­‰å¾…çŠ¶æ€çš„åŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶é™åˆ¶ï¼Œæ¯”å¦‚é€šè¿‡ `sleepï¼ˆlong millisï¼‰`æ–¹æ³•æˆ– `waitï¼ˆlong millisï¼‰`æ–¹æ³•å¯ä»¥å°†çº¿ç¨‹ç½®äº TIMED_WAITING çŠ¶æ€ã€‚å½“è¶…æ—¶æ—¶é—´ç»“æŸåï¼Œçº¿ç¨‹å°†ä¼šè¿”å›åˆ° RUNNABLE çŠ¶æ€ã€‚
- å½“çº¿ç¨‹è¿›å…¥ `synchronized` æ–¹æ³•/å—æˆ–è€…è°ƒç”¨ `wait` åï¼ˆè¢« `notify`ï¼‰é‡æ–°è¿›å…¥ `synchronized` æ–¹æ³•/å—ï¼Œä½†æ˜¯é”è¢«å…¶å®ƒçº¿ç¨‹å æœ‰ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹å°±ä¼šè¿›å…¥ **BLOCKEDï¼ˆé˜»å¡ï¼‰** çŠ¶æ€ã€‚
- çº¿ç¨‹åœ¨æ‰§è¡Œå®Œäº† `run()`æ–¹æ³•ä¹‹åå°†ä¼šè¿›å…¥åˆ° **TERMINATEDï¼ˆç»ˆæ­¢ï¼‰** çŠ¶æ€ã€‚

### ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢?

çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šæœ‰è‡ªå·±çš„è¿è¡Œæ¡ä»¶å’ŒçŠ¶æ€ï¼ˆä¹Ÿç§°ä¸Šä¸‹æ–‡ï¼‰ï¼Œæ¯”å¦‚ä¸Šæ–‡æ‰€è¯´åˆ°è¿‡çš„ç¨‹åºè®¡æ•°å™¨ï¼Œæ ˆä¿¡æ¯ç­‰ã€‚å½“å‡ºç°å¦‚ä¸‹æƒ…å†µçš„æ—¶å€™ï¼Œçº¿ç¨‹ä¼šä»å ç”¨ CPU çŠ¶æ€ä¸­é€€å‡ºã€‚

- ä¸»åŠ¨è®©å‡º CPUï¼Œæ¯”å¦‚è°ƒç”¨äº† `sleep()`, `wait()` ç­‰ã€‚
- æ—¶é—´ç‰‡ç”¨å®Œï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿè¦é˜²æ­¢ä¸€ä¸ªçº¿ç¨‹æˆ–è€…è¿›ç¨‹é•¿æ—¶é—´å ç”¨ CPU å¯¼è‡´å…¶ä»–çº¿ç¨‹æˆ–è€…è¿›ç¨‹é¥¿æ­»ã€‚
- è°ƒç”¨äº†é˜»å¡ç±»å‹çš„ç³»ç»Ÿä¸­æ–­ï¼Œæ¯”å¦‚è¯·æ±‚ IOï¼Œçº¿ç¨‹è¢«é˜»å¡ã€‚
- è¢«ç»ˆæ­¢æˆ–ç»“æŸè¿è¡Œ

è¿™å…¶ä¸­å‰ä¸‰ç§éƒ½ä¼šå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹åˆ‡æ¢æ„å‘³ç€éœ€è¦ä¿å­˜å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œç•™å¾…çº¿ç¨‹ä¸‹æ¬¡å ç”¨ CPU çš„æ—¶å€™æ¢å¤ç°åœºã€‚å¹¶åŠ è½½ä¸‹ä¸€ä¸ªå°†è¦å ç”¨ CPU çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚è¿™å°±æ˜¯æ‰€è°“çš„ **ä¸Šä¸‹æ–‡åˆ‡æ¢**ã€‚

ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯ç°ä»£æ“ä½œç³»ç»Ÿçš„åŸºæœ¬åŠŸèƒ½ï¼Œå› å…¶æ¯æ¬¡éœ€è¦ä¿å­˜ä¿¡æ¯æ¢å¤ä¿¡æ¯ï¼Œè¿™å°†ä¼šå ç”¨ CPUï¼Œå†…å­˜ç­‰ç³»ç»Ÿèµ„æºè¿›è¡Œå¤„ç†ï¼Œä¹Ÿå°±æ„å‘³ç€æ•ˆç‡ä¼šæœ‰ä¸€å®šæŸè€—ï¼Œå¦‚æœé¢‘ç¹åˆ‡æ¢å°±ä¼šé€ æˆæ•´ä½“æ•ˆç‡ä½ä¸‹ã€‚

### Thread#sleep() æ–¹æ³•å’Œ Object#wait() æ–¹æ³•å¯¹æ¯”

**å…±åŒç‚¹**ï¼šä¸¤è€…éƒ½å¯ä»¥æš‚åœçº¿ç¨‹çš„æ‰§è¡Œã€‚

**åŒºåˆ«**ï¼š

- **`sleep()` æ–¹æ³•æ²¡æœ‰é‡Šæ”¾é”ï¼Œè€Œ `wait()` æ–¹æ³•é‡Šæ”¾äº†é”** ã€‚
- `wait()` é€šå¸¸è¢«ç”¨äºçº¿ç¨‹é—´äº¤äº’/é€šä¿¡ï¼Œ`sleep()`é€šå¸¸è¢«ç”¨äºæš‚åœæ‰§è¡Œã€‚
- `wait()` æ–¹æ³•è¢«è°ƒç”¨åï¼Œçº¿ç¨‹ä¸ä¼šè‡ªåŠ¨è‹é†’ï¼Œéœ€è¦åˆ«çš„çº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡ä¸Šçš„ `notify()`æˆ–è€… `notifyAll()` æ–¹æ³•ã€‚`sleep()`æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ `wait(long timeout)` è¶…æ—¶åçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ã€‚
- `sleep()` æ˜¯ `Thread` ç±»çš„é™æ€æœ¬åœ°æ–¹æ³•ï¼Œ`wait()` åˆ™æ˜¯ `Object` ç±»çš„æœ¬åœ°æ–¹æ³•ã€‚ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡å‘¢ï¼Ÿä¸‹ä¸€ä¸ªé—®é¢˜å°±ä¼šèŠåˆ°ã€‚

### ä¸ºä»€ä¹ˆ wait() æ–¹æ³•ä¸å®šä¹‰åœ¨ Thread ä¸­ï¼Ÿ

`wait()` æ˜¯è®©è·å¾—å¯¹è±¡é”çš„çº¿ç¨‹å®ç°ç­‰å¾…ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾å½“å‰çº¿ç¨‹å æœ‰çš„å¯¹è±¡é”ã€‚æ¯ä¸ªå¯¹è±¡ï¼ˆ`Object`ï¼‰éƒ½æ‹¥æœ‰å¯¹è±¡é”ï¼Œæ—¢ç„¶è¦é‡Šæ”¾å½“å‰çº¿ç¨‹å æœ‰çš„å¯¹è±¡é”å¹¶è®©å…¶è¿›å…¥ WAITING çŠ¶æ€ï¼Œè‡ªç„¶æ˜¯è¦æ“ä½œå¯¹åº”çš„å¯¹è±¡ï¼ˆ`Object`ï¼‰è€Œéå½“å‰çš„çº¿ç¨‹ï¼ˆ`Thread`ï¼‰ã€‚

ç±»ä¼¼çš„é—®é¢˜ï¼š**ä¸ºä»€ä¹ˆ `sleep()` æ–¹æ³•å®šä¹‰åœ¨ `Thread` ä¸­ï¼Ÿ**

å› ä¸º `sleep()` æ˜¯è®©å½“å‰çº¿ç¨‹æš‚åœæ‰§è¡Œï¼Œä¸æ¶‰åŠåˆ°å¯¹è±¡ç±»ï¼Œä¹Ÿä¸éœ€è¦è·å¾—å¯¹è±¡é”ã€‚

### å¯ä»¥ç›´æ¥è°ƒç”¨ Thread ç±»çš„ run æ–¹æ³•å—ï¼Ÿ

è¿™æ˜¯å¦ä¸€ä¸ªéå¸¸ç»å…¸çš„ Java å¤šçº¿ç¨‹é¢è¯•é—®é¢˜ï¼Œè€Œä¸”åœ¨é¢è¯•ä¸­ä¼šç»å¸¸è¢«é—®åˆ°ã€‚å¾ˆç®€å•ï¼Œä½†æ˜¯å¾ˆå¤šäººéƒ½ä¼šç­”ä¸ä¸Šæ¥ï¼

new ä¸€ä¸ª `Thread`ï¼Œçº¿ç¨‹è¿›å…¥äº†æ–°å»ºçŠ¶æ€ã€‚è°ƒç”¨ `start()`æ–¹æ³•ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å¹¶ä½¿çº¿ç¨‹è¿›å…¥äº†å°±ç»ªçŠ¶æ€ï¼Œå½“åˆ†é…åˆ°æ—¶é—´ç‰‡åå°±å¯ä»¥å¼€å§‹è¿è¡Œäº†ã€‚ `start()` ä¼šæ‰§è¡Œçº¿ç¨‹çš„ç›¸åº”å‡†å¤‡å·¥ä½œï¼Œç„¶åè‡ªåŠ¨æ‰§è¡Œ `run()` æ–¹æ³•çš„å†…å®¹ï¼Œè¿™æ˜¯çœŸæ­£çš„å¤šçº¿ç¨‹å·¥ä½œã€‚ ä½†æ˜¯ï¼Œç›´æ¥æ‰§è¡Œ `run()` æ–¹æ³•ï¼Œä¼šæŠŠ `run()` æ–¹æ³•å½“æˆä¸€ä¸ª main çº¿ç¨‹ä¸‹çš„æ™®é€šæ–¹æ³•å»æ‰§è¡Œï¼Œå¹¶ä¸ä¼šåœ¨æŸä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œå®ƒï¼Œæ‰€ä»¥è¿™å¹¶ä¸æ˜¯å¤šçº¿ç¨‹å·¥ä½œã€‚

**æ€»ç»“ï¼šè°ƒç”¨ `start()` æ–¹æ³•æ–¹å¯å¯åŠ¨çº¿ç¨‹å¹¶ä½¿çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œç›´æ¥æ‰§è¡Œ `run()` æ–¹æ³•çš„è¯ä¸ä¼šä»¥å¤šçº¿ç¨‹çš„æ–¹å¼æ‰§è¡Œã€‚**

## å¤šçº¿ç¨‹

### å¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«

- **å¹¶å‘**ï¼šä¸¤ä¸ªåŠä¸¤ä¸ªä»¥ä¸Šçš„ä½œä¸šåœ¨åŒä¸€ **æ—¶é—´æ®µ** å†…æ‰§è¡Œã€‚
- **å¹¶è¡Œ**ï¼šä¸¤ä¸ªåŠä¸¤ä¸ªä»¥ä¸Šçš„ä½œä¸šåœ¨åŒä¸€ **æ—¶åˆ»** æ‰§è¡Œã€‚

æœ€å…³é”®çš„ç‚¹æ˜¯ï¼šæ˜¯å¦æ˜¯ **åŒæ—¶** æ‰§è¡Œã€‚

### åŒæ­¥å’Œå¼‚æ­¥çš„åŒºåˆ«

- **åŒæ­¥**ï¼šå‘å‡ºä¸€ä¸ªè°ƒç”¨ä¹‹åï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œ è¯¥è°ƒç”¨å°±ä¸å¯ä»¥è¿”å›ï¼Œä¸€ç›´ç­‰å¾…ã€‚
- **å¼‚æ­¥**ï¼šè°ƒç”¨åœ¨å‘å‡ºä¹‹åï¼Œä¸ç”¨ç­‰å¾…è¿”å›ç»“æœï¼Œè¯¥è°ƒç”¨ç›´æ¥è¿”å›ã€‚

### â­ï¸ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº¿ç¨‹?

å…ˆä»æ€»ä½“ä¸Šæ¥è¯´ï¼š

- **ä»è®¡ç®—æœºåº•å±‚æ¥è¯´ï¼š** çº¿ç¨‹å¯ä»¥æ¯”ä½œæ˜¯è½»é‡çº§çš„è¿›ç¨‹ï¼Œæ˜¯ç¨‹åºæ‰§è¡Œçš„æœ€å°å•ä½ï¼Œçº¿ç¨‹é—´çš„åˆ‡æ¢å’Œè°ƒåº¦çš„æˆæœ¬è¿œè¿œå°äºè¿›ç¨‹ã€‚å¦å¤–ï¼Œå¤šæ ¸ CPU æ—¶ä»£æ„å‘³ç€å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¿è¡Œï¼Œè¿™å‡å°‘äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚
- **ä»å½“ä»£äº’è”ç½‘å‘å±•è¶‹åŠ¿æ¥è¯´ï¼š** ç°åœ¨çš„ç³»ç»ŸåŠ¨ä¸åŠ¨å°±è¦æ±‚ç™¾ä¸‡çº§ç”šè‡³åƒä¸‡çº§çš„å¹¶å‘é‡ï¼Œè€Œå¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹æ­£æ˜¯å¼€å‘é«˜å¹¶å‘ç³»ç»Ÿçš„åŸºç¡€ï¼Œåˆ©ç”¨å¥½å¤šçº¿ç¨‹æœºåˆ¶å¯ä»¥å¤§å¤§æé«˜ç³»ç»Ÿæ•´ä½“çš„å¹¶å‘èƒ½åŠ›ä»¥åŠæ€§èƒ½ã€‚

å†æ·±å…¥åˆ°è®¡ç®—æœºåº•å±‚æ¥æ¢è®¨ï¼š

- **å•æ ¸æ—¶ä»£**ï¼šåœ¨å•æ ¸æ—¶ä»£å¤šçº¿ç¨‹ä¸»è¦æ˜¯ä¸ºäº†æé«˜å•è¿›ç¨‹åˆ©ç”¨ CPU å’Œ IO ç³»ç»Ÿçš„æ•ˆç‡ã€‚ å‡è®¾åªè¿è¡Œäº†ä¸€ä¸ª Java è¿›ç¨‹çš„æƒ…å†µï¼Œå½“æˆ‘ä»¬è¯·æ±‚ IO çš„æ—¶å€™ï¼Œå¦‚æœ Java è¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ­¤çº¿ç¨‹è¢« IO é˜»å¡åˆ™æ•´ä¸ªè¿›ç¨‹è¢«é˜»å¡ã€‚CPU å’Œ IO è®¾å¤‡åªæœ‰ä¸€ä¸ªåœ¨è¿è¡Œï¼Œé‚£ä¹ˆå¯ä»¥ç®€å•åœ°è¯´ç³»ç»Ÿæ•´ä½“æ•ˆç‡åªæœ‰ 50%ã€‚å½“ä½¿ç”¨å¤šçº¿ç¨‹çš„æ—¶å€™ï¼Œä¸€ä¸ªçº¿ç¨‹è¢« IO é˜»å¡ï¼Œå…¶ä»–çº¿ç¨‹è¿˜å¯ä»¥ç»§ç»­ä½¿ç”¨ CPUã€‚ä»è€Œæé«˜äº† Java è¿›ç¨‹åˆ©ç”¨ç³»ç»Ÿèµ„æºçš„æ•´ä½“æ•ˆç‡ã€‚
- **å¤šæ ¸æ—¶ä»£**: å¤šæ ¸æ—¶ä»£å¤šçº¿ç¨‹ä¸»è¦æ˜¯ä¸ºäº†æé«˜è¿›ç¨‹åˆ©ç”¨å¤šæ ¸ CPU çš„èƒ½åŠ›ã€‚ä¸¾ä¸ªä¾‹å­ï¼šå‡å¦‚æˆ‘ä»¬è¦è®¡ç®—ä¸€ä¸ªå¤æ‚çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬åªç”¨ä¸€ä¸ªçº¿ç¨‹çš„è¯ï¼Œä¸è®ºç³»ç»Ÿæœ‰å‡ ä¸ª CPU æ ¸å¿ƒï¼Œéƒ½åªä¼šæœ‰ä¸€ä¸ª CPU æ ¸å¿ƒè¢«åˆ©ç”¨åˆ°ã€‚è€Œåˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹å¯ä»¥è¢«æ˜ å°„åˆ°åº•å±‚å¤šä¸ª CPU æ ¸å¿ƒä¸Šæ‰§è¡Œï¼Œåœ¨ä»»åŠ¡ä¸­çš„å¤šä¸ªçº¿ç¨‹æ²¡æœ‰èµ„æºç«äº‰çš„æƒ…å†µä¸‹ï¼Œä»»åŠ¡æ‰§è¡Œçš„æ•ˆç‡ä¼šæœ‰æ˜¾è‘—æ€§çš„æé«˜ï¼Œçº¦ç­‰äºï¼ˆå•æ ¸æ—¶æ‰§è¡Œæ—¶é—´/CPU æ ¸å¿ƒæ•°ï¼‰ã€‚

### â­ï¸å•æ ¸ CPU æ”¯æŒ Java å¤šçº¿ç¨‹å—ï¼Ÿ

å•æ ¸ CPU æ˜¯æ”¯æŒ Java å¤šçº¿ç¨‹çš„ã€‚æ“ä½œç³»ç»Ÿé€šè¿‡æ—¶é—´ç‰‡è½®è½¬çš„æ–¹å¼ï¼Œå°† CPU çš„æ—¶é—´åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ã€‚å°½ç®¡å•æ ¸ CPU ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œä½†é€šè¿‡å¿«é€Ÿåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´åˆ‡æ¢ï¼Œå¯ä»¥è®©ç”¨æˆ·æ„Ÿè§‰å¤šä¸ªä»»åŠ¡æ˜¯åŒæ—¶è¿›è¡Œçš„ã€‚

è¿™é‡Œé¡ºå¸¦æä¸€ä¸‹ Java ä½¿ç”¨çš„çº¿ç¨‹è°ƒåº¦æ–¹å¼ã€‚

æ“ä½œç³»ç»Ÿä¸»è¦é€šè¿‡ä¸¤ç§çº¿ç¨‹è°ƒåº¦æ–¹å¼æ¥ç®¡ç†å¤šçº¿ç¨‹çš„æ‰§è¡Œï¼š

- **æŠ¢å å¼è°ƒåº¦ï¼ˆPreemptive Schedulingï¼‰**ï¼šæ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶æš‚åœå½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œå¹¶åˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚è¿™ç§åˆ‡æ¢é€šå¸¸æ˜¯ç”±ç³»ç»Ÿæ—¶é’Ÿä¸­æ–­ï¼ˆæ—¶é—´ç‰‡è½®è½¬ï¼‰æˆ–å…¶ä»–é«˜ä¼˜å…ˆçº§äº‹ä»¶ï¼ˆå¦‚ I/O æ“ä½œå®Œæˆï¼‰è§¦å‘çš„ã€‚è¿™ç§æ–¹å¼å­˜åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼Œä½†å…¬å¹³æ€§å’Œ CPU èµ„æºåˆ©ç”¨ç‡è¾ƒå¥½ï¼Œä¸æ˜“é˜»å¡ã€‚
- **ååŒå¼è°ƒåº¦ï¼ˆCooperative Schedulingï¼‰**ï¼šçº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œä¸»åŠ¨é€šçŸ¥ç³»ç»Ÿåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™ç§æ–¹å¼å¯ä»¥å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢å¸¦æ¥çš„æ€§èƒ½å¼€é”€ï¼Œä½†å…¬å¹³æ€§è¾ƒå·®ï¼Œå®¹æ˜“é˜»å¡ã€‚

Java ä½¿ç”¨çš„çº¿ç¨‹è°ƒåº¦æ˜¯æŠ¢å å¼çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒJVM æœ¬èº«ä¸è´Ÿè´£çº¿ç¨‹çš„è°ƒåº¦ï¼Œè€Œæ˜¯å°†çº¿ç¨‹çš„è°ƒåº¦å§”æ‰˜ç»™æ“ä½œç³»ç»Ÿã€‚æ“ä½œç³»ç»Ÿé€šå¸¸ä¼šåŸºäºçº¿ç¨‹ä¼˜å…ˆçº§å’Œæ—¶é—´ç‰‡æ¥è°ƒåº¦çº¿ç¨‹çš„æ‰§è¡Œï¼Œé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹é€šå¸¸è·å¾— CPU æ—¶é—´ç‰‡çš„æœºä¼šæ›´å¤šã€‚

### â­ï¸å•æ ¸ CPU ä¸Šè¿è¡Œå¤šä¸ªçº¿ç¨‹æ•ˆç‡ä¸€å®šä¼šé«˜å—ï¼Ÿ

å•æ ¸ CPU åŒæ—¶è¿è¡Œå¤šä¸ªçº¿ç¨‹çš„æ•ˆç‡æ˜¯å¦ä¼šé«˜ï¼Œå–å†³äºçº¿ç¨‹çš„ç±»å‹å’Œä»»åŠ¡çš„æ€§è´¨ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæœ‰ä¸¤ç§ç±»å‹çš„çº¿ç¨‹ï¼š

1. **CPU å¯†é›†å‹**ï¼šCPU å¯†é›†å‹çš„çº¿ç¨‹ä¸»è¦è¿›è¡Œè®¡ç®—å’Œé€»è¾‘å¤„ç†ï¼Œéœ€è¦å ç”¨å¤§é‡çš„ CPU èµ„æºã€‚
2. **IO å¯†é›†å‹**ï¼šIO å¯†é›†å‹çš„çº¿ç¨‹ä¸»è¦è¿›è¡Œè¾“å…¥è¾“å‡ºæ“ä½œï¼Œå¦‚è¯»å†™æ–‡ä»¶ã€ç½‘ç»œé€šä¿¡ç­‰ï¼Œéœ€è¦ç­‰å¾… IO è®¾å¤‡çš„å“åº”ï¼Œè€Œä¸å ç”¨å¤ªå¤šçš„ CPU èµ„æºã€‚

åœ¨å•æ ¸ CPU ä¸Šï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡Œï¼Œå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾… CPU çš„æ—¶é—´ç‰‡åˆ†é…ã€‚å¦‚æœçº¿ç¨‹æ˜¯ CPU å¯†é›†å‹çš„ï¼Œé‚£ä¹ˆå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œä¼šå¯¼è‡´é¢‘ç¹çš„çº¿ç¨‹åˆ‡æ¢ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å¼€é”€ï¼Œé™ä½äº†æ•ˆç‡ã€‚å¦‚æœçº¿ç¨‹æ˜¯ IO å¯†é›†å‹çš„ï¼Œé‚£ä¹ˆå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œå¯ä»¥åˆ©ç”¨ CPU åœ¨ç­‰å¾… IO æ—¶çš„ç©ºé—²æ—¶é—´ï¼Œæé«˜äº†æ•ˆç‡ã€‚

å› æ­¤ï¼Œå¯¹äºå•æ ¸ CPU æ¥è¯´ï¼Œå¦‚æœä»»åŠ¡æ˜¯ CPU å¯†é›†å‹çš„ï¼Œé‚£ä¹ˆå¼€å¾ˆå¤šçº¿ç¨‹ä¼šå½±å“æ•ˆç‡ï¼›å¦‚æœä»»åŠ¡æ˜¯ IO å¯†é›†å‹çš„ï¼Œé‚£ä¹ˆå¼€å¾ˆå¤šçº¿ç¨‹ä¼šæé«˜æ•ˆç‡ã€‚å½“ç„¶ï¼Œè¿™é‡Œçš„â€œå¾ˆå¤šâ€ä¹Ÿè¦é€‚åº¦ï¼Œä¸èƒ½è¶…è¿‡ç³»ç»Ÿèƒ½å¤Ÿæ‰¿å—çš„ä¸Šé™ã€‚

### ä½¿ç”¨å¤šçº¿ç¨‹å¯èƒ½å¸¦æ¥ä»€ä¹ˆé—®é¢˜?

å¹¶å‘ç¼–ç¨‹çš„ç›®çš„å°±æ˜¯ä¸ºäº†èƒ½æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡è¿›è€Œæé«˜ç¨‹åºçš„è¿è¡Œé€Ÿåº¦ï¼Œä½†æ˜¯å¹¶å‘ç¼–ç¨‹å¹¶ä¸æ€»æ˜¯èƒ½æé«˜ç¨‹åºè¿è¡Œé€Ÿåº¦çš„ï¼Œè€Œä¸”å¹¶å‘ç¼–ç¨‹å¯èƒ½ä¼šé‡åˆ°å¾ˆå¤šé—®é¢˜ï¼Œæ¯”å¦‚ï¼šå†…å­˜æ³„æ¼ã€æ­»é”ã€çº¿ç¨‹ä¸å®‰å…¨ç­‰ç­‰ã€‚

### å¦‚ä½•ç†è§£çº¿ç¨‹å®‰å…¨å’Œä¸å®‰å…¨ï¼Ÿ

çº¿ç¨‹å®‰å…¨å’Œä¸å®‰å…¨æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹äºåŒä¸€ä»½æ•°æ®çš„è®¿é—®æ˜¯å¦èƒ½å¤Ÿä¿è¯å…¶æ­£ç¡®æ€§å’Œä¸€è‡´æ€§çš„æè¿°ã€‚

- çº¿ç¨‹å®‰å…¨æŒ‡çš„æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¯¹äºåŒä¸€ä»½æ•°æ®ï¼Œä¸ç®¡æœ‰å¤šå°‘ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œéƒ½èƒ½ä¿è¯è¿™ä»½æ•°æ®çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚
- çº¿ç¨‹ä¸å®‰å…¨åˆ™è¡¨ç¤ºåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¯¹äºåŒä¸€ä»½æ•°æ®ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æ—¶å¯èƒ½ä¼šå¯¼è‡´æ•°æ®æ··ä¹±ã€é”™è¯¯æˆ–è€…ä¸¢å¤±ã€‚

## â­ï¸æ­»é”

### ä»€ä¹ˆæ˜¯çº¿ç¨‹æ­»é”ï¼Ÿ

çº¿ç¨‹æ­»é”æè¿°çš„æ˜¯è¿™æ ·ä¸€ç§æƒ…å†µï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¢«é˜»å¡ï¼Œå®ƒä»¬ä¸­çš„ä¸€ä¸ªæˆ–è€…å…¨éƒ¨éƒ½åœ¨ç­‰å¾…æŸä¸ªèµ„æºè¢«é‡Šæ”¾ã€‚ç”±äºçº¿ç¨‹è¢«æ— é™æœŸåœ°é˜»å¡ï¼Œå› æ­¤ç¨‹åºä¸å¯èƒ½æ­£å¸¸ç»ˆæ­¢ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¿ç¨‹ A æŒæœ‰èµ„æº 2ï¼Œçº¿ç¨‹ B æŒæœ‰èµ„æº 1ï¼Œä»–ä»¬åŒæ—¶éƒ½æƒ³ç”³è¯·å¯¹æ–¹çš„èµ„æºï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šäº’ç›¸ç­‰å¾…è€Œè¿›å…¥æ­»é”çŠ¶æ€ã€‚

![çº¿ç¨‹æ­»é”ç¤ºæ„å›¾ ](https://oss.javaguide.cn/github/javaguide/java/2019-4%E6%AD%BB%E9%94%811.png)

ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜çº¿ç¨‹æ­»é”,ä»£ç æ¨¡æ‹Ÿäº†ä¸Šå›¾çš„æ­»é”çš„æƒ…å†µ (ä»£ç æ¥æºäºã€Šå¹¶å‘ç¼–ç¨‹ä¹‹ç¾ã€‹)ï¼š

```java
public class DeadLockDemo {
    private static Object resource1 = new Object();//èµ„æº 1
    private static Object resource2 = new Object();//èµ„æº 2

    public static void main(String[] args) {
        new Thread(() -> {
            synchronized (resource1) {
                System.out.println(Thread.currentThread() + "get resource1");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread() + "waiting get resource2");
                synchronized (resource2) {
                    System.out.println(Thread.currentThread() + "get resource2");
                }
            }
        }, "çº¿ç¨‹ 1").start();

        new Thread(() -> {
            synchronized (resource2) {
                System.out.println(Thread.currentThread() + "get resource2");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread() + "waiting get resource1");
                synchronized (resource1) {
                    System.out.println(Thread.currentThread() + "get resource1");
                }
            }
        }, "çº¿ç¨‹ 2").start();
    }
}
```

Output

```plain
Thread[çº¿ç¨‹ 1,5,main]get resource1
Thread[çº¿ç¨‹ 2,5,main]get resource2
Thread[çº¿ç¨‹ 1,5,main]waiting get resource2
Thread[çº¿ç¨‹ 2,5,main]waiting get resource1
```

çº¿ç¨‹ A é€šè¿‡ `synchronized (resource1)` è·å¾— `resource1` çš„ç›‘è§†å™¨é”ï¼Œç„¶åé€šè¿‡ `Thread.sleep(1000);` è®©çº¿ç¨‹ A ä¼‘çœ  1sï¼Œä¸ºçš„æ˜¯è®©çº¿ç¨‹ B å¾—åˆ°æ‰§è¡Œç„¶åè·å–åˆ° resource2 çš„ç›‘è§†å™¨é”ã€‚çº¿ç¨‹ A å’Œçº¿ç¨‹ B ä¼‘çœ ç»“æŸäº†éƒ½å¼€å§‹ä¼å›¾è¯·æ±‚è·å–å¯¹æ–¹çš„èµ„æºï¼Œç„¶åè¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šé™·å…¥äº’ç›¸ç­‰å¾…çš„çŠ¶æ€ï¼Œè¿™ä¹Ÿå°±äº§ç”Ÿäº†æ­»é”ã€‚

ä¸Šé¢çš„ä¾‹å­ç¬¦åˆäº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼š

1. **äº’æ–¥æ¡ä»¶**ï¼šè¯¥èµ„æºä»»æ„ä¸€ä¸ªæ—¶åˆ»åªç”±ä¸€ä¸ªçº¿ç¨‹å ç”¨ã€‚
2. **è¯·æ±‚ä¸ä¿æŒæ¡ä»¶**ï¼šä¸€ä¸ªçº¿ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚
3. **ä¸å‰¥å¤ºæ¡ä»¶**ï¼šçº¿ç¨‹å·²è·å¾—çš„èµ„æºåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹å¼ºè¡Œå‰¥å¤ºï¼Œåªæœ‰è‡ªå·±ä½¿ç”¨å®Œæ¯•åæ‰é‡Šæ”¾èµ„æºã€‚
4. **å¾ªç¯ç­‰å¾…æ¡ä»¶**ï¼šè‹¥å¹²çº¿ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚

### å¦‚ä½•æ£€æµ‹æ­»é”ï¼Ÿ

- ä½¿ç”¨`jmap`ã€`jstack`ç­‰å‘½ä»¤æŸ¥çœ‹ JVM çº¿ç¨‹æ ˆå’Œå †å†…å­˜çš„æƒ…å†µã€‚å¦‚æœæœ‰æ­»é”ï¼Œ`jstack` çš„è¾“å‡ºä¸­é€šå¸¸ä¼šæœ‰ `Found one Java-level deadlock:`çš„å­—æ ·ï¼Œåé¢ä¼šè·Ÿç€æ­»é”ç›¸å…³çš„çº¿ç¨‹ä¿¡æ¯ã€‚å¦å¤–ï¼Œå®é™…é¡¹ç›®ä¸­è¿˜å¯ä»¥æ­é…ä½¿ç”¨`top`ã€`df`ã€`free`ç­‰å‘½ä»¤æŸ¥çœ‹æ“ä½œç³»ç»Ÿçš„åŸºæœ¬æƒ…å†µï¼Œå‡ºç°æ­»é”å¯èƒ½ä¼šå¯¼è‡´ CPUã€å†…å­˜ç­‰èµ„æºæ¶ˆè€—è¿‡é«˜ã€‚
- é‡‡ç”¨ VisualVMã€JConsole ç­‰å·¥å…·è¿›è¡Œæ’æŸ¥ã€‚

è¿™é‡Œä»¥ JConsole å·¥å…·ä¸ºä¾‹è¿›è¡Œæ¼”ç¤ºã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ‰¾åˆ° JDK çš„ bin ç›®å½•ï¼Œæ‰¾åˆ° jconsole å¹¶åŒå‡»æ‰“å¼€ã€‚

![jconsole](https://oss.javaguide.cn/github/javaguide/java/concurrent/jdk-home-bin-jconsole.png)

å¯¹äº MAC ç”¨æˆ·æ¥è¯´ï¼Œå¯ä»¥é€šè¿‡ `/usr/libexec/java_home -V`æŸ¥çœ‹ JDK å®‰è£…ç›®å½•ï¼Œæ‰¾åˆ°åé€šè¿‡ `open . + æ–‡ä»¶å¤¹åœ°å€`æ‰“å¼€å³å¯ã€‚ä¾‹å¦‚ï¼Œæˆ‘æœ¬åœ°çš„æŸä¸ª JDK çš„è·¯å¾„æ˜¯ï¼š

```bash
 open . /Users/guide/Library/Java/JavaVirtualMachines/corretto-1.8.0_252/Contents/Home
```

æ‰“å¼€ jconsole åï¼Œè¿æ¥å¯¹åº”çš„ç¨‹åºï¼Œç„¶åè¿›å…¥çº¿ç¨‹ç•Œé¢é€‰æ‹©æ£€æµ‹æ­»é”å³å¯ï¼

![jconsole æ£€æµ‹æ­»é”](https://oss.javaguide.cn/github/javaguide/java/concurrent/jconsole-check-deadlock.png)

![jconsole æ£€æµ‹åˆ°æ­»é”](https://oss.javaguide.cn/github/javaguide/java/concurrent/jconsole-check-deadlock-done.png)

### å¦‚ä½•é¢„é˜²å’Œé¿å…çº¿ç¨‹æ­»é”?

**å¦‚ä½•é¢„é˜²æ­»é”ï¼Ÿ** ç ´åæ­»é”çš„äº§ç”Ÿçš„å¿…è¦æ¡ä»¶å³å¯ï¼š

1. **ç ´åè¯·æ±‚ä¸ä¿æŒæ¡ä»¶**ï¼šä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰çš„èµ„æºã€‚
2. **ç ´åä¸å‰¥å¤ºæ¡ä»¶**ï¼šå ç”¨éƒ¨åˆ†èµ„æºçš„çº¿ç¨‹è¿›ä¸€æ­¥ç”³è¯·å…¶ä»–èµ„æºæ—¶ï¼Œå¦‚æœç”³è¯·ä¸åˆ°ï¼Œå¯ä»¥ä¸»åŠ¨é‡Šæ”¾å®ƒå æœ‰çš„èµ„æºã€‚
3. **ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶**ï¼šé æŒ‰åºç”³è¯·èµ„æºæ¥é¢„é˜²ã€‚æŒ‰æŸä¸€é¡ºåºç”³è¯·èµ„æºï¼Œé‡Šæ”¾èµ„æºåˆ™ååºé‡Šæ”¾ã€‚ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶ã€‚

**å¦‚ä½•é¿å…æ­»é”ï¼Ÿ**

é¿å…æ­»é”å°±æ˜¯åœ¨èµ„æºåˆ†é…æ—¶ï¼Œå€ŸåŠ©äºç®—æ³•ï¼ˆæ¯”å¦‚é“¶è¡Œå®¶ç®—æ³•ï¼‰å¯¹èµ„æºåˆ†é…è¿›è¡Œè®¡ç®—è¯„ä¼°ï¼Œä½¿å…¶è¿›å…¥å®‰å…¨çŠ¶æ€ã€‚

> **å®‰å…¨çŠ¶æ€** æŒ‡çš„æ˜¯ç³»ç»Ÿèƒ½å¤ŸæŒ‰ç…§æŸç§çº¿ç¨‹æ¨è¿›é¡ºåºï¼ˆP1ã€P2ã€P3â€¦â€¦Pnï¼‰æ¥ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…æ‰€éœ€èµ„æºï¼Œç›´åˆ°æ»¡è¶³æ¯ä¸ªçº¿ç¨‹å¯¹èµ„æºçš„æœ€å¤§éœ€æ±‚ï¼Œä½¿æ¯ä¸ªçº¿ç¨‹éƒ½å¯é¡ºåˆ©å®Œæˆã€‚ç§° `<P1ã€P2ã€P3.....Pn>` åºåˆ—ä¸ºå®‰å…¨åºåˆ—ã€‚

æˆ‘ä»¬å¯¹çº¿ç¨‹ 2 çš„ä»£ç ä¿®æ”¹æˆä¸‹é¢è¿™æ ·å°±ä¸ä¼šäº§ç”Ÿæ­»é”äº†ã€‚

```java
new Thread(() -> {
            synchronized (resource1) {
                System.out.println(Thread.currentThread() + "get resource1");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread() + "waiting get resource2");
                synchronized (resource2) {
                    System.out.println(Thread.currentThread() + "get resource2");
                }
            }
        }, "çº¿ç¨‹ 2").start();
```

è¾“å‡ºï¼š

```plain
Thread[çº¿ç¨‹ 1,5,main]get resource1
Thread[çº¿ç¨‹ 1,5,main]waiting get resource2
Thread[çº¿ç¨‹ 1,5,main]get resource2
Thread[çº¿ç¨‹ 2,5,main]get resource1
Thread[çº¿ç¨‹ 2,5,main]waiting get resource2
Thread[çº¿ç¨‹ 2,5,main]get resource2

Process finished with exit code 0
```

æˆ‘ä»¬åˆ†æä¸€ä¸‹ä¸Šé¢çš„ä»£ç ä¸ºä»€ä¹ˆé¿å…äº†æ­»é”çš„å‘ç”Ÿ?

çº¿ç¨‹ 1 é¦–å…ˆè·å¾—åˆ° resource1 çš„ç›‘è§†å™¨é”,è¿™æ—¶å€™çº¿ç¨‹ 2 å°±è·å–ä¸åˆ°äº†ã€‚ç„¶åçº¿ç¨‹ 1 å†å»è·å– resource2 çš„ç›‘è§†å™¨é”ï¼Œå¯ä»¥è·å–åˆ°ã€‚ç„¶åçº¿ç¨‹ 1 é‡Šæ”¾äº†å¯¹ resource1ã€resource2 çš„ç›‘è§†å™¨é”çš„å ç”¨ï¼Œçº¿ç¨‹ 2 è·å–åˆ°å°±å¯ä»¥æ‰§è¡Œäº†ã€‚è¿™æ ·å°±ç ´åäº†å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼Œå› æ­¤é¿å…äº†æ­»é”ã€‚

## â­ï¸JMM(Java å†…å­˜æ¨¡å‹)

JMMï¼ˆJava å†…å­˜æ¨¡å‹ï¼‰ç›¸å…³çš„é—®é¢˜æ¯”è¾ƒå¤šï¼Œä¹Ÿæ¯”è¾ƒé‡è¦ï¼Œäºæ˜¯æˆ‘å•ç‹¬æŠ½äº†ä¸€ç¯‡æ–‡ç« æ¥æ€»ç»“ JMM ç›¸å…³çš„çŸ¥è¯†ç‚¹å’Œé—®é¢˜ï¼š[JMMï¼ˆJava å†…å­˜æ¨¡å‹ï¼‰è¯¦è§£](https://javaguide.cn/java/concurrent/jmm.html) ã€‚

## â­ï¸volatile å…³é”®å­—

### å¦‚ä½•ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Ÿ

åœ¨ Java ä¸­ï¼Œ`volatile` å…³é”®å­—å¯ä»¥ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Œå¦‚æœæˆ‘ä»¬å°†å˜é‡å£°æ˜ä¸º **`volatile`** ï¼Œè¿™å°±æŒ‡ç¤º JVMï¼Œè¿™ä¸ªå˜é‡æ˜¯å…±äº«ä¸”ä¸ç¨³å®šçš„ï¼Œæ¯æ¬¡ä½¿ç”¨å®ƒéƒ½åˆ°ä¸»å­˜ä¸­è¿›è¡Œè¯»å–ã€‚

![JMM(Java å†…å­˜æ¨¡å‹)](https://oss.javaguide.cn/github/javaguide/java/concurrent/jmm.png)

![JMM(Java å†…å­˜æ¨¡å‹)å¼ºåˆ¶åœ¨ä¸»å­˜ä¸­è¿›è¡Œè¯»å–](https://oss.javaguide.cn/github/javaguide/java/concurrent/jmm2.png)

`volatile` å…³é”®å­—å…¶å®å¹¶éæ˜¯ Java è¯­è¨€ç‰¹æœ‰çš„ï¼Œåœ¨ C è¯­è¨€é‡Œä¹Ÿæœ‰ï¼Œå®ƒæœ€åŸå§‹çš„æ„ä¹‰å°±æ˜¯ç¦ç”¨ CPU ç¼“å­˜ã€‚å¦‚æœæˆ‘ä»¬å°†ä¸€ä¸ªå˜é‡ä½¿ç”¨ `volatile` ä¿®é¥°ï¼Œè¿™å°±æŒ‡ç¤º ç¼–è¯‘å™¨ï¼Œè¿™ä¸ªå˜é‡æ˜¯å…±äº«ä¸”ä¸ç¨³å®šçš„ï¼Œæ¯æ¬¡ä½¿ç”¨å®ƒéƒ½åˆ°ä¸»å­˜ä¸­è¿›è¡Œè¯»å–ã€‚

`volatile` å…³é”®å­—èƒ½ä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯æ•°æ®çš„åŸå­æ€§ã€‚`synchronized` å…³é”®å­—ä¸¤è€…éƒ½èƒ½ä¿è¯ã€‚

### å¦‚ä½•ç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼Ÿ

**åœ¨ Java ä¸­ï¼Œ`volatile` å…³é”®å­—é™¤äº†å¯ä»¥ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ä½œç”¨å°±æ˜¯é˜²æ­¢ JVM çš„æŒ‡ä»¤é‡æ’åºã€‚** å¦‚æœæˆ‘ä»¬å°†å˜é‡å£°æ˜ä¸º **`volatile`** ï¼Œåœ¨å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œè¯»å†™æ“ä½œçš„æ—¶å€™ï¼Œä¼šé€šè¿‡æ’å…¥ç‰¹å®šçš„ **å†…å­˜å±éšœ** çš„æ–¹å¼æ¥ç¦æ­¢æŒ‡ä»¤é‡æ’åºã€‚

åœ¨ Java ä¸­ï¼Œ`Unsafe` ç±»æä¾›äº†ä¸‰ä¸ªå¼€ç®±å³ç”¨çš„å†…å­˜å±éšœç›¸å…³çš„æ–¹æ³•ï¼Œå±è”½äº†æ“ä½œç³»ç»Ÿåº•å±‚çš„å·®å¼‚ï¼š

```java
public native void loadFence();
public native void storeFence();
public native void fullFence();
```

ç†è®ºä¸Šæ¥è¯´ï¼Œä½ é€šè¿‡è¿™ä¸ªä¸‰ä¸ªæ–¹æ³•ä¹Ÿå¯ä»¥å®ç°å’Œ`volatile`ç¦æ­¢é‡æ’åºä¸€æ ·çš„æ•ˆæœï¼Œåªæ˜¯ä¼šéº»çƒ¦ä¸€äº›ã€‚

ä¸‹é¢æˆ‘ä»¥ä¸€ä¸ªå¸¸è§çš„é¢è¯•é¢˜ä¸ºä¾‹è®²è§£ä¸€ä¸‹ `volatile` å…³é”®å­—ç¦æ­¢æŒ‡ä»¤é‡æ’åºçš„æ•ˆæœã€‚

é¢è¯•ä¸­é¢è¯•å®˜ç»å¸¸ä¼šè¯´ï¼šâ€œå•ä¾‹æ¨¡å¼äº†è§£å—ï¼Ÿæ¥ç»™æˆ‘æ‰‹å†™ä¸€ä¸‹ï¼ç»™æˆ‘è§£é‡Šä¸€ä¸‹åŒé‡æ£€éªŒé”æ–¹å¼å®ç°å•ä¾‹æ¨¡å¼çš„åŸç†å‘—ï¼â€

**åŒé‡æ ¡éªŒé”å®ç°å¯¹è±¡å•ä¾‹ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰**ï¼š

```java
public class Singleton {

    private volatile static Singleton uniqueInstance;

    private Singleton() {
    }

    public static Singleton getUniqueInstance() {
       //å…ˆåˆ¤æ–­å¯¹è±¡æ˜¯å¦å·²ç»å®ä¾‹è¿‡ï¼Œæ²¡æœ‰å®ä¾‹åŒ–è¿‡æ‰è¿›å…¥åŠ é”ä»£ç 
        if (uniqueInstance == null) {
            //ç±»å¯¹è±¡åŠ é”
            synchronized (Singleton.class) {
                if (uniqueInstance == null) {
                    uniqueInstance = new Singleton();
                }
            }
        }
        return uniqueInstance;
    }
}
```

`uniqueInstance` é‡‡ç”¨ `volatile` å…³é”®å­—ä¿®é¥°ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œ `uniqueInstance = new Singleton();` è¿™æ®µä»£ç å…¶å®æ˜¯åˆ†ä¸ºä¸‰æ­¥æ‰§è¡Œï¼š

1. ä¸º `uniqueInstance` åˆ†é…å†…å­˜ç©ºé—´
2. åˆå§‹åŒ– `uniqueInstance`
3. å°† `uniqueInstance` æŒ‡å‘åˆ†é…çš„å†…å­˜åœ°å€

ä½†æ˜¯ç”±äº JVM å…·æœ‰æŒ‡ä»¤é‡æ’çš„ç‰¹æ€§ï¼Œæ‰§è¡Œé¡ºåºæœ‰å¯èƒ½å˜æˆ 1->3->2ã€‚æŒ‡ä»¤é‡æ’åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šå¯¼è‡´ä¸€ä¸ªçº¿ç¨‹è·å¾—è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œçº¿ç¨‹ T1 æ‰§è¡Œäº† 1 å’Œ 3ï¼Œæ­¤æ—¶ T2 è°ƒç”¨ `getUniqueInstance`() åå‘ç° `uniqueInstance` ä¸ä¸ºç©ºï¼Œå› æ­¤è¿”å› `uniqueInstance`ï¼Œä½†æ­¤æ—¶ `uniqueInstance` è¿˜æœªè¢«åˆå§‹åŒ–ã€‚

### volatile å¯ä»¥ä¿è¯åŸå­æ€§ä¹ˆï¼Ÿ

**`volatile` å…³é”®å­—èƒ½ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯å¯¹å˜é‡çš„æ“ä½œæ˜¯åŸå­æ€§çš„ã€‚**

æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„ä»£ç å³å¯è¯æ˜ï¼š

```java
/**
 * å¾®ä¿¡æœ JavaGuide å›å¤"é¢è¯•çªå‡»"å³å¯å…è´¹é¢†å–ä¸ªäººåŸåˆ›çš„ Java é¢è¯•æ‰‹å†Œ
 *
 * @author Guideå“¥
 * @date 2022/08/03 13:40
 **/
public class VolatileAtomicityDemo {
    public volatile static int inc = 0;

    public void increase() {
        inc++;
    }

    public static void main(String[] args) throws InterruptedException {
        ExecutorService threadPool = Executors.newFixedThreadPool(5);
        VolatileAtomicityDemo volatileAtomicityDemo = new VolatileAtomicityDemo();
        for (int i = 0; i < 5; i++) {
            threadPool.execute(() -> {
                for (int j = 0; j < 500; j++) {
                    volatileAtomicityDemo.increase();
                }
            });
        }
        // ç­‰å¾…1.5ç§’ï¼Œä¿è¯ä¸Šé¢ç¨‹åºæ‰§è¡Œå®Œæˆ
        Thread.sleep(1500);
        System.out.println(inc);
        threadPool.shutdown();
    }
}
```

æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿è¡Œä¸Šé¢çš„ä»£ç ç†åº”è¾“å‡º `2500`ã€‚ä½†ä½ çœŸæ­£è¿è¡Œäº†ä¸Šé¢çš„ä»£ç ä¹‹åï¼Œä½ ä¼šå‘ç°æ¯æ¬¡è¾“å‡ºç»“æœéƒ½å°äº `2500`ã€‚

ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿä¸æ˜¯è¯´å¥½äº†ï¼Œ`volatile` å¯ä»¥ä¿è¯å˜é‡çš„å¯è§æ€§å˜›ï¼

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ `volatile` èƒ½ä¿è¯ `inc++` æ“ä½œçš„åŸå­æ€§çš„è¯ã€‚æ¯ä¸ªçº¿ç¨‹ä¸­å¯¹ `inc` å˜é‡è‡ªå¢å®Œä¹‹åï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥ç«‹å³çœ‹åˆ°ä¿®æ”¹åçš„å€¼ã€‚5 ä¸ªçº¿ç¨‹åˆ†åˆ«è¿›è¡Œäº† 500 æ¬¡æ“ä½œï¼Œé‚£ä¹ˆæœ€ç»ˆ inc çš„å€¼åº”è¯¥æ˜¯ 5\*500=2500ã€‚

å¾ˆå¤šäººä¼šè¯¯è®¤ä¸ºè‡ªå¢æ“ä½œ `inc++` æ˜¯åŸå­æ€§çš„ï¼Œå®é™…ä¸Šï¼Œ`inc++` å…¶å®æ˜¯ä¸€ä¸ªå¤åˆæ“ä½œï¼ŒåŒ…æ‹¬ä¸‰æ­¥ï¼š

1. è¯»å– inc çš„å€¼ã€‚
2. å¯¹ inc åŠ  1ã€‚
3. å°† inc çš„å€¼å†™å›å†…å­˜ã€‚

`volatile` æ˜¯æ— æ³•ä¿è¯è¿™ä¸‰ä¸ªæ“ä½œæ˜¯å…·æœ‰åŸå­æ€§çš„ï¼Œæœ‰å¯èƒ½å¯¼è‡´ä¸‹é¢è¿™ç§æƒ…å†µå‡ºç°ï¼š

1. çº¿ç¨‹ 1 å¯¹ `inc` è¿›è¡Œè¯»å–æ“ä½œä¹‹åï¼Œè¿˜æœªå¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚çº¿ç¨‹ 2 åˆè¯»å–äº† `inc`çš„å€¼å¹¶å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼ˆ+1ï¼‰ï¼Œå†å°†`inc` çš„å€¼å†™å›å†…å­˜ã€‚
2. çº¿ç¨‹ 2 æ“ä½œå®Œæ¯•åï¼Œçº¿ç¨‹ 1 å¯¹ `inc`çš„å€¼è¿›è¡Œä¿®æ”¹ï¼ˆ+1ï¼‰ï¼Œå†å°†`inc` çš„å€¼å†™å›å†…å­˜ã€‚

è¿™ä¹Ÿå°±å¯¼è‡´ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«å¯¹ `inc` è¿›è¡Œäº†ä¸€æ¬¡è‡ªå¢æ“ä½œåï¼Œ`inc` å®é™…ä¸Šåªå¢åŠ äº† 1ã€‚

å…¶å®ï¼Œå¦‚æœæƒ³è¦ä¿è¯ä¸Šé¢çš„ä»£ç è¿è¡Œæ­£ç¡®ä¹Ÿéå¸¸ç®€å•ï¼Œåˆ©ç”¨ `synchronized`ã€`Lock`æˆ–è€…`AtomicInteger`éƒ½å¯ä»¥ã€‚

ä½¿ç”¨ `synchronized` æ”¹è¿›ï¼š

```java
public synchronized void increase() {
    inc++;
}
```

ä½¿ç”¨ `AtomicInteger` æ”¹è¿›ï¼š

```java
public AtomicInteger inc = new AtomicInteger();

public void increase() {
    inc.getAndIncrement();
}
```

ä½¿ç”¨ `ReentrantLock` æ”¹è¿›ï¼š

```java
Lock lock = new ReentrantLock();
public void increase() {
    lock.lock();
    try {
        inc++;
    } finally {
        lock.unlock();
    }
}
```

## â­ï¸ä¹è§‚é”å’Œæ‚²è§‚é”

### ä»€ä¹ˆæ˜¯æ‚²è§‚é”ï¼Ÿ

æ‚²è§‚é”æ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œè®¤ä¸ºå…±äº«èµ„æºæ¯æ¬¡è¢«è®¿é—®çš„æ—¶å€™å°±ä¼šå‡ºç°é—®é¢˜(æ¯”å¦‚å…±äº«æ•°æ®è¢«ä¿®æ”¹)ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨è·å–èµ„æºæ“ä½œçš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·å…¶ä»–çº¿ç¨‹æƒ³æ‹¿åˆ°è¿™ä¸ªèµ„æºå°±ä¼šé˜»å¡ç›´åˆ°é”è¢«ä¸Šä¸€ä¸ªæŒæœ‰è€…é‡Šæ”¾ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**å…±äº«èµ„æºæ¯æ¬¡åªç»™ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå…¶å®ƒçº¿ç¨‹é˜»å¡ï¼Œç”¨å®Œåå†æŠŠèµ„æºè½¬è®©ç»™å…¶å®ƒçº¿ç¨‹**ã€‚

åƒ Java ä¸­`synchronized`å’Œ`ReentrantLock`ç­‰ç‹¬å é”å°±æ˜¯æ‚²è§‚é”æ€æƒ³çš„å®ç°ã€‚

```java
public void performSynchronisedTask() {
    synchronized (this) {
        // éœ€è¦åŒæ­¥çš„æ“ä½œ
    }
}

private Lock lock = new ReentrantLock();
lock.lock();
try {
   // éœ€è¦åŒæ­¥çš„æ“ä½œ
} finally {
    lock.unlock();
}
```

é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œæ¿€çƒˆçš„é”ç«äº‰ä¼šé€ æˆçº¿ç¨‹é˜»å¡ï¼Œå¤§é‡é˜»å¡çº¿ç¨‹ä¼šå¯¼è‡´ç³»ç»Ÿçš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¢åŠ ç³»ç»Ÿçš„æ€§èƒ½å¼€é”€ã€‚å¹¶ä¸”ï¼Œæ‚²è§‚é”è¿˜å¯èƒ½ä¼šå­˜åœ¨æ­»é”é—®é¢˜ï¼Œå½±å“ä»£ç çš„æ­£å¸¸è¿è¡Œã€‚

### ä»€ä¹ˆæ˜¯ä¹è§‚é”ï¼Ÿ

ä¹è§‚é”æ€»æ˜¯å‡è®¾æœ€å¥½çš„æƒ…å†µï¼Œè®¤ä¸ºå…±äº«èµ„æºæ¯æ¬¡è¢«è®¿é—®çš„æ—¶å€™ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œçº¿ç¨‹å¯ä»¥ä¸åœåœ°æ‰§è¡Œï¼Œæ— éœ€åŠ é”ä¹Ÿæ— éœ€ç­‰å¾…ï¼Œåªæ˜¯åœ¨æäº¤ä¿®æ”¹çš„æ—¶å€™å»éªŒè¯å¯¹åº”çš„èµ„æºï¼ˆä¹Ÿå°±æ˜¯æ•°æ®ï¼‰æ˜¯å¦è¢«å…¶å®ƒçº¿ç¨‹ä¿®æ”¹äº†ï¼ˆå…·ä½“æ–¹æ³•å¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶æˆ– CAS ç®—æ³•ï¼‰ã€‚

åœ¨ Java ä¸­`java.util.concurrent.atomic`åŒ…ä¸‹é¢çš„åŸå­å˜é‡ç±»ï¼ˆæ¯”å¦‚`AtomicInteger`ã€`LongAdder`ï¼‰å°±æ˜¯ä½¿ç”¨äº†ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼ **CAS** å®ç°çš„ã€‚
![JUCåŸå­ç±»æ¦‚è§ˆ](https://oss.javaguide.cn/github/javaguide/java/JUC%E5%8E%9F%E5%AD%90%E7%B1%BB%E6%A6%82%E8%A7%88-20230814005211968.png)

```java
// LongAdder åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¼šæ¯” AtomicInteger å’Œ AtomicLong çš„æ€§èƒ½æ›´å¥½
// ä»£ä»·å°±æ˜¯ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ç©ºé—´ï¼ˆç©ºé—´æ¢æ—¶é—´ï¼‰
LongAdder sum = new LongAdder();
sum.increment();
```

é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œä¹è§‚é”ç›¸æ¯”æ‚²è§‚é”æ¥è¯´ï¼Œä¸å­˜åœ¨é”ç«äº‰é€ æˆçº¿ç¨‹é˜»å¡ï¼Œä¹Ÿä¸ä¼šæœ‰æ­»é”çš„é—®é¢˜ï¼Œåœ¨æ€§èƒ½ä¸Šå¾€å¾€ä¼šæ›´èƒœä¸€ç­¹ã€‚ä½†æ˜¯ï¼Œå¦‚æœå†²çªé¢‘ç¹å‘ç”Ÿï¼ˆå†™å æ¯”éå¸¸å¤šçš„æƒ…å†µï¼‰ï¼Œä¼šé¢‘ç¹å¤±è´¥å’Œé‡è¯•ï¼Œè¿™æ ·åŒæ ·ä¼šéå¸¸å½±å“æ€§èƒ½ï¼Œå¯¼è‡´ CPU é£™å‡ã€‚

ä¸è¿‡ï¼Œå¤§é‡å¤±è´¥é‡è¯•çš„é—®é¢˜ä¹Ÿæ˜¯å¯ä»¥è§£å†³çš„ï¼Œåƒæˆ‘ä»¬å‰é¢æåˆ°çš„ `LongAdder`ä»¥ç©ºé—´æ¢æ—¶é—´çš„æ–¹å¼å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚

ç†è®ºä¸Šæ¥è¯´ï¼š

- æ‚²è§‚é”é€šå¸¸å¤šç”¨äºå†™æ¯”è¾ƒå¤šçš„æƒ…å†µï¼ˆå¤šå†™åœºæ™¯ï¼Œç«äº‰æ¿€çƒˆï¼‰ï¼Œè¿™æ ·å¯ä»¥é¿å…é¢‘ç¹å¤±è´¥å’Œé‡è¯•å½±å“æ€§èƒ½ï¼Œæ‚²è§‚é”çš„å¼€é”€æ˜¯å›ºå®šçš„ã€‚ä¸è¿‡ï¼Œå¦‚æœä¹è§‚é”è§£å†³äº†é¢‘ç¹å¤±è´¥å’Œé‡è¯•è¿™ä¸ªé—®é¢˜çš„è¯ï¼ˆæ¯”å¦‚`LongAdder`ï¼‰ï¼Œä¹Ÿæ˜¯å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¹è§‚é”çš„ï¼Œè¦è§†å®é™…æƒ…å†µè€Œå®šã€‚
- ä¹è§‚é”é€šå¸¸å¤šç”¨äºå†™æ¯”è¾ƒå°‘çš„æƒ…å†µï¼ˆå¤šè¯»åœºæ™¯ï¼Œç«äº‰è¾ƒå°‘ï¼‰ï¼Œè¿™æ ·å¯ä»¥é¿å…é¢‘ç¹åŠ é”å½±å“æ€§èƒ½ã€‚ä¸è¿‡ï¼Œä¹è§‚é”ä¸»è¦é’ˆå¯¹çš„å¯¹è±¡æ˜¯å•ä¸ªå…±äº«å˜é‡ï¼ˆå‚è€ƒ`java.util.concurrent.atomic`åŒ…ä¸‹é¢çš„åŸå­å˜é‡ç±»ï¼‰ã€‚

### å¦‚ä½•å®ç°ä¹è§‚é”ï¼Ÿ

ä¹è§‚é”ä¸€èˆ¬ä¼šä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶æˆ– CAS ç®—æ³•å®ç°ï¼ŒCAS ç®—æ³•ç›¸å¯¹æ¥è¯´æ›´å¤šä¸€äº›ï¼Œè¿™é‡Œéœ€è¦æ ¼å¤–æ³¨æ„ã€‚

#### ç‰ˆæœ¬å·æœºåˆ¶

ä¸€èˆ¬æ˜¯åœ¨æ•°æ®è¡¨ä¸­åŠ ä¸Šä¸€ä¸ªæ•°æ®ç‰ˆæœ¬å· `version` å­—æ®µï¼Œè¡¨ç¤ºæ•°æ®è¢«ä¿®æ”¹çš„æ¬¡æ•°ã€‚å½“æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œ`version` å€¼ä¼šåŠ ä¸€ã€‚å½“çº¿ç¨‹ A è¦æ›´æ–°æ•°æ®å€¼æ—¶ï¼Œåœ¨è¯»å–æ•°æ®çš„åŒæ—¶ä¹Ÿä¼šè¯»å– `version` å€¼ï¼Œåœ¨æäº¤æ›´æ–°æ—¶ï¼Œè‹¥åˆšæ‰è¯»å–åˆ°çš„ version å€¼ä¸ºå½“å‰æ•°æ®åº“ä¸­çš„ `version` å€¼ç›¸ç­‰æ—¶æ‰æ›´æ–°ï¼Œå¦åˆ™é‡è¯•æ›´æ–°æ“ä½œï¼Œç›´åˆ°æ›´æ–°æˆåŠŸã€‚

**ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­**ï¼šå‡è®¾æ•°æ®åº“ä¸­å¸æˆ·ä¿¡æ¯è¡¨ä¸­æœ‰ä¸€ä¸ª version å­—æ®µï¼Œå½“å‰å€¼ä¸º 1 ï¼›è€Œå½“å‰å¸æˆ·ä½™é¢å­—æ®µï¼ˆ `balance` ï¼‰ä¸º \$100 ã€‚

1. æ“ä½œå‘˜ A æ­¤æ—¶å°†å…¶è¯»å‡ºï¼ˆ `version`=1 ï¼‰ï¼Œå¹¶ä»å…¶å¸æˆ·ä½™é¢ä¸­æ‰£é™¤ $50ï¼ˆ $100-\$50 ï¼‰ã€‚
2. åœ¨æ“ä½œå‘˜ A æ“ä½œçš„è¿‡ç¨‹ä¸­ï¼Œæ“ä½œå‘˜ B ä¹Ÿè¯»å…¥æ­¤ç”¨æˆ·ä¿¡æ¯ï¼ˆ `version`=1 ï¼‰ï¼Œå¹¶ä»å…¶å¸æˆ·ä½™é¢ä¸­æ‰£é™¤ $20 ï¼ˆ $100-\$20 ï¼‰ã€‚
3. æ“ä½œå‘˜ A å®Œæˆäº†ä¿®æ”¹å·¥ä½œï¼Œå°†æ•°æ®ç‰ˆæœ¬å·ï¼ˆ `version`=1 ï¼‰ï¼Œè¿åŒå¸æˆ·æ‰£é™¤åä½™é¢ï¼ˆ `balance`=\$50 ï¼‰ï¼Œæäº¤è‡³æ•°æ®åº“æ›´æ–°ï¼Œæ­¤æ—¶ç”±äºæäº¤æ•°æ®ç‰ˆæœ¬ç­‰äºæ•°æ®åº“è®°å½•å½“å‰ç‰ˆæœ¬ï¼Œæ•°æ®è¢«æ›´æ–°ï¼Œæ•°æ®åº“è®°å½• `version` æ›´æ–°ä¸º 2 ã€‚
4. æ“ä½œå‘˜ B å®Œæˆäº†æ“ä½œï¼Œä¹Ÿå°†ç‰ˆæœ¬å·ï¼ˆ `version`=1 ï¼‰è¯•å›¾å‘æ•°æ®åº“æäº¤æ•°æ®ï¼ˆ `balance`=\$80 ï¼‰ï¼Œä½†æ­¤æ—¶æ¯”å¯¹æ•°æ®åº“è®°å½•ç‰ˆæœ¬æ—¶å‘ç°ï¼Œæ“ä½œå‘˜ B æäº¤çš„æ•°æ®ç‰ˆæœ¬å·ä¸º 1 ï¼Œæ•°æ®åº“è®°å½•å½“å‰ç‰ˆæœ¬ä¹Ÿä¸º 2 ï¼Œä¸æ»¡è¶³ â€œ æäº¤ç‰ˆæœ¬å¿…é¡»ç­‰äºå½“å‰ç‰ˆæœ¬æ‰èƒ½æ‰§è¡Œæ›´æ–° â€œ çš„ä¹è§‚é”ç­–ç•¥ï¼Œå› æ­¤ï¼Œæ“ä½œå‘˜ B çš„æäº¤è¢«é©³å›ã€‚

è¿™æ ·å°±é¿å…äº†æ“ä½œå‘˜ B ç”¨åŸºäº `version`=1 çš„æ—§æ•°æ®ä¿®æ”¹çš„ç»“æœè¦†ç›–æ“ä½œå‘˜ A çš„æ“ä½œç»“æœçš„å¯èƒ½ã€‚

#### CAS ç®—æ³•

CAS çš„å…¨ç§°æ˜¯ **Compare And Swapï¼ˆæ¯”è¾ƒä¸äº¤æ¢ï¼‰** ï¼Œç”¨äºå®ç°ä¹è§‚é”ï¼Œè¢«å¹¿æ³›åº”ç”¨äºå„å¤§æ¡†æ¶ä¸­ã€‚CAS çš„æ€æƒ³å¾ˆç®€å•ï¼Œå°±æ˜¯ç”¨ä¸€ä¸ªé¢„æœŸå€¼å’Œè¦æ›´æ–°çš„å˜é‡å€¼è¿›è¡Œæ¯”è¾ƒï¼Œä¸¤å€¼ç›¸ç­‰æ‰ä¼šè¿›è¡Œæ›´æ–°ã€‚

CAS æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œåº•å±‚ä¾èµ–äºä¸€æ¡ CPU çš„åŸå­æŒ‡ä»¤ã€‚

> **åŸå­æ“ä½œ** å³æœ€å°ä¸å¯æ‹†åˆ†çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´æ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸èƒ½è¢«æ‰“æ–­ï¼Œç›´åˆ°æ“ä½œå®Œæˆã€‚

CAS æ¶‰åŠåˆ°ä¸‰ä¸ªæ“ä½œæ•°ï¼š

- **V**ï¼šè¦æ›´æ–°çš„å˜é‡å€¼(Var)
- **E**ï¼šé¢„æœŸå€¼(Expected)
- **N**ï¼šæ‹Ÿå†™å…¥çš„æ–°å€¼(New)

å½“ä¸”ä»…å½“ V çš„å€¼ç­‰äº E æ—¶ï¼ŒCAS é€šè¿‡åŸå­æ–¹å¼ç”¨æ–°å€¼ N æ¥æ›´æ–° V çš„å€¼ã€‚å¦‚æœä¸ç­‰ï¼Œè¯´æ˜å·²ç»æœ‰å…¶å®ƒçº¿ç¨‹æ›´æ–°äº† Vï¼Œåˆ™å½“å‰çº¿ç¨‹æ”¾å¼ƒæ›´æ–°ã€‚

**ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­**ï¼šçº¿ç¨‹ A è¦ä¿®æ”¹å˜é‡ i çš„å€¼ä¸º 6ï¼Œi åŸå€¼ä¸º 1ï¼ˆV = 1ï¼ŒE=1ï¼ŒN=6ï¼Œå‡è®¾ä¸å­˜åœ¨ ABA é—®é¢˜ï¼‰ã€‚

1. i ä¸ 1 è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ï¼Œ åˆ™è¯´æ˜æ²¡è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œå¯ä»¥è¢«è®¾ç½®ä¸º 6 ã€‚
2. i ä¸ 1 è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™è¯´æ˜è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œå½“å‰çº¿ç¨‹æ”¾å¼ƒæ›´æ–°ï¼ŒCAS æ“ä½œå¤±è´¥ã€‚

å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨ CAS æ“ä½œä¸€ä¸ªå˜é‡æ—¶ï¼Œåªæœ‰ä¸€ä¸ªä¼šèƒœå‡ºï¼Œå¹¶æˆåŠŸæ›´æ–°ï¼Œå…¶ä½™å‡ä¼šå¤±è´¥ï¼Œä½†å¤±è´¥çš„çº¿ç¨‹å¹¶ä¸ä¼šè¢«æŒ‚èµ·ï¼Œä»…æ˜¯è¢«å‘ŠçŸ¥å¤±è´¥ï¼Œå¹¶ä¸”å…è®¸å†æ¬¡å°è¯•ï¼Œå½“ç„¶ä¹Ÿå…è®¸å¤±è´¥çš„çº¿ç¨‹æ”¾å¼ƒæ“ä½œã€‚

Java è¯­è¨€å¹¶æ²¡æœ‰ç›´æ¥å®ç° CASï¼ŒCAS ç›¸å…³çš„å®ç°æ˜¯é€šè¿‡ C++ å†…è”æ±‡ç¼–çš„å½¢å¼å®ç°çš„ï¼ˆJNI è°ƒç”¨ï¼‰ã€‚å› æ­¤ï¼Œ CAS çš„å…·ä½“å®ç°å’Œæ“ä½œç³»ç»Ÿä»¥åŠ CPU éƒ½æœ‰å…³ç³»ã€‚

`sun.misc`åŒ…ä¸‹çš„`Unsafe`ç±»æä¾›äº†`compareAndSwapObject`ã€`compareAndSwapInt`ã€`compareAndSwapLong`æ–¹æ³•æ¥å®ç°çš„å¯¹`Object`ã€`int`ã€`long`ç±»å‹çš„ CAS æ“ä½œ

```java
/**
  *  CAS
  * @param o         åŒ…å«è¦ä¿®æ”¹fieldçš„å¯¹è±¡
  * @param offset    å¯¹è±¡ä¸­æŸfieldçš„åç§»é‡
  * @param expected  æœŸæœ›å€¼
  * @param update    æ›´æ–°å€¼
  * @return          true | false
  */
public final native boolean compareAndSwapObject(Object o, long offset,  Object expected, Object update);

public final native boolean compareAndSwapInt(Object o, long offset, int expected,int update);

public final native boolean compareAndSwapLong(Object o, long offset, long expected, long update);
```

å…³äº `Unsafe` ç±»çš„è¯¦ç»†ä»‹ç»å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š[Java é­”æ³•ç±» Unsafe è¯¦è§£ - JavaGuide - 2022](https://javaguide.cn/java/basis/unsafe.html) ã€‚

### Java ä¸­ CAS æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

åœ¨ Java ä¸­ï¼Œå®ç° CASï¼ˆCompare-And-Swap, æ¯”è¾ƒå¹¶äº¤æ¢ï¼‰æ“ä½œçš„ä¸€ä¸ªå…³é”®ç±»æ˜¯`Unsafe`ã€‚

`Unsafe`ç±»ä½äº`sun.misc`åŒ…ä¸‹ï¼Œæ˜¯ä¸€ä¸ªæä¾›ä½çº§åˆ«ã€ä¸å®‰å…¨æ“ä½œçš„ç±»ã€‚ç”±äºå…¶å¼ºå¤§çš„åŠŸèƒ½å’Œæ½œåœ¨çš„å±é™©æ€§ï¼Œå®ƒé€šå¸¸ç”¨äº JVM å†…éƒ¨æˆ–ä¸€äº›éœ€è¦æé«˜æ€§èƒ½å’Œåº•å±‚è®¿é—®çš„åº“ä¸­ï¼Œè€Œä¸æ¨èæ™®é€šå¼€å‘è€…åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚å…³äº `Unsafe`ç±»çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼šğŸ“Œ[Java é­”æ³•ç±» Unsafe è¯¦è§£](https://javaguide.cn/java/basis/unsafe.html)ã€‚

`sun.misc`åŒ…ä¸‹çš„`Unsafe`ç±»æä¾›äº†`compareAndSwapObject`ã€`compareAndSwapInt`ã€`compareAndSwapLong`æ–¹æ³•æ¥å®ç°çš„å¯¹`Object`ã€`int`ã€`long`ç±»å‹çš„ CAS æ“ä½œï¼š

```java
/**
 * ä»¥åŸå­æ–¹å¼æ›´æ–°å¯¹è±¡å­—æ®µçš„å€¼ã€‚
 *
 * @param o        è¦æ“ä½œçš„å¯¹è±¡
 * @param offset   å¯¹è±¡å­—æ®µçš„å†…å­˜åç§»é‡
 * @param expected æœŸæœ›çš„æ—§å€¼
 * @param x        è¦è®¾ç½®çš„æ–°å€¼
 * @return å¦‚æœå€¼è¢«æˆåŠŸæ›´æ–°ï¼Œåˆ™è¿”å› trueï¼›å¦åˆ™è¿”å› false
 */
boolean compareAndSwapObject(Object o, long offset, Object expected, Object x);

/**
 * ä»¥åŸå­æ–¹å¼æ›´æ–° int ç±»å‹çš„å¯¹è±¡å­—æ®µçš„å€¼ã€‚
 */
boolean compareAndSwapInt(Object o, long offset, int expected, int x);

/**
 * ä»¥åŸå­æ–¹å¼æ›´æ–° long ç±»å‹çš„å¯¹è±¡å­—æ®µçš„å€¼ã€‚
 */
boolean compareAndSwapLong(Object o, long offset, long expected, long x);
```

`Unsafe`ç±»ä¸­çš„ CAS æ–¹æ³•æ˜¯`native`æ–¹æ³•ã€‚`native`å…³é”®å­—è¡¨æ˜è¿™äº›æ–¹æ³•æ˜¯ç”¨æœ¬åœ°ä»£ç ï¼ˆé€šå¸¸æ˜¯ C æˆ– C++ï¼‰å®ç°çš„ï¼Œè€Œä¸æ˜¯ç”¨ Java å®ç°çš„ã€‚è¿™äº›æ–¹æ³•ç›´æ¥è°ƒç”¨åº•å±‚çš„ç¡¬ä»¶æŒ‡ä»¤æ¥å®ç°åŸå­æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒJava è¯­è¨€å¹¶æ²¡æœ‰ç›´æ¥ç”¨ Java å®ç° CASï¼Œè€Œæ˜¯é€šè¿‡ C++ å†…è”æ±‡ç¼–çš„å½¢å¼å®ç°çš„ï¼ˆé€šè¿‡ JNI è°ƒç”¨ï¼‰ã€‚å› æ­¤ï¼ŒCAS çš„å…·ä½“å®ç°ä¸æ“ä½œç³»ç»Ÿä»¥åŠ CPU å¯†åˆ‡ç›¸å…³ã€‚

`java.util.concurrent.atomic` åŒ…æä¾›äº†ä¸€äº›ç”¨äºåŸå­æ“ä½œçš„ç±»ã€‚è¿™äº›ç±»åˆ©ç”¨åº•å±‚çš„åŸå­æŒ‡ä»¤ï¼Œç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

![JUCåŸå­ç±»æ¦‚è§ˆ](https://oss.javaguide.cn/github/javaguide/java/JUC%E5%8E%9F%E5%AD%90%E7%B1%BB%E6%A6%82%E8%A7%88.png)

å…³äºè¿™äº› Atomic åŸå­ç±»çš„ä»‹ç»å’Œä½¿ç”¨ï¼Œå¯ä»¥é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼š[Atomic åŸå­ç±»æ€»ç»“](https://javaguide.cn/java/concurrent/atomic-classes.html)ã€‚

`AtomicInteger`æ˜¯ Java çš„åŸå­ç±»ä¹‹ä¸€ï¼Œä¸»è¦ç”¨äºå¯¹ `int` ç±»å‹çš„å˜é‡è¿›è¡ŒåŸå­æ“ä½œï¼Œå®ƒåˆ©ç”¨`Unsafe`ç±»æä¾›çš„ä½çº§åˆ«åŸå­æ“ä½œæ–¹æ³•å®ç°æ— é”çš„çº¿ç¨‹å®‰å…¨æ€§ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡è§£è¯»`AtomicInteger`çš„æ ¸å¿ƒæºç ï¼ˆJDK1.8ï¼‰ï¼Œæ¥è¯´æ˜ Java å¦‚ä½•ä½¿ç”¨`Unsafe`ç±»çš„æ–¹æ³•æ¥å®ç°åŸå­æ“ä½œã€‚

`AtomicInteger`æ ¸å¿ƒæºç å¦‚ä¸‹ï¼š

```java
// è·å– Unsafe å®ä¾‹
private static final Unsafe unsafe = Unsafe.getUnsafe();
private static final long valueOffset;

static {
    try {
        // è·å–â€œvalueâ€å­—æ®µåœ¨AtomicIntegerç±»ä¸­çš„å†…å­˜åç§»é‡
        valueOffset = unsafe.objectFieldOffset
            (AtomicInteger.class.getDeclaredField("value"));
    } catch (Exception ex) { throw new Error(ex); }
}
// ç¡®ä¿â€œvalueâ€å­—æ®µçš„å¯è§æ€§
private volatile int value;

// å¦‚æœå½“å‰å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™åŸå­åœ°å°†å€¼è®¾ç½®ä¸ºnewValue
// ä½¿ç”¨ Unsafe#compareAndSwapInt æ–¹æ³•è¿›è¡ŒCASæ“ä½œ
public final boolean compareAndSet(int expect, int update) {
    return unsafe.compareAndSwapInt(this, valueOffset, expect, update);
}

// åŸå­åœ°å°†å½“å‰å€¼åŠ  delta å¹¶è¿”å›æ—§å€¼
public final int getAndAdd(int delta) {
    return unsafe.getAndAddInt(this, valueOffset, delta);
}

// åŸå­åœ°å°†å½“å‰å€¼åŠ  1 å¹¶è¿”å›åŠ ä¹‹å‰çš„å€¼ï¼ˆæ—§å€¼ï¼‰
// ä½¿ç”¨ Unsafe#getAndAddInt æ–¹æ³•è¿›è¡ŒCASæ“ä½œã€‚
public final int getAndIncrement() {
    return unsafe.getAndAddInt(this, valueOffset, 1);
}

// åŸå­åœ°å°†å½“å‰å€¼å‡ 1 å¹¶è¿”å›å‡ä¹‹å‰çš„å€¼ï¼ˆæ—§å€¼ï¼‰
public final int getAndDecrement() {
    return unsafe.getAndAddInt(this, valueOffset, -1);
}
```

`Unsafe#getAndAddInt`æºç ï¼š

```java
// åŸå­åœ°è·å–å¹¶å¢åŠ æ•´æ•°å€¼
public final int getAndAddInt(Object o, long offset, int delta) {
    int v;
    do {
        // ä»¥ volatile æ–¹å¼è·å–å¯¹è±¡ o åœ¨å†…å­˜åç§»é‡ offset å¤„çš„æ•´æ•°å€¼
        v = getIntVolatile(o, offset);
    } while (!compareAndSwapInt(o, offset, v, v + delta));
    // è¿”å›æ—§å€¼
    return v;
}
```

å¯ä»¥çœ‹åˆ°ï¼Œ`getAndAddInt` ä½¿ç”¨äº† `do-while` å¾ªç¯ï¼šåœ¨`compareAndSwapInt`æ“ä½œå¤±è´¥æ—¶ï¼Œä¼šä¸æ–­é‡è¯•ç›´åˆ°æˆåŠŸã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`getAndAddInt`æ–¹æ³•ä¼šé€šè¿‡ `compareAndSwapInt` æ–¹æ³•æ¥å°è¯•æ›´æ–° `value` çš„å€¼ï¼Œå¦‚æœæ›´æ–°å¤±è´¥ï¼ˆå½“å‰å€¼åœ¨æ­¤æœŸé—´è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼‰ï¼Œå®ƒä¼šé‡æ–°è·å–å½“å‰å€¼å¹¶å†æ¬¡å°è¯•æ›´æ–°ï¼Œç›´åˆ°æ“ä½œæˆåŠŸã€‚

ç”±äº CAS æ“ä½œå¯èƒ½ä¼šå› ä¸ºå¹¶å‘å†²çªè€Œå¤±è´¥ï¼Œå› æ­¤é€šå¸¸ä¼šä¸`while`å¾ªç¯æ­é…ä½¿ç”¨ï¼Œåœ¨å¤±è´¥åä¸æ–­é‡è¯•ï¼Œç›´åˆ°æ“ä½œæˆåŠŸã€‚è¿™å°±æ˜¯ **è‡ªæ—‹é”æœºåˆ¶** ã€‚

### CAS ç®—æ³•å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ

ABA é—®é¢˜æ˜¯ CAS ç®—æ³•æœ€å¸¸è§çš„é—®é¢˜ã€‚

#### ABA é—®é¢˜

å¦‚æœä¸€ä¸ªå˜é‡ V åˆæ¬¡è¯»å–çš„æ—¶å€™æ˜¯ A å€¼ï¼Œå¹¶ä¸”åœ¨å‡†å¤‡èµ‹å€¼çš„æ—¶å€™æ£€æŸ¥åˆ°å®ƒä»ç„¶æ˜¯ A å€¼ï¼Œé‚£æˆ‘ä»¬å°±èƒ½è¯´æ˜å®ƒçš„å€¼æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡äº†å—ï¼Ÿå¾ˆæ˜æ˜¾æ˜¯ä¸èƒ½çš„ï¼Œå› ä¸ºåœ¨è¿™æ®µæ—¶é—´å®ƒçš„å€¼å¯èƒ½è¢«æ”¹ä¸ºå…¶ä»–å€¼ï¼Œç„¶ååˆæ”¹å› Aï¼Œé‚£ CAS æ“ä½œå°±ä¼šè¯¯è®¤ä¸ºå®ƒä»æ¥æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ã€‚è¿™ä¸ªé—®é¢˜è¢«ç§°ä¸º CAS æ“ä½œçš„ **"ABA"é—®é¢˜ã€‚**

ABA é—®é¢˜çš„è§£å†³æ€è·¯æ˜¯åœ¨å˜é‡å‰é¢è¿½åŠ ä¸Š**ç‰ˆæœ¬å·æˆ–è€…æ—¶é—´æˆ³**ã€‚JDK 1.5 ä»¥åçš„ `AtomicStampedReference` ç±»å°±æ˜¯ç”¨æ¥è§£å†³ ABA é—®é¢˜çš„ï¼Œå…¶ä¸­çš„ `compareAndSet()` æ–¹æ³•å°±æ˜¯é¦–å…ˆæ£€æŸ¥å½“å‰å¼•ç”¨æ˜¯å¦ç­‰äºé¢„æœŸå¼•ç”¨ï¼Œå¹¶ä¸”å½“å‰æ ‡å¿—æ˜¯å¦ç­‰äºé¢„æœŸæ ‡å¿—ï¼Œå¦‚æœå…¨éƒ¨ç›¸ç­‰ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å¼•ç”¨å’Œè¯¥æ ‡å¿—çš„å€¼è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°å€¼ã€‚

```java
public boolean compareAndSet(V   expectedReference,
                             V   newReference,
                             int expectedStamp,
                             int newStamp) {
    Pair<V> current = pair;
    return
        expectedReference == current.reference &&
        expectedStamp == current.stamp &&
        ((newReference == current.reference &&
          newStamp == current.stamp) ||
         casPair(current, Pair.of(newReference, newStamp)));
}
```

#### å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§

CAS ç»å¸¸ä¼šç”¨åˆ°è‡ªæ—‹æ“ä½œæ¥è¿›è¡Œé‡è¯•ï¼Œä¹Ÿå°±æ˜¯ä¸æˆåŠŸå°±ä¸€ç›´å¾ªç¯æ‰§è¡Œç›´åˆ°æˆåŠŸã€‚å¦‚æœé•¿æ—¶é—´ä¸æˆåŠŸï¼Œä¼šç»™ CPU å¸¦æ¥éå¸¸å¤§çš„æ‰§è¡Œå¼€é”€ã€‚

å¦‚æœ JVM èƒ½å¤Ÿæ”¯æŒå¤„ç†å™¨æä¾›çš„`pause`æŒ‡ä»¤ï¼Œé‚£ä¹ˆè‡ªæ—‹æ“ä½œçš„æ•ˆç‡å°†æœ‰æ‰€æå‡ã€‚`pause`æŒ‡ä»¤æœ‰ä¸¤ä¸ªé‡è¦ä½œç”¨ï¼š

1. **å»¶è¿Ÿæµæ°´çº¿æ‰§è¡ŒæŒ‡ä»¤**ï¼š`pause`æŒ‡ä»¤å¯ä»¥å»¶è¿ŸæŒ‡ä»¤çš„æ‰§è¡Œï¼Œä»è€Œå‡å°‘ CPU çš„èµ„æºæ¶ˆè€—ã€‚å…·ä½“çš„å»¶è¿Ÿæ—¶é—´å–å†³äºå¤„ç†å™¨çš„å®ç°ç‰ˆæœ¬ï¼Œåœ¨æŸäº›å¤„ç†å™¨ä¸Šï¼Œå»¶è¿Ÿæ—¶é—´å¯èƒ½ä¸ºé›¶ã€‚
2. **é¿å…å†…å­˜é¡ºåºå†²çª**ï¼šåœ¨é€€å‡ºå¾ªç¯æ—¶ï¼Œ`pause`æŒ‡ä»¤å¯ä»¥é¿å…ç”±äºå†…å­˜é¡ºåºå†²çªè€Œå¯¼è‡´çš„ CPU æµæ°´çº¿è¢«æ¸…ç©ºï¼Œä»è€Œæé«˜ CPU çš„æ‰§è¡Œæ•ˆç‡ã€‚

#### åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ

CAS æ“ä½œä»…èƒ½å¯¹å•ä¸ªå…±äº«å˜é‡æœ‰æ•ˆã€‚å½“éœ€è¦æ“ä½œå¤šä¸ªå…±äº«å˜é‡æ—¶ï¼ŒCAS å°±æ˜¾å¾—æ— èƒ½ä¸ºåŠ›ã€‚ä¸è¿‡ï¼Œä» JDK 1.5 å¼€å§‹ï¼ŒJava æä¾›äº†`AtomicReference`ç±»ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿä¿è¯å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§ã€‚é€šè¿‡å°†å¤šä¸ªå˜é‡å°è£…åœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`AtomicReference`æ¥æ‰§è¡Œ CAS æ“ä½œã€‚

é™¤äº† `AtomicReference` è¿™ç§æ–¹å¼ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åˆ©ç”¨åŠ é”æ¥ä¿è¯ã€‚

## synchronized å…³é”®å­—

### synchronized æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`synchronized` æ˜¯ Java ä¸­çš„ä¸€ä¸ªå…³é”®å­—ï¼Œç¿»è¯‘æˆä¸­æ–‡æ˜¯åŒæ­¥çš„æ„æ€ï¼Œä¸»è¦è§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥æ€§ï¼Œå¯ä»¥ä¿è¯è¢«å®ƒä¿®é¥°çš„æ–¹æ³•æˆ–è€…ä»£ç å—åœ¨ä»»æ„æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚

åœ¨ Java æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œ`synchronized` å±äº **é‡é‡çº§é”**ï¼Œæ•ˆç‡ä½ä¸‹ã€‚è¿™æ˜¯å› ä¸ºç›‘è§†å™¨é”ï¼ˆmonitorï¼‰æ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„ `Mutex Lock` æ¥å®ç°çš„ï¼ŒJava çš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¹‹ä¸Šçš„ã€‚å¦‚æœè¦æŒ‚èµ·æˆ–è€…å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½éœ€è¦æ“ä½œç³»ç»Ÿå¸®å¿™å®Œæˆï¼Œè€Œæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ—¶éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢éœ€è¦ç›¸å¯¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œæ—¶é—´æˆæœ¬ç›¸å¯¹è¾ƒé«˜ã€‚

ä¸è¿‡ï¼Œåœ¨ Java 6 ä¹‹åï¼Œ `synchronized` å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–å¦‚è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”ã€è½»é‡çº§é”ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ï¼Œè¿™äº›ä¼˜åŒ–è®© `synchronized` é”çš„æ•ˆç‡æå‡äº†å¾ˆå¤šã€‚å› æ­¤ï¼Œ `synchronized` è¿˜æ˜¯å¯ä»¥åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨çš„ï¼Œåƒ JDK æºç ã€å¾ˆå¤šå¼€æºæ¡†æ¶éƒ½å¤§é‡ä½¿ç”¨äº† `synchronized` ã€‚

å…³äºåå‘é”å¤šè¡¥å……ä¸€ç‚¹ï¼šç”±äºåå‘é”å¢åŠ äº† JVM çš„å¤æ‚æ€§ï¼ŒåŒæ—¶ä¹Ÿå¹¶æ²¡æœ‰ä¸ºæ‰€æœ‰åº”ç”¨éƒ½å¸¦æ¥æ€§èƒ½æå‡ã€‚å› æ­¤ï¼Œåœ¨ JDK15 ä¸­ï¼Œåå‘é”è¢«é»˜è®¤å…³é—­ï¼ˆä»ç„¶å¯ä»¥ä½¿ç”¨ `-XX:+UseBiasedLocking` å¯ç”¨åå‘é”ï¼‰ï¼Œåœ¨ JDK18 ä¸­ï¼Œåå‘é”å·²ç»è¢«å½»åº•åºŸå¼ƒï¼ˆæ— æ³•é€šè¿‡å‘½ä»¤è¡Œæ‰“å¼€ï¼‰ã€‚

### å¦‚ä½•ä½¿ç”¨ synchronizedï¼Ÿ

`synchronized` å…³é”®å­—çš„ä½¿ç”¨æ–¹å¼ä¸»è¦æœ‰ä¸‹é¢ 3 ç§ï¼š

1. ä¿®é¥°å®ä¾‹æ–¹æ³•
2. ä¿®é¥°é™æ€æ–¹æ³•
3. ä¿®é¥°ä»£ç å—

**1ã€ä¿®é¥°å®ä¾‹æ–¹æ³•** ï¼ˆé”å½“å‰å¯¹è±¡å®ä¾‹ï¼‰

ç»™å½“å‰å¯¹è±¡å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— **å½“å‰å¯¹è±¡å®ä¾‹çš„é”** ã€‚

```java
synchronized void method() {
    //ä¸šåŠ¡ä»£ç 
}
```

**2ã€ä¿®é¥°é™æ€æ–¹æ³•** ï¼ˆé”å½“å‰ç±»ï¼‰

ç»™å½“å‰ç±»åŠ é”ï¼Œä¼šä½œç”¨äºç±»çš„æ‰€æœ‰å¯¹è±¡å®ä¾‹ ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— **å½“å‰ class çš„é”**ã€‚

è¿™æ˜¯å› ä¸ºé™æ€æˆå‘˜ä¸å±äºä»»ä½•ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå½’æ•´ä¸ªç±»æ‰€æœ‰ï¼Œä¸ä¾èµ–äºç±»çš„ç‰¹å®šå®ä¾‹ï¼Œè¢«ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«ã€‚

```java
synchronized static void method() {
    //ä¸šåŠ¡ä»£ç 
}
```

é™æ€ `synchronized` æ–¹æ³•å’Œéé™æ€ `synchronized` æ–¹æ³•ä¹‹é—´çš„è°ƒç”¨äº’æ–¥ä¹ˆï¼Ÿä¸äº’æ–¥ï¼å¦‚æœä¸€ä¸ªçº¿ç¨‹ A è°ƒç”¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„éé™æ€ `synchronized` æ–¹æ³•ï¼Œè€Œçº¿ç¨‹ B éœ€è¦è°ƒç”¨è¿™ä¸ªå®ä¾‹å¯¹è±¡æ‰€å±ç±»çš„é™æ€ `synchronized` æ–¹æ³•ï¼Œæ˜¯å…è®¸çš„ï¼Œä¸ä¼šå‘ç”Ÿäº’æ–¥ç°è±¡ï¼Œå› ä¸ºè®¿é—®é™æ€ `synchronized` æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰ç±»çš„é”ï¼Œè€Œè®¿é—®éé™æ€ `synchronized` æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡é”ã€‚

**3ã€ä¿®é¥°ä»£ç å—** ï¼ˆé”æŒ‡å®šå¯¹è±¡/ç±»ï¼‰

å¯¹æ‹¬å·é‡ŒæŒ‡å®šçš„å¯¹è±¡/ç±»åŠ é”ï¼š

- `synchronized(object)` è¡¨ç¤ºè¿›å…¥åŒæ­¥ä»£ç å—å‰è¦è·å¾— **ç»™å®šå¯¹è±¡çš„é”**ã€‚
- `synchronized(ç±».class)` è¡¨ç¤ºè¿›å…¥åŒæ­¥ä»£ç å—å‰è¦è·å¾— **ç»™å®š Class çš„é”**

```java
synchronized(this) {
    //ä¸šåŠ¡ä»£ç 
}
```

**æ€»ç»“ï¼š**

- `synchronized` å…³é”®å­—åŠ åˆ° `static` é™æ€æ–¹æ³•å’Œ `synchronized(class)` ä»£ç å—ä¸Šéƒ½æ˜¯æ˜¯ç»™ Class ç±»ä¸Šé”ï¼›
- `synchronized` å…³é”®å­—åŠ åˆ°å®ä¾‹æ–¹æ³•ä¸Šæ˜¯ç»™å¯¹è±¡å®ä¾‹ä¸Šé”ï¼›
- å°½é‡ä¸è¦ä½¿ç”¨ `synchronized(String a)` å› ä¸º JVM ä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å…·æœ‰ç¼“å­˜åŠŸèƒ½ã€‚

### æ„é€ æ–¹æ³•å¯ä»¥ç”¨ synchronized ä¿®é¥°ä¹ˆï¼Ÿ

æ„é€ æ–¹æ³•ä¸èƒ½ä½¿ç”¨ synchronized å…³é”®å­—ä¿®é¥°ã€‚ä¸è¿‡ï¼Œå¯ä»¥åœ¨æ„é€ æ–¹æ³•å†…éƒ¨ä½¿ç”¨ synchronized ä»£ç å—ã€‚

å¦å¤–ï¼Œæ„é€ æ–¹æ³•æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†å¦‚æœåœ¨æ„é€ æ–¹æ³•ä¸­æ¶‰åŠåˆ°å…±äº«èµ„æºçš„æ“ä½œï¼Œå°±éœ€è¦é‡‡å–é€‚å½“çš„åŒæ­¥æªæ–½æ¥ä¿è¯æ•´ä¸ªæ„é€ è¿‡ç¨‹çš„çº¿ç¨‹å®‰å…¨ã€‚

### â­ï¸synchronized åº•å±‚åŸç†äº†è§£å—ï¼Ÿ

synchronized å…³é”®å­—åº•å±‚åŸç†å±äº JVM å±‚é¢çš„ä¸œè¥¿ã€‚

#### synchronized åŒæ­¥è¯­å¥å—çš„æƒ…å†µ

```java
public class SynchronizedDemo {
    public void method() {
        synchronized (this) {
            System.out.println("synchronized ä»£ç å—");
        }
    }
}
```

é€šè¿‡ JDK è‡ªå¸¦çš„ `javap` å‘½ä»¤æŸ¥çœ‹ `SynchronizedDemo` ç±»çš„ç›¸å…³å­—èŠ‚ç ä¿¡æ¯ï¼šé¦–å…ˆåˆ‡æ¢åˆ°ç±»çš„å¯¹åº”ç›®å½•æ‰§è¡Œ `javac SynchronizedDemo.java` å‘½ä»¤ç”Ÿæˆç¼–è¯‘åçš„ .class æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œ`javap -c -s -v -l SynchronizedDemo.class`ã€‚

![synchronizedå…³é”®å­—åŸç†](https://oss.javaguide.cn/github/javaguide/java/concurrent/synchronized-principle.png)

ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š**`synchronized` åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ `monitorenter` å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå…¶ä¸­ `monitorenter` æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ`monitorexit` æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚**

ä¸Šé¢çš„å­—èŠ‚ç ä¸­åŒ…å«ä¸€ä¸ª `monitorenter` æŒ‡ä»¤ä»¥åŠä¸¤ä¸ª `monitorexit` æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸ºäº†ä¿è¯é”åœ¨åŒæ­¥ä»£ç å—ä»£ç æ­£å¸¸æ‰§è¡Œä»¥åŠå‡ºç°å¼‚å¸¸çš„è¿™ä¸¤ç§æƒ…å†µä¸‹éƒ½èƒ½è¢«æ­£ç¡®é‡Šæ”¾ã€‚

å½“æ‰§è¡Œ `monitorenter` æŒ‡ä»¤æ—¶ï¼Œçº¿ç¨‹è¯•å›¾è·å–é”ä¹Ÿå°±æ˜¯è·å– **å¯¹è±¡ç›‘è§†å™¨ `monitor`** çš„æŒæœ‰æƒã€‚

> åœ¨ Java è™šæ‹Ÿæœº(HotSpot)ä¸­ï¼ŒMonitor æ˜¯åŸºäº C++å®ç°çš„ï¼Œç”±[ObjectMonitor](https://github.com/openjdk-mirror/jdk7u-hotspot/blob/50bdefc3afe944ca74c3093e7448d6b889cd20d1/src/share/vm/runtime/objectMonitor.cpp)å®ç°çš„ã€‚æ¯ä¸ªå¯¹è±¡ä¸­éƒ½å†…ç½®äº†ä¸€ä¸ª `ObjectMonitor`å¯¹è±¡ã€‚
>
> å¦å¤–ï¼Œ`wait/notify`ç­‰æ–¹æ³•ä¹Ÿä¾èµ–äº`monitor`å¯¹è±¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåªæœ‰åœ¨åŒæ­¥çš„å—æˆ–è€…æ–¹æ³•ä¸­æ‰èƒ½è°ƒç”¨`wait/notify`ç­‰æ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ›å‡º`java.lang.IllegalMonitorStateException`çš„å¼‚å¸¸çš„åŸå› ã€‚

åœ¨æ‰§è¡Œ`monitorenter`æ—¶ï¼Œä¼šå°è¯•è·å–å¯¹è±¡çš„é”ï¼Œå¦‚æœé”çš„è®¡æ•°å™¨ä¸º 0 åˆ™è¡¨ç¤ºé”å¯ä»¥è¢«è·å–ï¼Œè·å–åå°†é”è®¡æ•°å™¨è®¾ä¸º 1 ä¹Ÿå°±æ˜¯åŠ  1ã€‚

![æ‰§è¡Œ monitorenter è·å–é”](https://oss.javaguide.cn/github/javaguide/java/concurrent/synchronized-get-lock-code-block.png)

å¯¹è±¡é”çš„æ‹¥æœ‰è€…çº¿ç¨‹æ‰å¯ä»¥æ‰§è¡Œ `monitorexit` æŒ‡ä»¤æ¥é‡Šæ”¾é”ã€‚åœ¨æ‰§è¡Œ `monitorexit` æŒ‡ä»¤åï¼Œå°†é”è®¡æ•°å™¨è®¾ä¸º 0ï¼Œè¡¨æ˜é”è¢«é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥å°è¯•è·å–é”ã€‚

![æ‰§è¡Œ monitorexit é‡Šæ”¾é”](https://oss.javaguide.cn/github/javaguide/java/concurrent/synchronized-release-lock-block.png)

å¦‚æœè·å–å¯¹è±¡é”å¤±è´¥ï¼Œé‚£å½“å‰çº¿ç¨‹å°±è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é”è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ä¸ºæ­¢ã€‚

#### synchronized ä¿®é¥°æ–¹æ³•çš„æƒ…å†µ

```java
public class SynchronizedDemo2 {
    public synchronized void method() {
        System.out.println("synchronized æ–¹æ³•");
    }
}

```

![synchronizedå…³é”®å­—åŸç†](https://oss.javaguide.cn/github/javaguide/synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E5%8E%9F%E7%90%862.png)

`synchronized` ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ `monitorenter` æŒ‡ä»¤å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ `ACC_SYNCHRONIZED` æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚JVM é€šè¿‡è¯¥ `ACC_SYNCHRONIZED` è®¿é—®æ ‡å¿—æ¥è¾¨åˆ«ä¸€ä¸ªæ–¹æ³•æ˜¯å¦å£°æ˜ä¸ºåŒæ­¥æ–¹æ³•ï¼Œä»è€Œæ‰§è¡Œç›¸åº”çš„åŒæ­¥è°ƒç”¨ã€‚

å¦‚æœæ˜¯å®ä¾‹æ–¹æ³•ï¼ŒJVM ä¼šå°è¯•è·å–å®ä¾‹å¯¹è±¡çš„é”ã€‚å¦‚æœæ˜¯é™æ€æ–¹æ³•ï¼ŒJVM ä¼šå°è¯•è·å–å½“å‰ class çš„é”ã€‚

#### æ€»ç»“

`synchronized` åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ `monitorenter` å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå…¶ä¸­ `monitorenter` æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ`monitorexit` æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚

`synchronized` ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ `monitorenter` æŒ‡ä»¤å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ `ACC_SYNCHRONIZED` æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚

**ä¸è¿‡ï¼Œä¸¤è€…çš„æœ¬è´¨éƒ½æ˜¯å¯¹å¯¹è±¡ç›‘è§†å™¨ monitor çš„è·å–ã€‚**

ç›¸å…³æ¨èï¼š[Java é”ä¸çº¿ç¨‹çš„é‚£äº›äº‹ - æœ‰èµæŠ€æœ¯å›¢é˜Ÿ](https://tech.youzan.com/javasuo-yu-xian-cheng-de-na-xie-shi/) ã€‚

ğŸ§—ğŸ» è¿›é˜¶ä¸€ä¸‹ï¼šå­¦æœ‰ä½™åŠ›çš„å°ä¼™ä¼´å¯ä»¥æŠ½æ—¶é—´è¯¦ç»†ç ”ç©¶ä¸€ä¸‹å¯¹è±¡ç›‘è§†å™¨ `monitor`ã€‚

### JDK1.6 ä¹‹åçš„ synchronized åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–ï¼Ÿé”å‡çº§åŸç†äº†è§£å—ï¼Ÿ

åœ¨ Java 6 ä¹‹åï¼Œ `synchronized` å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–å¦‚è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”ã€è½»é‡çº§é”ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ï¼Œè¿™äº›ä¼˜åŒ–è®© `synchronized` é”çš„æ•ˆç‡æå‡äº†å¾ˆå¤šï¼ˆJDK18 ä¸­ï¼Œåå‘é”å·²ç»è¢«å½»åº•åºŸå¼ƒï¼Œå‰é¢å·²ç»æåˆ°è¿‡äº†ï¼‰ã€‚

é”ä¸»è¦å­˜åœ¨å››ç§çŠ¶æ€ï¼Œä¾æ¬¡æ˜¯ï¼šæ— é”çŠ¶æ€ã€åå‘é”çŠ¶æ€ã€è½»é‡çº§é”çŠ¶æ€ã€é‡é‡çº§é”çŠ¶æ€ï¼Œä»–ä»¬ä¼šéšç€ç«äº‰çš„æ¿€çƒˆè€Œé€æ¸å‡çº§ã€‚æ³¨æ„é”å¯ä»¥å‡çº§ä¸å¯é™çº§ï¼Œè¿™ç§ç­–ç•¥æ˜¯ä¸ºäº†æé«˜è·å¾—é”å’Œé‡Šæ”¾é”çš„æ•ˆç‡ã€‚

`synchronized` é”å‡çº§æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„è¿‡ç¨‹ï¼Œé¢è¯•ä¹Ÿå¾ˆå°‘é—®åˆ°ï¼Œå¦‚æœä½ æƒ³è¦è¯¦ç»†äº†è§£çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼š[æµ…æ synchronized é”å‡çº§çš„åŸç†ä¸å®ç°](https://www.cnblogs.com/star95/p/17542850.html)ã€‚

### synchronized çš„åå‘é”ä¸ºä»€ä¹ˆè¢«åºŸå¼ƒäº†ï¼Ÿ

Open JDK å®˜æ–¹å£°æ˜ï¼š[JEP 374: Deprecate and Disable Biased Locking](https://openjdk.org/jeps/374)

åœ¨ JDK15 ä¸­ï¼Œåå‘é”è¢«é»˜è®¤å…³é—­ï¼ˆä»ç„¶å¯ä»¥ä½¿ç”¨ `-XX:+UseBiasedLocking` å¯ç”¨åå‘é”ï¼‰ï¼Œåœ¨ JDK18 ä¸­ï¼Œåå‘é”å·²ç»è¢«å½»åº•åºŸå¼ƒï¼ˆæ— æ³•é€šè¿‡å‘½ä»¤è¡Œæ‰“å¼€ï¼‰ã€‚

åœ¨å®˜æ–¹å£°æ˜ä¸­ï¼Œä¸»è¦åŸå› æœ‰ä¸¤ä¸ªæ–¹é¢ï¼š

- **æ€§èƒ½æ”¶ç›Šä¸æ˜æ˜¾ï¼š**

åå‘é”æ˜¯ HotSpot è™šæ‹Ÿæœºçš„ä¸€é¡¹ä¼˜åŒ–æŠ€æœ¯ï¼Œå¯ä»¥æå‡å•çº¿ç¨‹å¯¹åŒæ­¥ä»£ç å—çš„è®¿é—®æ€§èƒ½ã€‚

å—ç›Šäºåå‘é”çš„åº”ç”¨ç¨‹åºé€šå¸¸ä½¿ç”¨äº†æ—©æœŸçš„ Java é›†åˆ APIï¼Œä¾‹å¦‚ HashTableã€Vectorï¼Œåœ¨è¿™äº›é›†åˆç±»ä¸­é€šè¿‡ synchronized æ¥æ§åˆ¶åŒæ­¥ï¼Œè¿™æ ·åœ¨å•çº¿ç¨‹é¢‘ç¹è®¿é—®æ—¶ï¼Œé€šè¿‡åå‘é”ä¼šå‡å°‘åŒæ­¥å¼€é”€ã€‚

éšç€ JDK çš„å‘å±•ï¼Œå‡ºç°äº† ConcurrentHashMap é«˜æ€§èƒ½çš„é›†åˆç±»ï¼Œåœ¨é›†åˆç±»å†…éƒ¨è¿›è¡Œäº†è®¸å¤šæ€§èƒ½ä¼˜åŒ–ï¼Œæ­¤æ—¶åå‘é”å¸¦æ¥çš„æ€§èƒ½æ”¶ç›Šå°±ä¸æ˜æ˜¾äº†ã€‚

åå‘é”ä»…ä»…åœ¨å•çº¿ç¨‹è®¿é—®åŒæ­¥ä»£ç å—çš„åœºæ™¯ä¸­å¯ä»¥è·å¾—æ€§èƒ½æ”¶ç›Šã€‚

å¦‚æœå­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œå°±éœ€è¦ **æ’¤é”€åå‘é”** ï¼Œè¿™ä¸ªæ“ä½œçš„æ€§èƒ½å¼€é”€æ˜¯æ¯”è¾ƒæ˜‚è´µçš„ã€‚åå‘é”çš„æ’¤é”€éœ€è¦ç­‰å¾…è¿›å…¥åˆ°å…¨å±€å®‰å…¨ç‚¹ï¼ˆsafe pointï¼‰ï¼Œè¯¥çŠ¶æ€ä¸‹æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯æš‚åœçš„ï¼Œæ­¤æ—¶å»æ£€æŸ¥çº¿ç¨‹çŠ¶æ€å¹¶è¿›è¡Œåå‘é”çš„æ’¤é”€ã€‚

- **JVM å†…éƒ¨ä»£ç ç»´æŠ¤æˆæœ¬å¤ªé«˜ï¼š**

åå‘é”å°†è®¸å¤šå¤æ‚ä»£ç å¼•å…¥åˆ°åŒæ­¥å­ç³»ç»Ÿï¼Œå¹¶ä¸”å¯¹å…¶ä»–çš„ HotSpot ç»„ä»¶ä¹Ÿå…·æœ‰ä¾µå…¥æ€§ã€‚è¿™ç§å¤æ‚æ€§ä¸ºç†è§£ä»£ç ã€ç³»ç»Ÿé‡æ„å¸¦æ¥äº†å›°éš¾ï¼Œå› æ­¤ï¼Œ OpenJDK å®˜æ–¹å¸Œæœ›ç¦ç”¨ã€åºŸå¼ƒå¹¶åˆ é™¤åå‘é”ã€‚

### â­ï¸synchronized å’Œ volatile æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

`synchronized` å…³é”®å­—å’Œ `volatile` å…³é”®å­—æ˜¯ä¸¤ä¸ªäº’è¡¥çš„å­˜åœ¨ï¼Œè€Œä¸æ˜¯å¯¹ç«‹çš„å­˜åœ¨ï¼

- `volatile` å…³é”®å­—æ˜¯çº¿ç¨‹åŒæ­¥çš„è½»é‡çº§å®ç°ï¼Œæ‰€ä»¥ `volatile`æ€§èƒ½è‚¯å®šæ¯”`synchronized`å…³é”®å­—è¦å¥½ ã€‚ä½†æ˜¯ `volatile` å…³é”®å­—åªèƒ½ç”¨äºå˜é‡è€Œ `synchronized` å…³é”®å­—å¯ä»¥ä¿®é¥°æ–¹æ³•ä»¥åŠä»£ç å— ã€‚
- `volatile` å…³é”®å­—èƒ½ä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯æ•°æ®çš„åŸå­æ€§ã€‚`synchronized` å…³é”®å­—ä¸¤è€…éƒ½èƒ½ä¿è¯ã€‚
- `volatile`å…³é”®å­—ä¸»è¦ç”¨äºè§£å†³å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼Œè€Œ `synchronized` å…³é”®å­—è§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥æ€§ã€‚

## ReentrantLock

### ReentrantLock æ˜¯ä»€ä¹ˆï¼Ÿ

`ReentrantLock` å®ç°äº† `Lock` æ¥å£ï¼Œæ˜¯ä¸€ä¸ªå¯é‡å…¥ä¸”ç‹¬å å¼çš„é”ï¼Œå’Œ `synchronized` å…³é”®å­—ç±»ä¼¼ã€‚ä¸è¿‡ï¼Œ`ReentrantLock` æ›´çµæ´»ã€æ›´å¼ºå¤§ï¼Œå¢åŠ äº†è½®è¯¢ã€è¶…æ—¶ã€ä¸­æ–­ã€å…¬å¹³é”å’Œéå…¬å¹³é”ç­‰é«˜çº§åŠŸèƒ½ã€‚

```java
public class ReentrantLock implements Lock, java.io.Serializable {}
```

`ReentrantLock` é‡Œé¢æœ‰ä¸€ä¸ªå†…éƒ¨ç±» `Sync`ï¼Œ`Sync` ç»§æ‰¿ AQSï¼ˆ`AbstractQueuedSynchronizer`ï¼‰ï¼Œæ·»åŠ é”å’Œé‡Šæ”¾é”çš„å¤§éƒ¨åˆ†æ“ä½œå®é™…ä¸Šéƒ½æ˜¯åœ¨ `Sync` ä¸­å®ç°çš„ã€‚`Sync` æœ‰å…¬å¹³é” `FairSync` å’Œéå…¬å¹³é” `NonfairSync` ä¸¤ä¸ªå­ç±»ã€‚

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/reentrantlock-class-diagram.png)

`ReentrantLock` é»˜è®¤ä½¿ç”¨éå…¬å¹³é”ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ„é€ å™¨æ¥æ˜¾å¼çš„æŒ‡å®šä½¿ç”¨å…¬å¹³é”ã€‚

```java
// ä¼ å…¥ä¸€ä¸ª boolean å€¼ï¼Œtrue æ—¶ä¸ºå…¬å¹³é”ï¼Œfalse æ—¶ä¸ºéå…¬å¹³é”
public ReentrantLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
}
```

ä»ä¸Šé¢çš„å†…å®¹å¯ä»¥çœ‹å‡ºï¼Œ `ReentrantLock` çš„åº•å±‚å°±æ˜¯ç”± AQS æ¥å®ç°çš„ã€‚å…³äº AQS çš„ç›¸å…³å†…å®¹æ¨èé˜…è¯» [AQS è¯¦è§£](https://javaguide.cn/java/concurrent/aqs.html) è¿™ç¯‡æ–‡ç« ã€‚

### å…¬å¹³é”å’Œéå…¬å¹³é”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- **å…¬å¹³é”** : é”è¢«é‡Šæ”¾ä¹‹åï¼Œå…ˆç”³è¯·çš„çº¿ç¨‹å…ˆå¾—åˆ°é”ã€‚æ€§èƒ½è¾ƒå·®ä¸€äº›ï¼Œå› ä¸ºå…¬å¹³é”ä¸ºäº†ä¿è¯æ—¶é—´ä¸Šçš„ç»å¯¹é¡ºåºï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢æ›´é¢‘ç¹ã€‚
- **éå…¬å¹³é”**ï¼šé”è¢«é‡Šæ”¾ä¹‹åï¼Œåç”³è¯·çš„çº¿ç¨‹å¯èƒ½ä¼šå…ˆè·å–åˆ°é”ï¼Œæ˜¯éšæœºæˆ–è€…æŒ‰ç…§å…¶ä»–ä¼˜å…ˆçº§æ’åºçš„ã€‚æ€§èƒ½æ›´å¥½ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´æŸäº›çº¿ç¨‹æ°¸è¿œæ— æ³•è·å–åˆ°é”ã€‚

### â­ï¸synchronized å’Œ ReentrantLock æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

#### ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”

**å¯é‡å…¥é”** ä¹Ÿå«é€’å½’é”ï¼ŒæŒ‡çš„æ˜¯çº¿ç¨‹å¯ä»¥å†æ¬¡è·å–è‡ªå·±çš„å†…éƒ¨é”ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†æŸä¸ªå¯¹è±¡çš„é”ï¼Œæ­¤æ—¶è¿™ä¸ªå¯¹è±¡é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œå½“å…¶å†æ¬¡æƒ³è¦è·å–è¿™ä¸ªå¯¹è±¡çš„é”çš„æ—¶å€™è¿˜æ˜¯å¯ä»¥è·å–çš„ï¼Œå¦‚æœæ˜¯ä¸å¯é‡å…¥é”çš„è¯ï¼Œå°±ä¼šé€ æˆæ­»é”ã€‚

JDK æä¾›çš„æ‰€æœ‰ç°æˆçš„ `Lock` å®ç°ç±»ï¼ŒåŒ…æ‹¬ `synchronized` å…³é”®å­—é”éƒ½æ˜¯å¯é‡å…¥çš„ã€‚

åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œ`method1()` å’Œ `method2()`éƒ½è¢« `synchronized` å…³é”®å­—ä¿®é¥°ï¼Œ`method1()`è°ƒç”¨äº†`method2()`ã€‚

```java
public class SynchronizedDemo {
    public synchronized void method1() {
        System.out.println("æ–¹æ³•1");
        method2();
    }

    public synchronized void method2() {
        System.out.println("æ–¹æ³•2");
    }
}
```

ç”±äº `synchronized`é”æ˜¯å¯é‡å…¥çš„ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹åœ¨è°ƒç”¨`method1()` æ—¶å¯ä»¥ç›´æ¥è·å¾—å½“å‰å¯¹è±¡çš„é”ï¼Œæ‰§è¡Œ `method2()` çš„æ—¶å€™å¯ä»¥å†æ¬¡è·å–è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œä¸ä¼šäº§ç”Ÿæ­»é”é—®é¢˜ã€‚å‡å¦‚`synchronized`æ˜¯ä¸å¯é‡å…¥é”çš„è¯ï¼Œç”±äºè¯¥å¯¹è±¡çš„é”å·²è¢«å½“å‰çº¿ç¨‹æ‰€æŒæœ‰ä¸”æ— æ³•é‡Šæ”¾ï¼Œè¿™å°±å¯¼è‡´çº¿ç¨‹åœ¨æ‰§è¡Œ `method2()`æ—¶è·å–é”å¤±è´¥ï¼Œä¼šå‡ºç°æ­»é”é—®é¢˜ã€‚

#### synchronized ä¾èµ–äº JVM è€Œ ReentrantLock ä¾èµ–äº API

`synchronized` æ˜¯ä¾èµ–äº JVM å®ç°çš„ï¼Œå‰é¢æˆ‘ä»¬ä¹Ÿè®²åˆ°äº† è™šæ‹Ÿæœºå›¢é˜Ÿåœ¨ JDK1.6 ä¸º `synchronized` å…³é”®å­—è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œä½†æ˜¯è¿™äº›ä¼˜åŒ–éƒ½æ˜¯åœ¨è™šæ‹Ÿæœºå±‚é¢å®ç°çš„ï¼Œå¹¶æ²¡æœ‰ç›´æ¥æš´éœ²ç»™æˆ‘ä»¬ã€‚

`ReentrantLock` æ˜¯ JDK å±‚é¢å®ç°çš„ï¼ˆä¹Ÿå°±æ˜¯ API å±‚é¢ï¼Œéœ€è¦ lock() å’Œ unlock() æ–¹æ³•é…åˆ try/finally è¯­å¥å—æ¥å®Œæˆï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹å®ƒçš„æºä»£ç ï¼Œæ¥çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚

#### ReentrantLock æ¯” synchronized å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½

ç›¸æ¯”`synchronized`ï¼Œ`ReentrantLock`å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½ã€‚ä¸»è¦æ¥è¯´ä¸»è¦æœ‰ä¸‰ç‚¹ï¼š

- **ç­‰å¾…å¯ä¸­æ–­** : `ReentrantLock`æä¾›äº†ä¸€ç§èƒ½å¤Ÿä¸­æ–­ç­‰å¾…é”çš„çº¿ç¨‹çš„æœºåˆ¶ï¼Œé€šè¿‡ `lock.lockInterruptibly()` æ¥å®ç°è¿™ä¸ªæœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…è·å–é”çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ã€Œ `interrupt()` ã€ï¼Œå½“å‰çº¿ç¨‹å°±ä¼šæŠ›å‡º `InterruptedException` å¼‚å¸¸ï¼Œå¯ä»¥æ•æ‰è¯¥å¼‚å¸¸è¿›è¡Œç›¸åº”å¤„ç†ã€‚
- **å¯å®ç°å…¬å¹³é”** : `ReentrantLock`å¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚è€Œ`synchronized`åªèƒ½æ˜¯éå…¬å¹³é”ã€‚æ‰€è°“çš„å…¬å¹³é”å°±æ˜¯å…ˆç­‰å¾…çš„çº¿ç¨‹å…ˆè·å¾—é”ã€‚`ReentrantLock`é»˜è®¤æƒ…å†µæ˜¯éå…¬å¹³çš„ï¼Œå¯ä»¥é€šè¿‡ `ReentrantLock`ç±»çš„`ReentrantLock(boolean fair)`æ„é€ æ–¹æ³•æ¥æŒ‡å®šæ˜¯å¦æ˜¯å…¬å¹³çš„ã€‚
- **å¯å®ç°é€‰æ‹©æ€§é€šçŸ¥ï¼ˆé”å¯ä»¥ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼‰**: `synchronized`å…³é”®å­—ä¸`wait()`å’Œ`notify()`/`notifyAll()`æ–¹æ³•ç›¸ç»“åˆå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚`ReentrantLock`ç±»å½“ç„¶ä¹Ÿå¯ä»¥å®ç°ï¼Œä½†æ˜¯éœ€è¦å€ŸåŠ©äº`Condition`æ¥å£ä¸`newCondition()`æ–¹æ³•ã€‚
- **æ”¯æŒè¶…æ—¶** ï¼š`ReentrantLock` æä¾›äº† `tryLock(timeout)` çš„æ–¹æ³•ï¼Œå¯ä»¥æŒ‡å®šç­‰å¾…è·å–é”çš„æœ€é•¿ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡äº†ç­‰å¾…æ—¶é—´ï¼Œå°±ä¼šè·å–é”å¤±è´¥ï¼Œä¸ä¼šä¸€ç›´ç­‰å¾…ã€‚

å¦‚æœä½ æƒ³ä½¿ç”¨ä¸Šè¿°åŠŸèƒ½ï¼Œé‚£ä¹ˆé€‰æ‹© `ReentrantLock` æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

å…³äº `Condition`æ¥å£çš„è¡¥å……ï¼š

> `Condition`æ˜¯ JDK1.5 ä¹‹åæ‰æœ‰çš„ï¼Œå®ƒå…·æœ‰å¾ˆå¥½çš„çµæ´»æ€§ï¼Œæ¯”å¦‚å¯ä»¥å®ç°å¤šè·¯é€šçŸ¥åŠŸèƒ½ä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ª`Lock`å¯¹è±¡ä¸­å¯ä»¥åˆ›å»ºå¤šä¸ª`Condition`å®ä¾‹ï¼ˆå³å¯¹è±¡ç›‘è§†å™¨ï¼‰ï¼Œ**çº¿ç¨‹å¯¹è±¡å¯ä»¥æ³¨å†Œåœ¨æŒ‡å®šçš„`Condition`ä¸­ï¼Œä»è€Œå¯ä»¥æœ‰é€‰æ‹©æ€§çš„è¿›è¡Œçº¿ç¨‹é€šçŸ¥ï¼Œåœ¨è°ƒåº¦çº¿ç¨‹ä¸Šæ›´åŠ çµæ´»ã€‚ åœ¨ä½¿ç”¨`notify()/notifyAll()`æ–¹æ³•è¿›è¡Œé€šçŸ¥æ—¶ï¼Œè¢«é€šçŸ¥çš„çº¿ç¨‹æ˜¯ç”± JVM é€‰æ‹©çš„ï¼Œç”¨`ReentrantLock`ç±»ç»“åˆ`Condition`å®ä¾‹å¯ä»¥å®ç°â€œé€‰æ‹©æ€§é€šçŸ¥â€** ï¼Œè¿™ä¸ªåŠŸèƒ½éå¸¸é‡è¦ï¼Œè€Œä¸”æ˜¯ `Condition` æ¥å£é»˜è®¤æä¾›çš„ã€‚è€Œ`synchronized`å…³é”®å­—å°±ç›¸å½“äºæ•´ä¸ª `Lock` å¯¹è±¡ä¸­åªæœ‰ä¸€ä¸ª`Condition`å®ä¾‹ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ³¨å†Œåœ¨å®ƒä¸€ä¸ªèº«ä¸Šã€‚å¦‚æœæ‰§è¡Œ`notifyAll()`æ–¹æ³•çš„è¯å°±ä¼šé€šçŸ¥æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ï¼Œè¿™æ ·ä¼šé€ æˆå¾ˆå¤§çš„æ•ˆç‡é—®é¢˜ã€‚è€Œ`Condition`å®ä¾‹çš„`signalAll()`æ–¹æ³•ï¼Œåªä¼šå”¤é†’æ³¨å†Œåœ¨è¯¥`Condition`å®ä¾‹ä¸­çš„æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚

å…³äº **ç­‰å¾…å¯ä¸­æ–­** çš„è¡¥å……ï¼š

> `lockInterruptibly()` ä¼šè®©è·å–é”çš„çº¿ç¨‹åœ¨é˜»å¡ç­‰å¾…çš„è¿‡ç¨‹ä¸­å¯ä»¥å“åº”ä¸­æ–­ï¼Œå³å½“å‰çº¿ç¨‹åœ¨è·å–é”çš„æ—¶å€™ï¼Œå‘ç°é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œå°±ä¼šé˜»å¡ç­‰å¾…ã€‚
>
> åœ¨é˜»å¡ç­‰å¾…çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ `interrupt()` ï¼Œå°±ä¼šæŠ›å‡º `InterruptedException` å¼‚å¸¸ï¼Œå¯ä»¥æ•è·è¯¥å¼‚å¸¸ï¼Œåšä¸€äº›å¤„ç†æ“ä½œã€‚
>
> ä¸ºäº†æ›´å¥½ç†è§£è¿™ä¸ªæ–¹æ³•ï¼Œå€Ÿç”¨ Stack Overflow ä¸Šçš„ä¸€ä¸ªæ¡ˆä¾‹ï¼Œå¯ä»¥æ›´å¥½åœ°ç†è§£ `lockInterruptibly()` å¯ä»¥å“åº”ä¸­æ–­ï¼š
>
> ```JAVA
> public class MyRentrantlock {
>  Thread t = new Thread() {
>      @Override
>      public void run() {
>          ReentrantLock r = new ReentrantLock();
>          // 1.1ã€ç¬¬ä¸€æ¬¡å°è¯•è·å–é”ï¼Œå¯ä»¥è·å–æˆåŠŸ
>          r.lock();
> 
>          // 1.2ã€æ­¤æ—¶é”çš„é‡å…¥æ¬¡æ•°ä¸º 1
>          System.out.println("lock() : lock count :" + r.getHoldCount());
> 
>          // 2ã€ä¸­æ–­å½“å‰çº¿ç¨‹ï¼Œé€šè¿‡ Thread.currentThread().isInterrupted() å¯ä»¥çœ‹åˆ°å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ä¸º true
>          interrupt();
>          System.out.println("Current thread is intrupted");
> 
>          // 3.1ã€å°è¯•è·å–é”ï¼Œå¯ä»¥æˆåŠŸè·å–
>          r.tryLock();
>          // 3.2ã€æ­¤æ—¶é”çš„é‡å…¥æ¬¡æ•°ä¸º 2
>          System.out.println("tryLock() on intrupted thread lock count :" + r.getHoldCount());
>          try {
>              // 4ã€æ‰“å°çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ä¸º trueï¼Œé‚£ä¹ˆè°ƒç”¨ lockInterruptibly() æ–¹æ³•å°±ä¼šæŠ›å‡º InterruptedException å¼‚å¸¸
>              System.out.println("Current Thread isInterrupted:" + Thread.currentThread().isInterrupted());
>              r.lockInterruptibly();
>              System.out.println("lockInterruptibly() --NOt executable statement" + r.getHoldCount());
>          } catch (InterruptedException e) {
>              r.lock();
>              System.out.println("Error");
>          } finally {
>              r.unlock();
>          }
> 
>          // 5ã€æ‰“å°é”çš„é‡å…¥æ¬¡æ•°ï¼Œå¯ä»¥å‘ç° lockInterruptibly() æ–¹æ³•å¹¶æ²¡æœ‰æˆåŠŸè·å–åˆ°é”
>          System.out.println("lockInterruptibly() not able to Acqurie lock: lock count :" + r.getHoldCount());
> 
>          r.unlock();
>          System.out.println("lock count :" + r.getHoldCount());
>          r.unlock();
>          System.out.println("lock count :" + r.getHoldCount());
>      }
>  };
>  public static void main(String str[]) {
>      MyRentrantlock m = new MyRentrantlock();
>      m.t.start();
>  }
> }
> ```
>
> è¾“å‡ºï¼š
>
> ```BASH
> lock() : lock count :1
> Current thread is intrupted
> tryLock() on intrupted thread lock count :2
> Current Thread isInterrupted:true
> Error
> lockInterruptibly() not able to Acqurie lock: lock count :2
> lock count :1
> lock count :0
> ```

å…³äº **æ”¯æŒè¶…æ—¶** çš„è¡¥å……ï¼š

> **ä¸ºä»€ä¹ˆéœ€è¦ `tryLock(timeout)` è¿™ä¸ªåŠŸèƒ½å‘¢ï¼Ÿ**
>
> `tryLock(timeout)` æ–¹æ³•å°è¯•åœ¨æŒ‡å®šçš„è¶…æ—¶æ—¶é—´å†…è·å–é”ã€‚å¦‚æœæˆåŠŸè·å–é”ï¼Œåˆ™è¿”å› `true`ï¼›å¦‚æœåœ¨é”å¯ç”¨ä¹‹å‰è¶…æ—¶ï¼Œåˆ™è¿”å› `false`ã€‚æ­¤åŠŸèƒ½åœ¨ä»¥ä¸‹å‡ ç§åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ï¼š
>
> - **é˜²æ­¢æ­»é”ï¼š** åœ¨å¤æ‚çš„é”åœºæ™¯ä¸­ï¼Œ`tryLock(timeout)` å¯ä»¥é€šè¿‡å…è®¸çº¿ç¨‹åœ¨åˆç†çš„æ—¶é—´å†…æ”¾å¼ƒå¹¶é‡è¯•æ¥å¸®åŠ©é˜²æ­¢æ­»é”ã€‚
> - **æé«˜å“åº”é€Ÿåº¦ï¼š** é˜²æ­¢çº¿ç¨‹æ— é™æœŸé˜»å¡ã€‚
> - **å¤„ç†æ—¶é—´æ•æ„Ÿçš„æ“ä½œï¼š** å¯¹äºå…·æœ‰ä¸¥æ ¼æ—¶é—´é™åˆ¶çš„æ“ä½œï¼Œ`tryLock(timeout)` å…è®¸çº¿ç¨‹åœ¨æ— æ³•åŠæ—¶è·å–é”æ—¶ç»§ç»­æ‰§è¡Œæ›¿ä»£æ“ä½œã€‚

### å¯ä¸­æ–­é”å’Œä¸å¯ä¸­æ–­é”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- **å¯ä¸­æ–­é”**ï¼šè·å–é”çš„è¿‡ç¨‹ä¸­å¯ä»¥è¢«ä¸­æ–­ï¼Œä¸éœ€è¦ä¸€ç›´ç­‰åˆ°è·å–é”ä¹‹å æ‰èƒ½è¿›è¡Œå…¶ä»–é€»è¾‘å¤„ç†ã€‚`ReentrantLock` å°±å±äºæ˜¯å¯ä¸­æ–­é”ã€‚
- **ä¸å¯ä¸­æ–­é”**ï¼šä¸€æ—¦çº¿ç¨‹ç”³è¯·äº†é”ï¼Œå°±åªèƒ½ç­‰åˆ°æ‹¿åˆ°é”ä»¥åæ‰èƒ½è¿›è¡Œå…¶ä»–çš„é€»è¾‘å¤„ç†ã€‚ `synchronized` å°±å±äºæ˜¯ä¸å¯ä¸­æ–­é”ã€‚

## ReentrantReadWriteLock

`ReentrantReadWriteLock` åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨çš„å¹¶ä¸å¤šï¼Œé¢è¯•ä¸­ä¹Ÿé—®çš„æ¯”è¾ƒå°‘ï¼Œç®€å•äº†è§£å³å¯ã€‚JDK 1.8 å¼•å…¥äº†æ€§èƒ½æ›´å¥½çš„è¯»å†™é” `StampedLock` ã€‚

### ReentrantReadWriteLock æ˜¯ä»€ä¹ˆï¼Ÿ

`ReentrantReadWriteLock` å®ç°äº† `ReadWriteLock` ï¼Œæ˜¯ä¸€ä¸ªå¯é‡å…¥çš„è¯»å†™é”ï¼Œæ—¢å¯ä»¥ä¿è¯å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»çš„æ•ˆç‡ï¼ŒåŒæ—¶åˆå¯ä»¥ä¿è¯æœ‰å†™å…¥æ“ä½œæ—¶çš„çº¿ç¨‹å®‰å…¨ã€‚

```java
public class ReentrantReadWriteLock
        implements ReadWriteLock, java.io.Serializable{
}
public interface ReadWriteLock {
    Lock readLock();
    Lock writeLock();
}
```

- ä¸€èˆ¬é”è¿›è¡Œå¹¶å‘æ§åˆ¶çš„è§„åˆ™ï¼šè¯»è¯»äº’æ–¥ã€è¯»å†™äº’æ–¥ã€å†™å†™äº’æ–¥ã€‚
- è¯»å†™é”è¿›è¡Œå¹¶å‘æ§åˆ¶çš„è§„åˆ™ï¼šè¯»è¯»ä¸äº’æ–¥ã€è¯»å†™äº’æ–¥ã€å†™å†™äº’æ–¥ï¼ˆåªæœ‰è¯»è¯»ä¸äº’æ–¥ï¼‰ã€‚

`ReentrantReadWriteLock` å…¶å®æ˜¯ä¸¤æŠŠé”ï¼Œä¸€æŠŠæ˜¯ `WriteLock` (å†™é”)ï¼Œä¸€æŠŠæ˜¯ `ReadLock`ï¼ˆè¯»é”ï¼‰ ã€‚è¯»é”æ˜¯å…±äº«é”ï¼Œå†™é”æ˜¯ç‹¬å é”ã€‚è¯»é”å¯ä»¥è¢«åŒæ—¶è¯»ï¼Œå¯ä»¥åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹æŒæœ‰ï¼Œè€Œå†™é”æœ€å¤šåªèƒ½åŒæ—¶è¢«ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ã€‚

å’Œ `ReentrantLock` ä¸€æ ·ï¼Œ`ReentrantReadWriteLock` åº•å±‚ä¹Ÿæ˜¯åŸºäº AQS å®ç°çš„ã€‚

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/reentrantreadwritelock-class-diagram.png)

`ReentrantReadWriteLock` ä¹Ÿæ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œé»˜è®¤ä½¿ç”¨éå…¬å¹³é”ï¼Œå¯ä»¥é€šè¿‡æ„é€ å™¨æ¥æ˜¾å¼åœ°æŒ‡å®šã€‚

```java
// ä¼ å…¥ä¸€ä¸ª boolean å€¼ï¼Œtrue æ—¶ä¸ºå…¬å¹³é”ï¼Œfalse æ—¶ä¸ºéå…¬å¹³é”
public ReentrantReadWriteLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
    readerLock = new ReadLock(this);
    writerLock = new WriteLock(this);
}
```

### ReentrantReadWriteLock é€‚åˆä»€ä¹ˆåœºæ™¯ï¼Ÿ

ç”±äº `ReentrantReadWriteLock` æ—¢å¯ä»¥ä¿è¯å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»çš„æ•ˆç‡ï¼ŒåŒæ—¶åˆå¯ä»¥ä¿è¯æœ‰å†™å…¥æ“ä½œæ—¶çš„çº¿ç¨‹å®‰å…¨ã€‚å› æ­¤ï¼Œåœ¨è¯»å¤šå†™å°‘çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ `ReentrantReadWriteLock` èƒ½å¤Ÿæ˜æ˜¾æå‡ç³»ç»Ÿæ€§èƒ½ã€‚

### å…±äº«é”å’Œç‹¬å é”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- **å…±äº«é”**ï¼šä¸€æŠŠé”å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å¾—ã€‚
- **ç‹¬å é”**ï¼šä¸€æŠŠé”åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è·å¾—ã€‚

### çº¿ç¨‹æŒæœ‰è¯»é”è¿˜èƒ½è·å–å†™é”å—ï¼Ÿ

- åœ¨çº¿ç¨‹æŒæœ‰è¯»é”çš„æƒ…å†µä¸‹ï¼Œè¯¥çº¿ç¨‹ä¸èƒ½å–å¾—å†™é”(å› ä¸ºè·å–å†™é”çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å½“å‰çš„è¯»é”è¢«å ç”¨ï¼Œå°±é©¬ä¸Šè·å–å¤±è´¥ï¼Œä¸ç®¡è¯»é”æ˜¯ä¸æ˜¯è¢«å½“å‰çº¿ç¨‹æŒæœ‰)ã€‚
- åœ¨çº¿ç¨‹æŒæœ‰å†™é”çš„æƒ…å†µä¸‹ï¼Œè¯¥çº¿ç¨‹å¯ä»¥ç»§ç»­è·å–è¯»é”ï¼ˆè·å–è¯»é”æ—¶å¦‚æœå‘ç°å†™é”è¢«å ç”¨ï¼Œåªæœ‰å†™é”æ²¡æœ‰è¢«å½“å‰çº¿ç¨‹å ç”¨çš„æƒ…å†µæ‰ä¼šè·å–å¤±è´¥ï¼‰ã€‚

è¯»å†™é”çš„æºç åˆ†æï¼Œæ¨èé˜…è¯» [èŠèŠ Java çš„å‡ æŠŠ JVM çº§é” - é˜¿é‡Œå·´å·´ä¸­é—´ä»¶](https://mp.weixin.qq.com/s/h3VIUyH9L0v14MrQJiiDbw) è¿™ç¯‡æ–‡ç« ï¼Œå†™çš„å¾ˆä¸é”™ã€‚

### è¯»é”ä¸ºä»€ä¹ˆä¸èƒ½å‡çº§ä¸ºå†™é”ï¼Ÿ

å†™é”å¯ä»¥é™çº§ä¸ºè¯»é”ï¼Œä½†æ˜¯è¯»é”å´ä¸èƒ½å‡çº§ä¸ºå†™é”ã€‚è¿™æ˜¯å› ä¸ºè¯»é”å‡çº§ä¸ºå†™é”ä¼šå¼•èµ·çº¿ç¨‹çš„äº‰å¤ºï¼Œæ¯•ç«Ÿå†™é”å±äºæ˜¯ç‹¬å é”ï¼Œè¿™æ ·çš„è¯ï¼Œä¼šå½±å“æ€§èƒ½ã€‚

å¦å¤–ï¼Œè¿˜å¯èƒ½ä¼šæœ‰æ­»é”é—®é¢˜å‘ç”Ÿã€‚ä¸¾ä¸ªä¾‹å­ï¼šå‡è®¾ä¸¤ä¸ªçº¿ç¨‹çš„è¯»é”éƒ½æƒ³å‡çº§å†™é”ï¼Œåˆ™éœ€è¦å¯¹æ–¹éƒ½é‡Šæ”¾è‡ªå·±é”ï¼Œè€ŒåŒæ–¹éƒ½ä¸é‡Šæ”¾ï¼Œå°±ä¼šäº§ç”Ÿæ­»é”ã€‚

## ThreadLocal

### ThreadLocal æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºçš„å˜é‡å¯ä»¥è¢«ä»»ä½•ä¸€ä¸ªçº¿ç¨‹è®¿é—®å’Œä¿®æ”¹ã€‚è¿™åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¯èƒ½å¯¼è‡´æ•°æ®ç«äº‰å’Œçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚é‚£ä¹ˆï¼Œ**å¦‚æœæƒ³è®©æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸“å±æœ¬åœ°å˜é‡ï¼Œè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ**

JDK ä¸­æä¾›çš„ `ThreadLocal` ç±»æ­£æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚**`ThreadLocal` ç±»å…è®¸æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼**ï¼Œå¯ä»¥å°†å…¶å½¢è±¡åœ°æ¯”å–»ä¸ºä¸€ä¸ªâ€œå­˜æ”¾æ•°æ®çš„ç›’å­â€ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ç›’å­ï¼Œç”¨äºå­˜å‚¨ç§æœ‰æ•°æ®ï¼Œç¡®ä¿ä¸åŒçº¿ç¨‹ä¹‹é—´çš„æ•°æ®äº’ä¸å¹²æ‰°ã€‚

å½“ä½ åˆ›å»ºä¸€ä¸ª `ThreadLocal` å˜é‡æ—¶ï¼Œæ¯ä¸ªè®¿é—®è¯¥å˜é‡çš„çº¿ç¨‹éƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„å‰¯æœ¬ã€‚è¿™ä¹Ÿæ˜¯ `ThreadLocal` åç§°çš„ç”±æ¥ã€‚çº¿ç¨‹å¯ä»¥é€šè¿‡ `get()` æ–¹æ³•è·å–è‡ªå·±çº¿ç¨‹çš„æœ¬åœ°å‰¯æœ¬ï¼Œæˆ–é€šè¿‡ `set()` æ–¹æ³•ä¿®æ”¹è¯¥å‰¯æœ¬çš„å€¼ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼šå‡è®¾æœ‰ä¸¤ä¸ªäººå»å®å±‹æ”¶é›†å®ç‰©ã€‚å¦‚æœä»–ä»¬å…±ç”¨ä¸€ä¸ªè¢‹å­ï¼Œå¿…ç„¶ä¼šäº§ç”Ÿäº‰æ‰§ï¼›ä½†å¦‚æœæ¯ä¸ªäººéƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„è¢‹å­ï¼Œå°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœå°†è¿™ä¸¤ä¸ªäººæ¯”ä½œçº¿ç¨‹ï¼Œé‚£ä¹ˆ `ThreadLocal` å°±æ˜¯ç”¨æ¥é¿å…è¿™ä¸¤ä¸ªçº¿ç¨‹ç«äº‰åŒä¸€ä¸ªèµ„æºçš„æ–¹æ³•ã€‚

```java
public class ThreadLocalExample {
    private static ThreadLocal<Integer> threadLocal = ThreadLocal.withInitial(() -> 0);

    public static void main(String[] args) {
        Runnable task = () -> {
            int value = threadLocal.get();
            value += 1;
            threadLocal.set(value);
            System.out.println(Thread.currentThread().getName() + " Value: " + threadLocal.get());
        };

        Thread thread1 = new Thread(task, "Thread-1");
        Thread thread2 = new Thread(task, "Thread-2");

        thread1.start(); // è¾“å‡º: Thread-1 Value: 1
        thread2.start(); // è¾“å‡º: Thread-2 Value: 1
    }
}
```

### â­ï¸ThreadLocal åŸç†äº†è§£å—ï¼Ÿ

ä» `Thread`ç±»æºä»£ç å…¥æ‰‹ã€‚

```java
public class Thread implements Runnable {
    //......
    //ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„ThreadLocalå€¼ã€‚ç”±ThreadLocalç±»ç»´æŠ¤
    ThreadLocal.ThreadLocalMap threadLocals = null;

    //ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„InheritableThreadLocalå€¼ã€‚ç”±InheritableThreadLocalç±»ç»´æŠ¤
    ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
    //......
}
```

ä»ä¸Šé¢`Thread`ç±» æºä»£ç å¯ä»¥çœ‹å‡º`Thread` ç±»ä¸­æœ‰ä¸€ä¸ª `threadLocals` å’Œ ä¸€ä¸ª `inheritableThreadLocals` å˜é‡ï¼Œå®ƒä»¬éƒ½æ˜¯ `ThreadLocalMap` ç±»å‹çš„å˜é‡,æˆ‘ä»¬å¯ä»¥æŠŠ `ThreadLocalMap` ç†è§£ä¸º`ThreadLocal` ç±»å®ç°çš„å®šåˆ¶åŒ–çš„ `HashMap`ã€‚é»˜è®¤æƒ…å†µä¸‹è¿™ä¸¤ä¸ªå˜é‡éƒ½æ˜¯ nullï¼Œåªæœ‰å½“å‰çº¿ç¨‹è°ƒç”¨ `ThreadLocal` ç±»çš„ `set`æˆ–`get`æ–¹æ³•æ—¶æ‰åˆ›å»ºå®ƒä»¬ï¼Œå®é™…ä¸Šè°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨çš„æ˜¯`ThreadLocalMap`ç±»å¯¹åº”çš„ `get()`ã€`set()`æ–¹æ³•ã€‚

`ThreadLocal`ç±»çš„`set()`æ–¹æ³•

```java
public void set(T value) {
    //è·å–å½“å‰è¯·æ±‚çš„çº¿ç¨‹
    Thread t = Thread.currentThread();
    //å–å‡º Thread ç±»å†…éƒ¨çš„ threadLocals å˜é‡(å“ˆå¸Œè¡¨ç»“æ„)
    ThreadLocalMap map = getMap(t);
    if (map != null)
        // å°†éœ€è¦å­˜å‚¨çš„å€¼æ”¾å…¥åˆ°è¿™ä¸ªå“ˆå¸Œè¡¨ä¸­
        map.set(this, value);
    else
        createMap(t, value);
}
ThreadLocalMap getMap(Thread t) {
    return t.threadLocals;
}
```

é€šè¿‡ä¸Šé¢è¿™äº›å†…å®¹ï¼Œæˆ‘ä»¬è¶³ä»¥é€šè¿‡çŒœæµ‹å¾—å‡ºç»“è®ºï¼š**æœ€ç»ˆçš„å˜é‡æ˜¯æ”¾åœ¨äº†å½“å‰çº¿ç¨‹çš„ `ThreadLocalMap` ä¸­ï¼Œå¹¶ä¸æ˜¯å­˜åœ¨ `ThreadLocal` ä¸Šï¼Œ`ThreadLocal` å¯ä»¥ç†è§£ä¸ºåªæ˜¯`ThreadLocalMap`çš„å°è£…ï¼Œä¼ é€’äº†å˜é‡å€¼ã€‚** `ThrealLocal` ç±»ä¸­å¯ä»¥é€šè¿‡`Thread.currentThread()`è·å–åˆ°å½“å‰çº¿ç¨‹å¯¹è±¡åï¼Œç›´æ¥é€šè¿‡`getMap(Thread t)`å¯ä»¥è®¿é—®åˆ°è¯¥çº¿ç¨‹çš„`ThreadLocalMap`å¯¹è±¡ã€‚

**æ¯ä¸ª`Thread`ä¸­éƒ½å…·å¤‡ä¸€ä¸ª`ThreadLocalMap`ï¼Œè€Œ`ThreadLocalMap`å¯ä»¥å­˜å‚¨ä»¥`ThreadLocal`ä¸º key ï¼ŒObject å¯¹è±¡ä¸º value çš„é”®å€¼å¯¹ã€‚**

```java
ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {
    //......
}
```

æ¯”å¦‚æˆ‘ä»¬åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å£°æ˜äº†ä¸¤ä¸ª `ThreadLocal` å¯¹è±¡çš„è¯ï¼Œ `Thread`å†…éƒ¨éƒ½æ˜¯ä½¿ç”¨ä»…æœ‰çš„é‚£ä¸ª`ThreadLocalMap` å­˜æ”¾æ•°æ®çš„ï¼Œ`ThreadLocalMap`çš„ key å°±æ˜¯ `ThreadLocal`å¯¹è±¡ï¼Œvalue å°±æ˜¯ `ThreadLocal` å¯¹è±¡è°ƒç”¨`set`æ–¹æ³•è®¾ç½®çš„å€¼ã€‚

`ThreadLocal` æ•°æ®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ThreadLocal æ•°æ®ç»“æ„](https://oss.javaguide.cn/github/javaguide/java/concurrent/threadlocal-data-structure.png)

`ThreadLocalMap`æ˜¯`ThreadLocal`çš„é™æ€å†…éƒ¨ç±»ã€‚

![ThreadLocalå†…éƒ¨ç±»](https://oss.javaguide.cn/github/javaguide/java/concurrent/thread-local-inner-class.png)

### â­ï¸ThreadLocal å†…å­˜æ³„éœ²é—®é¢˜æ˜¯æ€ä¹ˆå¯¼è‡´çš„ï¼Ÿ

`ThreadLocal` å†…å­˜æ³„æ¼çš„æ ¹æœ¬åŸå› åœ¨äºå…¶å†…éƒ¨å®ç°æœºåˆ¶ã€‚

é€šè¿‡ä¸Šé¢çš„å†…å®¹æˆ‘ä»¬å·²ç»çŸ¥é“ï¼šæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªåä¸º `ThreadLocalMap` çš„ mapã€‚ å½“ä½ ä½¿ç”¨ `ThreadLocal` å­˜å‚¨å€¼æ—¶ï¼Œå®é™…ä¸Šæ˜¯å°†å€¼å­˜å‚¨åœ¨å½“å‰çº¿ç¨‹çš„ `ThreadLocalMap` ä¸­ï¼Œå…¶ä¸­ `ThreadLocal` å®ä¾‹æœ¬èº«ä½œä¸º keyï¼Œè€Œä½ è¦å­˜å‚¨çš„å€¼ä½œä¸º valueã€‚

`ThreadLocal` çš„ `set()` æ–¹æ³•æºç å¦‚ä¸‹ï¼š

```java
public void set(T value) {
    Thread t = Thread.currentThread(); // è·å–å½“å‰çº¿ç¨‹
    ThreadLocalMap map = getMap(t);   // è·å–å½“å‰çº¿ç¨‹çš„ ThreadLocalMap
    if (map != null) {
        map.set(this, value);         // è®¾ç½®å€¼
    } else {
        createMap(t, value);          // åˆ›å»ºæ–°çš„ ThreadLocalMap
    }
}
```

`ThreadLocalMap` çš„ `set()` å’Œ `createMap()` æ–¹æ³•ä¸­ï¼Œå¹¶æ²¡æœ‰ç›´æ¥å­˜å‚¨ `ThreadLocal` å¯¹è±¡æœ¬èº«ï¼Œè€Œæ˜¯ä½¿ç”¨ `ThreadLocal` çš„å“ˆå¸Œå€¼è®¡ç®—æ•°ç»„ç´¢å¼•ï¼Œæœ€ç»ˆå­˜å‚¨äºç±»å‹ä¸º`static class Entry extends WeakReference<ThreadLocal<?>>`çš„æ•°ç»„ä¸­ã€‚

```java
int i = key.threadLocalHashCode & (len-1);
```

`ThreadLocalMap` çš„ `Entry` å®šä¹‰å¦‚ä¸‹ï¼š

```java
static class Entry extends WeakReference<ThreadLocal<?>> {
    Object value;

    Entry(ThreadLocal<?> k, Object v) {
        super(k);
        value = v;
    }
}
```

`ThreadLocalMap` çš„ `key` å’Œ `value` å¼•ç”¨æœºåˆ¶ï¼š

- **key æ˜¯å¼±å¼•ç”¨**ï¼š`ThreadLocalMap` ä¸­çš„ key æ˜¯ `ThreadLocal` çš„å¼±å¼•ç”¨ (`WeakReference<ThreadLocal<?>>`)ã€‚ è¿™æ„å‘³ç€ï¼Œå¦‚æœ `ThreadLocal` å®ä¾‹ä¸å†è¢«ä»»ä½•å¼ºå¼•ç”¨æŒ‡å‘ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šåœ¨ä¸‹æ¬¡ GC æ—¶å›æ”¶è¯¥å®ä¾‹ï¼Œå¯¼è‡´ `ThreadLocalMap` ä¸­å¯¹åº”çš„ key å˜ä¸º `null`ã€‚
- **value æ˜¯å¼ºå¼•ç”¨**ï¼šå³ä½¿ `key` è¢« GC å›æ”¶ï¼Œ`value` ä»ç„¶è¢« `ThreadLocalMap.Entry` å¼ºå¼•ç”¨å­˜åœ¨ï¼Œæ— æ³•è¢« GC å›æ”¶ã€‚

å½“ `ThreadLocal` å®ä¾‹å¤±å»å¼ºå¼•ç”¨åï¼Œå…¶å¯¹åº”çš„ value ä»ç„¶å­˜åœ¨äº `ThreadLocalMap` ä¸­ï¼Œå› ä¸º `Entry` å¯¹è±¡å¼ºå¼•ç”¨äº†å®ƒã€‚å¦‚æœçº¿ç¨‹æŒç»­å­˜æ´»ï¼ˆä¾‹å¦‚çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼‰ï¼Œ`ThreadLocalMap` ä¹Ÿä¼šä¸€ç›´å­˜åœ¨ï¼Œå¯¼è‡´ key ä¸º `null` çš„ entry æ— æ³•è¢«åƒåœ¾å›æ”¶ï¼Œå³ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œå†…å­˜æ³„æ¼çš„å‘ç”Ÿéœ€è¦åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š

1. `ThreadLocal` å®ä¾‹ä¸å†è¢«å¼ºå¼•ç”¨ï¼›
2. çº¿ç¨‹æŒç»­å­˜æ´»ï¼Œå¯¼è‡´ `ThreadLocalMap` é•¿æœŸå­˜åœ¨ã€‚

è™½ç„¶ `ThreadLocalMap` åœ¨ `get()`, `set()` å’Œ `remove()` æ“ä½œæ—¶ä¼šå°è¯•æ¸…ç† key ä¸º null çš„ entryï¼Œä½†è¿™ç§æ¸…ç†æœºåˆ¶æ˜¯è¢«åŠ¨çš„ï¼Œå¹¶ä¸å®Œå…¨å¯é ã€‚

**å¦‚ä½•é¿å…å†…å­˜æ³„æ¼çš„å‘ç”Ÿï¼Ÿ**

1. åœ¨ä½¿ç”¨å®Œ `ThreadLocal` åï¼ŒåŠ¡å¿…è°ƒç”¨ `remove()` æ–¹æ³•ã€‚ è¿™æ˜¯æœ€å®‰å…¨å’Œæœ€æ¨èçš„åšæ³•ã€‚ `remove()` æ–¹æ³•ä¼šä» `ThreadLocalMap` ä¸­æ˜¾å¼åœ°ç§»é™¤å¯¹åº”çš„ entryï¼Œå½»åº•è§£å†³å†…å­˜æ³„æ¼çš„é£é™©ã€‚ å³ä½¿å°† `ThreadLocal` å®šä¹‰ä¸º `static final`ï¼Œä¹Ÿå¼ºçƒˆå»ºè®®åœ¨æ¯æ¬¡ä½¿ç”¨åè°ƒç”¨ `remove()`ã€‚
2. åœ¨çº¿ç¨‹æ± ç­‰çº¿ç¨‹å¤ç”¨çš„åœºæ™¯ä¸‹ï¼Œä½¿ç”¨ `try-finally` å—å¯ä»¥ç¡®ä¿å³ä½¿å‘ç”Ÿå¼‚å¸¸ï¼Œ`remove()` æ–¹æ³•ä¹Ÿä¸€å®šä¼šè¢«æ‰§è¡Œã€‚

### â­ï¸å¦‚ä½•è·¨çº¿ç¨‹ä¼ é€’ ThreadLocal çš„å€¼ï¼Ÿ

ç”±äº `ThreadLocal` çš„å˜é‡å€¼å­˜æ”¾åœ¨ `Thread` é‡Œï¼Œè€Œçˆ¶å­çº¿ç¨‹å±äºä¸åŒçš„ `Thread` çš„ã€‚å› æ­¤åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ï¼Œçˆ¶å­çº¿ç¨‹çš„ `ThreadLocal` å€¼æ— æ³•è¿›è¡Œä¼ é€’ã€‚

å¦‚æœæƒ³è¦åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ä¼ é€’ `ThreadLocal` å€¼ï¼Œæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š

- `InheritableThreadLocal` ï¼š`InheritableThreadLocal` æ˜¯ JDK1.2 æä¾›çš„å·¥å…·ï¼Œç»§æ‰¿è‡ª `ThreadLocal` ã€‚ä½¿ç”¨ `InheritableThreadLocal` æ—¶ï¼Œä¼šåœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶ï¼Œä»¤å­çº¿ç¨‹ç»§æ‰¿çˆ¶çº¿ç¨‹ä¸­çš„ `ThreadLocal` å€¼ï¼Œä½†æ˜¯æ— æ³•æ”¯æŒçº¿ç¨‹æ± åœºæ™¯ä¸‹çš„ `ThreadLocal` å€¼ä¼ é€’ã€‚
- `TransmittableThreadLocal` ï¼š `TransmittableThreadLocal` ï¼ˆç®€ç§° TTLï¼‰ æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„å·¥å…·ç±»ï¼Œç»§æ‰¿å¹¶åŠ å¼ºäº†`InheritableThreadLocal`ç±»ï¼Œå¯ä»¥åœ¨çº¿ç¨‹æ± çš„åœºæ™¯ä¸‹æ”¯æŒ `ThreadLocal` å€¼ä¼ é€’ã€‚é¡¹ç›®åœ°å€ï¼š<https://github.com/alibaba/transmittable-thread-local>ã€‚

#### InheritableThreadLocal åŸç†

`InheritableThreadLocal` å®ç°äº†åˆ›å»ºå¼‚æ­¥çº¿ç¨‹æ—¶ï¼Œç»§æ‰¿çˆ¶çº¿ç¨‹ `ThreadLocal` å€¼çš„åŠŸèƒ½ã€‚è¯¥ç±»æ˜¯ JDK å›¢é˜Ÿæä¾›çš„ï¼Œé€šè¿‡æ”¹é€  JDK æºç åŒ…ä¸­çš„ `Thread` ç±»æ¥å®ç°åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œ`ThreadLocal` å€¼çš„ä¼ é€’ã€‚

**`InheritableThreadLocal` çš„å€¼å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ**

åœ¨ `Thread` ç±»ä¸­æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ `ThreadLocalMap` ï¼Œå‘½åä¸º `inheritableThreadLocals` ï¼Œè¯¥å˜é‡ç”¨äºå­˜å‚¨éœ€è¦è·¨çº¿ç¨‹ä¼ é€’çš„ `ThreadLocal` å€¼ã€‚å¦‚ä¸‹ï¼š

```JAVA
class Thread implements Runnable {
    ThreadLocal.ThreadLocalMap threadLocals = null;
    ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
}
```

**å¦‚ä½•å®Œæˆ `ThreadLocal` å€¼çš„ä¼ é€’ï¼Ÿ**

é€šè¿‡æ”¹é€  `Thread` ç±»çš„æ„é€ æ–¹æ³•æ¥å®ç°ï¼Œåœ¨åˆ›å»º `Thread` çº¿ç¨‹æ—¶ï¼Œæ‹¿åˆ°çˆ¶çº¿ç¨‹çš„ `inheritableThreadLocals` å˜é‡èµ‹å€¼ç»™å­çº¿ç¨‹å³å¯ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š

```JAVA
// Thread çš„æ„é€ æ–¹æ³•ä¼šè°ƒç”¨ init() æ–¹æ³•
private void init(/* ... */) {
	// 1ã€è·å–çˆ¶çº¿ç¨‹
    Thread parent = currentThread();
    // 2ã€å°†çˆ¶çº¿ç¨‹çš„ inheritableThreadLocals èµ‹å€¼ç»™å­çº¿ç¨‹
    if (inheritThreadLocals && parent.inheritableThreadLocals != null)
        this.inheritableThreadLocals =
        	ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);
}
```

#### TransmittableThreadLocal åŸç†

JDK é»˜è®¤æ²¡æœ‰æ”¯æŒçº¿ç¨‹æ± åœºæ™¯ä¸‹ `ThreadLocal` å€¼ä¼ é€’çš„åŠŸèƒ½ï¼Œå› æ­¤é˜¿é‡Œå·´å·´å¼€æºäº†ä¸€å¥—å·¥å…· `TransmittableThreadLocal` æ¥å®ç°è¯¥åŠŸèƒ½ã€‚

é˜¿é‡Œå·´å·´æ— æ³•æ”¹åŠ¨ JDK çš„æºç ï¼Œå› æ­¤ä»–å†…éƒ¨é€šè¿‡ **è£…é¥°å™¨æ¨¡å¼** åœ¨åŸæœ‰çš„åŠŸèƒ½ä¸Šåšå¢å¼ºï¼Œä»¥æ­¤æ¥å®ç°çº¿ç¨‹æ± åœºæ™¯ä¸‹çš„ `ThreadLocal` å€¼ä¼ é€’ã€‚

TTL æ”¹é€ çš„åœ°æ–¹æœ‰ä¸¤å¤„ï¼š

- å®ç°è‡ªå®šä¹‰çš„ `Thread` ï¼Œåœ¨ `run()` æ–¹æ³•å†…éƒ¨åš `ThreadLocal` å˜é‡çš„èµ‹å€¼æ“ä½œã€‚

- åŸºäº **çº¿ç¨‹æ± ** è¿›è¡Œè£…é¥°ï¼Œåœ¨ `execute()` æ–¹æ³•ä¸­ï¼Œä¸æäº¤ JDK å†…éƒ¨çš„ `Thread` ï¼Œè€Œæ˜¯æäº¤è‡ªå®šä¹‰çš„ `Thread` ã€‚

å¦‚æœæƒ³è¦æŸ¥çœ‹ç›¸å…³æºç ï¼Œå¯ä»¥å¼•å…¥ Maven ä¾èµ–è¿›è¡Œä¸‹è½½ã€‚

```XML
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>transmittable-thread-local</artifactId>
    <version>2.12.0</version>
</dependency>
```

#### åº”ç”¨åœºæ™¯

1. **å‹æµ‹æµé‡æ ‡è®°**ï¼š åœ¨å‹æµ‹åœºæ™¯ä¸­ï¼Œä½¿ç”¨ `ThreadLocal` å­˜å‚¨å‹æµ‹æ ‡è®°ï¼Œç”¨äºåŒºåˆ†å‹æµ‹æµé‡å’ŒçœŸå®æµé‡ã€‚å¦‚æœæ ‡è®°ä¸¢å¤±ï¼Œå¯èƒ½å¯¼è‡´å‹æµ‹æµé‡è¢«é”™è¯¯åœ°å½“æˆçº¿ä¸Šæµé‡å¤„ç†ã€‚
2. **ä¸Šä¸‹æ–‡ä¼ é€’**ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¼ é€’é“¾è·¯è¿½è¸ªä¿¡æ¯ï¼ˆå¦‚ Trace IDï¼‰æˆ–ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

## çº¿ç¨‹æ± 

### ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± ?

é¡¾åæ€ä¹‰ï¼Œçº¿ç¨‹æ± å°±æ˜¯ç®¡ç†ä¸€ç³»åˆ—çº¿ç¨‹çš„èµ„æºæ± ã€‚å½“æœ‰ä»»åŠ¡è¦å¤„ç†æ—¶ï¼Œç›´æ¥ä»çº¿ç¨‹æ± ä¸­è·å–çº¿ç¨‹æ¥å¤„ç†ï¼Œå¤„ç†å®Œä¹‹åçº¿ç¨‹å¹¶ä¸ä¼šç«‹å³è¢«é”€æ¯ï¼Œè€Œæ˜¯ç­‰å¾…ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚

### â­ï¸ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± ï¼Ÿ

æ± åŒ–æŠ€æœ¯æƒ³å¿…å¤§å®¶å·²ç»å±¡è§ä¸é²œäº†ï¼Œçº¿ç¨‹æ± ã€æ•°æ®åº“è¿æ¥æ± ã€HTTP è¿æ¥æ± ç­‰ç­‰éƒ½æ˜¯å¯¹è¿™ä¸ªæ€æƒ³çš„åº”ç”¨ã€‚æ± åŒ–æŠ€æœ¯çš„æ€æƒ³ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘æ¯æ¬¡è·å–èµ„æºçš„æ¶ˆè€—ï¼Œæé«˜å¯¹èµ„æºçš„åˆ©ç”¨ç‡ã€‚

çº¿ç¨‹æ± æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†èµ„æºï¼ˆåŒ…æ‹¬æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰çš„æ–¹å¼ã€‚ æ¯ä¸ªçº¿ç¨‹æ± è¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆä»»åŠ¡çš„æ•°é‡ã€‚ä½¿ç”¨çº¿ç¨‹æ± ä¸»è¦å¸¦æ¥ä»¥ä¸‹å‡ ä¸ªå¥½å¤„ï¼š

1. **é™ä½èµ„æºæ¶ˆè€—**ï¼šçº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹æ˜¯å¯ä»¥é‡å¤åˆ©ç”¨çš„ã€‚ä¸€æ—¦çº¿ç¨‹å®Œæˆäº†æŸä¸ªä»»åŠ¡ï¼Œå®ƒä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯å›åˆ°æ± å­é‡Œç­‰å¾…ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚è¿™å°±é¿å…äº†é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¸¦æ¥çš„å¼€é”€ã€‚
2. **æé«˜å“åº”é€Ÿåº¦**ï¼šå› ä¸ºçº¿ç¨‹æ± é‡Œé€šå¸¸ä¼šç»´æŠ¤ä¸€å®šæ•°é‡çš„æ ¸å¿ƒçº¿ç¨‹ï¼ˆæˆ–è€…è¯´â€œå¸¸é©»å·¥äººâ€ï¼‰ï¼Œä»»åŠ¡æ¥äº†ä¹‹åï¼Œå¯ä»¥ç›´æ¥äº¤ç»™è¿™äº›å·²ç»å­˜åœ¨çš„ã€ç©ºé—²çš„çº¿ç¨‹å»æ‰§è¡Œï¼Œçœå»äº†åˆ›å»ºçº¿ç¨‹çš„æ—¶é—´ï¼Œä»»åŠ¡èƒ½å¤Ÿæ›´å¿«åœ°å¾—åˆ°å¤„ç†ã€‚
3. **æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§**ï¼šçº¿ç¨‹æ± å…è®¸æˆ‘ä»¬ç»Ÿä¸€ç®¡ç†æ± ä¸­çš„çº¿ç¨‹ã€‚æˆ‘ä»¬å¯ä»¥é…ç½®çº¿ç¨‹æ± çš„å¤§å°ï¼ˆæ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ï¼‰ã€ä»»åŠ¡é˜Ÿåˆ—çš„ç±»å‹å’Œå¤§å°ã€æ‹’ç»ç­–ç•¥ç­‰ã€‚è¿™æ ·å°±èƒ½æ§åˆ¶å¹¶å‘çº¿ç¨‹çš„æ€»é‡ï¼Œé˜²æ­¢èµ„æºè€—å°½ï¼Œä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚åŒæ—¶ï¼Œçº¿ç¨‹æ± é€šå¸¸ä¹Ÿæä¾›äº†ç›‘æ§æ¥å£ï¼Œæ–¹ä¾¿æˆ‘ä»¬äº†è§£çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ï¼ˆæ¯”å¦‚æœ‰å¤šå°‘æ´»è·ƒçº¿ç¨‹ã€å¤šå°‘ä»»åŠ¡åœ¨æ’é˜Ÿç­‰ï¼‰ï¼Œä¾¿äºè°ƒä¼˜ã€‚

### å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± ï¼Ÿ

åœ¨ Java ä¸­ï¼Œåˆ›å»ºçº¿ç¨‹æ± ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š

**æ–¹å¼ä¸€ï¼šé€šè¿‡ `ThreadPoolExecutor` æ„é€ å‡½æ•°ç›´æ¥åˆ›å»º (æ¨è)**

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/threadpoolexecutor-construtors.png)

è¿™æ˜¯æœ€æ¨èçš„æ–¹å¼ï¼Œå› ä¸ºå®ƒå…è®¸å¼€å‘è€…æ˜ç¡®æŒ‡å®šçº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°ï¼Œå¯¹çº¿ç¨‹æ± çš„è¿è¡Œè¡Œä¸ºæœ‰æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œä»è€Œé¿å…èµ„æºè€—å°½çš„é£é™©ã€‚

**æ–¹å¼äºŒï¼šé€šè¿‡ `Executors` å·¥å…·ç±»åˆ›å»º (ä¸æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ)**

`Executors`å·¥å…·ç±»æä¾›çš„åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹æ³•å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/executors-new-thread-pool-methods.png)

å¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡`Executors`å·¥å…·ç±»å¯ä»¥åˆ›å»ºå¤šç§ç±»å‹çš„çº¿ç¨‹æ± ï¼ŒåŒ…æ‹¬ï¼š

- `FixedThreadPool`ï¼šå›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚è¯¥çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å§‹ç»ˆä¸å˜ã€‚å½“æœ‰ä¸€ä¸ªæ–°çš„ä»»åŠ¡æäº¤æ—¶ï¼Œçº¿ç¨‹æ± ä¸­è‹¥æœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ç«‹å³æ‰§è¡Œã€‚è‹¥æ²¡æœ‰ï¼Œåˆ™æ–°çš„ä»»åŠ¡ä¼šè¢«æš‚å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…æœ‰çº¿ç¨‹ç©ºé—²æ—¶ï¼Œä¾¿å¤„ç†åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚
- `SingleThreadExecutor`ï¼š åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚è‹¥å¤šä½™ä¸€ä¸ªä»»åŠ¡è¢«æäº¤åˆ°è¯¥çº¿ç¨‹æ± ï¼Œä»»åŠ¡ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…çº¿ç¨‹ç©ºé—²ï¼ŒæŒ‰å…ˆå…¥å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚
- `CachedThreadPool`ï¼š å¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´çº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ä¸ç¡®å®šï¼Œä½†è‹¥æœ‰ç©ºé—²çº¿ç¨‹å¯ä»¥å¤ç”¨ï¼Œåˆ™ä¼šä¼˜å…ˆä½¿ç”¨å¯å¤ç”¨çš„çº¿ç¨‹ã€‚è‹¥æ‰€æœ‰çº¿ç¨‹å‡åœ¨å·¥ä½œï¼Œåˆæœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œåˆ™ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹å¤„ç†ä»»åŠ¡ã€‚æ‰€æœ‰çº¿ç¨‹åœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå°†è¿”å›çº¿ç¨‹æ± è¿›è¡Œå¤ç”¨ã€‚
- `ScheduledThreadPool`ï¼šç»™å®šçš„å»¶è¿Ÿåè¿è¡Œä»»åŠ¡æˆ–è€…å®šæœŸæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± ã€‚

### â­ï¸ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨å†…ç½®çº¿ç¨‹æ± ï¼Ÿ

åœ¨ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹â€œå¹¶å‘å¤„ç†â€è¿™ä¸€ç« èŠ‚ï¼Œæ˜ç¡®æŒ‡å‡ºçº¿ç¨‹èµ„æºå¿…é¡»é€šè¿‡çº¿ç¨‹æ± æä¾›ï¼Œä¸å…è®¸åœ¨åº”ç”¨ä¸­è‡ªè¡Œæ˜¾å¼åˆ›å»ºçº¿ç¨‹ã€‚

**ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ**

> ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„æ˜¯å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€æ¶ˆè€—çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºå¼€é”€ï¼Œè§£å†³èµ„æºä¸è¶³çš„é—®é¢˜ã€‚å¦‚æœä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡åŒç±»çº¿ç¨‹è€Œå¯¼è‡´æ¶ˆè€—å®Œå†…å­˜æˆ–è€…â€œè¿‡åº¦åˆ‡æ¢â€çš„é—®é¢˜ã€‚

å¦å¤–ï¼Œã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ä¸­å¼ºåˆ¶çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ `Executors` å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ `ThreadPoolExecutor` æ„é€ å‡½æ•°çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©

`Executors` è¿”å›çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹(åæ–‡ä¼šè¯¦ç»†ä»‹ç»åˆ°)ï¼š

- `FixedThreadPool` å’Œ `SingleThreadExecutor`:ä½¿ç”¨çš„æ˜¯é˜»å¡é˜Ÿåˆ— `LinkedBlockingQueue`ï¼Œä»»åŠ¡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ä¸º `Integer.MAX_VALUE`ï¼Œå¯ä»¥çœ‹ä½œæ˜¯æ— ç•Œçš„ï¼Œå¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- `CachedThreadPool`:ä½¿ç”¨çš„æ˜¯åŒæ­¥é˜Ÿåˆ— `SynchronousQueue`, å…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°é‡ä¸º `Integer.MAX_VALUE` ï¼Œå¦‚æœä»»åŠ¡æ•°é‡è¿‡å¤šä¸”æ‰§è¡Œé€Ÿåº¦è¾ƒæ…¢ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- `ScheduledThreadPool` å’Œ `SingleThreadScheduledExecutor`:ä½¿ç”¨çš„æ— ç•Œçš„å»¶è¿Ÿé˜»å¡é˜Ÿåˆ—`DelayedWorkQueue`ï¼Œä»»åŠ¡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ä¸º `Integer.MAX_VALUE`,å¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚

```java
public static ExecutorService newFixedThreadPool(int nThreads) {
    // LinkedBlockingQueue çš„é»˜è®¤é•¿åº¦ä¸º Integer.MAX_VALUEï¼Œå¯ä»¥çœ‹ä½œæ˜¯æ— ç•Œçš„
    return new ThreadPoolExecutor(nThreads, nThreads,0L, TimeUnit.MILLISECONDS,new LinkedBlockingQueue<Runnable>());

}

public static ExecutorService newSingleThreadExecutor() {
    // LinkedBlockingQueue çš„é»˜è®¤é•¿åº¦ä¸º Integer.MAX_VALUEï¼Œå¯ä»¥çœ‹ä½œæ˜¯æ— ç•Œçš„
    return new FinalizableDelegatedExecutorService (new ThreadPoolExecutor(1, 1,0L, TimeUnit.MILLISECONDS,new LinkedBlockingQueue<Runnable>()));

}

// åŒæ­¥é˜Ÿåˆ— SynchronousQueueï¼Œæ²¡æœ‰å®¹é‡ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯ Integer.MAX_VALUE`
public static ExecutorService newCachedThreadPool() {

    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,60L, TimeUnit.SECONDS,new SynchronousQueue<Runnable>());

}

// DelayedWorkQueueï¼ˆå»¶è¿Ÿé˜»å¡é˜Ÿåˆ—ï¼‰
public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) {
    return new ScheduledThreadPoolExecutor(corePoolSize);
}
public ScheduledThreadPoolExecutor(int corePoolSize) {
    super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,
          new DelayedWorkQueue());
}
```

### â­ï¸çº¿ç¨‹æ± å¸¸è§å‚æ•°æœ‰å“ªäº›ï¼Ÿå¦‚ä½•è§£é‡Šï¼Ÿ

```java
    /**
     * ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚
     */
    public ThreadPoolExecutor(int corePoolSize,//çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡
                              int maximumPoolSize,//çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°
                              long keepAliveTime,//å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»çš„æœ€é•¿æ—¶é—´
                              TimeUnit unit,//æ—¶é—´å•ä½
                              BlockingQueue<Runnable> workQueue,//ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å‚¨å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—
                              ThreadFactory threadFactory,//çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯
                              RejectedExecutionHandler handler//æ‹’ç»ç­–ç•¥ï¼Œå½“æäº¤çš„ä»»åŠ¡è¿‡å¤šè€Œä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡
                               ) {
        if (corePoolSize < 0 ||
            maximumPoolSize <= 0 ||
            maximumPoolSize < corePoolSize ||
            keepAliveTime < 0)
            throw new IllegalArgumentException();
        if (workQueue == null || threadFactory == null || handler == null)
            throw new NullPointerException();
        this.corePoolSize = corePoolSize;
        this.maximumPoolSize = maximumPoolSize;
        this.workQueue = workQueue;
        this.keepAliveTime = unit.toNanos(keepAliveTime);
        this.threadFactory = threadFactory;
        this.handler = handler;
    }
```

`ThreadPoolExecutor` 3 ä¸ªæœ€é‡è¦çš„å‚æ•°ï¼š

- `corePoolSize` : ä»»åŠ¡é˜Ÿåˆ—æœªè¾¾åˆ°é˜Ÿåˆ—å®¹é‡æ—¶ï¼Œæœ€å¤§å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚
- `maximumPoolSize` : ä»»åŠ¡é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ã€‚
- `workQueue`: æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

`ThreadPoolExecutor`å…¶ä»–å¸¸è§å‚æ•° :

- `keepAliveTime`:å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº `corePoolSize` ï¼Œå³æœ‰éæ ¸å¿ƒçº¿ç¨‹ï¼ˆçº¿ç¨‹æ± ä¸­æ ¸å¿ƒçº¿ç¨‹ä»¥å¤–çš„çº¿ç¨‹ï¼‰æ—¶ï¼Œè¿™äº›éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²åä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº† `keepAliveTime`æ‰ä¼šè¢«å›æ”¶é”€æ¯ã€‚
- `unit` : `keepAliveTime` å‚æ•°çš„æ—¶é—´å•ä½ã€‚
- `threadFactory` :executor åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚
- `handler` :æ‹’ç»ç­–ç•¥ï¼ˆåé¢ä¼šå•ç‹¬è¯¦ç»†ä»‹ç»ä¸€ä¸‹ï¼‰ã€‚

ä¸‹é¢è¿™å¼ å›¾å¯ä»¥åŠ æ·±ä½ å¯¹çº¿ç¨‹æ± ä¸­å„ä¸ªå‚æ•°çš„ç›¸äº’å…³ç³»çš„ç†è§£ï¼ˆå›¾ç‰‡æ¥æºï¼šã€ŠJava æ€§èƒ½è°ƒä¼˜å®æˆ˜ã€‹ï¼‰ï¼š

![çº¿ç¨‹æ± å„ä¸ªå‚æ•°çš„å…³ç³»](https://oss.javaguide.cn/github/javaguide/java/concurrent/relationship-between-thread-pool-parameters.png)

### çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹ä¼šè¢«å›æ”¶å—ï¼Ÿ

`ThreadPoolExecutor` é»˜è®¤ä¸ä¼šå›æ”¶æ ¸å¿ƒçº¿ç¨‹ï¼Œå³ä½¿å®ƒä»¬å·²ç»ç©ºé—²äº†ã€‚è¿™æ˜¯ä¸ºäº†å‡å°‘åˆ›å»ºçº¿ç¨‹çš„å¼€é”€ï¼Œå› ä¸ºæ ¸å¿ƒçº¿ç¨‹é€šå¸¸æ˜¯è¦é•¿æœŸä¿æŒæ´»è·ƒçš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœçº¿ç¨‹æ± æ˜¯è¢«ç”¨äºå‘¨æœŸæ€§ä½¿ç”¨çš„åœºæ™¯ï¼Œä¸”é¢‘ç‡ä¸é«˜ï¼ˆå‘¨æœŸä¹‹é—´æœ‰æ˜æ˜¾çš„ç©ºé—²æ—¶é—´ï¼‰ï¼Œå¯ä»¥è€ƒè™‘å°† `allowCoreThreadTimeOut(boolean value)` æ–¹æ³•çš„å‚æ•°è®¾ç½®ä¸º `true`ï¼Œè¿™æ ·å°±ä¼šå›æ”¶ç©ºé—²ï¼ˆæ—¶é—´é—´éš”ç”± `keepAliveTime` æŒ‡å®šï¼‰çš„æ ¸å¿ƒçº¿ç¨‹äº†ã€‚

```java
public void allowCoreThreadTimeOut(boolean value) {
    // æ ¸å¿ƒçº¿ç¨‹çš„ keepAliveTime å¿…é¡»å¤§äº 0 æ‰èƒ½å¯ç”¨è¶…æ—¶æœºåˆ¶
    if (value && keepAliveTime <= 0) {
        throw new IllegalArgumentException("Core threads must have nonzero keep alive times");
    }
    // è®¾ç½® allowCoreThreadTimeOut çš„å€¼
    if (value != allowCoreThreadTimeOut) {
        allowCoreThreadTimeOut = value;
        // å¦‚æœå¯ç”¨äº†è¶…æ—¶æœºåˆ¶ï¼Œæ¸…ç†æ‰€æœ‰ç©ºé—²çš„çº¿ç¨‹ï¼ŒåŒ…æ‹¬æ ¸å¿ƒçº¿ç¨‹
        if (value) {
            interruptIdleWorkers();
        }
    }
}
```

### æ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶å¤„äºä»€ä¹ˆçŠ¶æ€ï¼Ÿ

æ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶ï¼Œå…¶çŠ¶æ€åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š

- **è®¾ç½®äº†æ ¸å¿ƒçº¿ç¨‹çš„å­˜æ´»æ—¶é—´** ï¼šæ ¸å¿ƒçº¿ç¨‹åœ¨ç©ºé—²æ—¶ï¼Œä¼šå¤„äº `WAITING` çŠ¶æ€ï¼Œç­‰å¾…è·å–ä»»åŠ¡ã€‚å¦‚æœé˜»å¡ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹å­˜æ´»æ—¶é—´ï¼Œåˆ™è¯¥çº¿ç¨‹ä¼šé€€å‡ºå·¥ä½œï¼Œå°†è¯¥çº¿ç¨‹ä»çº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹é›†åˆä¸­ç§»é™¤ï¼Œçº¿ç¨‹çŠ¶æ€å˜ä¸º `TERMINATED` çŠ¶æ€ã€‚
- **æ²¡æœ‰è®¾ç½®æ ¸å¿ƒçº¿ç¨‹çš„å­˜æ´»æ—¶é—´** ï¼šæ ¸å¿ƒçº¿ç¨‹åœ¨ç©ºé—²æ—¶ï¼Œä¼šä¸€ç›´å¤„äº `WAITING` çŠ¶æ€ï¼Œç­‰å¾…è·å–ä»»åŠ¡ï¼Œæ ¸å¿ƒçº¿ç¨‹ä¼šä¸€ç›´å­˜æ´»åœ¨çº¿ç¨‹æ± ä¸­ã€‚

å½“é˜Ÿåˆ—ä¸­æœ‰å¯ç”¨ä»»åŠ¡æ—¶ï¼Œä¼šå”¤é†’è¢«é˜»å¡çš„çº¿ç¨‹ï¼Œçº¿ç¨‹çš„çŠ¶æ€ä¼šç”± `WAITING` çŠ¶æ€å˜ä¸º `RUNNABLE` çŠ¶æ€ï¼Œä¹‹åå»æ‰§è¡Œå¯¹åº”ä»»åŠ¡ã€‚

æ¥ä¸‹æ¥é€šè¿‡ç›¸å…³æºç ï¼Œäº†è§£ä¸€ä¸‹çº¿ç¨‹æ± å†…éƒ¨æ˜¯å¦‚ä½•åšçš„ã€‚

çº¿ç¨‹åœ¨çº¿ç¨‹æ± å†…éƒ¨è¢«æŠ½è±¡ä¸ºäº† `Worker` ï¼Œå½“ `Worker` è¢«å¯åŠ¨ä¹‹åï¼Œä¼šä¸æ–­å»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ã€‚

åœ¨è·å–ä»»åŠ¡çš„æ—¶å€™ï¼Œä¼šæ ¹æ® `timed` å€¼æ¥å†³å®šä»ä»»åŠ¡é˜Ÿåˆ—ï¼ˆ `BlockingQueue` ï¼‰è·å–ä»»åŠ¡çš„è¡Œä¸ºã€‚

å¦‚æœã€Œè®¾ç½®äº†æ ¸å¿ƒçº¿ç¨‹çš„å­˜æ´»æ—¶é—´ã€æˆ–è€…ã€Œçº¿ç¨‹æ•°é‡è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹æ•°é‡ã€ï¼Œåˆ™å°† `timed` æ ‡è®°ä¸º `true` ï¼Œè¡¨æ˜è·å–ä»»åŠ¡æ—¶éœ€è¦ä½¿ç”¨ `poll()` æŒ‡å®šè¶…æ—¶æ—¶é—´ã€‚

- `timed == true` ï¼šä½¿ç”¨ `poll()` æ¥è·å–ä»»åŠ¡ã€‚ä½¿ç”¨ `poll()` æ–¹æ³•è·å–ä»»åŠ¡è¶…æ—¶çš„è¯ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šé€€å‡ºæ‰§è¡Œï¼ˆ `TERMINATED` ï¼‰ï¼Œè¯¥çº¿ç¨‹ä»çº¿ç¨‹æ± ä¸­è¢«ç§»é™¤ã€‚
- `timed == false` ï¼šä½¿ç”¨ `take()` æ¥è·å–ä»»åŠ¡ã€‚ä½¿ç”¨ `take()` æ–¹æ³•è·å–ä»»åŠ¡ä¼šè®©å½“å‰çº¿ç¨‹ä¸€ç›´é˜»å¡ç­‰å¾…ï¼ˆ`WAITING`ï¼‰ã€‚

æºç å¦‚ä¸‹ï¼š

```JAVA
// ThreadPoolExecutor
private Runnable getTask() {
    boolean timedOut = false;
    for (;;) {
        // ...

        // 1ã€å¦‚æœã€Œè®¾ç½®äº†æ ¸å¿ƒçº¿ç¨‹çš„å­˜æ´»æ—¶é—´ã€æˆ–è€…æ˜¯ã€Œçº¿ç¨‹æ•°é‡è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹æ•°é‡ã€ï¼Œåˆ™ timed ä¸º trueã€‚
        boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;
        // 2ã€æ‰£å‡çº¿ç¨‹æ•°é‡ã€‚
        // wc > maximuimPoolSizeï¼šçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°é‡ã€‚å…¶ä¸­ wc ä¸ºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ã€‚
        // timed && timeOutï¼štimeOut è¡¨ç¤ºè·å–ä»»åŠ¡è¶…æ—¶ã€‚
        // åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼šæ ¸å¿ƒçº¿ç¨‹è®¾ç½®äº†å­˜æ´»æ—¶é—´ && è·å–ä»»åŠ¡è¶…æ—¶ï¼Œåˆ™æ‰£å‡çº¿ç¨‹æ•°é‡ï¼›çº¿ç¨‹æ•°é‡è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹æ•°é‡ && è·å–ä»»åŠ¡è¶…æ—¶ï¼Œåˆ™æ‰£å‡çº¿ç¨‹æ•°é‡ã€‚
        if ((wc > maximumPoolSize || (timed && timedOut))
            && (wc > 1 || workQueue.isEmpty())) {
            if (compareAndDecrementWorkerCount(c))
                return null;
            continue;
        }
        try {
            // 3ã€å¦‚æœ timed ä¸º trueï¼Œåˆ™ä½¿ç”¨ poll() è·å–ä»»åŠ¡ï¼›å¦åˆ™ï¼Œä½¿ç”¨ take() è·å–ä»»åŠ¡ã€‚
            Runnable r = timed ?
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                workQueue.take();
            // 4ã€è·å–ä»»åŠ¡ä¹‹åè¿”å›ã€‚
            if (r != null)
                return r;
            timedOut = true;
        } catch (InterruptedException retry) {
            timedOut = false;
        }
    }
}
```

### â­ï¸çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

å¦‚æœå½“å‰åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°é‡å¹¶ä¸”é˜Ÿåˆ—ä¹Ÿå·²ç»è¢«æ”¾æ»¡äº†ä»»åŠ¡æ—¶ï¼Œ`ThreadPoolExecutor` å®šä¹‰ä¸€äº›ç­–ç•¥:

- `ThreadPoolExecutor.AbortPolicy`ï¼šæŠ›å‡º `RejectedExecutionException`æ¥æ‹’ç»æ–°ä»»åŠ¡çš„å¤„ç†ã€‚
- `ThreadPoolExecutor.CallerRunsPolicy`ï¼šè°ƒç”¨æ‰§è¡Œè€…è‡ªå·±çš„çº¿ç¨‹è¿è¡Œä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥åœ¨è°ƒç”¨`execute`æ–¹æ³•çš„çº¿ç¨‹ä¸­è¿è¡Œ(`run`)è¢«æ‹’ç»çš„ä»»åŠ¡ï¼Œå¦‚æœæ‰§è¡Œç¨‹åºå·²å…³é—­ï¼Œåˆ™ä¼šä¸¢å¼ƒè¯¥ä»»åŠ¡ã€‚å› æ­¤è¿™ç§ç­–ç•¥ä¼šé™ä½å¯¹äºæ–°ä»»åŠ¡æäº¤é€Ÿåº¦ï¼Œå½±å“ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚å¦‚æœä½ çš„åº”ç”¨ç¨‹åºå¯ä»¥æ‰¿å—æ­¤å»¶è¿Ÿå¹¶ä¸”ä½ è¦æ±‚ä»»ä½•ä¸€ä¸ªä»»åŠ¡è¯·æ±‚éƒ½è¦è¢«æ‰§è¡Œçš„è¯ï¼Œä½ å¯ä»¥é€‰æ‹©è¿™ä¸ªç­–ç•¥ã€‚
- `ThreadPoolExecutor.DiscardPolicy`ï¼šä¸å¤„ç†æ–°ä»»åŠ¡ï¼Œç›´æ¥ä¸¢å¼ƒæ‰ã€‚
- `ThreadPoolExecutor.DiscardOldestPolicy`ï¼šæ­¤ç­–ç•¥å°†ä¸¢å¼ƒæœ€æ—©çš„æœªå¤„ç†çš„ä»»åŠ¡è¯·æ±‚ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šSpring é€šè¿‡ `ThreadPoolTaskExecutor` æˆ–è€…æˆ‘ä»¬ç›´æ¥é€šè¿‡ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹æ± çš„æ—¶å€™ï¼Œå½“æˆ‘ä»¬ä¸æŒ‡å®š `RejectedExecutionHandler` æ‹’ç»ç­–ç•¥æ¥é…ç½®çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯ `AbortPolicy`ã€‚åœ¨è¿™ç§æ‹’ç»ç­–ç•¥ä¸‹ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œ`ThreadPoolExecutor` å°†æŠ›å‡º `RejectedExecutionException` å¼‚å¸¸æ¥æ‹’ç»æ–°æ¥çš„ä»»åŠ¡ ï¼Œè¿™ä»£è¡¨ä½ å°†ä¸¢å¤±å¯¹è¿™ä¸ªä»»åŠ¡çš„å¤„ç†ã€‚å¦‚æœä¸æƒ³ä¸¢å¼ƒä»»åŠ¡çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨`CallerRunsPolicy`ã€‚`CallerRunsPolicy` å’Œå…¶ä»–çš„å‡ ä¸ªç­–ç•¥ä¸åŒï¼Œå®ƒæ—¢ä¸ä¼šæŠ›å¼ƒä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯å°†ä»»åŠ¡å›é€€ç»™è°ƒç”¨è€…ï¼Œä½¿ç”¨è°ƒç”¨è€…çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚

```java
public static class CallerRunsPolicy implements RejectedExecutionHandler {

        public CallerRunsPolicy() { }

        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            if (!e.isShutdown()) {
                // ç›´æ¥ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œè€Œä¸æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œ
                r.run();
            }
        }
    }
```

### å¦‚æœä¸å…è®¸ä¸¢å¼ƒä»»åŠ¡ï¼Œåº”è¯¥é€‰æ‹©å“ªä¸ªæ‹’ç»ç­–ç•¥ï¼Ÿ

æ ¹æ®ä¸Šé¢å¯¹çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥çš„ä»‹ç»ï¼Œç›¸ä¿¡å¤§å®¶å¾ˆå®¹æ˜“èƒ½å¤Ÿå¾—å‡ºç­”æ¡ˆæ˜¯ï¼š`CallerRunsPolicy` ã€‚

è¿™é‡Œæˆ‘ä»¬å†æ¥ç»“åˆ`CallerRunsPolicy` çš„æºç æ¥çœ‹çœ‹ï¼š

```java
public static class CallerRunsPolicy implements RejectedExecutionHandler {

        public CallerRunsPolicy() { }


        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            //åªè¦å½“å‰ç¨‹åºæ²¡æœ‰å…³é—­ï¼Œå°±ç”¨æ‰§è¡Œexecuteæ–¹æ³•çš„çº¿ç¨‹æ‰§è¡Œè¯¥ä»»åŠ¡
            if (!e.isShutdown()) {

                r.run();
            }
        }
    }
```

ä»æºç å¯ä»¥çœ‹å‡ºï¼Œåªè¦å½“å‰ç¨‹åºä¸å…³é—­å°±ä¼šä½¿ç”¨æ‰§è¡Œ`execute`æ–¹æ³•çš„çº¿ç¨‹æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚

### CallerRunsPolicy æ‹’ç»ç­–ç•¥æœ‰ä»€ä¹ˆé£é™©ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ

æˆ‘ä»¬ä¸Šé¢ä¹Ÿæåˆ°äº†ï¼šå¦‚æœæƒ³è¦ä¿è¯ä»»ä½•ä¸€ä¸ªä»»åŠ¡è¯·æ±‚éƒ½è¦è¢«æ‰§è¡Œçš„è¯ï¼Œé‚£é€‰æ‹© `CallerRunsPolicy` æ‹’ç»ç­–ç•¥æ›´åˆé€‚ä¸€äº›ã€‚

ä¸è¿‡ï¼Œå¦‚æœèµ°åˆ°`CallerRunsPolicy`çš„ä»»åŠ¡æ˜¯ä¸ªéå¸¸è€—æ—¶çš„ä»»åŠ¡ï¼Œä¸”å¤„ç†æäº¤ä»»åŠ¡çš„çº¿ç¨‹æ˜¯ä¸»çº¿ç¨‹ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡ï¼Œå½±å“ç¨‹åºçš„æ­£å¸¸è¿è¡Œã€‚

è¿™é‡Œç®€å•ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œè¯¥çº¿ç¨‹æ± é™å®šäº†æœ€å¤§çº¿ç¨‹æ•°ä¸º 2ï¼Œé˜»å¡é˜Ÿåˆ—å¤§å°ä¸º 1(è¿™æ„å‘³ç€ç¬¬ 4 ä¸ªä»»åŠ¡å°±ä¼šèµ°åˆ°æ‹’ç»ç­–ç•¥)ï¼Œ`ThreadUtil`ä¸º Hutool æä¾›çš„å·¥å…·ç±»ï¼š

```java
public class ThreadPoolTest {

    private static final Logger log = LoggerFactory.getLogger(ThreadPoolTest.class);

    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°ä¸º1ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸º2
        // å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»çš„æœ€é•¿æ—¶é—´ä¸º60ç§’ï¼Œ
        // ä»»åŠ¡é˜Ÿåˆ—ä¸ºå®¹é‡ä¸º1çš„ArrayBlockingQueueï¼Œé¥±å’Œç­–ç•¥ä¸ºCallerRunsPolicyã€‚
        ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(1,
                2,
                60,
                TimeUnit.SECONDS,
                new ArrayBlockingQueue<>(1),
                new ThreadPoolExecutor.CallerRunsPolicy());

        // æäº¤ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œç”±æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œ
        threadPoolExecutor.execute(() -> {
            log.info("æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡");
            ThreadUtil.sleep(1, TimeUnit.MINUTES);
        });

        // æäº¤ç¬¬äºŒä¸ªä»»åŠ¡ï¼Œç”±äºæ ¸å¿ƒçº¿ç¨‹è¢«å ç”¨ï¼Œä»»åŠ¡å°†è¿›å…¥é˜Ÿåˆ—ç­‰å¾…
        threadPoolExecutor.execute(() -> {
            log.info("éæ ¸å¿ƒçº¿ç¨‹å¤„ç†å…¥é˜Ÿçš„ç¬¬äºŒä¸ªä»»åŠ¡");
            ThreadUtil.sleep(1, TimeUnit.MINUTES);
        });

        // æäº¤ç¬¬ä¸‰ä¸ªä»»åŠ¡ï¼Œç”±äºæ ¸å¿ƒçº¿ç¨‹è¢«å ç”¨ä¸”é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å¤„ç†
        threadPoolExecutor.execute(() -> {
            log.info("éæ ¸å¿ƒçº¿ç¨‹å¤„ç†ç¬¬ä¸‰ä¸ªä»»åŠ¡");
            ThreadUtil.sleep(1, TimeUnit.MINUTES);
        });

        // æäº¤ç¬¬å››ä¸ªä»»åŠ¡ï¼Œç”±äºæ ¸å¿ƒçº¿ç¨‹å’Œéæ ¸å¿ƒçº¿ç¨‹éƒ½è¢«å ç”¨ï¼Œé˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œæ ¹æ®CallerRunsPolicyç­–ç•¥ï¼Œä»»åŠ¡å°†ç”±æäº¤ä»»åŠ¡çš„çº¿ç¨‹ï¼ˆå³ä¸»çº¿ç¨‹ï¼‰æ¥æ‰§è¡Œ
        threadPoolExecutor.execute(() -> {
            log.info("ä¸»çº¿ç¨‹å¤„ç†ç¬¬å››ä¸ªä»»åŠ¡");
            ThreadUtil.sleep(2, TimeUnit.MINUTES);
        });

        // æäº¤ç¬¬äº”ä¸ªä»»åŠ¡ï¼Œä¸»çº¿ç¨‹è¢«ç¬¬å››ä¸ªä»»åŠ¡å¡ä½ï¼Œè¯¥ä»»åŠ¡å¿…é¡»ç­‰åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ‰èƒ½æäº¤
        threadPoolExecutor.execute(() -> {
            log.info("æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œç¬¬äº”ä¸ªä»»åŠ¡");
        });

        // å…³é—­çº¿ç¨‹æ± 
        threadPoolExecutor.shutdown();
    }
}

```

è¾“å‡ºï¼š

```bash
18:19:48.203 INFO  [pool-1-thread-1] c.j.concurrent.ThreadPoolTest - æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡
18:19:48.203 INFO  [pool-1-thread-2] c.j.concurrent.ThreadPoolTest - éæ ¸å¿ƒçº¿ç¨‹å¤„ç†ç¬¬ä¸‰ä¸ªä»»åŠ¡
18:19:48.203 INFO  [main] c.j.concurrent.ThreadPoolTest - ä¸»çº¿ç¨‹å¤„ç†ç¬¬å››ä¸ªä»»åŠ¡
18:20:48.212 INFO  [pool-1-thread-2] c.j.concurrent.ThreadPoolTest - éæ ¸å¿ƒçº¿ç¨‹å¤„ç†å…¥é˜Ÿçš„ç¬¬äºŒä¸ªä»»åŠ¡
18:21:48.219 INFO  [pool-1-thread-2] c.j.concurrent.ThreadPoolTest - æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œç¬¬äº”ä¸ªä»»åŠ¡
```

ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼Œå› ä¸º`CallerRunsPolicy`è¿™ä¸ªæ‹’ç»ç­–ç•¥ï¼Œå¯¼è‡´è€—æ—¶çš„ä»»åŠ¡ç”¨äº†ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œå¯¼è‡´çº¿ç¨‹æ± é˜»å¡ï¼Œè¿›è€Œå¯¼è‡´åç»­ä»»åŠ¡æ— æ³•åŠæ—¶æ‰§è¡Œï¼Œä¸¥é‡çš„æƒ…å†µä¸‹å¾ˆå¯èƒ½å¯¼è‡´ OOMã€‚

æˆ‘ä»¬ä»é—®é¢˜çš„æœ¬è´¨å…¥æ‰‹ï¼Œè°ƒç”¨è€…é‡‡ç”¨`CallerRunsPolicy`æ˜¯å¸Œæœ›æ‰€æœ‰çš„ä»»åŠ¡éƒ½èƒ½å¤Ÿè¢«æ‰§è¡Œï¼Œæš‚æ—¶æ— æ³•å¤„ç†çš„ä»»åŠ¡åˆè¢«ä¿å­˜åœ¨é˜»å¡é˜Ÿåˆ—`BlockingQueue`ä¸­ã€‚è¿™æ ·çš„è¯ï¼Œåœ¨å†…å­˜å…è®¸çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å¢åŠ é˜»å¡é˜Ÿåˆ—`BlockingQueue`çš„å¤§å°å¹¶è°ƒæ•´å †å†…å­˜ä»¥å®¹çº³æ›´å¤šçš„ä»»åŠ¡ï¼Œç¡®ä¿ä»»åŠ¡èƒ½å¤Ÿè¢«å‡†ç¡®æ‰§è¡Œã€‚

ä¸ºäº†å……åˆ†åˆ©ç”¨ CPUï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è°ƒæ•´çº¿ç¨‹æ± çš„`maximumPoolSize` ï¼ˆæœ€å¤§çº¿ç¨‹æ•°ï¼‰å‚æ•°ï¼Œè¿™æ ·å¯ä»¥æé«˜ä»»åŠ¡å¤„ç†é€Ÿåº¦ï¼Œé¿å…ç´¯è®¡åœ¨ `BlockingQueue`çš„ä»»åŠ¡è¿‡å¤šå¯¼è‡´å†…å­˜ç”¨å®Œã€‚

![è°ƒæ•´é˜»å¡é˜Ÿåˆ—å¤§å°å’Œæœ€å¤§çº¿ç¨‹æ•°](https://oss.javaguide.cn/github/javaguide/java/concurrent/threadpool-reject-2-threadpool-reject-01.png)

å¦‚æœæœåŠ¡å™¨èµ„æºä»¥è¾¾åˆ°å¯åˆ©ç”¨çš„æé™ï¼Œè¿™å°±æ„å‘³æˆ‘ä»¬è¦åœ¨è®¾è®¡ç­–ç•¥ä¸Šæ”¹å˜çº¿ç¨‹æ± çš„è°ƒåº¦äº†ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå¯¼è‡´ä¸»çº¿ç¨‹å¡æ­»çš„æœ¬è´¨å°±æ˜¯å› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›ä»»ä½•ä¸€ä¸ªä»»åŠ¡è¢«ä¸¢å¼ƒã€‚æ¢ä¸ªæ€è·¯ï¼Œæœ‰æ²¡æœ‰åŠæ³•æ—¢èƒ½ä¿è¯ä»»åŠ¡ä¸è¢«ä¸¢å¼ƒä¸”åœ¨æœåŠ¡å™¨æœ‰ä½™åŠ›æ—¶åŠæ—¶å¤„ç†å‘¢ï¼Ÿ

è¿™é‡Œæä¾›çš„ä¸€ç§**ä»»åŠ¡æŒä¹…åŒ–**çš„æ€è·¯ï¼Œè¿™é‡Œæ‰€è°“çš„ä»»åŠ¡æŒä¹…åŒ–ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº:

1. è®¾è®¡ä¸€å¼ ä»»åŠ¡è¡¨å°†ä»»åŠ¡å­˜å‚¨åˆ° MySQL æ•°æ®åº“ä¸­ã€‚
2. Redis ç¼“å­˜ä»»åŠ¡ã€‚
3. å°†ä»»åŠ¡æäº¤åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚

è¿™é‡Œä»¥æ–¹æ¡ˆä¸€ä¸ºä¾‹ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹å®ç°é€»è¾‘ï¼š

1. å®ç°`RejectedExecutionHandler`æ¥å£è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥ï¼Œè‡ªå®šä¹‰æ‹’ç»ç­–ç•¥è´Ÿè´£å°†çº¿ç¨‹æ± æš‚æ—¶æ— æ³•å¤„ç†ï¼ˆæ­¤æ—¶é˜»å¡é˜Ÿåˆ—å·²æ»¡ï¼‰çš„ä»»åŠ¡å…¥åº“ï¼ˆä¿å­˜åˆ° MySQL ä¸­ï¼‰ã€‚æ³¨æ„ï¼šçº¿ç¨‹æ± æš‚æ—¶æ— æ³•å¤„ç†çš„ä»»åŠ¡ä¼šå…ˆè¢«æ”¾åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œé˜»å¡é˜Ÿåˆ—æ»¡äº†æ‰ä¼šè§¦å‘æ‹’ç»ç­–ç•¥ã€‚
2. ç»§æ‰¿`BlockingQueue`å®ç°ä¸€ä¸ªæ··åˆå¼é˜»å¡é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—åŒ…å« JDK è‡ªå¸¦çš„`ArrayBlockingQueue`ã€‚å¦å¤–ï¼Œè¯¥æ··åˆå¼é˜»å¡é˜Ÿåˆ—éœ€è¦ä¿®æ”¹å–ä»»åŠ¡å¤„ç†çš„é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯é‡å†™`take()`æ–¹æ³•ï¼Œå–ä»»åŠ¡æ—¶ä¼˜å…ˆä»æ•°æ®åº“ä¸­è¯»å–æœ€æ—©çš„ä»»åŠ¡ï¼Œæ•°æ®åº“ä¸­æ— ä»»åŠ¡æ—¶å†ä» `ArrayBlockingQueue`ä¸­å»å–ä»»åŠ¡ã€‚

![å°†ä¸€éƒ¨åˆ†ä»»åŠ¡ä¿å­˜åˆ°MySQLä¸­](https://oss.javaguide.cn/github/javaguide/java/concurrent/threadpool-reject-2-threadpool-reject-02.png)

æ•´ä¸ªå®ç°é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ ¸å¿ƒåœ¨äºè‡ªå®šä¹‰æ‹’ç»ç­–ç•¥å’Œé˜»å¡é˜Ÿåˆ—ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œä¸€æ—¦æˆ‘ä»¬çš„çº¿ç¨‹æ± ä¸­çº¿ç¨‹è¾¾åˆ°æ»¡è½½æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ‹’ç»ç­–ç•¥å°†æœ€æ–°ä»»åŠ¡æŒä¹…åŒ–åˆ° MySQL æ•°æ®åº“ä¸­ï¼Œç­‰åˆ°çº¿ç¨‹æ± æœ‰äº†æœ‰ä½™åŠ›å¤„ç†æ‰€æœ‰ä»»åŠ¡æ—¶ï¼Œè®©å…¶ä¼˜å…ˆå¤„ç†æ•°æ®åº“ä¸­çš„ä»»åŠ¡ä»¥é¿å…"é¥¥é¥¿"é—®é¢˜ã€‚

å½“ç„¶ï¼Œå¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å‚è€ƒå…¶ä»–ä¸»æµæ¡†æ¶çš„åšæ³•ï¼Œä»¥ Netty ä¸ºä¾‹ï¼Œå®ƒçš„æ‹’ç»ç­–ç•¥åˆ™æ˜¯ç›´æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ä»¥å¤–çš„çº¿ç¨‹å¤„ç†è¿™äº›ä»»åŠ¡ï¼Œä¸ºäº†ä¿è¯ä»»åŠ¡çš„å®æ—¶å¤„ç†ï¼Œè¿™ç§åšæ³•å¯èƒ½éœ€è¦è‰¯å¥½çš„ç¡¬ä»¶è®¾å¤‡ä¸”ä¸´æ—¶åˆ›å»ºçš„çº¿ç¨‹æ— æ³•åšåˆ°å‡†ç¡®çš„ç›‘æ§ï¼š

```java
private static final class NewThreadRunsPolicy implements RejectedExecutionHandler {
    NewThreadRunsPolicy() {
        super();
    }
    public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
        try {
            //åˆ›å»ºä¸€ä¸ªä¸´æ—¶çº¿ç¨‹å¤„ç†ä»»åŠ¡
            final Thread t = new Thread(r, "Temporary task executor");
            t.start();
        } catch (Throwable e) {
            throw new RejectedExecutionException(
                    "Failed to start a new thread", e);
        }
    }
}
```

ActiveMQ åˆ™æ˜¯å°è¯•åœ¨æŒ‡å®šçš„æ—¶æ•ˆå†…å°½å¯èƒ½çš„äº‰å–å°†ä»»åŠ¡å…¥é˜Ÿï¼Œä»¥ä¿è¯æœ€å¤§äº¤ä»˜ï¼š

```java
new RejectedExecutionHandler() {
                @Override
                public void rejectedExecution(final Runnable r, final ThreadPoolExecutor executor) {
                    try {
                        //é™æ—¶é˜»å¡ç­‰å¾…ï¼Œå®ç°å°½å¯èƒ½äº¤ä»˜
                        executor.getQueue().offer(r, 60, TimeUnit.SECONDS);
                    } catch (InterruptedException e) {
                        throw new RejectedExecutionException("Interrupted waiting for BrokerService.worker");
                    }
                    throw new RejectedExecutionException("Timed Out while attempting to enqueue Task.");
                }
            });
```

### çº¿ç¨‹æ± å¸¸ç”¨çš„é˜»å¡é˜Ÿåˆ—æœ‰å“ªäº›ï¼Ÿ

æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

ä¸åŒçš„çº¿ç¨‹æ± ä¼šé€‰ç”¨ä¸åŒçš„é˜»å¡é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆå†…ç½®çº¿ç¨‹æ± æ¥åˆ†æã€‚

- å®¹é‡ä¸º `Integer.MAX_VALUE` çš„ `LinkedBlockingQueue`ï¼ˆæ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼‰ï¼š`FixedThreadPool` å’Œ `SingleThreadExecutor` ã€‚`FixedThreadPool`æœ€å¤šåªèƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ï¼ˆæ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°ç›¸ç­‰ï¼‰ï¼Œ`SingleThreadExecutor`åªèƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼ˆæ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°éƒ½æ˜¯ 1ï¼‰ï¼ŒäºŒè€…çš„ä»»åŠ¡é˜Ÿåˆ—æ°¸è¿œä¸ä¼šè¢«æ”¾æ»¡ã€‚
- `SynchronousQueue`ï¼ˆåŒæ­¥é˜Ÿåˆ—ï¼‰ï¼š`CachedThreadPool` ã€‚`SynchronousQueue` æ²¡æœ‰å®¹é‡ï¼Œä¸å­˜å‚¨å…ƒç´ ï¼Œç›®çš„æ˜¯ä¿è¯å¯¹äºæäº¤çš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ä½¿ç”¨ç©ºé—²çº¿ç¨‹æ¥å¤„ç†ï¼›å¦åˆ™æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`CachedThreadPool` çš„æœ€å¤§çº¿ç¨‹æ•°æ˜¯ `Integer.MAX_VALUE` ï¼Œå¯ä»¥ç†è§£ä¸ºçº¿ç¨‹æ•°æ˜¯å¯ä»¥æ— é™æ‰©å±•çš„ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- `DelayedWorkQueue`ï¼ˆå»¶è¿Ÿé˜Ÿåˆ—ï¼‰ï¼š`ScheduledThreadPool` å’Œ `SingleThreadScheduledExecutor` ã€‚`DelayedWorkQueue` çš„å†…éƒ¨å…ƒç´ å¹¶ä¸æ˜¯æŒ‰ç…§æ”¾å…¥çš„æ—¶é—´æ’åºï¼Œè€Œæ˜¯ä¼šæŒ‰ç…§å»¶è¿Ÿçš„æ—¶é—´é•¿çŸ­å¯¹ä»»åŠ¡è¿›è¡Œæ’åºï¼Œå†…éƒ¨é‡‡ç”¨çš„æ˜¯â€œå †â€çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥ä¿è¯æ¯æ¬¡å‡ºé˜Ÿçš„ä»»åŠ¡éƒ½æ˜¯å½“å‰é˜Ÿåˆ—ä¸­æ‰§è¡Œæ—¶é—´æœ€é å‰çš„ã€‚`DelayedWorkQueue` æ·»åŠ å…ƒç´ æ»¡äº†ä¹‹åä¼šè‡ªåŠ¨æ‰©å®¹ï¼Œå¢åŠ åŸæ¥å®¹é‡çš„ 50%ï¼Œå³æ°¸è¿œä¸ä¼šé˜»å¡ï¼Œæœ€å¤§æ‰©å®¹å¯è¾¾ `Integer.MAX_VALUE`ï¼Œæ‰€ä»¥æœ€å¤šåªèƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ã€‚
- `ArrayBlockingQueue`ï¼ˆæœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼‰ï¼šåº•å±‚ç”±æ•°ç»„å®ç°ï¼Œå®¹é‡ä¸€æ—¦åˆ›å»ºï¼Œå°±ä¸èƒ½ä¿®æ”¹ã€‚

### â­ï¸çº¿ç¨‹æ± å¤„ç†ä»»åŠ¡çš„æµç¨‹äº†è§£å—ï¼Ÿ

![å›¾è§£çº¿ç¨‹æ± å®ç°åŸç†](https://oss.javaguide.cn/github/javaguide/java/concurrent/thread-pool-principle.png)

1. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå°±ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚
2. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°ç­‰äºæˆ–å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä½†æ˜¯å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå°±æŠŠè¯¥ä»»åŠ¡æ”¾å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—é‡Œç­‰å¾…æ‰§è¡Œã€‚
3. å¦‚æœå‘ä»»åŠ¡é˜Ÿåˆ—æŠ•æ”¾ä»»åŠ¡å¤±è´¥ï¼ˆä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡äº†ï¼‰ï¼Œä½†æ˜¯å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°æ˜¯å°äºæœ€å¤§çº¿ç¨‹æ•°çš„ï¼Œå°±æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚
4. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å·²ç»ç­‰åŒäºæœ€å¤§çº¿ç¨‹æ•°äº†ï¼Œæ–°å»ºçº¿ç¨‹å°†ä¼šä½¿å½“å‰è¿è¡Œçš„çº¿ç¨‹è¶…å‡ºæœ€å¤§çº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå½“å‰ä»»åŠ¡ä¼šè¢«æ‹’ç»ï¼Œæ‹’ç»ç­–ç•¥ä¼šè°ƒç”¨`RejectedExecutionHandler.rejectedExecution()`æ–¹æ³•ã€‚

å†æä¸€ä¸ªæœ‰æ„æ€çš„å°é—®é¢˜ï¼š**çº¿ç¨‹æ± åœ¨æäº¤ä»»åŠ¡å‰ï¼Œå¯ä»¥æå‰åˆ›å»ºçº¿ç¨‹å—ï¼Ÿ**

ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼`ThreadPoolExecutor` æä¾›äº†ä¸¤ä¸ªæ–¹æ³•å¸®åŠ©æˆ‘ä»¬åœ¨æäº¤ä»»åŠ¡ä¹‹å‰ï¼Œå®Œæˆæ ¸å¿ƒçº¿ç¨‹çš„åˆ›å»ºï¼Œä»è€Œå®ç°çº¿ç¨‹æ± é¢„çƒ­çš„æ•ˆæœï¼š

- `prestartCoreThread()`:å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œç­‰å¾…ä»»åŠ¡ï¼Œå¦‚æœå·²è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å› falseï¼Œå¦åˆ™è¿”å› trueï¼›
- `prestartAllCoreThreads()`:å¯åŠ¨æ‰€æœ‰çš„æ ¸å¿ƒçº¿ç¨‹ï¼Œå¹¶è¿”å›å¯åŠ¨æˆåŠŸçš„æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚

### â­ï¸çº¿ç¨‹æ± ä¸­çº¿ç¨‹å¼‚å¸¸åï¼Œé”€æ¯è¿˜æ˜¯å¤ç”¨ï¼Ÿ

ç›´æ¥è¯´ç»“è®ºï¼Œéœ€è¦åˆ†ä¸¤ç§æƒ…å†µï¼š

- **ä½¿ç”¨`execute()`æäº¤ä»»åŠ¡**ï¼šå½“ä»»åŠ¡é€šè¿‡`execute()`æäº¤åˆ°çº¿ç¨‹æ± å¹¶åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¦‚æœè¿™ä¸ªå¼‚å¸¸æ²¡æœ‰åœ¨ä»»åŠ¡å†…è¢«æ•è·ï¼Œé‚£ä¹ˆè¯¥å¼‚å¸¸ä¼šå¯¼è‡´å½“å‰çº¿ç¨‹ç»ˆæ­¢ï¼Œå¹¶ä¸”å¼‚å¸¸ä¼šè¢«æ‰“å°åˆ°æ§åˆ¶å°æˆ–æ—¥å¿—æ–‡ä»¶ä¸­ã€‚çº¿ç¨‹æ± ä¼šæ£€æµ‹åˆ°è¿™ç§çº¿ç¨‹ç»ˆæ­¢ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ›¿æ¢å®ƒï¼Œä»è€Œä¿æŒé…ç½®çš„çº¿ç¨‹æ•°ä¸å˜ã€‚
- **ä½¿ç”¨`submit()`æäº¤ä»»åŠ¡**ï¼šå¯¹äºé€šè¿‡`submit()`æäº¤çš„ä»»åŠ¡ï¼Œå¦‚æœåœ¨ä»»åŠ¡æ‰§è¡Œä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œè¿™ä¸ªå¼‚å¸¸ä¸ä¼šç›´æ¥æ‰“å°å‡ºæ¥ã€‚ç›¸åï¼Œå¼‚å¸¸ä¼šè¢«å°è£…åœ¨ç”±`submit()`è¿”å›çš„`Future`å¯¹è±¡ä¸­ã€‚å½“è°ƒç”¨`Future.get()`æ–¹æ³•æ—¶ï¼Œå¯ä»¥æ•è·åˆ°ä¸€ä¸ª`ExecutionException`ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçº¿ç¨‹ä¸ä¼šå› ä¸ºå¼‚å¸¸è€Œç»ˆæ­¢ï¼Œå®ƒä¼šç»§ç»­å­˜åœ¨äºçº¿ç¨‹æ± ä¸­ï¼Œå‡†å¤‡æ‰§è¡Œåç»­çš„ä»»åŠ¡ã€‚

ç®€å•æ¥è¯´ï¼šä½¿ç”¨`execute()`æ—¶ï¼Œæœªæ•è·å¼‚å¸¸å¯¼è‡´çº¿ç¨‹ç»ˆæ­¢ï¼Œçº¿ç¨‹æ± åˆ›å»ºæ–°çº¿ç¨‹æ›¿ä»£ï¼›ä½¿ç”¨`submit()`æ—¶ï¼Œå¼‚å¸¸è¢«å°è£…åœ¨`Future`ä¸­ï¼Œçº¿ç¨‹ç»§ç»­å¤ç”¨ã€‚

è¿™ç§è®¾è®¡å…è®¸`submit()`æä¾›æ›´çµæ´»çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå› ä¸ºå®ƒå…è®¸è°ƒç”¨è€…å†³å®šå¦‚ä½•å¤„ç†å¼‚å¸¸ï¼Œè€Œ`execute()`åˆ™é€‚ç”¨äºé‚£äº›ä¸éœ€è¦å…³æ³¨æ‰§è¡Œç»“æœçš„åœºæ™¯ã€‚

å…·ä½“çš„æºç åˆ†æå¯ä»¥å‚è€ƒè¿™ç¯‡ï¼š[çº¿ç¨‹æ± ä¸­çº¿ç¨‹å¼‚å¸¸åï¼šé”€æ¯è¿˜æ˜¯å¤ç”¨ï¼Ÿ - äº¬ä¸œæŠ€æœ¯](https://mp.weixin.qq.com/s/9ODjdUU-EwQFF5PrnzOGfw)ã€‚

### â­ï¸å¦‚ä½•ç»™çº¿ç¨‹æ± å‘½åï¼Ÿ

åˆå§‹åŒ–çº¿ç¨‹æ± çš„æ—¶å€™éœ€è¦æ˜¾ç¤ºå‘½åï¼ˆè®¾ç½®çº¿ç¨‹æ± åç§°å‰ç¼€ï¼‰ï¼Œæœ‰åˆ©äºå®šä½é—®é¢˜ã€‚

é»˜è®¤æƒ…å†µä¸‹åˆ›å»ºçš„çº¿ç¨‹åå­—ç±»ä¼¼ `pool-1-thread-n` è¿™æ ·çš„ï¼Œæ²¡æœ‰ä¸šåŠ¡å«ä¹‰ï¼Œä¸åˆ©äºæˆ‘ä»¬å®šä½é—®é¢˜ã€‚

ç»™çº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹å‘½åé€šå¸¸æœ‰ä¸‹é¢ä¸¤ç§æ–¹å¼ï¼š

**1ã€åˆ©ç”¨ guava çš„ `ThreadFactoryBuilder`**

```java
ThreadFactory threadFactory = new ThreadFactoryBuilder()
                        .setNameFormat(threadNamePrefix + "-%d")
                        .setDaemon(true).build();
ExecutorService threadPool = new ThreadPoolExecutor(corePoolSize, maximumPoolSize, keepAliveTime, TimeUnit.MINUTES, workQueue, threadFactory);
```

**2ã€è‡ªå·±å®ç° `ThreadFactory`ã€‚**

```java
import java.util.concurrent.ThreadFactory;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * çº¿ç¨‹å·¥å‚ï¼Œå®ƒè®¾ç½®çº¿ç¨‹åç§°ï¼Œæœ‰åˆ©äºæˆ‘ä»¬å®šä½é—®é¢˜ã€‚
 */
public final class NamingThreadFactory implements ThreadFactory {

    private final AtomicInteger threadNum = new AtomicInteger();
    private final String name;

    /**
     * åˆ›å»ºä¸€ä¸ªå¸¦åå­—çš„çº¿ç¨‹æ± ç”Ÿäº§å·¥å‚
     */
    public NamingThreadFactory(String name) {
        this.name = name;
    }

    @Override
    public Thread newThread(Runnable r) {
        Thread t = new Thread(r);
        t.setName(name + " [#" + threadNum.incrementAndGet() + "]");
        return t;
    }
}
```

### å¦‚ä½•è®¾å®šçº¿ç¨‹æ± çš„å¤§å°ï¼Ÿ

å¾ˆå¤šäººç”šè‡³å¯èƒ½éƒ½ä¼šè§‰å¾—æŠŠçº¿ç¨‹æ± é…ç½®è¿‡å¤§ä¸€ç‚¹æ¯”è¾ƒå¥½ï¼æˆ‘è§‰å¾—è¿™æ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ã€‚å°±æ‹¿æˆ‘ä»¬ç”Ÿæ´»ä¸­éå¸¸å¸¸è§çš„ä¸€ä¾‹å­æ¥è¯´ï¼š**å¹¶ä¸æ˜¯äººå¤šå°±èƒ½æŠŠäº‹æƒ…åšå¥½ï¼Œå¢åŠ äº†æ²Ÿé€šäº¤æµæˆæœ¬ã€‚ä½ æœ¬æ¥ä¸€ä»¶äº‹æƒ…åªéœ€è¦ 3 ä¸ªäººåšï¼Œä½ ç¡¬æ˜¯æ‹‰æ¥äº† 6 ä¸ªäººï¼Œä¼šæå‡åšäº‹æ•ˆç‡å˜›ï¼Ÿæˆ‘æƒ³å¹¶ä¸ä¼šã€‚** çº¿ç¨‹æ•°é‡è¿‡å¤šçš„å½±å“ä¹Ÿæ˜¯å’Œæˆ‘ä»¬åˆ†é…å¤šå°‘äººåšäº‹æƒ…ä¸€æ ·ï¼Œå¯¹äºå¤šçº¿ç¨‹è¿™ä¸ªåœºæ™¯æ¥è¯´ä¸»è¦æ˜¯å¢åŠ äº†**ä¸Šä¸‹æ–‡åˆ‡æ¢**æˆæœ¬ã€‚ä¸æ¸…æ¥šä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢çš„è¯ï¼Œå¯ä»¥çœ‹æˆ‘ä¸‹é¢çš„ä»‹ç»ã€‚

> ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š
>
> å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ä¸€èˆ¬çº¿ç¨‹çš„ä¸ªæ•°éƒ½å¤§äº CPU æ ¸å¿ƒçš„ä¸ªæ•°ï¼Œè€Œä¸€ä¸ª CPU æ ¸å¿ƒåœ¨ä»»æ„æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä¸ºäº†è®©è¿™äº›çº¿ç¨‹éƒ½èƒ½å¾—åˆ°æœ‰æ•ˆæ‰§è¡Œï¼ŒCPU é‡‡å–çš„ç­–ç•¥æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡å¹¶è½®è½¬çš„å½¢å¼ã€‚å½“ä¸€ä¸ªçº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œçš„æ—¶å€™å°±ä¼šé‡æ–°å¤„äºå°±ç»ªçŠ¶æ€è®©ç»™å…¶ä»–çº¿ç¨‹ä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å±äºä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ¦‚æ‹¬æ¥è¯´å°±æ˜¯ï¼šå½“å‰ä»»åŠ¡åœ¨æ‰§è¡Œå®Œ CPU æ—¶é—´ç‰‡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ä¼šå…ˆä¿å­˜è‡ªå·±çš„çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå¯ä»¥å†åŠ è½½è¿™ä¸ªä»»åŠ¡çš„çŠ¶æ€ã€‚**ä»»åŠ¡ä»ä¿å­˜åˆ°å†åŠ è½½çš„è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢**ã€‚
>
> ä¸Šä¸‹æ–‡åˆ‡æ¢é€šå¸¸æ˜¯è®¡ç®—å¯†é›†å‹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒéœ€è¦ç›¸å½“å¯è§‚çš„å¤„ç†å™¨æ—¶é—´ï¼Œåœ¨æ¯ç§’å‡ åä¸Šç™¾æ¬¡çš„åˆ‡æ¢ä¸­ï¼Œæ¯æ¬¡åˆ‡æ¢éƒ½éœ€è¦çº³ç§’é‡çº§çš„æ—¶é—´ã€‚æ‰€ä»¥ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¯¹ç³»ç»Ÿæ¥è¯´æ„å‘³ç€æ¶ˆè€—å¤§é‡çš„ CPU æ—¶é—´ï¼Œäº‹å®ä¸Šï¼Œå¯èƒ½æ˜¯æ“ä½œç³»ç»Ÿä¸­æ—¶é—´æ¶ˆè€—æœ€å¤§çš„æ“ä½œã€‚
>
> Linux ç›¸æ¯”ä¸å…¶ä»–æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬å…¶ä»–ç±» Unix ç³»ç»Ÿï¼‰æœ‰å¾ˆå¤šçš„ä¼˜ç‚¹ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹å°±æ˜¯ï¼Œå…¶ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ¨¡å¼åˆ‡æ¢çš„æ—¶é—´æ¶ˆè€—éå¸¸å°‘ã€‚

ç±»æ¯”äºç°å®ä¸–ç•Œä¸­çš„äººç±»é€šè¿‡åˆä½œåšæŸä»¶äº‹æƒ…ï¼Œæˆ‘ä»¬å¯ä»¥è‚¯å®šçš„ä¸€ç‚¹æ˜¯çº¿ç¨‹æ± å¤§å°è®¾ç½®è¿‡å¤§æˆ–è€…è¿‡å°éƒ½ä¼šæœ‰é—®é¢˜ï¼Œåˆé€‚çš„æ‰æ˜¯æœ€å¥½ã€‚

- å¦‚æœæˆ‘ä»¬è®¾ç½®çš„çº¿ç¨‹æ± æ•°é‡å¤ªå°çš„è¯ï¼Œå¦‚æœåŒä¸€æ—¶é—´æœ‰å¤§é‡ä»»åŠ¡/è¯·æ±‚éœ€è¦å¤„ç†ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤§é‡çš„è¯·æ±‚/ä»»åŠ¡åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­æ’é˜Ÿç­‰å¾…æ‰§è¡Œï¼Œç”šè‡³ä¼šå‡ºç°ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ä¹‹åä»»åŠ¡/è¯·æ±‚æ— æ³•å¤„ç†çš„æƒ…å†µï¼Œæˆ–è€…å¤§é‡ä»»åŠ¡å †ç§¯åœ¨ä»»åŠ¡é˜Ÿåˆ—å¯¼è‡´ OOMã€‚è¿™æ ·å¾ˆæ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ï¼ŒCPU æ ¹æœ¬æ²¡æœ‰å¾—åˆ°å……åˆ†åˆ©ç”¨ã€‚
- å¦‚æœæˆ‘ä»¬è®¾ç½®çº¿ç¨‹æ•°é‡å¤ªå¤§ï¼Œå¤§é‡çº¿ç¨‹å¯èƒ½ä¼šåŒæ—¶åœ¨äº‰å– CPU èµ„æºï¼Œè¿™æ ·ä¼šå¯¼è‡´å¤§é‡çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»è€Œå¢åŠ çº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ï¼Œå½±å“äº†æ•´ä½“æ‰§è¡Œæ•ˆç‡ã€‚

æœ‰ä¸€ä¸ªç®€å•å¹¶ä¸”é€‚ç”¨é¢æ¯”è¾ƒå¹¿çš„å…¬å¼ï¼š

- **CPU å¯†é›†å‹ä»»åŠ¡(N+1)ï¼š** è¿™ç§ä»»åŠ¡æ¶ˆè€—çš„ä¸»è¦æ˜¯ CPU èµ„æºï¼Œå¯ä»¥å°†çº¿ç¨‹æ•°è®¾ç½®ä¸º Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰+1ã€‚æ¯” CPU æ ¸å¿ƒæ•°å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹å¶å‘çš„ç¼ºé¡µä¸­æ–­ï¼Œæˆ–è€…å…¶å®ƒåŸå› å¯¼è‡´çš„ä»»åŠ¡æš‚åœè€Œå¸¦æ¥çš„å½±å“ã€‚ä¸€æ—¦ä»»åŠ¡æš‚åœï¼ŒCPU å°±ä¼šå¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œåœ¨è¿™ç§æƒ…å†µä¸‹å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„ç©ºé—²æ—¶é—´ã€‚
- **I/O å¯†é›†å‹ä»»åŠ¡(2N)ï¼š** è¿™ç§ä»»åŠ¡åº”ç”¨èµ·æ¥ï¼Œç³»ç»Ÿä¼šç”¨å¤§éƒ¨åˆ†çš„æ—¶é—´æ¥å¤„ç† I/O äº¤äº’ï¼Œè€Œçº¿ç¨‹åœ¨å¤„ç† I/O çš„æ—¶é—´æ®µå†…ä¸ä¼šå ç”¨ CPU æ¥å¤„ç†ï¼Œè¿™æ—¶å°±å¯ä»¥å°† CPU äº¤å‡ºç»™å…¶å®ƒçº¿ç¨‹ä½¿ç”¨ã€‚å› æ­¤åœ¨ I/O å¯†é›†å‹ä»»åŠ¡çš„åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤šé…ç½®ä¸€äº›çº¿ç¨‹ï¼Œå…·ä½“çš„è®¡ç®—æ–¹æ³•æ˜¯ 2Nã€‚

**å¦‚ä½•åˆ¤æ–­æ˜¯ CPU å¯†é›†ä»»åŠ¡è¿˜æ˜¯ IO å¯†é›†ä»»åŠ¡ï¼Ÿ**

CPU å¯†é›†å‹ç®€å•ç†è§£å°±æ˜¯åˆ©ç”¨ CPU è®¡ç®—èƒ½åŠ›çš„ä»»åŠ¡æ¯”å¦‚ä½ åœ¨å†…å­˜ä¸­å¯¹å¤§é‡æ•°æ®è¿›è¡Œæ’åºã€‚ä½†å‡¡æ¶‰åŠåˆ°ç½‘ç»œè¯»å–ï¼Œæ–‡ä»¶è¯»å–è¿™ç±»éƒ½æ˜¯ IO å¯†é›†å‹ï¼Œè¿™ç±»ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯ CPU è®¡ç®—è€—è´¹æ—¶é—´ç›¸æ¯”äºç­‰å¾… IO æ“ä½œå®Œæˆçš„æ—¶é—´æ¥è¯´å¾ˆå°‘ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨äº†ç­‰å¾… IO æ“ä½œå®Œæˆä¸Šã€‚

> ğŸŒˆ æ‹“å±•ä¸€ä¸‹ï¼ˆå‚è§ï¼š[issue#1737](https://github.com/Snailclimb/JavaGuide/issues/1737)ï¼‰ï¼š
>
> çº¿ç¨‹æ•°æ›´ä¸¥è°¨çš„è®¡ç®—çš„æ–¹æ³•åº”è¯¥æ˜¯ï¼š`æœ€ä½³çº¿ç¨‹æ•° = Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰âˆ—ï¼ˆ1+WTï¼ˆçº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼‰/STï¼ˆçº¿ç¨‹è®¡ç®—æ—¶é—´ï¼‰ï¼‰`ï¼Œå…¶ä¸­ `WTï¼ˆçº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼‰=çº¿ç¨‹è¿è¡Œæ€»æ—¶é—´ - STï¼ˆçº¿ç¨‹è®¡ç®—æ—¶é—´ï¼‰`ã€‚
>
> çº¿ç¨‹ç­‰å¾…æ—¶é—´æ‰€å æ¯”ä¾‹è¶Šé«˜ï¼Œéœ€è¦è¶Šå¤šçº¿ç¨‹ã€‚çº¿ç¨‹è®¡ç®—æ—¶é—´æ‰€å æ¯”ä¾‹è¶Šé«˜ï¼Œéœ€è¦è¶Šå°‘çº¿ç¨‹ã€‚
>
> æˆ‘ä»¬å¯ä»¥é€šè¿‡ JDK è‡ªå¸¦çš„å·¥å…· VisualVM æ¥æŸ¥çœ‹ `WT/ST` æ¯”ä¾‹ã€‚
>
> CPU å¯†é›†å‹ä»»åŠ¡çš„ `WT/ST` æ¥è¿‘æˆ–è€…ç­‰äº 0ï¼Œå› æ­¤ï¼Œ çº¿ç¨‹æ•°å¯ä»¥è®¾ç½®ä¸º Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰âˆ—ï¼ˆ1+0ï¼‰= Nï¼Œå’Œæˆ‘ä»¬ä¸Šé¢è¯´çš„ Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰+1 å·®ä¸å¤šã€‚
>
> IO å¯†é›†å‹ä»»åŠ¡ä¸‹ï¼Œå‡ ä¹å…¨æ˜¯çº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼Œä»ç†è®ºä¸Šæ¥è¯´ï¼Œä½ å°±å¯ä»¥å°†çº¿ç¨‹æ•°è®¾ç½®ä¸º 2Nï¼ˆæŒ‰é“ç†æ¥è¯´ï¼ŒWT/ST çš„ç»“æœåº”è¯¥æ¯”è¾ƒå¤§ï¼Œè¿™é‡Œé€‰æ‹© 2N çš„åŸå› åº”è¯¥æ˜¯ä¸ºäº†é¿å…åˆ›å»ºè¿‡å¤šçº¿ç¨‹å§ï¼‰ã€‚

å…¬å¼ä¹Ÿåªæ˜¯å‚è€ƒï¼Œå…·ä½“è¿˜æ˜¯è¦æ ¹æ®é¡¹ç›®å®é™…çº¿ä¸Šè¿è¡Œæƒ…å†µæ¥åŠ¨æ€è°ƒæ•´ã€‚æˆ‘åœ¨åé¢ä»‹ç»çš„ç¾å›¢çš„çº¿ç¨‹æ± å‚æ•°åŠ¨æ€é…ç½®è¿™ç§æ–¹æ¡ˆå°±éå¸¸ä¸é”™ï¼Œå¾ˆå®ç”¨ï¼

### â­ï¸å¦‚ä½•åŠ¨æ€ä¿®æ”¹çº¿ç¨‹æ± çš„å‚æ•°ï¼Ÿ

ç¾å›¢æŠ€æœ¯å›¢é˜Ÿåœ¨[ã€ŠJava çº¿ç¨‹æ± å®ç°åŸç†åŠå…¶åœ¨ç¾å›¢ä¸šåŠ¡ä¸­çš„å®è·µã€‹](https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html)è¿™ç¯‡æ–‡ç« ä¸­ä»‹ç»åˆ°å¯¹çº¿ç¨‹æ± å‚æ•°å®ç°å¯è‡ªå®šä¹‰é…ç½®çš„æ€è·¯å’Œæ–¹æ³•ã€‚

ç¾å›¢æŠ€æœ¯å›¢é˜Ÿçš„æ€è·¯æ˜¯ä¸»è¦å¯¹çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°å®ç°è‡ªå®šä¹‰å¯é…ç½®ã€‚è¿™ä¸‰ä¸ªæ ¸å¿ƒå‚æ•°æ˜¯ï¼š

- **`corePoolSize` :** æ ¸å¿ƒçº¿ç¨‹æ•°å®šä¹‰äº†æœ€å°å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚
- **`maximumPoolSize` :** å½“é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ã€‚
- **`workQueue`:** å½“æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

**ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸‰ä¸ªå‚æ•°ï¼Ÿ**

æˆ‘åœ¨[Java çº¿ç¨‹æ± è¯¦è§£](https://javaguide.cn/java/concurrent/java-thread-pool-summary.html) è¿™ç¯‡æ–‡ç« ä¸­å°±è¯´è¿‡è¿™ä¸‰ä¸ªå‚æ•°æ˜¯ `ThreadPoolExecutor` æœ€é‡è¦çš„å‚æ•°ï¼Œå®ƒä»¬åŸºæœ¬å†³å®šäº†çº¿ç¨‹æ± å¯¹äºä»»åŠ¡çš„å¤„ç†ç­–ç•¥ã€‚

**å¦‚ä½•æ”¯æŒå‚æ•°åŠ¨æ€é…ç½®ï¼Ÿ** ä¸”çœ‹ `ThreadPoolExecutor` æä¾›çš„ä¸‹é¢è¿™äº›æ–¹æ³•ã€‚

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/threadpoolexecutor-methods.png)

æ ¼å¤–éœ€è¦æ³¨æ„çš„æ˜¯`corePoolSize`ï¼Œ ç¨‹åºè¿è¡ŒæœŸé—´çš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨ `setCorePoolSize()`è¿™ä¸ªæ–¹æ³•çš„è¯ï¼Œçº¿ç¨‹æ± ä¼šé¦–å…ˆåˆ¤æ–­å½“å‰å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦å¤§äº`corePoolSize`ï¼Œå¦‚æœå¤§äºçš„è¯å°±ä¼šå›æ”¶å·¥ä½œçº¿ç¨‹ã€‚

å¦å¤–ï¼Œä½ ä¹Ÿçœ‹åˆ°äº†ä¸Šé¢å¹¶æ²¡æœ‰åŠ¨æ€æŒ‡å®šé˜Ÿåˆ—é•¿åº¦çš„æ–¹æ³•ï¼Œç¾å›¢çš„æ–¹å¼æ˜¯è‡ªå®šä¹‰äº†ä¸€ä¸ªå«åš `ResizableCapacityLinkedBlockIngQueue` çš„é˜Ÿåˆ—ï¼ˆä¸»è¦å°±æ˜¯æŠŠ`LinkedBlockingQueue`çš„ capacity å­—æ®µçš„ final å…³é”®å­—ä¿®é¥°ç»™å»æ‰äº†ï¼Œè®©å®ƒå˜ä¸ºå¯å˜çš„ï¼‰ã€‚

æœ€ç»ˆå®ç°çš„å¯åŠ¨æ€ä¿®æ”¹çº¿ç¨‹æ± å‚æ•°æ•ˆæœå¦‚ä¸‹ã€‚ğŸ‘ğŸ‘ğŸ‘

![åŠ¨æ€é…ç½®çº¿ç¨‹æ± å‚æ•°æœ€ç»ˆæ•ˆæœ](https://oss.javaguide.cn/github/javaguide/java/concurrent/meituan-dynamically-configuring-thread-pool-parameters.png)

è¿˜æ²¡çœ‹å¤Ÿï¼Ÿæˆ‘åœ¨[ã€Šåç«¯é¢è¯•é«˜é¢‘ç³»ç»Ÿè®¾è®¡&åœºæ™¯é¢˜ã€‹](https://javaguide.cn/zhuanlan/back-end-interview-high-frequency-system-design-and-scenario-questions.html)ä¸­è¯¦ç»†ä»‹ç»äº†å¦‚ä½•è®¾è®¡ä¸€ä¸ªåŠ¨æ€çº¿ç¨‹æ± ï¼Œè¿™ä¹Ÿæ˜¯é¢è¯•ä¸­å¸¸é—®çš„ä¸€é“ç³»ç»Ÿè®¾è®¡é¢˜ã€‚

![ã€Šåç«¯é¢è¯•é«˜é¢‘ç³»ç»Ÿè®¾è®¡&åœºæ™¯é¢˜ã€‹](https://oss.javaguide.cn/xingqiu/back-end-interview-high-frequency-system-design-and-scenario-questions-fengmian.png)

å¦‚æœæˆ‘ä»¬çš„é¡¹ç›®ä¹Ÿæƒ³è¦å®ç°è¿™ç§æ•ˆæœçš„è¯ï¼Œå¯ä»¥å€ŸåŠ©ç°æˆçš„å¼€æºé¡¹ç›®ï¼š

- **[Hippo4j](https://github.com/opengoofy/hippo4j)**ï¼šå¼‚æ­¥çº¿ç¨‹æ± æ¡†æ¶ï¼Œæ”¯æŒçº¿ç¨‹æ± åŠ¨æ€å˜æ›´&ç›‘æ§&æŠ¥è­¦ï¼Œæ— éœ€ä¿®æ”¹ä»£ç è½»æ¾å¼•å…¥ã€‚æ”¯æŒå¤šç§ä½¿ç”¨æ¨¡å¼ï¼Œè½»æ¾å¼•å…¥ï¼Œè‡´åŠ›äºæé«˜ç³»ç»Ÿè¿è¡Œä¿éšœèƒ½åŠ›ã€‚
- **[Dynamic TP](https://github.com/dromara/dynamic-tp)**ï¼šè½»é‡çº§åŠ¨æ€çº¿ç¨‹æ± ï¼Œå†…ç½®ç›‘æ§å‘Šè­¦åŠŸèƒ½ï¼Œé›†æˆä¸‰æ–¹ä¸­é—´ä»¶çº¿ç¨‹æ± ç®¡ç†ï¼ŒåŸºäºä¸»æµé…ç½®ä¸­å¿ƒï¼ˆå·²æ”¯æŒ Nacosã€Apolloï¼ŒZookeeperã€Consulã€Etcdï¼Œå¯é€šè¿‡ SPI è‡ªå®šä¹‰å®ç°ï¼‰ã€‚

### â­ï¸å¦‚ä½•è®¾è®¡ä¸€ä¸ªèƒ½å¤Ÿæ ¹æ®ä»»åŠ¡çš„ä¼˜å…ˆçº§æ¥æ‰§è¡Œçš„çº¿ç¨‹æ± ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„é¢è¯•é—®é¢˜ï¼Œæœ¬è´¨å…¶å®è¿˜æ˜¯åœ¨è€ƒå¯Ÿæ±‚èŒè€…å¯¹äºçº¿ç¨‹æ± ä»¥åŠé˜»å¡é˜Ÿåˆ—çš„æŒæ¡ã€‚

æˆ‘ä»¬ä¸Šé¢ä¹Ÿæåˆ°äº†ï¼Œä¸åŒçš„çº¿ç¨‹æ± ä¼šé€‰ç”¨ä¸åŒçš„é˜»å¡é˜Ÿåˆ—ä½œä¸ºä»»åŠ¡é˜Ÿåˆ—ï¼Œæ¯”å¦‚`FixedThreadPool` ä½¿ç”¨çš„æ˜¯`LinkedBlockingQueue`ï¼ˆæœ‰ç•Œé˜Ÿåˆ—ï¼‰ï¼Œé»˜è®¤æ„é€ å™¨åˆå§‹çš„é˜Ÿåˆ—é•¿åº¦ä¸º `Integer.MAX_VALUE` ï¼Œç”±äºé˜Ÿåˆ—æ°¸è¿œä¸ä¼šè¢«æ”¾æ»¡ï¼Œå› æ­¤`FixedThreadPool`æœ€å¤šåªèƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ã€‚

å‡å¦‚æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªä¼˜å…ˆçº§ä»»åŠ¡çº¿ç¨‹æ± çš„è¯ï¼Œé‚£å¯ä»¥è€ƒè™‘ä½¿ç”¨ `PriorityBlockingQueue` ï¼ˆä¼˜å…ˆçº§é˜»å¡é˜Ÿåˆ—ï¼‰ä½œä¸ºä»»åŠ¡é˜Ÿåˆ—ï¼ˆ`ThreadPoolExecutor` çš„æ„é€ å‡½æ•°æœ‰ä¸€ä¸ª `workQueue` å‚æ•°å¯ä»¥ä¼ å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼‰ã€‚

![ThreadPoolExecutoræ„é€ å‡½æ•°](https://oss.javaguide.cn/github/javaguide/java/concurrent/common-parameters-of-threadpool-workqueue.jpg)

`PriorityBlockingQueue` æ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥çœ‹ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ `PriorityQueue`ï¼Œä¸¤è€…åº•å±‚éƒ½æ˜¯ä½¿ç”¨å°é¡¶å †å½¢å¼çš„äºŒå‰å †ï¼Œå³å€¼æœ€å°çš„å…ƒç´ ä¼˜å…ˆå‡ºé˜Ÿã€‚ä¸è¿‡ï¼Œ`PriorityQueue` ä¸æ”¯æŒé˜»å¡æ“ä½œã€‚

è¦æƒ³è®© `PriorityBlockingQueue` å®ç°å¯¹ä»»åŠ¡çš„æ’åºï¼Œä¼ å…¥å…¶ä¸­çš„ä»»åŠ¡å¿…é¡»æ˜¯å…·å¤‡æ’åºèƒ½åŠ›çš„ï¼Œæ–¹å¼æœ‰ä¸¤ç§ï¼š

1. æäº¤åˆ°çº¿ç¨‹æ± çš„ä»»åŠ¡å®ç° `Comparable` æ¥å£ï¼Œå¹¶é‡å†™ `compareTo` æ–¹æ³•æ¥æŒ‡å®šä»»åŠ¡ä¹‹é—´çš„ä¼˜å…ˆçº§æ¯”è¾ƒè§„åˆ™ã€‚
2. åˆ›å»º `PriorityBlockingQueue` æ—¶ä¼ å…¥ä¸€ä¸ª `Comparator` å¯¹è±¡æ¥æŒ‡å®šä»»åŠ¡ä¹‹é—´çš„æ’åºè§„åˆ™(æ¨è)ã€‚

ä¸è¿‡ï¼Œè¿™å­˜åœ¨ä¸€äº›é£é™©å’Œé—®é¢˜ï¼Œæ¯”å¦‚ï¼š

- `PriorityBlockingQueue` æ˜¯æ— ç•Œçš„ï¼Œå¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- å¯èƒ½ä¼šå¯¼è‡´é¥¥é¥¿é—®é¢˜ï¼Œå³ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡é•¿æ—¶é—´å¾—ä¸åˆ°æ‰§è¡Œã€‚
- ç”±äºéœ€è¦å¯¹é˜Ÿåˆ—ä¸­çš„å…ƒç´ è¿›è¡Œæ’åºæ“ä½œä»¥åŠä¿è¯çº¿ç¨‹å®‰å…¨ï¼ˆå¹¶å‘æ§åˆ¶é‡‡ç”¨çš„æ˜¯å¯é‡å…¥é” `ReentrantLock`ï¼‰ï¼Œå› æ­¤ä¼šé™ä½æ€§èƒ½ã€‚

å¯¹äº OOM è¿™ä¸ªé—®é¢˜çš„è§£å†³æ¯”è¾ƒç®€å•ç²—æš´ï¼Œå°±æ˜¯ç»§æ‰¿`PriorityBlockingQueue` å¹¶é‡å†™ä¸€ä¸‹ `offer` æ–¹æ³•(å…¥é˜Ÿ)çš„é€»è¾‘ï¼Œå½“æ’å…¥çš„å…ƒç´ æ•°é‡è¶…è¿‡æŒ‡å®šå€¼å°±è¿”å› false ã€‚

é¥¥é¥¿é—®é¢˜è¿™ä¸ªå¯ä»¥é€šè¿‡ä¼˜åŒ–è®¾è®¡æ¥è§£å†³ï¼ˆæ¯”è¾ƒéº»çƒ¦ï¼‰ï¼Œæ¯”å¦‚ç­‰å¾…æ—¶é—´è¿‡é•¿çš„ä»»åŠ¡ä¼šè¢«ç§»é™¤å¹¶é‡æ–°æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œä½†æ˜¯ä¼˜å…ˆçº§ä¼šè¢«æå‡ã€‚

å¯¹äºæ€§èƒ½æ–¹é¢çš„å½±å“ï¼Œæ˜¯æ²¡åŠæ³•é¿å…çš„ï¼Œæ¯•ç«Ÿéœ€è¦å¯¹ä»»åŠ¡è¿›è¡Œæ’åºæ“ä½œã€‚å¹¶ä¸”ï¼Œå¯¹äºå¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯æ¥è¯´ï¼Œè¿™ç‚¹æ€§èƒ½å½±å“æ˜¯å¯ä»¥æ¥å—çš„ã€‚

## Future

é‡ç‚¹æ˜¯è¦æŒæ¡ `CompletableFuture` çš„ä½¿ç”¨ä»¥åŠå¸¸è§é¢è¯•é¢˜ã€‚

é™¤äº†ä¸‹é¢çš„é¢è¯•é¢˜ä¹‹å¤–ï¼Œè¿˜æ¨èä½ çœ‹çœ‹æˆ‘å†™çš„è¿™ç¯‡æ–‡ç« ï¼š [CompletableFuture è¯¦è§£](https://javaguide.cn/java/concurrent/completablefuture-intro.html)ã€‚

### Future ç±»æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`Future` ç±»æ˜¯å¼‚æ­¥æ€æƒ³çš„å…¸å‹è¿ç”¨ï¼Œä¸»è¦ç”¨åœ¨ä¸€äº›éœ€è¦æ‰§è¡Œè€—æ—¶ä»»åŠ¡çš„åœºæ™¯ï¼Œé¿å…ç¨‹åºä¸€ç›´åŸåœ°ç­‰å¾…è€—æ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰§è¡Œæ•ˆç‡å¤ªä½ã€‚å…·ä½“æ¥è¯´æ˜¯è¿™æ ·çš„ï¼šå½“æˆ‘ä»¬æ‰§è¡ŒæŸä¸€è€—æ—¶çš„ä»»åŠ¡æ—¶ï¼Œå¯ä»¥å°†è¿™ä¸ªè€—æ—¶ä»»åŠ¡äº¤ç»™ä¸€ä¸ªå­çº¿ç¨‹å»å¼‚æ­¥æ‰§è¡Œï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥å¹²ç‚¹å…¶ä»–äº‹æƒ…ï¼Œä¸ç”¨å‚»å‚»ç­‰å¾…è€—æ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚ç­‰æˆ‘ä»¬çš„äº‹æƒ…å¹²å®Œåï¼Œæˆ‘ä»¬å†é€šè¿‡ `Future` ç±»è·å–åˆ°è€—æ—¶ä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚è¿™æ ·ä¸€æ¥ï¼Œç¨‹åºçš„æ‰§è¡Œæ•ˆç‡å°±æ˜æ˜¾æé«˜äº†ã€‚

è¿™å…¶å®å°±æ˜¯å¤šçº¿ç¨‹ä¸­ç»å…¸çš„ **Future æ¨¡å¼**ï¼Œä½ å¯ä»¥å°†å…¶çœ‹ä½œæ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œä¸»è¦ç”¨åœ¨å¤šçº¿ç¨‹é¢†åŸŸï¼Œå¹¶é Java è¯­è¨€ç‹¬æœ‰ã€‚

åœ¨ Java ä¸­ï¼Œ`Future` ç±»åªæ˜¯ä¸€ä¸ªæ³›å‹æ¥å£ï¼Œä½äº `java.util.concurrent` åŒ…ä¸‹ï¼Œå…¶ä¸­å®šä¹‰äº† 5 ä¸ªæ–¹æ³•ï¼Œä¸»è¦åŒ…æ‹¬ä¸‹é¢è¿™ 4 ä¸ªåŠŸèƒ½ï¼š

- å–æ¶ˆä»»åŠ¡ï¼›
- åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ;
- åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆ;
- è·å–ä»»åŠ¡æ‰§è¡Œç»“æœã€‚

```java
// V ä»£è¡¨äº†Futureæ‰§è¡Œçš„ä»»åŠ¡è¿”å›å€¼çš„ç±»å‹
public interface Future<V> {
    // å–æ¶ˆä»»åŠ¡æ‰§è¡Œ
    // æˆåŠŸå–æ¶ˆè¿”å› trueï¼Œå¦åˆ™è¿”å› false
    boolean cancel(boolean mayInterruptIfRunning);
    // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ
    boolean isCancelled();
    // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆ
    boolean isDone();
    // è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ
    V get() throws InterruptedException, ExecutionException;
    // æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è¿”å›è®¡ç®—ç»“æœå°±æŠ›å‡º TimeOutException å¼‚å¸¸
    V get(long timeout, TimeUnit unit)

        throws InterruptedException, ExecutionException, TimeoutExceptio

}
```

ç®€å•ç†è§£å°±æ˜¯ï¼šæˆ‘æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œæäº¤ç»™äº† `Future` æ¥å¤„ç†ã€‚ä»»åŠ¡æ‰§è¡ŒæœŸé—´æˆ‘è‡ªå·±å¯ä»¥å»åšä»»ä½•æƒ³åšçš„äº‹æƒ…ã€‚å¹¶ä¸”ï¼Œåœ¨è¿™æœŸé—´æˆ‘è¿˜å¯ä»¥å–æ¶ˆä»»åŠ¡ä»¥åŠè·å–ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ã€‚ä¸€æ®µæ—¶é—´ä¹‹åï¼Œæˆ‘å°±å¯ä»¥ `Future` é‚£é‡Œç›´æ¥å–å‡ºä»»åŠ¡æ‰§è¡Œç»“æœã€‚

### Callable å’Œ Future æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ

æˆ‘ä»¬å¯ä»¥é€šè¿‡ `FutureTask` æ¥ç†è§£ `Callable` å’Œ `Future` ä¹‹é—´çš„å…³ç³»ã€‚

`FutureTask` æä¾›äº† `Future` æ¥å£çš„åŸºæœ¬å®ç°ï¼Œå¸¸ç”¨æ¥å°è£… `Callable` å’Œ `Runnable`ï¼Œå…·æœ‰å–æ¶ˆä»»åŠ¡ã€æŸ¥çœ‹ä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæˆä»¥åŠè·å–ä»»åŠ¡æ‰§è¡Œç»“æœçš„æ–¹æ³•ã€‚`ExecutorService.submit()` æ–¹æ³•è¿”å›çš„å…¶å®å°±æ˜¯ `Future` çš„å®ç°ç±» `FutureTask` ã€‚

```java
<T> Future<T> submit(Callable<T> task);
Future<?> submit(Runnable task);
```

`FutureTask` ä¸å…‰å®ç°äº† `Future`æ¥å£ï¼Œè¿˜å®ç°äº†`Runnable` æ¥å£ï¼Œå› æ­¤å¯ä»¥ä½œä¸ºä»»åŠ¡ç›´æ¥è¢«çº¿ç¨‹æ‰§è¡Œã€‚

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/completablefuture-class-diagram.jpg)

`FutureTask` æœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œå¯ä¼ å…¥ `Callable` æˆ–è€… `Runnable` å¯¹è±¡ã€‚å®é™…ä¸Šï¼Œä¼ å…¥ `Runnable` å¯¹è±¡ä¹Ÿä¼šåœ¨æ–¹æ³•å†…éƒ¨è½¬æ¢ä¸º`Callable` å¯¹è±¡ã€‚

```java
public FutureTask(Callable<V> callable) {
    if (callable == null)
        throw new NullPointerException();
    this.callable = callable;
    this.state = NEW;
}
public FutureTask(Runnable runnable, V result) {
    // é€šè¿‡é€‚é…å™¨RunnableAdapteræ¥å°†Runnableå¯¹è±¡runnableè½¬æ¢æˆCallableå¯¹è±¡
    this.callable = Executors.callable(runnable, result);
    this.state = NEW;
}
```

`FutureTask`ç›¸å½“äºå¯¹`Callable` è¿›è¡Œäº†å°è£…ï¼Œç®¡ç†ç€ä»»åŠ¡æ‰§è¡Œçš„æƒ…å†µï¼Œå­˜å‚¨äº† `Callable` çš„ `call` æ–¹æ³•çš„ä»»åŠ¡æ‰§è¡Œç»“æœã€‚

å…³äºæ›´å¤š `Future` çš„æºç ç»†èŠ‚ï¼Œå¯ä»¥è‚è¿™ç¯‡ä¸‡å­—è§£æï¼Œå†™çš„å¾ˆæ¸…æ¥šï¼š[Java æ˜¯å¦‚ä½•å®ç° Future æ¨¡å¼çš„ï¼Ÿä¸‡å­—è¯¦è§£ï¼](https://juejin.cn/post/6844904199625375757)ã€‚

### CompletableFuture ç±»æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`Future` åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­å­˜åœ¨ä¸€äº›å±€é™æ€§ï¼Œæ¯”å¦‚ä¸æ”¯æŒå¼‚æ­¥ä»»åŠ¡çš„ç¼–æ’ç»„åˆã€è·å–è®¡ç®—ç»“æœçš„ `get()` æ–¹æ³•ä¸ºé˜»å¡è°ƒç”¨ã€‚

Java 8 æ‰è¢«å¼•å…¥`CompletableFuture` ç±»å¯ä»¥è§£å†³`Future` çš„è¿™äº›ç¼ºé™·ã€‚`CompletableFuture` é™¤äº†æä¾›äº†æ›´ä¸ºå¥½ç”¨å’Œå¼ºå¤§çš„ `Future` ç‰¹æ€§ä¹‹å¤–ï¼Œè¿˜æä¾›äº†å‡½æ•°å¼ç¼–ç¨‹ã€å¼‚æ­¥ä»»åŠ¡ç¼–æ’ç»„åˆï¼ˆå¯ä»¥å°†å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ä¸²è”èµ·æ¥ï¼Œç»„æˆä¸€ä¸ªå®Œæ•´çš„é“¾å¼è°ƒç”¨ï¼‰ç­‰èƒ½åŠ›ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥ç®€å•çœ‹çœ‹ `CompletableFuture` ç±»çš„å®šä¹‰ã€‚

```java
public class CompletableFuture<T> implements Future<T>, CompletionStage<T> {
}
```

å¯ä»¥çœ‹åˆ°ï¼Œ`CompletableFuture` åŒæ—¶å®ç°äº† `Future` å’Œ `CompletionStage` æ¥å£ã€‚

![](https://oss.javaguide.cn/github/javaguide/java/concurrent/completablefuture-class-diagram.jpg)

`CompletionStage` æ¥å£æè¿°äº†ä¸€ä¸ªå¼‚æ­¥è®¡ç®—çš„é˜¶æ®µã€‚å¾ˆå¤šè®¡ç®—å¯ä»¥åˆ†æˆå¤šä¸ªé˜¶æ®µæˆ–æ­¥éª¤ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å®ƒå°†æ‰€æœ‰æ­¥éª¤ç»„åˆèµ·æ¥ï¼Œå½¢æˆå¼‚æ­¥è®¡ç®—çš„æµæ°´çº¿ã€‚

`CompletionStage` æ¥å£ä¸­çš„æ–¹æ³•æ¯”è¾ƒå¤šï¼Œ`CompletableFuture` çš„å‡½æ•°å¼èƒ½åŠ›å°±æ˜¯è¿™ä¸ªæ¥å£èµ‹äºˆçš„ã€‚ä»è¿™ä¸ªæ¥å£çš„æ–¹æ³•å‚æ•°ä½ å°±å¯ä»¥å‘ç°å…¶å¤§é‡ä½¿ç”¨äº† Java8 å¼•å…¥çš„å‡½æ•°å¼ç¼–ç¨‹ã€‚

![](https://oss.javaguide.cn/javaguide/image-20210902093026059.png)

### â­ï¸ä¸€ä¸ªä»»åŠ¡éœ€è¦ä¾èµ–å¦å¤–ä¸¤ä¸ªä»»åŠ¡æ‰§è¡Œå®Œä¹‹åå†æ‰§è¡Œï¼Œæ€ä¹ˆè®¾è®¡ï¼Ÿ

è¿™ç§ä»»åŠ¡ç¼–æ’åœºæ™¯éå¸¸é€‚åˆé€šè¿‡`CompletableFuture`å®ç°ã€‚è¿™é‡Œå‡è®¾è¦å®ç° T3 åœ¨ T2 å’Œ T1 æ‰§è¡Œå®Œåæ‰§è¡Œã€‚

ä»£ç å¦‚ä¸‹ï¼ˆè¿™é‡Œä¸ºäº†ç®€åŒ–ä»£ç ï¼Œç”¨åˆ°äº† Hutool çš„çº¿ç¨‹å·¥å…·ç±» `ThreadUtil` å’Œæ—¥æœŸæ—¶é—´å·¥å…·ç±» `DateUtil`ï¼‰ï¼š

```java
// T1
CompletableFuture<Void> futureT1 = CompletableFuture.runAsync(() -> {
    System.out.println("T1 is executing. Current timeï¼š" + DateUtil.now());
    // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    ThreadUtil.sleep(1000);
});
// T2
CompletableFuture<Void> futureT2 = CompletableFuture.runAsync(() -> {
    System.out.println("T2 is executing. Current timeï¼š" + DateUtil.now());
    ThreadUtil.sleep(1000);
});

// ä½¿ç”¨allOf()æ–¹æ³•åˆå¹¶T1å’ŒT2çš„CompletableFutureï¼Œç­‰å¾…å®ƒä»¬éƒ½å®Œæˆ
CompletableFuture<Void> bothCompleted = CompletableFuture.allOf(futureT1, futureT2);
// å½“T1å’ŒT2éƒ½å®Œæˆåï¼Œæ‰§è¡ŒT3
bothCompleted.thenRunAsync(() -> System.out.println("T3 is executing after T1 and T2 have completed.Current timeï¼š" + DateUtil.now()));
// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼ŒéªŒè¯æ•ˆæœ
ThreadUtil.sleep(3000);
```

é€šè¿‡ `CompletableFuture` çš„ `allOf()` è¿™ä¸ªé™æ€æ–¹æ³•æ¥å¹¶è¡Œè¿è¡Œ T1 å’Œ T2ï¼Œå½“ T1 å’Œ T2 éƒ½å®Œæˆåï¼Œå†æ‰§è¡Œ T3ã€‚

### â­ï¸ä½¿ç”¨ CompletableFutureï¼Œæœ‰ä¸€ä¸ªä»»åŠ¡å¤±è´¥ï¼Œå¦‚ä½•å¤„ç†å¼‚å¸¸ï¼Ÿ

ä½¿ç”¨ `CompletableFuture`çš„æ—¶å€™ä¸€å®šè¦ä»¥æ­£ç¡®çš„æ–¹å¼è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œé¿å…å¼‚å¸¸ä¸¢å¤±æˆ–è€…å‡ºç°ä¸å¯æ§é—®é¢˜ã€‚

ä¸‹é¢æ˜¯ä¸€äº›å»ºè®®ï¼š

- ä½¿ç”¨ `whenComplete` æ–¹æ³•å¯ä»¥åœ¨ä»»åŠ¡å®Œæˆæ—¶è§¦å‘å›è°ƒå‡½æ•°ï¼Œå¹¶æ­£ç¡®åœ°å¤„ç†å¼‚å¸¸ï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸è¢«åå™¬æˆ–ä¸¢å¤±ã€‚
- ä½¿ç”¨ `exceptionally` æ–¹æ³•å¯ä»¥å¤„ç†å¼‚å¸¸å¹¶é‡æ–°æŠ›å‡ºï¼Œä»¥ä¾¿å¼‚å¸¸èƒ½å¤Ÿä¼ æ’­åˆ°åç»­é˜¶æ®µï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸è¢«å¿½ç•¥æˆ–ç»ˆæ­¢ã€‚
- ä½¿ç”¨ `handle` æ–¹æ³•å¯ä»¥å¤„ç†æ­£å¸¸çš„è¿”å›ç»“æœå’Œå¼‚å¸¸ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ç»“æœï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸å½±å“æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘ã€‚
- ä½¿ç”¨ `CompletableFuture.allOf` æ–¹æ³•å¯ä»¥ç»„åˆå¤šä¸ª `CompletableFuture`ï¼Œå¹¶ç»Ÿä¸€å¤„ç†æ‰€æœ‰ä»»åŠ¡çš„å¼‚å¸¸ï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸å¤„ç†è¿‡äºå†—é•¿æˆ–é‡å¤ã€‚
- â€¦â€¦

### â­ï¸åœ¨ä½¿ç”¨ CompletableFuture çš„æ—¶å€™ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Ÿ

`CompletableFuture` é»˜è®¤ä½¿ç”¨å…¨å±€å…±äº«çš„ `ForkJoinPool.commonPool()` ä½œä¸ºæ‰§è¡Œå™¨ï¼Œæ‰€æœ‰æœªæŒ‡å®šæ‰§è¡Œå™¨çš„å¼‚æ­¥ä»»åŠ¡éƒ½ä¼šä½¿ç”¨è¯¥çº¿ç¨‹æ± ã€‚è¿™æ„å‘³ç€åº”ç”¨ç¨‹åºã€å¤šä¸ªåº“æˆ–æ¡†æ¶ï¼ˆå¦‚ Springã€ç¬¬ä¸‰æ–¹åº“ï¼‰è‹¥éƒ½ä¾èµ– `CompletableFuture`ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒä»¬éƒ½ä¼šå…±äº«åŒä¸€ä¸ªçº¿ç¨‹æ± ã€‚

è™½ç„¶ `ForkJoinPool` æ•ˆç‡å¾ˆé«˜ï¼Œä½†å½“åŒæ—¶æäº¤å¤§é‡ä»»åŠ¡æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´èµ„æºç«äº‰å’Œçº¿ç¨‹é¥¥é¥¿ï¼Œè¿›è€Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚

ä¸ºé¿å…è¿™äº›é—®é¢˜ï¼Œå»ºè®®ä¸º `CompletableFuture` æä¾›è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œå¸¦æ¥ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- éš”ç¦»æ€§ï¼šä¸ºä¸åŒä»»åŠ¡åˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹æ± ï¼Œé¿å…å…¨å±€çº¿ç¨‹æ± èµ„æºäº‰å¤ºã€‚
- èµ„æºæ§åˆ¶ï¼šæ ¹æ®ä»»åŠ¡ç‰¹æ€§è°ƒæ•´çº¿ç¨‹æ± å¤§å°å’Œé˜Ÿåˆ—ç±»å‹ï¼Œä¼˜åŒ–æ€§èƒ½è¡¨ç°ã€‚
- å¼‚å¸¸å¤„ç†ï¼šé€šè¿‡è‡ªå®šä¹‰ `ThreadFactory` æ›´å¥½åœ°å¤„ç†çº¿ç¨‹ä¸­çš„å¼‚å¸¸æƒ…å†µã€‚

```java
private ThreadPoolExecutor executor = new ThreadPoolExecutor(10, 10,
        0L, TimeUnit.MILLISECONDS,
        new LinkedBlockingQueue<Runnable>());

CompletableFuture.runAsync(() -> {
     //...
}, executor);
```

## AQS

å…³äº AQS æºç çš„è¯¦ç»†åˆ†æï¼Œå¯ä»¥çœ‹çœ‹è¿™ä¸€ç¯‡æ–‡ç« ï¼š[AQS è¯¦è§£](https://javaguide.cn/java/concurrent/aqs.html)ã€‚

### AQS æ˜¯ä»€ä¹ˆï¼Ÿ

AQS ï¼ˆ`AbstractQueuedSynchronizer` ï¼ŒæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ï¼‰æ˜¯ä» JDK1.5 å¼€å§‹æä¾›çš„ Java å¹¶å‘æ ¸å¿ƒç»„ä»¶ã€‚

AQS è§£å†³äº†å¼€å‘è€…åœ¨å®ç°åŒæ­¥å™¨æ—¶çš„å¤æ‚æ€§é—®é¢˜ã€‚å®ƒæä¾›äº†ä¸€ä¸ªé€šç”¨æ¡†æ¶ï¼Œç”¨äºå®ç°å„ç§åŒæ­¥å™¨ï¼Œä¾‹å¦‚ **å¯é‡å…¥é”**ï¼ˆ`ReentrantLock`ï¼‰ã€**ä¿¡å·é‡**ï¼ˆ`Semaphore`ï¼‰å’Œ **å€’è®¡æ—¶å™¨**ï¼ˆ`CountDownLatch`ï¼‰ã€‚é€šè¿‡å°è£…åº•å±‚çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶ï¼ŒAQS å°†å¤æ‚çš„çº¿ç¨‹ç®¡ç†é€»è¾‘éšè—èµ·æ¥ï¼Œä½¿å¼€å‘è€…åªéœ€ä¸“æ³¨äºå…·ä½“çš„åŒæ­¥é€»è¾‘ã€‚

ç®€å•æ¥è¯´ï¼ŒAQS æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸ºåŒæ­¥å™¨æä¾›äº†é€šç”¨çš„ **æ‰§è¡Œæ¡†æ¶**ã€‚å®ƒå®šä¹‰äº† **èµ„æºè·å–å’Œé‡Šæ”¾çš„é€šç”¨æµç¨‹**ï¼Œè€Œå…·ä½“çš„èµ„æºè·å–é€»è¾‘åˆ™ç”±å…·ä½“åŒæ­¥å™¨é€šè¿‡é‡å†™æ¨¡æ¿æ–¹æ³•æ¥å®ç°ã€‚ å› æ­¤ï¼Œå¯ä»¥å°† AQS çœ‹ä½œæ˜¯åŒæ­¥å™¨çš„ **åŸºç¡€â€œåº•åº§â€**ï¼Œè€ŒåŒæ­¥å™¨åˆ™æ˜¯åŸºäº AQS å®ç°çš„ **å…·ä½“â€œåº”ç”¨â€**ã€‚

### â­ï¸AQS çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

AQS æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶ AQS æ˜¯åŸºäº **CLH é”** ï¼ˆCraig, Landin, and Hagersten locksï¼‰ è¿›ä¸€æ­¥ä¼˜åŒ–å®ç°çš„ã€‚

**CLH é”** å¯¹è‡ªæ—‹é”è¿›è¡Œäº†æ”¹è¿›ï¼Œæ˜¯åŸºäºå•é“¾è¡¨çš„è‡ªæ—‹é”ã€‚åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼Œä¼šå°†è¯·æ±‚è·å–é”çš„çº¿ç¨‹ç»„ç»‡æˆä¸€ä¸ªå•å‘é˜Ÿåˆ—ï¼Œæ¯ä¸ªç­‰å¾…çš„çº¿ç¨‹ä¼šé€šè¿‡è‡ªæ—‹è®¿é—®å‰ä¸€ä¸ªçº¿ç¨‹èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå‰ä¸€ä¸ªèŠ‚ç‚¹é‡Šæ”¾é”ä¹‹åï¼Œå½“å‰èŠ‚ç‚¹æ‰å¯ä»¥è·å–é”ã€‚**CLH é”** çš„é˜Ÿåˆ—ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![CLH é”çš„é˜Ÿåˆ—ç»“æ„](https://oss.javaguide.cn/github/javaguide/open-source-project/clh-lock-queue-structure.png)

AQS ä¸­ä½¿ç”¨çš„ **ç­‰å¾…é˜Ÿåˆ—** æ˜¯ CLH é”é˜Ÿåˆ—çš„å˜ä½“ï¼ˆæ¥ä¸‹æ¥ç®€ç§°ä¸º CLH å˜ä½“é˜Ÿåˆ—ï¼‰ã€‚

AQS çš„ CLH å˜ä½“é˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘é˜Ÿåˆ—ï¼Œä¼šæš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹å°†è¢«åŠ å…¥åˆ°è¯¥é˜Ÿåˆ—ä¸­ï¼ŒCLH å˜ä½“é˜Ÿåˆ—å’ŒåŸæœ¬çš„ CLH é”é˜Ÿåˆ—çš„åŒºåˆ«ä¸»è¦æœ‰ä¸¤ç‚¹ï¼š

- ç”± **è‡ªæ—‹** ä¼˜åŒ–ä¸º **è‡ªæ—‹ + é˜»å¡** ï¼šè‡ªæ—‹æ“ä½œçš„æ€§èƒ½å¾ˆé«˜ï¼Œä½†å¤§é‡çš„è‡ªæ—‹æ“ä½œæ¯”è¾ƒå ç”¨ CPU èµ„æºï¼Œå› æ­¤åœ¨ CLH å˜ä½“é˜Ÿåˆ—ä¸­ä¼šå…ˆé€šè¿‡è‡ªæ—‹å°è¯•è·å–é”ï¼Œå¦‚æœå¤±è´¥å†è¿›è¡Œé˜»å¡ç­‰å¾…ã€‚
- ç”± **å•å‘é˜Ÿåˆ—** ä¼˜åŒ–ä¸º **åŒå‘é˜Ÿåˆ—** ï¼šåœ¨ CLH å˜ä½“é˜Ÿåˆ—ä¸­ï¼Œä¼šå¯¹ç­‰å¾…çš„çº¿ç¨‹è¿›è¡Œé˜»å¡æ“ä½œï¼Œå½“é˜Ÿåˆ—å‰è¾¹çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åï¼Œéœ€è¦å¯¹åè¾¹çš„çº¿ç¨‹è¿›è¡Œå”¤é†’ï¼Œå› æ­¤å¢åŠ äº† `next` æŒ‡é’ˆï¼Œæˆä¸ºäº†åŒå‘é˜Ÿåˆ—ã€‚

AQS å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª CLH å˜ä½“é˜Ÿåˆ—çš„ä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰æ¥å®ç°é”çš„åˆ†é…ã€‚åœ¨ CLH å˜ä½“é˜Ÿåˆ—ä¸­ï¼Œä¸€ä¸ªèŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒä¿å­˜ç€çº¿ç¨‹çš„å¼•ç”¨ï¼ˆthreadï¼‰ã€ å½“å‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€ï¼ˆwaitStatusï¼‰ã€å‰é©±èŠ‚ç‚¹ï¼ˆprevï¼‰ã€åç»§èŠ‚ç‚¹ï¼ˆnextï¼‰ã€‚

AQS ä¸­çš„ CLH å˜ä½“é˜Ÿåˆ—ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![CLH å˜ä½“é˜Ÿåˆ—ç»“æ„](https://oss.javaguide.cn/github/javaguide/java/concurrent/clh-queue-structure-bianti.png)

AQS(`AbstractQueuedSynchronizer`)çš„æ ¸å¿ƒåŸç†å›¾ï¼š

![CLH å˜ä½“é˜Ÿåˆ—](https://oss.javaguide.cn/github/javaguide/java/concurrent/clh-queue-state.png)

AQS ä½¿ç”¨ **int æˆå‘˜å˜é‡ `state` è¡¨ç¤ºåŒæ­¥çŠ¶æ€**ï¼Œé€šè¿‡å†…ç½®çš„ **çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—** æ¥å®Œæˆè·å–èµ„æºçº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚

`state` å˜é‡ç”± `volatile` ä¿®é¥°ï¼Œç”¨äºå±•ç¤ºå½“å‰ä¸´ç•Œèµ„æºçš„è·é”æƒ…å†µã€‚

```java
// å…±äº«å˜é‡ï¼Œä½¿ç”¨volatileä¿®é¥°ä¿è¯çº¿ç¨‹å¯è§æ€§
private volatile int state;
```

å¦å¤–ï¼ŒçŠ¶æ€ä¿¡æ¯ `state` å¯ä»¥é€šè¿‡ `protected` ç±»å‹çš„`getState()`ã€`setState()`å’Œ`compareAndSetState()` è¿›è¡Œæ“ä½œã€‚å¹¶ä¸”ï¼Œè¿™å‡ ä¸ªæ–¹æ³•éƒ½æ˜¯ `final` ä¿®é¥°çš„ï¼Œåœ¨å­ç±»ä¸­æ— æ³•è¢«é‡å†™ã€‚

```java
//è¿”å›åŒæ­¥çŠ¶æ€çš„å½“å‰å€¼
protected final int getState() {
     return state;
}
 // è®¾ç½®åŒæ­¥çŠ¶æ€çš„å€¼
protected final void setState(int newState) {
     state = newState;
}
//åŸå­åœ°ï¼ˆCASæ“ä½œï¼‰å°†åŒæ­¥çŠ¶æ€å€¼è®¾ç½®ä¸ºç»™å®šå€¼updateå¦‚æœå½“å‰åŒæ­¥çŠ¶æ€çš„å€¼ç­‰äºexpectï¼ˆæœŸæœ›å€¼ï¼‰
protected final boolean compareAndSetState(int expect, int update) {
      return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
}
```

ä»¥ `ReentrantLock` ä¸ºä¾‹ï¼Œ`state` åˆå§‹å€¼ä¸º 0ï¼Œè¡¨ç¤ºæœªé”å®šçŠ¶æ€ã€‚A çº¿ç¨‹ `lock()` æ—¶ï¼Œä¼šè°ƒç”¨ `tryAcquire()` ç‹¬å è¯¥é”å¹¶å°† `state+1` ã€‚æ­¤åï¼Œå…¶ä»–çº¿ç¨‹å† `tryAcquire()` æ—¶å°±ä¼šå¤±è´¥ï¼Œç›´åˆ° A çº¿ç¨‹ `unlock()` åˆ° `state=`0ï¼ˆå³é‡Šæ”¾é”ï¼‰ä¸ºæ­¢ï¼Œå…¶å®ƒçº¿ç¨‹æ‰æœ‰æœºä¼šè·å–è¯¥é”ã€‚å½“ç„¶ï¼Œé‡Šæ”¾é”ä¹‹å‰ï¼ŒA çº¿ç¨‹è‡ªå·±æ˜¯å¯ä»¥é‡å¤è·å–æ­¤é”çš„ï¼ˆ`state` ä¼šç´¯åŠ ï¼‰ï¼Œè¿™å°±æ˜¯å¯é‡å…¥çš„æ¦‚å¿µã€‚ä½†è¦æ³¨æ„ï¼Œè·å–å¤šå°‘æ¬¡å°±è¦é‡Šæ”¾å¤šå°‘æ¬¡ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ state æ˜¯èƒ½å›åˆ°é›¶æ€çš„ã€‚

å†ä»¥ `CountDownLatch` ä»¥ä¾‹ï¼Œä»»åŠ¡åˆ†ä¸º N ä¸ªå­çº¿ç¨‹å»æ‰§è¡Œï¼Œ`state` ä¹Ÿåˆå§‹åŒ–ä¸º Nï¼ˆæ³¨æ„ N è¦ä¸çº¿ç¨‹ä¸ªæ•°ä¸€è‡´ï¼‰ã€‚è¿™ N ä¸ªå­çº¿ç¨‹æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œæ¯ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®Œå`countDown()` ä¸€æ¬¡ï¼Œstate ä¼š CAS(Compare and Swap) å‡ 1ã€‚ç­‰åˆ°æ‰€æœ‰å­çº¿ç¨‹éƒ½æ‰§è¡Œå®Œå(å³ `state=0` )ï¼Œä¼š `unpark()` ä¸»è°ƒç”¨çº¿ç¨‹ï¼Œç„¶åä¸»è°ƒç”¨çº¿ç¨‹å°±ä¼šä» `await()` å‡½æ•°è¿”å›ï¼Œç»§ç»­åç»­åŠ¨ä½œã€‚

### Semaphore æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`synchronized` å’Œ `ReentrantLock` éƒ½æ˜¯ä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªèµ„æºï¼Œè€Œ`Semaphore`(ä¿¡å·é‡)å¯ä»¥ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚

Semaphore çš„ä½¿ç”¨ç®€å•ï¼Œæˆ‘ä»¬è¿™é‡Œå‡è®¾æœ‰ N(N>5) ä¸ªçº¿ç¨‹æ¥è·å– `Semaphore` ä¸­çš„å…±äº«èµ„æºï¼Œä¸‹é¢çš„ä»£ç è¡¨ç¤ºåŒä¸€æ—¶åˆ» N ä¸ªçº¿ç¨‹ä¸­åªæœ‰ 5 ä¸ªçº¿ç¨‹èƒ½è·å–åˆ°å…±äº«èµ„æºï¼Œå…¶ä»–çº¿ç¨‹éƒ½ä¼šé˜»å¡ï¼Œåªæœ‰è·å–åˆ°å…±äº«èµ„æºçš„çº¿ç¨‹æ‰èƒ½æ‰§è¡Œã€‚ç­‰åˆ°æœ‰çº¿ç¨‹é‡Šæ”¾äº†å…±äº«èµ„æºï¼Œå…¶ä»–é˜»å¡çš„çº¿ç¨‹æ‰èƒ½è·å–åˆ°ã€‚

```java
// åˆå§‹å…±äº«èµ„æºæ•°é‡
final Semaphore semaphore = new Semaphore(5);
// è·å–1ä¸ªè®¸å¯
semaphore.acquire();
// é‡Šæ”¾1ä¸ªè®¸å¯
semaphore.release();
```

å½“åˆå§‹çš„èµ„æºä¸ªæ•°ä¸º 1 çš„æ—¶å€™ï¼Œ`Semaphore` é€€åŒ–ä¸ºæ’ä»–é”ã€‚

`Semaphore` æœ‰ä¸¤ç§æ¨¡å¼ï¼šã€‚

- **å…¬å¹³æ¨¡å¼ï¼š** è°ƒç”¨ `acquire()` æ–¹æ³•çš„é¡ºåºå°±æ˜¯è·å–è®¸å¯è¯çš„é¡ºåºï¼Œéµå¾ª FIFOï¼›
- **éå…¬å¹³æ¨¡å¼ï¼š** æŠ¢å å¼çš„ã€‚

`Semaphore` å¯¹åº”çš„ä¸¤ä¸ªæ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š

```java
public Semaphore(int permits) {
    sync = new NonfairSync(permits);
}

public Semaphore(int permits, boolean fair) {
    sync = fair ? new FairSync(permits) : new NonfairSync(permits);
}
```

**è¿™ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œéƒ½å¿…é¡»æä¾›è®¸å¯çš„æ•°é‡ï¼Œç¬¬äºŒä¸ªæ„é€ æ–¹æ³•å¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³æ¨¡å¼è¿˜æ˜¯éå…¬å¹³æ¨¡å¼ï¼Œé»˜è®¤éå…¬å¹³æ¨¡å¼ã€‚**

`Semaphore` é€šå¸¸ç”¨äºé‚£äº›èµ„æºæœ‰æ˜ç¡®è®¿é—®æ•°é‡é™åˆ¶çš„åœºæ™¯æ¯”å¦‚é™æµï¼ˆä»…é™äºå•æœºæ¨¡å¼ï¼Œå®é™…é¡¹ç›®ä¸­æ¨èä½¿ç”¨ Redis +Lua æ¥åšé™æµï¼‰ã€‚

### Semaphore çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

`Semaphore` æ˜¯å…±äº«é”çš„ä¸€ç§å®ç°ï¼Œå®ƒé»˜è®¤æ„é€  AQS çš„ `state` å€¼ä¸º `permits`ï¼Œä½ å¯ä»¥å°† `permits` çš„å€¼ç†è§£ä¸ºè®¸å¯è¯çš„æ•°é‡ï¼Œåªæœ‰æ‹¿åˆ°è®¸å¯è¯çš„çº¿ç¨‹æ‰èƒ½æ‰§è¡Œã€‚

è°ƒç”¨`semaphore.acquire()` ï¼Œçº¿ç¨‹å°è¯•è·å–è®¸å¯è¯ï¼Œå¦‚æœ `state >= 0` çš„è¯ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥è·å–æˆåŠŸã€‚å¦‚æœè·å–æˆåŠŸçš„è¯ï¼Œä½¿ç”¨ CAS æ“ä½œå»ä¿®æ”¹ `state` çš„å€¼ `state=state-1`ã€‚å¦‚æœ `state<0` çš„è¯ï¼Œåˆ™è¡¨ç¤ºè®¸å¯è¯æ•°é‡ä¸è¶³ã€‚æ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ª Node èŠ‚ç‚¹åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·å½“å‰çº¿ç¨‹ã€‚

```java
/**
 *  è·å–1ä¸ªè®¸å¯è¯
 */
public void acquire() throws InterruptedException {
    sync.acquireSharedInterruptibly(1);
}
/**
 * å…±äº«æ¨¡å¼ä¸‹è·å–è®¸å¯è¯ï¼Œè·å–æˆåŠŸåˆ™è¿”å›ï¼Œå¤±è´¥åˆ™åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·çº¿ç¨‹
 */
public final void acquireSharedInterruptibly(int arg)
    throws InterruptedException {
    if (Thread.interrupted())
      throw new InterruptedException();
        // å°è¯•è·å–è®¸å¯è¯ï¼Œargä¸ºè·å–è®¸å¯è¯ä¸ªæ•°ï¼Œå½“å¯ç”¨è®¸å¯è¯æ•°å‡å½“å‰è·å–çš„è®¸å¯è¯æ•°ç»“æœå°äº0,åˆ™åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·å½“å‰çº¿ç¨‹ã€‚
    if (tryAcquireShared(arg) < 0)
      doAcquireSharedInterruptibly(arg);
}
```

è°ƒç”¨`semaphore.release();` ï¼Œçº¿ç¨‹å°è¯•é‡Šæ”¾è®¸å¯è¯ï¼Œå¹¶ä½¿ç”¨ CAS æ“ä½œå»ä¿®æ”¹ `state` çš„å€¼ `state=state+1`ã€‚é‡Šæ”¾è®¸å¯è¯æˆåŠŸä¹‹åï¼ŒåŒæ—¶ä¼šå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ã€‚è¢«å”¤é†’çš„çº¿ç¨‹ä¼šé‡æ–°å°è¯•å»ä¿®æ”¹ `state` çš„å€¼ `state=state-1` ï¼Œå¦‚æœ `state>=0` åˆ™è·å–ä»¤ç‰ŒæˆåŠŸï¼Œå¦åˆ™é‡æ–°è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·çº¿ç¨‹ã€‚

```java
// é‡Šæ”¾ä¸€ä¸ªè®¸å¯è¯
public void release() {
    sync.releaseShared(1);
}

// é‡Šæ”¾å…±äº«é”ï¼ŒåŒæ—¶ä¼šå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ã€‚
public final boolean releaseShared(int arg) {
    //é‡Šæ”¾å…±äº«é”
    if (tryReleaseShared(arg)) {
      //å”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹
      doReleaseShared();
      return true;
    }
    return false;
}
```

### CountDownLatch æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`CountDownLatch` å…è®¸ `count` ä¸ªçº¿ç¨‹é˜»å¡åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œç›´è‡³æ‰€æœ‰çº¿ç¨‹çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ã€‚

`CountDownLatch` æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè®¡æ•°å™¨çš„å€¼åªèƒ½åœ¨æ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¹‹åæ²¡æœ‰ä»»ä½•æœºåˆ¶å†æ¬¡å¯¹å…¶è®¾ç½®å€¼ï¼Œå½“ `CountDownLatch` ä½¿ç”¨å®Œæ¯•åï¼Œå®ƒä¸èƒ½å†æ¬¡è¢«ä½¿ç”¨ã€‚

### CountDownLatch çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

`CountDownLatch` æ˜¯å…±äº«é”çš„ä¸€ç§å®ç°,å®ƒé»˜è®¤æ„é€  AQS çš„ `state` å€¼ä¸º `count`ã€‚å½“çº¿ç¨‹ä½¿ç”¨ `countDown()` æ–¹æ³•æ—¶,å…¶å®ä½¿ç”¨äº†`tryReleaseShared`æ–¹æ³•ä»¥ CAS çš„æ“ä½œæ¥å‡å°‘ `state`,ç›´è‡³ `state` ä¸º 0 ã€‚å½“è°ƒç”¨ `await()` æ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœ `state` ä¸ä¸º 0ï¼Œé‚£å°±è¯æ˜ä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œ`await()` æ–¹æ³•å°±ä¼šä¸€ç›´é˜»å¡ï¼Œä¹Ÿå°±æ˜¯è¯´ `await()` æ–¹æ³•ä¹‹åçš„è¯­å¥ä¸ä¼šè¢«æ‰§è¡Œã€‚ç›´åˆ°`count` ä¸ªçº¿ç¨‹è°ƒç”¨äº†`countDown()`ä½¿ state å€¼è¢«å‡ä¸º 0ï¼Œæˆ–è€…è°ƒç”¨`await()`çš„çº¿ç¨‹è¢«ä¸­æ–­ï¼Œè¯¥çº¿ç¨‹æ‰ä¼šä»é˜»å¡ä¸­è¢«å”¤é†’ï¼Œ`await()` æ–¹æ³•ä¹‹åçš„è¯­å¥å¾—åˆ°æ‰§è¡Œã€‚

### ç”¨è¿‡ CountDownLatch ä¹ˆï¼Ÿä»€ä¹ˆåœºæ™¯ä¸‹ç”¨çš„ï¼Ÿ

`CountDownLatch` çš„ä½œç”¨å°±æ˜¯ å…è®¸ count ä¸ªçº¿ç¨‹é˜»å¡åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œç›´è‡³æ‰€æœ‰çº¿ç¨‹çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ã€‚ä¹‹å‰åœ¨é¡¹ç›®ä¸­ï¼Œæœ‰ä¸€ä¸ªä½¿ç”¨å¤šçº¿ç¨‹è¯»å–å¤šä¸ªæ–‡ä»¶å¤„ç†çš„åœºæ™¯ï¼Œæˆ‘ç”¨åˆ°äº† `CountDownLatch` ã€‚å…·ä½“åœºæ™¯æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

æˆ‘ä»¬è¦è¯»å–å¤„ç† 6 ä¸ªæ–‡ä»¶ï¼Œè¿™ 6 ä¸ªä»»åŠ¡éƒ½æ˜¯æ²¡æœ‰æ‰§è¡Œé¡ºåºä¾èµ–çš„ä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è¿”å›ç»™ç”¨æˆ·çš„æ—¶å€™å°†è¿™å‡ ä¸ªæ–‡ä»¶çš„å¤„ç†çš„ç»“æœè¿›è¡Œç»Ÿè®¡æ•´ç†ã€‚

ä¸ºæ­¤æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªçº¿ç¨‹æ± å’Œ count ä¸º 6 çš„`CountDownLatch`å¯¹è±¡ ã€‚ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†è¯»å–ä»»åŠ¡ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¤„ç†å®Œä¹‹åå°±å°† count-1ï¼Œè°ƒç”¨`CountDownLatch`å¯¹è±¡çš„ `await()`æ–¹æ³•ï¼Œç›´åˆ°æ‰€æœ‰æ–‡ä»¶è¯»å–å®Œä¹‹åï¼Œæ‰ä¼šæ¥ç€æ‰§è¡Œåé¢çš„é€»è¾‘ã€‚

ä¼ªä»£ç æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

```java
public class CountDownLatchExample1 {
    // å¤„ç†æ–‡ä»¶çš„æ•°é‡
    private static final int threadCount = 6;

    public static void main(String[] args) throws InterruptedException {
        // åˆ›å»ºä¸€ä¸ªå…·æœ‰å›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± å¯¹è±¡ï¼ˆæ¨èä½¿ç”¨æ„é€ æ–¹æ³•åˆ›å»ºï¼‰
        ExecutorService threadPool = Executors.newFixedThreadPool(10);
        final CountDownLatch countDownLatch = new CountDownLatch(threadCount);
        for (int i = 0; i < threadCount; i++) {
            final int threadnum = i;
            threadPool.execute(() -> {
                try {
                    //å¤„ç†æ–‡ä»¶çš„ä¸šåŠ¡æ“ä½œ
                    //......
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } finally {
                    //è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶å·²ç»è¢«å®Œæˆ
                    countDownLatch.countDown();
                }

            });
        }
        countDownLatch.await();
        threadPool.shutdown();
        System.out.println("finish");
    }
}
```

**æœ‰æ²¡æœ‰å¯ä»¥æ”¹è¿›çš„åœ°æ–¹å‘¢ï¼Ÿ**

å¯ä»¥ä½¿ç”¨ `CompletableFuture` ç±»æ¥æ”¹è¿›ï¼Java8 çš„ `CompletableFuture` æä¾›äº†å¾ˆå¤šå¯¹å¤šçº¿ç¨‹å‹å¥½çš„æ–¹æ³•ï¼Œä½¿ç”¨å®ƒå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä¸ºæˆ‘ä»¬ç¼–å†™å¤šçº¿ç¨‹ç¨‹åºï¼Œä»€ä¹ˆå¼‚æ­¥ã€ä¸²è¡Œã€å¹¶è¡Œæˆ–è€…ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡ä»€ä¹ˆçš„éƒ½éå¸¸æ–¹ä¾¿ã€‚

```java
CompletableFuture<Void> task1 =
    CompletableFuture.supplyAsync(()->{
        //è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ
    });
......
CompletableFuture<Void> task6 =
    CompletableFuture.supplyAsync(()->{
    //è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ
    });
......
CompletableFuture<Void> headerFuture=CompletableFuture.allOf(task1,.....,task6);

try {
    headerFuture.join();
} catch (Exception ex) {
    //......
}
System.out.println("all done. ");
```

ä¸Šé¢çš„ä»£ç è¿˜å¯ä»¥ç»§ç»­ä¼˜åŒ–ï¼Œå½“ä»»åŠ¡è¿‡å¤šçš„æ—¶å€™ï¼ŒæŠŠæ¯ä¸€ä¸ª task éƒ½åˆ—å‡ºæ¥ä¸å¤ªç°å®ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡å¾ªç¯æ¥æ·»åŠ ä»»åŠ¡ã€‚

```java
//æ–‡ä»¶å¤¹ä½ç½®
List<String> filePaths = Arrays.asList(...)
// å¼‚æ­¥å¤„ç†æ‰€æœ‰æ–‡ä»¶
List<CompletableFuture<String>> fileFutures = filePaths.stream()
    .map(filePath -> doSomeThing(filePath))
    .collect(Collectors.toList());
// å°†ä»–ä»¬åˆå¹¶èµ·æ¥
CompletableFuture<Void> allFutures = CompletableFuture.allOf(
    fileFutures.toArray(new CompletableFuture[fileFutures.size()])
);
```

### CyclicBarrier æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`CyclicBarrier` å’Œ `CountDownLatch` éå¸¸ç±»ä¼¼ï¼Œå®ƒä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹é—´çš„æŠ€æœ¯ç­‰å¾…ï¼Œä½†æ˜¯å®ƒçš„åŠŸèƒ½æ¯” `CountDownLatch` æ›´åŠ å¤æ‚å’Œå¼ºå¤§ã€‚ä¸»è¦åº”ç”¨åœºæ™¯å’Œ `CountDownLatch` ç±»ä¼¼ã€‚

> `CountDownLatch` çš„å®ç°æ˜¯åŸºäº AQS çš„ï¼Œè€Œ `CyclicBarrier` æ˜¯åŸºäº `ReentrantLock`(`ReentrantLock` ä¹Ÿå±äº AQS åŒæ­¥å™¨)å’Œ `Condition` çš„ã€‚

`CyclicBarrier` çš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ä½¿ç”¨ï¼ˆCyclicï¼‰çš„å±éšœï¼ˆBarrierï¼‰ã€‚å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼šè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ã€‚

### CyclicBarrier çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

`CyclicBarrier` å†…éƒ¨é€šè¿‡ä¸€ä¸ª `count` å˜é‡ä½œä¸ºè®¡æ•°å™¨ï¼Œ`count` çš„åˆå§‹å€¼ä¸º `parties` å±æ€§çš„åˆå§‹åŒ–å€¼ï¼Œæ¯å½“ä¸€ä¸ªçº¿ç¨‹åˆ°äº†æ …æ è¿™é‡Œäº†ï¼Œé‚£ä¹ˆå°±å°†è®¡æ•°å™¨å‡ 1ã€‚å¦‚æœ count å€¼ä¸º 0 äº†ï¼Œè¡¨ç¤ºè¿™æ˜¯è¿™ä¸€ä»£æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾æ …æ ï¼Œå°±å°è¯•æ‰§è¡Œæˆ‘ä»¬æ„é€ æ–¹æ³•ä¸­è¾“å…¥çš„ä»»åŠ¡ã€‚

```java
//æ¯æ¬¡æ‹¦æˆªçš„çº¿ç¨‹æ•°
private final int parties;
//è®¡æ•°å™¨
private int count;
```

ä¸‹é¢æˆ‘ä»¬ç»“åˆæºç æ¥ç®€å•çœ‹çœ‹ã€‚

1ã€`CyclicBarrier` é»˜è®¤çš„æ„é€ æ–¹æ³•æ˜¯ `CyclicBarrier(int parties)`ï¼Œå…¶å‚æ•°è¡¨ç¤ºå±éšœæ‹¦æˆªçš„çº¿ç¨‹æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨ `await()` æ–¹æ³•å‘Šè¯‰ `CyclicBarrier` æˆ‘å·²ç»åˆ°è¾¾äº†å±éšœï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚

```java
public CyclicBarrier(int parties) {
    this(parties, null);
}

public CyclicBarrier(int parties, Runnable barrierAction) {
    if (parties <= 0) throw new IllegalArgumentException();
    this.parties = parties;
    this.count = parties;
    this.barrierCommand = barrierAction;
}
```

å…¶ä¸­ï¼Œ`parties` å°±ä»£è¡¨äº†æœ‰æ‹¦æˆªçš„çº¿ç¨‹çš„æ•°é‡ï¼Œå½“æ‹¦æˆªçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°è¿™ä¸ªå€¼çš„æ—¶å€™å°±æ‰“å¼€æ …æ ï¼Œè®©æ‰€æœ‰çº¿ç¨‹é€šè¿‡ã€‚

2ã€å½“è°ƒç”¨ `CyclicBarrier` å¯¹è±¡è°ƒç”¨ `await()` æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯ `dowait(false, 0L)`æ–¹æ³•ã€‚ `await()` æ–¹æ³•å°±åƒæ ‘ç«‹èµ·ä¸€ä¸ªæ …æ çš„è¡Œä¸ºä¸€æ ·ï¼Œå°†çº¿ç¨‹æŒ¡ä½äº†ï¼Œå½“æ‹¦ä½çš„çº¿ç¨‹æ•°é‡è¾¾åˆ° `parties` çš„å€¼æ—¶ï¼Œæ …æ æ‰ä¼šæ‰“å¼€ï¼Œçº¿ç¨‹æ‰å¾—ä»¥é€šè¿‡æ‰§è¡Œã€‚

```java
public int await() throws InterruptedException, BrokenBarrierException {
  try {
      return dowait(false, 0L);
  } catch (TimeoutException toe) {
      throw new Error(toe); // cannot happen
  }
}
```

`dowait(false, 0L)`æ–¹æ³•æºç åˆ†æå¦‚ä¸‹ï¼š

```java
    // å½“çº¿ç¨‹æ•°é‡æˆ–è€…è¯·æ±‚æ•°é‡è¾¾åˆ° count æ—¶ await ä¹‹åçš„æ–¹æ³•æ‰ä¼šè¢«æ‰§è¡Œã€‚ä¸Šé¢çš„ç¤ºä¾‹ä¸­ count çš„å€¼å°±ä¸º 5ã€‚
    private int count;
    /**
     * Main barrier code, covering the various policies.
     */
    private int dowait(boolean timed, long nanos)
        throws InterruptedException, BrokenBarrierException,
               TimeoutException {
        final ReentrantLock lock = this.lock;
        // é”ä½
        lock.lock();
        try {
            final Generation g = generation;

            if (g.broken)
                throw new BrokenBarrierException();

            // å¦‚æœçº¿ç¨‹ä¸­æ–­äº†ï¼ŒæŠ›å‡ºå¼‚å¸¸
            if (Thread.interrupted()) {
                breakBarrier();
                throw new InterruptedException();
            }
            // coutå‡1
            int index = --count;
            // å½“ count æ•°é‡å‡ä¸º 0 ä¹‹åè¯´æ˜æœ€åä¸€ä¸ªçº¿ç¨‹å·²ç»åˆ°è¾¾æ …æ äº†ï¼Œä¹Ÿå°±æ˜¯è¾¾åˆ°äº†å¯ä»¥æ‰§è¡Œawait æ–¹æ³•ä¹‹åçš„æ¡ä»¶
            if (index == 0) {  // tripped
                boolean ranAction = false;
                try {
                    final Runnable command = barrierCommand;
                    if (command != null)
                        command.run();
                    ranAction = true;
                    // å°† count é‡ç½®ä¸º parties å±æ€§çš„åˆå§‹åŒ–å€¼
                    // å”¤é†’ä¹‹å‰ç­‰å¾…çš„çº¿ç¨‹
                    // ä¸‹ä¸€æ³¢æ‰§è¡Œå¼€å§‹
                    nextGeneration();
                    return 0;
                } finally {
                    if (!ranAction)
                        breakBarrier();
                }
            }

            // loop until tripped, broken, interrupted, or timed out
            for (;;) {
                try {
                    if (!timed)
                        trip.await();
                    else if (nanos > 0L)
                        nanos = trip.awaitNanos(nanos);
                } catch (InterruptedException ie) {
                    if (g == generation && ! g.broken) {
                        breakBarrier();
                        throw ie;
                    } else {
                        // We're about to finish waiting even if we had not
                        // been interrupted, so this interrupt is deemed to
                        // "belong" to subsequent execution.
                        Thread.currentThread().interrupt();
                    }
                }

                if (g.broken)
                    throw new BrokenBarrierException();

                if (g != generation)
                    return index;

                if (timed && nanos <= 0L) {
                    breakBarrier();
                    throw new TimeoutException();
                }
            }
        } finally {
            lock.unlock();
        }
    }
```

## è™šæ‹Ÿçº¿ç¨‹

è™šæ‹Ÿçº¿ç¨‹åœ¨ Java 21 æ­£å¼å‘å¸ƒï¼Œè¿™æ˜¯ä¸€é¡¹é‡é‡çº§çš„æ›´æ–°ã€‚è™½ç„¶ç›®å‰é¢è¯•ä¸­é—®çš„ä¸å¤šï¼Œä½†è¿˜æ˜¯å»ºè®®å¤§å®¶å»ç®€å•äº†è§£ä¸€ä¸‹ã€‚æˆ‘å†™äº†ä¸€ç¯‡æ–‡ç« æ¥æ€»ç»“è™šæ‹Ÿçº¿ç¨‹å¸¸è§çš„é—®é¢˜ï¼š[è™šæ‹Ÿçº¿ç¨‹å¸¸è§é—®é¢˜æ€»ç»“](https://javaguide.cn/java/concurrent/virtual-thread.html)ï¼ŒåŒ…å«ä¸‹é¢è¿™äº›é—®é¢˜ï¼š

1. ä»€ä¹ˆæ˜¯è™šæ‹Ÿçº¿ç¨‹ï¼Ÿ
2. è™šæ‹Ÿçº¿ç¨‹å’Œå¹³å°çº¿ç¨‹æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ
3. è™šæ‹Ÿçº¿ç¨‹æœ‰ä»€ä¹ˆä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Ÿ
4. å¦‚ä½•åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ï¼Ÿ
5. è™šæ‹Ÿçº¿ç¨‹çš„åº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ
