------



## 2.3. å¤šçº¿ç¨‹

> [JavaGuide](https://javaguide.cn/) ï¼šã€ŒJavaå­¦ä¹ +é¢è¯•æŒ‡å—ã€ä¸€ä»½æ¶µç›–å¤§éƒ¨åˆ† Java ç¨‹åºå‘˜æ‰€éœ€è¦æŒæ¡çš„æ ¸å¿ƒçŸ¥è¯†ã€‚å‡†å¤‡ Java é¢è¯•ï¼Œé¦–é€‰ JavaGuideï¼
>
> è¿™éƒ¨åˆ†å†…å®¹æ‘˜è‡ª [JavaGuide](https://javaguide.cn/) ä¸‹é¢å‡ ç¯‡æ–‡ç« ï¼š
>
> - [Java å¹¶å‘å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸Šï¼‰](https://javaguide.cn/java/concurrent/java-concurrent-questions-01.html)
> - [Java å¹¶å‘å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸­ï¼‰](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html)
> - [Java å¹¶å‘å¸¸è§é¢è¯•é¢˜æ€»ç»“ï¼ˆä¸‹ï¼‰](https://javaguide.cn/java/concurrent/java-concurrent-questions-03.html)

### ä»€ä¹ˆæ˜¯çº¿ç¨‹å’Œè¿›ç¨‹?

#### ä½•ä¸ºè¿›ç¨‹?

è¿›ç¨‹æ˜¯ç¨‹åºçš„ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ï¼Œæ˜¯ç³»ç»Ÿè¿è¡Œç¨‹åºçš„åŸºæœ¬å•ä½ï¼Œå› æ­¤è¿›ç¨‹æ˜¯åŠ¨æ€çš„ã€‚ç³»ç»Ÿè¿è¡Œä¸€ä¸ªç¨‹åºå³æ˜¯ä¸€ä¸ªè¿›ç¨‹ä»åˆ›å»ºï¼Œè¿è¡Œåˆ°æ¶ˆäº¡çš„è¿‡ç¨‹ã€‚

åœ¨ Java ä¸­ï¼Œå½“æˆ‘ä»¬å¯åŠ¨ main å‡½æ•°æ—¶å…¶å®å°±æ˜¯å¯åŠ¨äº†ä¸€ä¸ª JVM çš„è¿›ç¨‹ï¼Œè€Œ main å‡½æ•°æ‰€åœ¨çš„çº¿ç¨‹å°±æ˜¯è¿™ä¸ªè¿›ç¨‹ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿç§°ä¸»çº¿ç¨‹ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨ Windows ä¸­é€šè¿‡æŸ¥çœ‹ä»»åŠ¡ç®¡ç†å™¨çš„æ–¹å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¸…æ¥šçœ‹åˆ° Windows å½“å‰è¿è¡Œçš„è¿›ç¨‹ï¼ˆ`.exe` æ–‡ä»¶çš„è¿è¡Œï¼‰ã€‚

![è¿›ç¨‹ç¤ºä¾‹å›¾ç‰‡-Windows](https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/è¿›ç¨‹ç¤ºä¾‹å›¾ç‰‡-Windows.png)

#### ä½•ä¸ºçº¿ç¨‹?

çº¿ç¨‹ä¸è¿›ç¨‹ç›¸ä¼¼ï¼Œä½†çº¿ç¨‹æ˜¯ä¸€ä¸ªæ¯”è¿›ç¨‹æ›´å°çš„æ‰§è¡Œå•ä½ã€‚ä¸€ä¸ªè¿›ç¨‹åœ¨å…¶æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å¯ä»¥äº§ç”Ÿå¤šä¸ªçº¿ç¨‹ã€‚ä¸è¿›ç¨‹ä¸åŒçš„æ˜¯åŒç±»çš„å¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„**å †**å’Œ**æ–¹æ³•åŒº**èµ„æºï¼Œä½†æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„**ç¨‹åºè®¡æ•°å™¨**ã€**è™šæ‹Ÿæœºæ ˆ**å’Œ**æœ¬åœ°æ–¹æ³•æ ˆ**ï¼Œæ‰€ä»¥ç³»ç»Ÿåœ¨äº§ç”Ÿä¸€ä¸ªçº¿ç¨‹ï¼Œæˆ–æ˜¯åœ¨å„ä¸ªçº¿ç¨‹ä¹‹é—´ä½œåˆ‡æ¢å·¥ä½œæ—¶ï¼Œè´Ÿæ‹…è¦æ¯”è¿›ç¨‹å°å¾—å¤šï¼Œä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼Œçº¿ç¨‹ä¹Ÿè¢«ç§°ä¸ºè½»é‡çº§è¿›ç¨‹ã€‚

Java ç¨‹åºå¤©ç”Ÿå°±æ˜¯å¤šçº¿ç¨‹ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ JMX æ¥çœ‹çœ‹ä¸€ä¸ªæ™®é€šçš„ Java ç¨‹åºæœ‰å“ªäº›çº¿ç¨‹ï¼Œä»£ç å¦‚ä¸‹ã€‚

```java
public class MultiThread {
	public static void main(String[] args) {
		// è·å– Java çº¿ç¨‹ç®¡ç† MXBean
	ThreadMXBean threadMXBean = ManagementFactory.getThreadMXBean();
		// ä¸éœ€è¦è·å–åŒæ­¥çš„ monitor å’Œ synchronizer ä¿¡æ¯ï¼Œä»…è·å–çº¿ç¨‹å’Œçº¿ç¨‹å †æ ˆä¿¡æ¯
		ThreadInfo[] threadInfos = threadMXBean.dumpAllThreads(false, false);
		// éå†çº¿ç¨‹ä¿¡æ¯ï¼Œä»…æ‰“å°çº¿ç¨‹ ID å’Œçº¿ç¨‹åç§°ä¿¡æ¯
		for (ThreadInfo threadInfo : threadInfos) {
			System.out.println("[" + threadInfo.getThreadId() + "] " + threadInfo.getThreadName());
		}
	}
}
```

ä¸Šè¿°ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼ˆè¾“å‡ºå†…å®¹å¯èƒ½ä¸åŒï¼Œä¸ç”¨å¤ªçº ç»“ä¸‹é¢æ¯ä¸ªçº¿ç¨‹çš„ä½œç”¨ï¼Œåªç”¨çŸ¥é“ main çº¿ç¨‹æ‰§è¡Œ main æ–¹æ³•å³å¯ï¼‰ï¼š

```
[5] Attach Listener //æ·»åŠ äº‹ä»¶
[4] Signal Dispatcher // åˆ†å‘å¤„ç†ç»™ JVM ä¿¡å·çš„çº¿ç¨‹
[3] Finalizer //è°ƒç”¨å¯¹è±¡ finalize æ–¹æ³•çš„çº¿ç¨‹
[2] Reference Handler //æ¸…é™¤ reference çº¿ç¨‹
[1] main //main çº¿ç¨‹,ç¨‹åºå…¥å£
```

ä»ä¸Šé¢çš„è¾“å‡ºå†…å®¹å¯ä»¥çœ‹å‡ºï¼š**ä¸€ä¸ª Java ç¨‹åºçš„è¿è¡Œæ˜¯ main çº¿ç¨‹å’Œå¤šä¸ªå…¶ä»–çº¿ç¨‹åŒæ—¶è¿è¡Œ**ã€‚

### è¯·ç®€è¦æè¿°çº¿ç¨‹ä¸è¿›ç¨‹çš„å…³ç³»,åŒºåˆ«åŠä¼˜ç¼ºç‚¹ï¼Ÿ

ä» JVM è§’åº¦è¯´è¿›ç¨‹å’Œçº¿ç¨‹ä¹‹é—´çš„å…³ç³»ã€‚

#### å›¾è§£è¿›ç¨‹å’Œçº¿ç¨‹çš„å…³ç³»

ä¸‹å›¾æ˜¯ Java å†…å­˜åŒºåŸŸï¼Œé€šè¿‡ä¸‹å›¾æˆ‘ä»¬ä» JVM çš„è§’åº¦æ¥è¯´ä¸€ä¸‹çº¿ç¨‹å’Œè¿›ç¨‹ä¹‹é—´çš„å…³ç³»ã€‚

![Java è¿è¡Œæ—¶æ•°æ®åŒºåŸŸï¼ˆJDK1.8 ä¹‹åï¼‰](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/java/jvm/java-runtime-data-areas-jdk1.8.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼šä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„**å †**å’Œ**æ–¹æ³•åŒº (JDK1.8 ä¹‹åçš„å…ƒç©ºé—´)**èµ„æºï¼Œä½†æ˜¯æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„**ç¨‹åºè®¡æ•°å™¨**ã€**è™šæ‹Ÿæœºæ ˆ** å’Œ **æœ¬åœ°æ–¹æ³•æ ˆ**ã€‚

**æ€»ç»“ï¼š** **çº¿ç¨‹æ˜¯è¿›ç¨‹åˆ’åˆ†æˆçš„æ›´å°çš„è¿è¡Œå•ä½ã€‚çº¿ç¨‹å’Œè¿›ç¨‹æœ€å¤§çš„ä¸åŒåœ¨äºåŸºæœ¬ä¸Šå„è¿›ç¨‹æ˜¯ç‹¬ç«‹çš„ï¼Œè€Œå„çº¿ç¨‹åˆ™ä¸ä¸€å®šï¼Œå› ä¸ºåŒä¸€è¿›ç¨‹ä¸­çš„çº¿ç¨‹ææœ‰å¯èƒ½ä¼šç›¸äº’å½±å“ã€‚çº¿ç¨‹æ‰§è¡Œå¼€é”€å°ï¼Œä½†ä¸åˆ©äºèµ„æºçš„ç®¡ç†å’Œä¿æŠ¤ï¼›è€Œè¿›ç¨‹æ­£ç›¸åã€‚**

ä¸‹é¢æ˜¯è¯¥çŸ¥è¯†ç‚¹çš„æ‰©å±•å†…å®¹ï¼

ä¸‹é¢æ¥æ€è€ƒè¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆ**ç¨‹åºè®¡æ•°å™¨**ã€**è™šæ‹Ÿæœºæ ˆ**å’Œ**æœ¬åœ°æ–¹æ³•æ ˆ**æ˜¯çº¿ç¨‹ç§æœ‰çš„å‘¢ï¼Ÿä¸ºä»€ä¹ˆå †å’Œæ–¹æ³•åŒºæ˜¯çº¿ç¨‹å…±äº«çš„å‘¢ï¼Ÿ

#### ç¨‹åºè®¡æ•°å™¨ä¸ºä»€ä¹ˆæ˜¯ç§æœ‰çš„?

ç¨‹åºè®¡æ•°å™¨ä¸»è¦æœ‰ä¸‹é¢ä¸¤ä¸ªä½œç”¨ï¼š

1. å­—èŠ‚ç è§£é‡Šå™¨é€šè¿‡æ”¹å˜ç¨‹åºè®¡æ•°å™¨æ¥ä¾æ¬¡è¯»å–æŒ‡ä»¤ï¼Œä»è€Œå®ç°ä»£ç çš„æµç¨‹æ§åˆ¶ï¼Œå¦‚ï¼šé¡ºåºæ‰§è¡Œã€é€‰æ‹©ã€å¾ªç¯ã€å¼‚å¸¸å¤„ç†ã€‚
2. åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œç¨‹åºè®¡æ•°å™¨ç”¨äºè®°å½•å½“å‰çº¿ç¨‹æ‰§è¡Œçš„ä½ç½®ï¼Œä»è€Œå½“çº¿ç¨‹è¢«åˆ‡æ¢å›æ¥çš„æ—¶å€™èƒ½å¤ŸçŸ¥é“è¯¥çº¿ç¨‹ä¸Šæ¬¡è¿è¡Œåˆ°å“ªå„¿äº†ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ‰§è¡Œçš„æ˜¯ native æ–¹æ³•ï¼Œé‚£ä¹ˆç¨‹åºè®¡æ•°å™¨è®°å½•çš„æ˜¯ undefined åœ°å€ï¼Œåªæœ‰æ‰§è¡Œçš„æ˜¯ Java ä»£ç æ—¶ç¨‹åºè®¡æ•°å™¨è®°å½•çš„æ‰æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚

æ‰€ä»¥ï¼Œç¨‹åºè®¡æ•°å™¨ç§æœ‰ä¸»è¦æ˜¯ä¸ºäº†**çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®**ã€‚

#### è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆä¸ºä»€ä¹ˆæ˜¯ç§æœ‰çš„?

- **è™šæ‹Ÿæœºæ ˆï¼š** æ¯ä¸ª Java æ–¹æ³•åœ¨æ‰§è¡Œçš„åŒæ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€å¸¸é‡æ± å¼•ç”¨ç­‰ä¿¡æ¯ã€‚ä»æ–¹æ³•è°ƒç”¨ç›´è‡³æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨ Java è™šæ‹Ÿæœºæ ˆä¸­å…¥æ ˆå’Œå‡ºæ ˆçš„è¿‡ç¨‹ã€‚
- **æœ¬åœ°æ–¹æ³•æ ˆï¼š** å’Œè™šæ‹Ÿæœºæ ˆæ‰€å‘æŒ¥çš„ä½œç”¨éå¸¸ç›¸ä¼¼ï¼ŒåŒºåˆ«æ˜¯ï¼š **è™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡Œ Java æ–¹æ³• ï¼ˆä¹Ÿå°±æ˜¯å­—èŠ‚ç ï¼‰æœåŠ¡ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆåˆ™ä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„ Native æ–¹æ³•æœåŠ¡ã€‚** åœ¨ HotSpot è™šæ‹Ÿæœºä¸­å’Œ Java è™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚

æ‰€ä»¥ï¼Œä¸ºäº†**ä¿è¯çº¿ç¨‹ä¸­çš„å±€éƒ¨å˜é‡ä¸è¢«åˆ«çš„çº¿ç¨‹è®¿é—®åˆ°**ï¼Œè™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚

#### ä¸€å¥è¯ç®€å•äº†è§£å †å’Œæ–¹æ³•åŒº

å †å’Œæ–¹æ³•åŒºæ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„èµ„æºï¼Œå…¶ä¸­å †æ˜¯è¿›ç¨‹ä¸­æœ€å¤§çš„ä¸€å—å†…å­˜ï¼Œä¸»è¦ç”¨äºå­˜æ”¾æ–°åˆ›å»ºçš„å¯¹è±¡ (å‡ ä¹æ‰€æœ‰å¯¹è±¡éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜)ï¼Œæ–¹æ³•åŒºä¸»è¦ç”¨äºå­˜æ”¾å·²è¢«åŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚

### å¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«

- **å¹¶å‘**ï¼šä¸¤ä¸ªåŠä¸¤ä¸ªä»¥ä¸Šçš„ä½œä¸šåœ¨åŒä¸€ **æ—¶é—´æ®µ** å†…æ‰§è¡Œã€‚
- **å¹¶è¡Œ**ï¼šä¸¤ä¸ªåŠä¸¤ä¸ªä»¥ä¸Šçš„ä½œä¸šåœ¨åŒä¸€ **æ—¶åˆ»** æ‰§è¡Œã€‚

æœ€å…³é”®çš„ç‚¹æ˜¯ï¼šæ˜¯å¦æ˜¯ **åŒæ—¶** æ‰§è¡Œã€‚

### åŒæ­¥å’Œå¼‚æ­¥çš„åŒºåˆ«

- **åŒæ­¥** ï¼š å‘å‡ºä¸€ä¸ªè°ƒç”¨ä¹‹åï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œ è¯¥è°ƒç”¨å°±ä¸å¯ä»¥è¿”å›ï¼Œä¸€ç›´ç­‰å¾…ã€‚
- **å¼‚æ­¥** ï¼šè°ƒç”¨åœ¨å‘å‡ºä¹‹åï¼Œä¸ç”¨ç­‰å¾…è¿”å›ç»“æœï¼Œè¯¥è°ƒç”¨ç›´æ¥è¿”å›ã€‚

### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº¿ç¨‹å‘¢?

å…ˆä»æ€»ä½“ä¸Šæ¥è¯´ï¼š

- **ä»è®¡ç®—æœºåº•å±‚æ¥è¯´ï¼š** çº¿ç¨‹å¯ä»¥æ¯”ä½œæ˜¯è½»é‡çº§çš„è¿›ç¨‹ï¼Œæ˜¯ç¨‹åºæ‰§è¡Œçš„æœ€å°å•ä½,çº¿ç¨‹é—´çš„åˆ‡æ¢å’Œè°ƒåº¦çš„æˆæœ¬è¿œè¿œå°äºè¿›ç¨‹ã€‚å¦å¤–ï¼Œå¤šæ ¸ CPU æ—¶ä»£æ„å‘³ç€å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¿è¡Œï¼Œè¿™å‡å°‘äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚
- **ä»å½“ä»£äº’è”ç½‘å‘å±•è¶‹åŠ¿æ¥è¯´ï¼š** ç°åœ¨çš„ç³»ç»ŸåŠ¨ä¸åŠ¨å°±è¦æ±‚ç™¾ä¸‡çº§ç”šè‡³åƒä¸‡çº§çš„å¹¶å‘é‡ï¼Œè€Œå¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹æ­£æ˜¯å¼€å‘é«˜å¹¶å‘ç³»ç»Ÿçš„åŸºç¡€ï¼Œåˆ©ç”¨å¥½å¤šçº¿ç¨‹æœºåˆ¶å¯ä»¥å¤§å¤§æé«˜ç³»ç»Ÿæ•´ä½“çš„å¹¶å‘èƒ½åŠ›ä»¥åŠæ€§èƒ½ã€‚

å†æ·±å…¥åˆ°è®¡ç®—æœºåº•å±‚æ¥æ¢è®¨ï¼š

- **å•æ ¸æ—¶ä»£**ï¼š åœ¨å•æ ¸æ—¶ä»£å¤šçº¿ç¨‹ä¸»è¦æ˜¯ä¸ºäº†æé«˜å•è¿›ç¨‹åˆ©ç”¨ CPU å’Œ IO ç³»ç»Ÿçš„æ•ˆç‡ã€‚ å‡è®¾åªè¿è¡Œäº†ä¸€ä¸ª Java è¿›ç¨‹çš„æƒ…å†µï¼Œå½“æˆ‘ä»¬è¯·æ±‚ IO çš„æ—¶å€™ï¼Œå¦‚æœ Java è¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ­¤çº¿ç¨‹è¢« IO é˜»å¡åˆ™æ•´ä¸ªè¿›ç¨‹è¢«é˜»å¡ã€‚CPU å’Œ IO è®¾å¤‡åªæœ‰ä¸€ä¸ªåœ¨è¿è¡Œï¼Œé‚£ä¹ˆå¯ä»¥ç®€å•åœ°è¯´ç³»ç»Ÿæ•´ä½“æ•ˆç‡åªæœ‰ 50%ã€‚å½“ä½¿ç”¨å¤šçº¿ç¨‹çš„æ—¶å€™ï¼Œä¸€ä¸ªçº¿ç¨‹è¢« IO é˜»å¡ï¼Œå…¶ä»–çº¿ç¨‹è¿˜å¯ä»¥ç»§ç»­ä½¿ç”¨ CPUã€‚ä»è€Œæé«˜äº† Java è¿›ç¨‹åˆ©ç”¨ç³»ç»Ÿèµ„æºçš„æ•´ä½“æ•ˆç‡ã€‚
- **å¤šæ ¸æ—¶ä»£**: å¤šæ ¸æ—¶ä»£å¤šçº¿ç¨‹ä¸»è¦æ˜¯ä¸ºäº†æé«˜è¿›ç¨‹åˆ©ç”¨å¤šæ ¸ CPU çš„èƒ½åŠ›ã€‚ä¸¾ä¸ªä¾‹å­ï¼šå‡å¦‚æˆ‘ä»¬è¦è®¡ç®—ä¸€ä¸ªå¤æ‚çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬åªç”¨ä¸€ä¸ªçº¿ç¨‹çš„è¯ï¼Œä¸è®ºç³»ç»Ÿæœ‰å‡ ä¸ª CPU æ ¸å¿ƒï¼Œéƒ½åªä¼šæœ‰ä¸€ä¸ª CPU æ ¸å¿ƒè¢«åˆ©ç”¨åˆ°ã€‚è€Œåˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹å¯ä»¥è¢«æ˜ å°„åˆ°åº•å±‚å¤šä¸ª CPU ä¸Šæ‰§è¡Œï¼Œåœ¨ä»»åŠ¡ä¸­çš„å¤šä¸ªçº¿ç¨‹æ²¡æœ‰èµ„æºç«äº‰çš„æƒ…å†µä¸‹ï¼Œä»»åŠ¡æ‰§è¡Œçš„æ•ˆç‡ä¼šæœ‰æ˜¾è‘—æ€§çš„æé«˜ï¼Œçº¦ç­‰äºï¼ˆå•æ ¸æ—¶æ‰§è¡Œæ—¶é—´/CPU æ ¸å¿ƒæ•°ï¼‰ã€‚

### ä½¿ç”¨å¤šçº¿ç¨‹å¯èƒ½å¸¦æ¥ä»€ä¹ˆé—®é¢˜?

å¹¶å‘ç¼–ç¨‹çš„ç›®çš„å°±æ˜¯ä¸ºäº†èƒ½æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡æé«˜ç¨‹åºè¿è¡Œé€Ÿåº¦ï¼Œä½†æ˜¯å¹¶å‘ç¼–ç¨‹å¹¶ä¸æ€»æ˜¯èƒ½æé«˜ç¨‹åºè¿è¡Œé€Ÿåº¦çš„ï¼Œè€Œä¸”å¹¶å‘ç¼–ç¨‹å¯èƒ½ä¼šé‡åˆ°å¾ˆå¤šé—®é¢˜ï¼Œæ¯”å¦‚ï¼šå†…å­˜æ³„æ¼ã€æ­»é”ã€çº¿ç¨‹ä¸å®‰å…¨ç­‰ç­‰ã€‚

### è¯´è¯´çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå’ŒçŠ¶æ€?

Java çº¿ç¨‹åœ¨è¿è¡Œçš„ç”Ÿå‘½å‘¨æœŸä¸­çš„æŒ‡å®šæ—¶åˆ»åªå¯èƒ½å¤„äºä¸‹é¢ 6 ç§ä¸åŒçŠ¶æ€çš„å…¶ä¸­ä¸€ä¸ªçŠ¶æ€ï¼š

- NEW: åˆå§‹çŠ¶æ€ï¼Œçº¿ç¨‹è¢«åˆ›å»ºå‡ºæ¥ä½†æ²¡æœ‰è¢«è°ƒç”¨ `start()` ã€‚
- RUNNABLE: è¿è¡ŒçŠ¶æ€ï¼Œçº¿ç¨‹è¢«è°ƒç”¨äº† `start()`ç­‰å¾…è¿è¡Œçš„çŠ¶æ€ã€‚
- BLOCKED ï¼šé˜»å¡çŠ¶æ€ï¼Œéœ€è¦ç­‰å¾…é”é‡Šæ”¾ã€‚
- WAITINGï¼šç­‰å¾…çŠ¶æ€ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹éœ€è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹åšå‡ºä¸€äº›ç‰¹å®šåŠ¨ä½œï¼ˆé€šçŸ¥æˆ–ä¸­æ–­ï¼‰ã€‚
- TIME_WAITINGï¼šè¶…æ—¶ç­‰å¾…çŠ¶æ€ï¼Œå¯ä»¥åœ¨æŒ‡å®šçš„æ—¶é—´åè‡ªè¡Œè¿”å›è€Œä¸æ˜¯åƒ WAITING é‚£æ ·ä¸€ç›´ç­‰å¾…ã€‚
- TERMINATEDï¼šç»ˆæ­¢çŠ¶æ€ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»è¿è¡Œå®Œæ¯•ã€‚

çº¿ç¨‹åœ¨ç”Ÿå‘½å‘¨æœŸä¸­å¹¶ä¸æ˜¯å›ºå®šå¤„äºæŸä¸€ä¸ªçŠ¶æ€è€Œæ˜¯éšç€ä»£ç çš„æ‰§è¡Œåœ¨ä¸åŒçŠ¶æ€ä¹‹é—´åˆ‡æ¢ã€‚

Java çº¿ç¨‹çŠ¶æ€å˜è¿å›¾(å›¾æºï¼š[æŒ‘é”™ |ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ä¸­å…³äºçº¿ç¨‹çŠ¶æ€çš„ä¸‰å¤„é”™è¯¯](https://mp.weixin.qq.com/s/UOrXql_LhOD8dhTq_EPI0w))ï¼š

![Java çº¿ç¨‹çŠ¶æ€å˜è¿å›¾](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/java/concurrent/640.png)

ç”±ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼šçº¿ç¨‹åˆ›å»ºä¹‹åå®ƒå°†å¤„äº **NEWï¼ˆæ–°å»ºï¼‰** çŠ¶æ€ï¼Œè°ƒç”¨ `start()` æ–¹æ³•åå¼€å§‹è¿è¡Œï¼Œçº¿ç¨‹è¿™æ—¶å€™å¤„äº **READYï¼ˆå¯è¿è¡Œï¼‰** çŠ¶æ€ã€‚å¯è¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹è·å¾—äº† CPU æ—¶é—´ç‰‡ï¼ˆtimesliceï¼‰åå°±å¤„äº **RUNNINGï¼ˆè¿è¡Œï¼‰** çŠ¶æ€ã€‚

> åœ¨æ“ä½œç³»ç»Ÿå±‚é¢ï¼Œçº¿ç¨‹æœ‰ READY å’Œ RUNNING çŠ¶æ€ï¼›è€Œåœ¨ JVM å±‚é¢ï¼Œåªèƒ½çœ‹åˆ° RUNNABLE çŠ¶æ€ï¼ˆå›¾æºï¼š[HowToDoInJava](https://howtodoinJava.com/ "HowToDoInJava")ï¼š[Java Thread Life Cycle and Thread States](https://howtodoinJava.com/Java/multi-threading/Java-thread-life-cycle-and-thread-states/ "Java Thread Life Cycle and Thread States")ï¼‰ï¼Œæ‰€ä»¥ Java ç³»ç»Ÿä¸€èˆ¬å°†è¿™ä¸¤ä¸ªçŠ¶æ€ç»Ÿç§°ä¸º **RUNNABLEï¼ˆè¿è¡Œä¸­ï¼‰** çŠ¶æ€ ã€‚
>
> **ä¸ºä»€ä¹ˆ JVM æ²¡æœ‰åŒºåˆ†è¿™ä¸¤ç§çŠ¶æ€å‘¢ï¼Ÿ** ï¼ˆæ‘˜è‡ªï¼š[Java çº¿ç¨‹è¿è¡Œæ€ä¹ˆæœ‰ç¬¬å…­ç§çŠ¶æ€ï¼Ÿ - Dawell çš„å›ç­”](https://www.zhihu.com/question/56494969/answer/154053599) ï¼‰ ç°åœ¨çš„æ—¶åˆ†ï¼ˆtime-sharingï¼‰å¤šä»»åŠ¡ï¼ˆmulti-taskï¼‰æ“ä½œç³»ç»Ÿæ¶æ„é€šå¸¸éƒ½æ˜¯ç”¨æ‰€è°“çš„â€œæ—¶é—´åˆ†ç‰‡ï¼ˆtime quantum or time sliceï¼‰â€æ–¹å¼è¿›è¡ŒæŠ¢å å¼ï¼ˆpreemptiveï¼‰è½®è½¬è°ƒåº¦ï¼ˆround-robin å¼ï¼‰ã€‚è¿™ä¸ªæ—¶é—´åˆ†ç‰‡é€šå¸¸æ˜¯å¾ˆå°çš„ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡æœ€å¤šåªèƒ½åœ¨ CPU ä¸Šè¿è¡Œæ¯”å¦‚ 10-20ms çš„æ—¶é—´ï¼ˆæ­¤æ—¶å¤„äº running çŠ¶æ€ï¼‰ï¼Œä¹Ÿå³å¤§æ¦‚åªæœ‰ 0.01 ç§’è¿™ä¸€é‡çº§ï¼Œæ—¶é—´ç‰‡ç”¨åå°±è¦è¢«åˆ‡æ¢ä¸‹æ¥æ”¾å…¥è°ƒåº¦é˜Ÿåˆ—çš„æœ«å°¾ç­‰å¾…å†æ¬¡è°ƒåº¦ã€‚ï¼ˆä¹Ÿå³å›åˆ° ready çŠ¶æ€ï¼‰ã€‚çº¿ç¨‹åˆ‡æ¢çš„å¦‚æ­¤ä¹‹å¿«ï¼ŒåŒºåˆ†è¿™ä¸¤ç§çŠ¶æ€å°±æ²¡ä»€ä¹ˆæ„ä¹‰äº†ã€‚

![RUNNABLE-VS-RUNNING](https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-3/RUNNABLE-VS-RUNNING.png)

- å½“çº¿ç¨‹æ‰§è¡Œ `wait()`æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹è¿›å…¥ **WAITINGï¼ˆç­‰å¾…ï¼‰** çŠ¶æ€ã€‚è¿›å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹éœ€è¦ä¾é å…¶ä»–çº¿ç¨‹çš„é€šçŸ¥æ‰èƒ½å¤Ÿè¿”å›åˆ°è¿è¡ŒçŠ¶æ€ã€‚
- **TIMED_WAITING(è¶…æ—¶ç­‰å¾…)** çŠ¶æ€ç›¸å½“äºåœ¨ç­‰å¾…çŠ¶æ€çš„åŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶é™åˆ¶ï¼Œæ¯”å¦‚é€šè¿‡ `sleepï¼ˆlong millisï¼‰`æ–¹æ³•æˆ– `waitï¼ˆlong millisï¼‰`æ–¹æ³•å¯ä»¥å°†çº¿ç¨‹ç½®äº TIMED_WAITING çŠ¶æ€ã€‚å½“è¶…æ—¶æ—¶é—´ç»“æŸåï¼Œçº¿ç¨‹å°†ä¼šè¿”å›åˆ° RUNNABLE çŠ¶æ€ã€‚
- å½“çº¿ç¨‹è¿›å…¥ `synchronized` æ–¹æ³•/å—æˆ–è€…è°ƒç”¨ `wait` åï¼ˆè¢« `notify`ï¼‰é‡æ–°è¿›å…¥ `synchronized` æ–¹æ³•/å—ï¼Œä½†æ˜¯é”è¢«å…¶å®ƒçº¿ç¨‹å æœ‰ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹å°±ä¼šè¿›å…¥ **BLOCKEDï¼ˆé˜»å¡ï¼‰** çŠ¶æ€ã€‚
- çº¿ç¨‹åœ¨æ‰§è¡Œå®Œäº† `run()`æ–¹æ³•ä¹‹åå°†ä¼šè¿›å…¥åˆ° **TERMINATEDï¼ˆç»ˆæ­¢ï¼‰** çŠ¶æ€ã€‚

ç›¸å…³é˜…è¯»ï¼š[çº¿ç¨‹çš„å‡ ç§çŠ¶æ€ä½ çœŸçš„äº†è§£ä¹ˆï¼Ÿ](https://mp.weixin.qq.com/s/R5MrTsWvk9McFSQ7bS0W2w) ã€‚

### ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢?

çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šæœ‰è‡ªå·±çš„è¿è¡Œæ¡ä»¶å’ŒçŠ¶æ€ï¼ˆä¹Ÿç§°ä¸Šä¸‹æ–‡ï¼‰ï¼Œæ¯”å¦‚ä¸Šæ–‡æ‰€è¯´åˆ°è¿‡çš„ç¨‹åºè®¡æ•°å™¨ï¼Œæ ˆä¿¡æ¯ç­‰ã€‚å½“å‡ºç°å¦‚ä¸‹æƒ…å†µçš„æ—¶å€™ï¼Œçº¿ç¨‹ä¼šä»å ç”¨ CPU çŠ¶æ€ä¸­é€€å‡ºã€‚

- ä¸»åŠ¨è®©å‡º CPUï¼Œæ¯”å¦‚è°ƒç”¨äº† `sleep()`, `wait()` ç­‰ã€‚
- æ—¶é—´ç‰‡ç”¨å®Œï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿè¦é˜²æ­¢ä¸€ä¸ªçº¿ç¨‹æˆ–è€…è¿›ç¨‹é•¿æ—¶é—´å ç”¨ CPU å¯¼è‡´å…¶ä»–çº¿ç¨‹æˆ–è€…è¿›ç¨‹é¥¿æ­»ã€‚
- è°ƒç”¨äº†é˜»å¡ç±»å‹çš„ç³»ç»Ÿä¸­æ–­ï¼Œæ¯”å¦‚è¯·æ±‚ IOï¼Œçº¿ç¨‹è¢«é˜»å¡ã€‚
- è¢«ç»ˆæ­¢æˆ–ç»“æŸè¿è¡Œ

è¿™å…¶ä¸­å‰ä¸‰ç§éƒ½ä¼šå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹åˆ‡æ¢æ„å‘³ç€éœ€è¦ä¿å­˜å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œç•™å¾…çº¿ç¨‹ä¸‹æ¬¡å ç”¨ CPU çš„æ—¶å€™æ¢å¤ç°åœºã€‚å¹¶åŠ è½½ä¸‹ä¸€ä¸ªå°†è¦å ç”¨ CPU çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚è¿™å°±æ˜¯æ‰€è°“çš„ **ä¸Šä¸‹æ–‡åˆ‡æ¢**ã€‚

ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯ç°ä»£æ“ä½œç³»ç»Ÿçš„åŸºæœ¬åŠŸèƒ½ï¼Œå› å…¶æ¯æ¬¡éœ€è¦ä¿å­˜ä¿¡æ¯æ¢å¤ä¿¡æ¯ï¼Œè¿™å°†ä¼šå ç”¨ CPUï¼Œå†…å­˜ç­‰ç³»ç»Ÿèµ„æºè¿›è¡Œå¤„ç†ï¼Œä¹Ÿå°±æ„å‘³ç€æ•ˆç‡ä¼šæœ‰ä¸€å®šæŸè€—ï¼Œå¦‚æœé¢‘ç¹åˆ‡æ¢å°±ä¼šé€ æˆæ•´ä½“æ•ˆç‡ä½ä¸‹ã€‚

### ä»€ä¹ˆæ˜¯çº¿ç¨‹æ­»é”?å¦‚ä½•é¿å…æ­»é”?

#### è®¤è¯†çº¿ç¨‹æ­»é”

çº¿ç¨‹æ­»é”æè¿°çš„æ˜¯è¿™æ ·ä¸€ç§æƒ…å†µï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¢«é˜»å¡ï¼Œå®ƒä»¬ä¸­çš„ä¸€ä¸ªæˆ–è€…å…¨éƒ¨éƒ½åœ¨ç­‰å¾…æŸä¸ªèµ„æºè¢«é‡Šæ”¾ã€‚ç”±äºçº¿ç¨‹è¢«æ— é™æœŸåœ°é˜»å¡ï¼Œå› æ­¤ç¨‹åºä¸å¯èƒ½æ­£å¸¸ç»ˆæ­¢ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¿ç¨‹ A æŒæœ‰èµ„æº 2ï¼Œçº¿ç¨‹ B æŒæœ‰èµ„æº 1ï¼Œä»–ä»¬åŒæ—¶éƒ½æƒ³ç”³è¯·å¯¹æ–¹çš„èµ„æºï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šäº’ç›¸ç­‰å¾…è€Œè¿›å…¥æ­»é”çŠ¶æ€ã€‚

![çº¿ç¨‹æ­»é”ç¤ºæ„å›¾ ](https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-4/2019-4%E6%AD%BB%E9%94%811.png)

ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜çº¿ç¨‹æ­»é”,ä»£ç æ¨¡æ‹Ÿäº†ä¸Šå›¾çš„æ­»é”çš„æƒ…å†µ (ä»£ç æ¥æºäºã€Šå¹¶å‘ç¼–ç¨‹ä¹‹ç¾ã€‹)ï¼š

```java
public class DeadLockDemo {
    private static Object resource1 = new Object();//èµ„æº 1
    private static Object resource2 = new Object();//èµ„æº 2

    public static void main(String[] args) {
        new Thread(() -> {
            synchronized (resource1) {
                System.out.println(Thread.currentThread() + "get resource1");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread() + "waiting get resource2");
                synchronized (resource2) {
                    System.out.println(Thread.currentThread() + "get resource2");
                }
            }
        }, "çº¿ç¨‹ 1").start();

        new Thread(() -> {
            synchronized (resource2) {
                System.out.println(Thread.currentThread() + "get resource2");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread() + "waiting get resource1");
                synchronized (resource1) {
                    System.out.println(Thread.currentThread() + "get resource1");
                }
            }
        }, "çº¿ç¨‹ 2").start();
    }
}
```

Output

```
Thread[çº¿ç¨‹ 1,5,main]get resource1
Thread[çº¿ç¨‹ 2,5,main]get resource2
Thread[çº¿ç¨‹ 1,5,main]waiting get resource2
Thread[çº¿ç¨‹ 2,5,main]waiting get resource1
```

çº¿ç¨‹ A é€šè¿‡ `synchronized (resource1)` è·å¾— `resource1` çš„ç›‘è§†å™¨é”ï¼Œç„¶åé€šè¿‡`Thread.sleep(1000);`è®©çº¿ç¨‹ A ä¼‘çœ  1s ä¸ºçš„æ˜¯è®©çº¿ç¨‹ B å¾—åˆ°æ‰§è¡Œç„¶åè·å–åˆ° resource2 çš„ç›‘è§†å™¨é”ã€‚çº¿ç¨‹ A å’Œçº¿ç¨‹ B ä¼‘çœ ç»“æŸäº†éƒ½å¼€å§‹ä¼å›¾è¯·æ±‚è·å–å¯¹æ–¹çš„èµ„æºï¼Œç„¶åè¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šé™·å…¥äº’ç›¸ç­‰å¾…çš„çŠ¶æ€ï¼Œè¿™ä¹Ÿå°±äº§ç”Ÿäº†æ­»é”ã€‚

ä¸Šé¢çš„ä¾‹å­ç¬¦åˆäº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼š

1. äº’æ–¥æ¡ä»¶ï¼šè¯¥èµ„æºä»»æ„ä¸€ä¸ªæ—¶åˆ»åªç”±ä¸€ä¸ªçº¿ç¨‹å ç”¨ã€‚
2. è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªçº¿ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚
3. ä¸å‰¥å¤ºæ¡ä»¶:çº¿ç¨‹å·²è·å¾—çš„èµ„æºåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹å¼ºè¡Œå‰¥å¤ºï¼Œåªæœ‰è‡ªå·±ä½¿ç”¨å®Œæ¯•åæ‰é‡Šæ”¾èµ„æºã€‚
4. å¾ªç¯ç­‰å¾…æ¡ä»¶:è‹¥å¹²çº¿ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚

#### å¦‚ä½•é¢„é˜²å’Œé¿å…çº¿ç¨‹æ­»é”?

**å¦‚ä½•é¢„é˜²æ­»é”ï¼Ÿ** ç ´åæ­»é”çš„äº§ç”Ÿçš„å¿…è¦æ¡ä»¶å³å¯ï¼š

1. **ç ´åè¯·æ±‚ä¸ä¿æŒæ¡ä»¶** ï¼šä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰çš„èµ„æºã€‚
2. **ç ´åä¸å‰¥å¤ºæ¡ä»¶** ï¼šå ç”¨éƒ¨åˆ†èµ„æºçš„çº¿ç¨‹è¿›ä¸€æ­¥ç”³è¯·å…¶ä»–èµ„æºæ—¶ï¼Œå¦‚æœç”³è¯·ä¸åˆ°ï¼Œå¯ä»¥ä¸»åŠ¨é‡Šæ”¾å®ƒå æœ‰çš„èµ„æºã€‚
3. **ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶** ï¼šé æŒ‰åºç”³è¯·èµ„æºæ¥é¢„é˜²ã€‚æŒ‰æŸä¸€é¡ºåºç”³è¯·èµ„æºï¼Œé‡Šæ”¾èµ„æºåˆ™ååºé‡Šæ”¾ã€‚ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶ã€‚

**å¦‚ä½•é¿å…æ­»é”ï¼Ÿ**

é¿å…æ­»é”å°±æ˜¯åœ¨èµ„æºåˆ†é…æ—¶ï¼Œå€ŸåŠ©äºç®—æ³•ï¼ˆæ¯”å¦‚é“¶è¡Œå®¶ç®—æ³•ï¼‰å¯¹èµ„æºåˆ†é…è¿›è¡Œè®¡ç®—è¯„ä¼°ï¼Œä½¿å…¶è¿›å…¥å®‰å…¨çŠ¶æ€ã€‚

> **å®‰å…¨çŠ¶æ€** æŒ‡çš„æ˜¯ç³»ç»Ÿèƒ½å¤ŸæŒ‰ç…§æŸç§çº¿ç¨‹æ¨è¿›é¡ºåºï¼ˆP1ã€P2ã€P3.....Pnï¼‰æ¥ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…æ‰€éœ€èµ„æºï¼Œç›´åˆ°æ»¡è¶³æ¯ä¸ªçº¿ç¨‹å¯¹èµ„æºçš„æœ€å¤§éœ€æ±‚ï¼Œä½¿æ¯ä¸ªçº¿ç¨‹éƒ½å¯é¡ºåˆ©å®Œæˆã€‚ç§° `<P1ã€P2ã€P3.....Pn>` åºåˆ—ä¸ºå®‰å…¨åºåˆ—ã€‚

æˆ‘ä»¬å¯¹çº¿ç¨‹ 2 çš„ä»£ç ä¿®æ”¹æˆä¸‹é¢è¿™æ ·å°±ä¸ä¼šäº§ç”Ÿæ­»é”äº†ã€‚

```java
new Thread(() -> {
            synchronized (resource1) {
                System.out.println(Thread.currentThread() + "get resource1");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread() + "waiting get resource2");
                synchronized (resource2) {
                    System.out.println(Thread.currentThread() + "get resource2");
                }
            }
        }, "çº¿ç¨‹ 2").start();
```

è¾“å‡ºï¼š

```
Thread[çº¿ç¨‹ 1,5,main]get resource1
Thread[çº¿ç¨‹ 1,5,main]waiting get resource2
Thread[çº¿ç¨‹ 1,5,main]get resource2
Thread[çº¿ç¨‹ 2,5,main]get resource1
Thread[çº¿ç¨‹ 2,5,main]waiting get resource2
Thread[çº¿ç¨‹ 2,5,main]get resource2

Process finished with exit code 0
```

æˆ‘ä»¬åˆ†æä¸€ä¸‹ä¸Šé¢çš„ä»£ç ä¸ºä»€ä¹ˆé¿å…äº†æ­»é”çš„å‘ç”Ÿ?

çº¿ç¨‹ 1 é¦–å…ˆè·å¾—åˆ° resource1 çš„ç›‘è§†å™¨é”,è¿™æ—¶å€™çº¿ç¨‹ 2 å°±è·å–ä¸åˆ°äº†ã€‚ç„¶åçº¿ç¨‹ 1 å†å»è·å– resource2 çš„ç›‘è§†å™¨é”ï¼Œå¯ä»¥è·å–åˆ°ã€‚ç„¶åçº¿ç¨‹ 1 é‡Šæ”¾äº†å¯¹ resource1ã€resource2 çš„ç›‘è§†å™¨é”çš„å ç”¨ï¼Œçº¿ç¨‹ 2 è·å–åˆ°å°±å¯ä»¥æ‰§è¡Œäº†ã€‚è¿™æ ·å°±ç ´åäº†ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶ï¼Œå› æ­¤é¿å…äº†æ­»é”ã€‚

### sleep() æ–¹æ³•å’Œ wait() æ–¹æ³•å¯¹æ¯”

**å…±åŒç‚¹** ï¼šä¸¤è€…éƒ½å¯ä»¥æš‚åœçº¿ç¨‹çš„æ‰§è¡Œã€‚

**åŒºåˆ«** ï¼š

- **`sleep()` æ–¹æ³•æ²¡æœ‰é‡Šæ”¾é”ï¼Œè€Œ `wait()` æ–¹æ³•é‡Šæ”¾äº†é”** ã€‚
- `wait()` é€šå¸¸è¢«ç”¨äºçº¿ç¨‹é—´äº¤äº’/é€šä¿¡ï¼Œ`sleep()`é€šå¸¸è¢«ç”¨äºæš‚åœæ‰§è¡Œã€‚
- `wait()` æ–¹æ³•è¢«è°ƒç”¨åï¼Œçº¿ç¨‹ä¸ä¼šè‡ªåŠ¨è‹é†’ï¼Œéœ€è¦åˆ«çš„çº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡ä¸Šçš„ `notify()`æˆ–è€… `notifyAll()` æ–¹æ³•ã€‚`sleep()`æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ `wait(long timeout)` è¶…æ—¶åçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ã€‚
- `sleep()` æ˜¯ `Thread` ç±»çš„é™æ€æœ¬åœ°æ–¹æ³•ï¼Œ`wait()` åˆ™æ˜¯ `Object` ç±»çš„æœ¬åœ°æ–¹æ³•ã€‚ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡å‘¢ï¼Ÿ

### ä¸ºä»€ä¹ˆ wait() æ–¹æ³•ä¸å®šä¹‰åœ¨ Thread ä¸­ï¼Ÿ

`wait()` æ˜¯è®©è·å¾—å¯¹è±¡é”çš„çº¿ç¨‹å®ç°ç­‰å¾…ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾å½“å‰çº¿ç¨‹å æœ‰çš„å¯¹è±¡é”ã€‚æ¯ä¸ªå¯¹è±¡ï¼ˆ`Object`ï¼‰éƒ½æ‹¥æœ‰å¯¹è±¡é”ï¼Œæ—¢ç„¶è¦é‡Šæ”¾å½“å‰çº¿ç¨‹å æœ‰çš„å¯¹è±¡é”å¹¶è®©å…¶è¿›å…¥ WAITING çŠ¶æ€ï¼Œè‡ªç„¶æ˜¯è¦æ“ä½œå¯¹åº”çš„å¯¹è±¡ï¼ˆ`Object`ï¼‰è€Œéå½“å‰çš„çº¿ç¨‹ï¼ˆ`Thread`ï¼‰ã€‚

ç±»ä¼¼çš„é—®é¢˜ï¼š**ä¸ºä»€ä¹ˆ `sleep()` æ–¹æ³•å®šä¹‰åœ¨ `Thread` ä¸­ï¼Ÿ**

å› ä¸º `sleep()` æ˜¯è®©å½“å‰çº¿ç¨‹æš‚åœæ‰§è¡Œï¼Œä¸æ¶‰åŠåˆ°å¯¹è±¡ç±»ï¼Œä¹Ÿä¸éœ€è¦è·å¾—å¯¹è±¡é”ã€‚

### å¯ä»¥ç›´æ¥è°ƒç”¨ Thread ç±»çš„ run æ–¹æ³•å—ï¼Ÿ

è¿™æ˜¯å¦ä¸€ä¸ªéå¸¸ç»å…¸çš„ Java å¤šçº¿ç¨‹é¢è¯•é—®é¢˜ï¼Œè€Œä¸”åœ¨é¢è¯•ä¸­ä¼šç»å¸¸è¢«é—®åˆ°ã€‚å¾ˆç®€å•ï¼Œä½†æ˜¯å¾ˆå¤šäººéƒ½ä¼šç­”ä¸ä¸Šæ¥ï¼

new ä¸€ä¸ª `Thread`ï¼Œçº¿ç¨‹è¿›å…¥äº†æ–°å»ºçŠ¶æ€ã€‚è°ƒç”¨ `start()`æ–¹æ³•ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å¹¶ä½¿çº¿ç¨‹è¿›å…¥äº†å°±ç»ªçŠ¶æ€ï¼Œå½“åˆ†é…åˆ°æ—¶é—´ç‰‡åå°±å¯ä»¥å¼€å§‹è¿è¡Œäº†ã€‚ `start()` ä¼šæ‰§è¡Œçº¿ç¨‹çš„ç›¸åº”å‡†å¤‡å·¥ä½œï¼Œç„¶åè‡ªåŠ¨æ‰§è¡Œ `run()` æ–¹æ³•çš„å†…å®¹ï¼Œè¿™æ˜¯çœŸæ­£çš„å¤šçº¿ç¨‹å·¥ä½œã€‚ ä½†æ˜¯ï¼Œç›´æ¥æ‰§è¡Œ `run()` æ–¹æ³•ï¼Œä¼šæŠŠ `run()` æ–¹æ³•å½“æˆä¸€ä¸ª main çº¿ç¨‹ä¸‹çš„æ™®é€šæ–¹æ³•å»æ‰§è¡Œï¼Œå¹¶ä¸ä¼šåœ¨æŸä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œå®ƒï¼Œæ‰€ä»¥è¿™å¹¶ä¸æ˜¯å¤šçº¿ç¨‹å·¥ä½œã€‚

**æ€»ç»“ï¼š è°ƒç”¨ `start()` æ–¹æ³•æ–¹å¯å¯åŠ¨çº¿ç¨‹å¹¶ä½¿çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œç›´æ¥æ‰§è¡Œ `run()` æ–¹æ³•çš„è¯ä¸ä¼šä»¥å¤šçº¿ç¨‹çš„æ–¹å¼æ‰§è¡Œã€‚**

### JMM(Java Memory Model)

JMMï¼ˆJava å†…å­˜æ¨¡å‹ï¼‰ç›¸å…³çš„é—®é¢˜æ¯”è¾ƒå¤šï¼Œä¹Ÿæ¯”è¾ƒé‡è¦ï¼Œäºæ˜¯æˆ‘å•ç‹¬æŠ½äº†ä¸€ç¯‡æ–‡ç« æ¥æ€»ç»“ JMM ç›¸å…³çš„çŸ¥è¯†ç‚¹å’Œé—®é¢˜ï¼š [JMMï¼ˆJava å†…å­˜æ¨¡å‹ï¼‰è¯¦è§£](https://javaguide.cn/java/concurrent/jmm.html) ã€‚

### volatile å…³é”®å­—

#### å¦‚ä½•ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Ÿ

åœ¨ Java ä¸­ï¼Œ`volatile` å…³é”®å­—å¯ä»¥ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Œå¦‚æœæˆ‘ä»¬å°†å˜é‡å£°æ˜ä¸º **`volatile`** ï¼Œè¿™å°±æŒ‡ç¤º JVMï¼Œè¿™ä¸ªå˜é‡æ˜¯å…±äº«ä¸”ä¸ç¨³å®šçš„ï¼Œæ¯æ¬¡ä½¿ç”¨å®ƒéƒ½åˆ°ä¸»å­˜ä¸­è¿›è¡Œè¯»å–ã€‚

![JMM(Java å†…å­˜æ¨¡å‹)](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/java/concurrent/jmm.png)

![JMM(Java å†…å­˜æ¨¡å‹)å¼ºåˆ¶åœ¨ä¸»å­˜ä¸­è¿›è¡Œè¯»å–](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/java/concurrent/jmm2.png)

`volatile` å…³é”®å­—å…¶å®å¹¶éæ˜¯ Java è¯­è¨€ç‰¹æœ‰çš„ï¼Œåœ¨ C è¯­è¨€é‡Œä¹Ÿæœ‰ï¼Œå®ƒæœ€åŸå§‹çš„æ„ä¹‰å°±æ˜¯ç¦ç”¨ CPU ç¼“å­˜ã€‚å¦‚æœæˆ‘ä»¬å°†ä¸€ä¸ªå˜é‡ä½¿ç”¨ `volatile` ä¿®é¥°ï¼Œè¿™å°±æŒ‡ç¤º ç¼–è¯‘å™¨ï¼Œè¿™ä¸ªå˜é‡æ˜¯å…±äº«ä¸”ä¸ç¨³å®šçš„ï¼Œæ¯æ¬¡ä½¿ç”¨å®ƒéƒ½åˆ°ä¸»å­˜ä¸­è¿›è¡Œè¯»å–ã€‚

`volatile` å…³é”®å­—èƒ½ä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯æ•°æ®çš„åŸå­æ€§ã€‚`synchronized` å…³é”®å­—ä¸¤è€…éƒ½èƒ½ä¿è¯ã€‚

#### å¦‚ä½•ç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼Ÿ

**åœ¨ Java ä¸­ï¼Œ`volatile` å…³é”®å­—é™¤äº†å¯ä»¥ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ä½œç”¨å°±æ˜¯é˜²æ­¢ JVM çš„æŒ‡ä»¤é‡æ’åºã€‚** å¦‚æœæˆ‘ä»¬å°†å˜é‡å£°æ˜ä¸º **`volatile`** ï¼Œåœ¨å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œè¯»å†™æ“ä½œçš„æ—¶å€™ï¼Œä¼šé€šè¿‡æ’å…¥ç‰¹å®šçš„ **å†…å­˜å±éšœ** çš„æ–¹å¼æ¥ç¦æ­¢æŒ‡ä»¤é‡æ’åºã€‚

åœ¨ Java ä¸­ï¼Œ`Unsafe` ç±»æä¾›äº†ä¸‰ä¸ªå¼€ç®±å³ç”¨çš„å†…å­˜å±éšœç›¸å…³çš„æ–¹æ³•ï¼Œå±è”½äº†æ“ä½œç³»ç»Ÿåº•å±‚çš„å·®å¼‚ï¼š

```java
public native void loadFence();
public native void storeFence();
public native void fullFence();
```

ç†è®ºä¸Šæ¥è¯´ï¼Œä½ é€šè¿‡è¿™ä¸ªä¸‰ä¸ªæ–¹æ³•ä¹Ÿå¯ä»¥å®ç°å’Œ`volatile`ç¦æ­¢é‡æ’åºä¸€æ ·çš„æ•ˆæœï¼Œåªæ˜¯ä¼šéº»çƒ¦ä¸€äº›ã€‚

ä¸‹é¢æˆ‘ä»¥ä¸€ä¸ªå¸¸è§çš„é¢è¯•é¢˜ä¸ºä¾‹è®²è§£ä¸€ä¸‹ `volatile` å…³é”®å­—ç¦æ­¢æŒ‡ä»¤é‡æ’åºçš„æ•ˆæœã€‚

é¢è¯•ä¸­é¢è¯•å®˜ç»å¸¸ä¼šè¯´ï¼šâ€œå•ä¾‹æ¨¡å¼äº†è§£å—ï¼Ÿæ¥ç»™æˆ‘æ‰‹å†™ä¸€ä¸‹ï¼ç»™æˆ‘è§£é‡Šä¸€ä¸‹åŒé‡æ£€éªŒé”æ–¹å¼å®ç°å•ä¾‹æ¨¡å¼çš„åŸç†å‘—ï¼â€

**åŒé‡æ ¡éªŒé”å®ç°å¯¹è±¡å•ä¾‹ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰** ï¼š

```java
public class Singleton {

    private volatile static Singleton uniqueInstance;

    private Singleton() {
    }

    public  static Singleton getUniqueInstance() {
       //å…ˆåˆ¤æ–­å¯¹è±¡æ˜¯å¦å·²ç»å®ä¾‹è¿‡ï¼Œæ²¡æœ‰å®ä¾‹åŒ–è¿‡æ‰è¿›å…¥åŠ é”ä»£ç 
        if (uniqueInstance == null) {
            //ç±»å¯¹è±¡åŠ é”
            synchronized (Singleton.class) {
                if (uniqueInstance == null) {
                    uniqueInstance = new Singleton();
                }
            }
        }
        return uniqueInstance;
    }
}
```

`uniqueInstance` é‡‡ç”¨ `volatile` å…³é”®å­—ä¿®é¥°ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œ `uniqueInstance = new Singleton();` è¿™æ®µä»£ç å…¶å®æ˜¯åˆ†ä¸ºä¸‰æ­¥æ‰§è¡Œï¼š

1. ä¸º `uniqueInstance` åˆ†é…å†…å­˜ç©ºé—´
2. åˆå§‹åŒ– `uniqueInstance`
3. å°† `uniqueInstance` æŒ‡å‘åˆ†é…çš„å†…å­˜åœ°å€

ä½†æ˜¯ç”±äº JVM å…·æœ‰æŒ‡ä»¤é‡æ’çš„ç‰¹æ€§ï¼Œæ‰§è¡Œé¡ºåºæœ‰å¯èƒ½å˜æˆ 1->3->2ã€‚æŒ‡ä»¤é‡æ’åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šå¯¼è‡´ä¸€ä¸ªçº¿ç¨‹è·å¾—è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œçº¿ç¨‹ T1 æ‰§è¡Œäº† 1 å’Œ 3ï¼Œæ­¤æ—¶ T2 è°ƒç”¨ `getUniqueInstance`() åå‘ç° `uniqueInstance` ä¸ä¸ºç©ºï¼Œå› æ­¤è¿”å› `uniqueInstance`ï¼Œä½†æ­¤æ—¶ `uniqueInstance` è¿˜æœªè¢«åˆå§‹åŒ–ã€‚

#### volatile å¯ä»¥ä¿è¯åŸå­æ€§ä¹ˆï¼Ÿ

**`volatile` å…³é”®å­—èƒ½ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯å¯¹å˜é‡çš„æ“ä½œæ˜¯åŸå­æ€§çš„ã€‚**

æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„ä»£ç å³å¯è¯æ˜ï¼š

```java
/**
 * å¾®ä¿¡æœ JavaGuide å›å¤"é¢è¯•çªå‡»"å³å¯å…è´¹é¢†å–ä¸ªäººåŸåˆ›çš„ Java é¢è¯•æ‰‹å†Œ
 *
 * @author Guideå“¥
 * @date 2022/08/03 13:40
 **/
public class VolatoleAtomicityDemo {
    public volatile static int inc = 0;

    public void increase() {
        inc++;
    }

    public static void main(String[] args) throws InterruptedException {
        ExecutorService threadPool = Executors.newFixedThreadPool(5);
        VolatoleAtomicityDemo volatoleAtomicityDemo = new VolatoleAtomicityDemo();
        for (int i = 0; i < 5; i++) {
            threadPool.execute(() -> {
                for (int j = 0; j < 500; j++) {
                    volatoleAtomicityDemo.increase();
                }
            });
        }
        // ç­‰å¾…1.5ç§’ï¼Œä¿è¯ä¸Šé¢ç¨‹åºæ‰§è¡Œå®Œæˆ
        Thread.sleep(1500);
        System.out.println(inc);
        threadPool.shutdown();
    }
}
```

æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿è¡Œä¸Šé¢çš„ä»£ç ç†åº”è¾“å‡º `2500`ã€‚ä½†ä½ çœŸæ­£è¿è¡Œäº†ä¸Šé¢çš„ä»£ç ä¹‹åï¼Œä½ ä¼šå‘ç°æ¯æ¬¡è¾“å‡ºç»“æœéƒ½å°äº `2500`ã€‚

ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿä¸æ˜¯è¯´å¥½äº†ï¼Œ`volatile` å¯ä»¥ä¿è¯å˜é‡çš„å¯è§æ€§å˜›ï¼

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ `volatile` èƒ½ä¿è¯ `inc++` æ“ä½œçš„åŸå­æ€§çš„è¯ã€‚æ¯ä¸ªçº¿ç¨‹ä¸­å¯¹ `inc` å˜é‡è‡ªå¢å®Œä¹‹åï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥ç«‹å³çœ‹åˆ°ä¿®æ”¹åçš„å€¼ã€‚5 ä¸ªçº¿ç¨‹åˆ†åˆ«è¿›è¡Œäº† 500 æ¬¡æ“ä½œï¼Œé‚£ä¹ˆæœ€ç»ˆ inc çš„å€¼åº”è¯¥æ˜¯ 5\*500=2500ã€‚

å¾ˆå¤šäººä¼šè¯¯è®¤ä¸ºè‡ªå¢æ“ä½œ `inc++` æ˜¯åŸå­æ€§çš„ï¼Œå®é™…ä¸Šï¼Œ`inc++` å…¶å®æ˜¯ä¸€ä¸ªå¤åˆæ“ä½œï¼ŒåŒ…æ‹¬ä¸‰æ­¥ï¼š

1. è¯»å– inc çš„å€¼ã€‚
2. å¯¹ inc åŠ  1ã€‚
3. å°† inc çš„å€¼å†™å›å†…å­˜ã€‚

`volatile` æ˜¯æ— æ³•ä¿è¯è¿™ä¸‰ä¸ªæ“ä½œæ˜¯å…·æœ‰åŸå­æ€§çš„ï¼Œæœ‰å¯èƒ½å¯¼è‡´ä¸‹é¢è¿™ç§æƒ…å†µå‡ºç°ï¼š

1. çº¿ç¨‹ 1 å¯¹ `inc` è¿›è¡Œè¯»å–æ“ä½œä¹‹åï¼Œè¿˜æœªå¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚çº¿ç¨‹ 2 åˆè¯»å–äº† `inc`çš„å€¼å¹¶å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼ˆ+1ï¼‰ï¼Œå†å°†`inc` çš„å€¼å†™å›å†…å­˜ã€‚
2. çº¿ç¨‹ 2 æ“ä½œå®Œæ¯•åï¼Œçº¿ç¨‹ 1 å¯¹ `inc`çš„å€¼è¿›è¡Œä¿®æ”¹ï¼ˆ+1ï¼‰ï¼Œå†å°†`inc` çš„å€¼å†™å›å†…å­˜ã€‚

è¿™ä¹Ÿå°±å¯¼è‡´ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«å¯¹ `inc` è¿›è¡Œäº†ä¸€æ¬¡è‡ªå¢æ“ä½œåï¼Œ`inc` å®é™…ä¸Šåªå¢åŠ äº† 1ã€‚

å…¶å®ï¼Œå¦‚æœæƒ³è¦ä¿è¯ä¸Šé¢çš„ä»£ç è¿è¡Œæ­£ç¡®ä¹Ÿéå¸¸ç®€å•ï¼Œåˆ©ç”¨ `synchronized` ã€`Lock`æˆ–è€…`AtomicInteger`éƒ½å¯ä»¥ã€‚

ä½¿ç”¨ `synchronized` æ”¹è¿›ï¼š

```java
public synchronized void increase() {
    inc++;
}
```

ä½¿ç”¨ `AtomicInteger` æ”¹è¿›ï¼š

```java
public AtomicInteger inc = new AtomicInteger();

public void increase() {
    inc.getAndIncrement();
}
```

ä½¿ç”¨ `ReentrantLock` æ”¹è¿›ï¼š

```java
Lock lock = new ReentrantLock();
public void increase() {
    lock.lock();
    try {
        inc++;
    } finally {
        lock.unlock();
    }
}
```

<div align="center">   
    <img src="https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/gongzhonghaoxuanchuan.png" style="margin: 0 auto;" />  
</div>

### synchronized å…³é”®å­—

#### è¯´ä¸€è¯´è‡ªå·±å¯¹äº synchronized å…³é”®å­—çš„äº†è§£

`synchronized` ç¿»è¯‘æˆä¸­æ–‡æ˜¯åŒæ­¥çš„çš„æ„æ€ï¼Œä¸»è¦è§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥æ€§ï¼Œå¯ä»¥ä¿è¯è¢«å®ƒä¿®é¥°çš„æ–¹æ³•æˆ–è€…ä»£ç å—åœ¨ä»»æ„æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚

åœ¨ Java æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œ`synchronized` å±äº **é‡é‡çº§é”**ï¼Œæ•ˆç‡ä½ä¸‹ã€‚ å› ä¸ºç›‘è§†å™¨é”ï¼ˆmonitorï¼‰æ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„ `Mutex Lock` æ¥å®ç°çš„ï¼ŒJava çš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¹‹ä¸Šçš„ã€‚å¦‚æœè¦æŒ‚èµ·æˆ–è€…å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½éœ€è¦æ“ä½œç³»ç»Ÿå¸®å¿™å®Œæˆï¼Œè€Œæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ—¶éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢éœ€è¦ç›¸å¯¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œæ—¶é—´æˆæœ¬ç›¸å¯¹è¾ƒé«˜ã€‚

ä¸è¿‡ï¼Œåœ¨ Java 6 ä¹‹åï¼ŒJava å®˜æ–¹å¯¹ä» JVM å±‚é¢å¯¹ `synchronized` è¾ƒå¤§ä¼˜åŒ–ï¼Œæ‰€ä»¥ç°åœ¨çš„ `synchronized` é”æ•ˆç‡ä¹Ÿä¼˜åŒ–å¾—å¾ˆä¸é”™äº†ã€‚JDK1.6 å¯¹é”çš„å®ç°å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå¦‚è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”ã€è½»é‡çº§é”ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ã€‚æ‰€ä»¥ï¼Œä½ ä¼šå‘ç°ç›®å‰çš„è¯ï¼Œä¸è®ºæ˜¯å„ç§å¼€æºæ¡†æ¶è¿˜æ˜¯ JDK æºç éƒ½å¤§é‡ä½¿ç”¨äº† `synchronized` å…³é”®å­—ã€‚

#### å¦‚ä½•ä½¿ç”¨ synchronized å…³é”®å­—ï¼Ÿ

synchronized å…³é”®å­—æœ€ä¸»è¦çš„ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š

1. ä¿®é¥°å®ä¾‹æ–¹æ³•
2. ä¿®é¥°é™æ€æ–¹æ³•
3. ä¿®é¥°ä»£ç å—

**1ã€ä¿®é¥°å®ä¾‹æ–¹æ³•** ï¼ˆé”å½“å‰å¯¹è±¡å®ä¾‹ï¼‰

ç»™å½“å‰å¯¹è±¡å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— **å½“å‰å¯¹è±¡å®ä¾‹çš„é”** ã€‚

```java
synchronized void method() {
    //ä¸šåŠ¡ä»£ç 
}
```

**2ã€ä¿®é¥°é™æ€æ–¹æ³•** ï¼ˆé”å½“å‰ç±»ï¼‰

ç»™å½“å‰ç±»åŠ é”ï¼Œä¼šä½œç”¨äºç±»çš„æ‰€æœ‰å¯¹è±¡å®ä¾‹ ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— **å½“å‰ class çš„é”**ã€‚

è¿™æ˜¯å› ä¸ºé™æ€æˆå‘˜ä¸å±äºä»»ä½•ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå½’æ•´ä¸ªç±»æ‰€æœ‰ï¼Œä¸ä¾èµ–äºç±»çš„ç‰¹å®šå®ä¾‹ï¼Œè¢«ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«ã€‚

```java
synchronized static void method() {
    //ä¸šåŠ¡ä»£ç 
}
```

é™æ€ `synchronized` æ–¹æ³•å’Œéé™æ€ `synchronized` æ–¹æ³•ä¹‹é—´çš„è°ƒç”¨äº’æ–¥ä¹ˆï¼Ÿä¸äº’æ–¥ï¼å¦‚æœä¸€ä¸ªçº¿ç¨‹ A è°ƒç”¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„éé™æ€ `synchronized` æ–¹æ³•ï¼Œè€Œçº¿ç¨‹ B éœ€è¦è°ƒç”¨è¿™ä¸ªå®ä¾‹å¯¹è±¡æ‰€å±ç±»çš„é™æ€ `synchronized` æ–¹æ³•ï¼Œæ˜¯å…è®¸çš„ï¼Œä¸ä¼šå‘ç”Ÿäº’æ–¥ç°è±¡ï¼Œå› ä¸ºè®¿é—®é™æ€ `synchronized` æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰ç±»çš„é”ï¼Œè€Œè®¿é—®éé™æ€ `synchronized` æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡é”ã€‚

**3ã€ä¿®é¥°ä»£ç å—** ï¼ˆé”æŒ‡å®šå¯¹è±¡/ç±»ï¼‰

å¯¹æ‹¬å·é‡ŒæŒ‡å®šçš„å¯¹è±¡/ç±»åŠ é”ï¼š

- `synchronized(object)` è¡¨ç¤ºè¿›å…¥åŒæ­¥ä»£ç åº“å‰è¦è·å¾— **ç»™å®šå¯¹è±¡çš„é”**ã€‚
- `synchronized(ç±».class)` è¡¨ç¤ºè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— **ç»™å®š Class çš„é”**

```java
synchronized(this) {
    //ä¸šåŠ¡ä»£ç 
}
```

**æ€»ç»“ï¼š**

- `synchronized` å…³é”®å­—åŠ åˆ° `static` é™æ€æ–¹æ³•å’Œ `synchronized(class)` ä»£ç å—ä¸Šéƒ½æ˜¯æ˜¯ç»™ Class ç±»ä¸Šé”ï¼›
- `synchronized` å…³é”®å­—åŠ åˆ°å®ä¾‹æ–¹æ³•ä¸Šæ˜¯ç»™å¯¹è±¡å®ä¾‹ä¸Šé”ï¼›
- å°½é‡ä¸è¦ä½¿ç”¨ `synchronized(String a)` å› ä¸º JVM ä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å…·æœ‰ç¼“å­˜åŠŸèƒ½ã€‚

#### æ„é€ æ–¹æ³•å¯ä»¥ä½¿ç”¨ synchronized å…³é”®å­—ä¿®é¥°ä¹ˆï¼Ÿ

å…ˆè¯´ç»“è®ºï¼š**æ„é€ æ–¹æ³•ä¸èƒ½ä½¿ç”¨ synchronized å…³é”®å­—ä¿®é¥°ã€‚**

æ„é€ æ–¹æ³•æœ¬èº«å°±å±äºçº¿ç¨‹å®‰å…¨çš„ï¼Œä¸å­˜åœ¨åŒæ­¥çš„æ„é€ æ–¹æ³•ä¸€è¯´ã€‚

#### è®²ä¸€ä¸‹ synchronized å…³é”®å­—çš„åº•å±‚åŸç†

synchronized å…³é”®å­—åº•å±‚åŸç†å±äº JVM å±‚é¢ã€‚

###### synchronized åŒæ­¥è¯­å¥å—çš„æƒ…å†µ

```java
public class SynchronizedDemo {
    public void method() {
        synchronized (this) {
            System.out.println("synchronized ä»£ç å—");
        }
    }
}

```

é€šè¿‡ JDK è‡ªå¸¦çš„ `javap` å‘½ä»¤æŸ¥çœ‹ `SynchronizedDemo` ç±»çš„ç›¸å…³å­—èŠ‚ç ä¿¡æ¯ï¼šé¦–å…ˆåˆ‡æ¢åˆ°ç±»çš„å¯¹åº”ç›®å½•æ‰§è¡Œ `javac SynchronizedDemo.java` å‘½ä»¤ç”Ÿæˆç¼–è¯‘åçš„ .class æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œ`javap -c -s -v -l SynchronizedDemo.class`ã€‚

![synchronizedå…³é”®å­—åŸç†](https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/synchronizedå…³é”®å­—åŸç†.png)

ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š**`synchronized` åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ `monitorenter` å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå…¶ä¸­ `monitorenter` æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ`monitorexit` æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚**

å½“æ‰§è¡Œ `monitorenter` æŒ‡ä»¤æ—¶ï¼Œçº¿ç¨‹è¯•å›¾è·å–é”ä¹Ÿå°±æ˜¯è·å– **å¯¹è±¡ç›‘è§†å™¨ `monitor`** çš„æŒæœ‰æƒã€‚

> åœ¨ Java è™šæ‹Ÿæœº(HotSpot)ä¸­ï¼ŒMonitor æ˜¯åŸºäº C++å®ç°çš„ï¼Œç”±[ObjectMonitor](https://github.com/openjdk-mirror/jdk7u-hotspot/blob/50bdefc3afe944ca74c3093e7448d6b889cd20d1/src/share/vm/runtime/objectMonitor.cpp)å®ç°çš„ã€‚æ¯ä¸ªå¯¹è±¡ä¸­éƒ½å†…ç½®äº†ä¸€ä¸ª `ObjectMonitor`å¯¹è±¡ã€‚
>
> å¦å¤–ï¼Œ`wait/notify`ç­‰æ–¹æ³•ä¹Ÿä¾èµ–äº`monitor`å¯¹è±¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåªæœ‰åœ¨åŒæ­¥çš„å—æˆ–è€…æ–¹æ³•ä¸­æ‰èƒ½è°ƒç”¨`wait/notify`ç­‰æ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ›å‡º`java.lang.IllegalMonitorStateException`çš„å¼‚å¸¸çš„åŸå› ã€‚

åœ¨æ‰§è¡Œ`monitorenter`æ—¶ï¼Œä¼šå°è¯•è·å–å¯¹è±¡çš„é”ï¼Œå¦‚æœé”çš„è®¡æ•°å™¨ä¸º 0 åˆ™è¡¨ç¤ºé”å¯ä»¥è¢«è·å–ï¼Œè·å–åå°†é”è®¡æ•°å™¨è®¾ä¸º 1 ä¹Ÿå°±æ˜¯åŠ  1ã€‚

![æ‰§è¡Œ monitorenter è·å–é”](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/java/concurrent/synchronized-get-lock-code-block.png)

å¯¹è±¡é”çš„çš„æ‹¥æœ‰è€…çº¿ç¨‹æ‰å¯ä»¥æ‰§è¡Œ `monitorexit` æŒ‡ä»¤æ¥é‡Šæ”¾é”ã€‚åœ¨æ‰§è¡Œ `monitorexit` æŒ‡ä»¤åï¼Œå°†é”è®¡æ•°å™¨è®¾ä¸º 0ï¼Œè¡¨æ˜é”è¢«é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥å°è¯•è·å–é”ã€‚

![æ‰§è¡Œ monitorexit é‡Šæ”¾é”](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/java/concurrent/synchronized-release-lock-block.png)

å¦‚æœè·å–å¯¹è±¡é”å¤±è´¥ï¼Œé‚£å½“å‰çº¿ç¨‹å°±è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é”è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ä¸ºæ­¢ã€‚

###### synchronized ä¿®é¥°æ–¹æ³•çš„çš„æƒ…å†µ

```java
public class SynchronizedDemo2 {
    public synchronized void method() {
        System.out.println("synchronized æ–¹æ³•");
    }
}

```

![synchronizedå…³é”®å­—åŸç†](https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/synchronizedå…³é”®å­—åŸç†2.png)

`synchronized` ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ `monitorenter` æŒ‡ä»¤å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå–å¾—ä»£ä¹‹çš„ç¡®å®æ˜¯ `ACC_SYNCHRONIZED` æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚JVM é€šè¿‡è¯¥ `ACC_SYNCHRONIZED` è®¿é—®æ ‡å¿—æ¥è¾¨åˆ«ä¸€ä¸ªæ–¹æ³•æ˜¯å¦å£°æ˜ä¸ºåŒæ­¥æ–¹æ³•ï¼Œä»è€Œæ‰§è¡Œç›¸åº”çš„åŒæ­¥è°ƒç”¨ã€‚

å¦‚æœæ˜¯å®ä¾‹æ–¹æ³•ï¼ŒJVM ä¼šå°è¯•è·å–å®ä¾‹å¯¹è±¡çš„é”ã€‚å¦‚æœæ˜¯é™æ€æ–¹æ³•ï¼ŒJVM ä¼šå°è¯•è·å–å½“å‰ class çš„é”ã€‚

###### æ€»ç»“

`synchronized` åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ `monitorenter` å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå…¶ä¸­ `monitorenter` æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ`monitorexit` æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚

`synchronized` ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ `monitorenter` æŒ‡ä»¤å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå–å¾—ä»£ä¹‹çš„ç¡®å®æ˜¯ `ACC_SYNCHRONIZED` æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚

**ä¸è¿‡ä¸¤è€…çš„æœ¬è´¨éƒ½æ˜¯å¯¹å¯¹è±¡ç›‘è§†å™¨ monitor çš„è·å–ã€‚**

ç›¸å…³æ¨èï¼š[Java é”ä¸çº¿ç¨‹çš„é‚£äº›äº‹ - æœ‰èµæŠ€æœ¯å›¢é˜Ÿ](https://tech.youzan.com/javasuo-yu-xian-cheng-de-na-xie-shi/) ã€‚

ğŸ§—ğŸ» è¿›é˜¶ä¸€ä¸‹ï¼šå­¦æœ‰ä½™åŠ›çš„å°ä¼™ä¼´å¯ä»¥æŠ½æ—¶é—´è¯¦ç»†ç ”ç©¶ä¸€ä¸‹å¯¹è±¡ç›‘è§†å™¨ `monitor`ã€‚

#### JDK1.6 ä¹‹åçš„ synchronized å…³é”®å­—åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–ï¼Ÿ

JDK1.6 å¯¹é”çš„å®ç°å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå¦‚åå‘é”ã€è½»é‡çº§é”ã€è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ã€‚

é”ä¸»è¦å­˜åœ¨å››ç§çŠ¶æ€ï¼Œä¾æ¬¡æ˜¯ï¼šæ— é”çŠ¶æ€ã€åå‘é”çŠ¶æ€ã€è½»é‡çº§é”çŠ¶æ€ã€é‡é‡çº§é”çŠ¶æ€ï¼Œä»–ä»¬ä¼šéšç€ç«äº‰çš„æ¿€çƒˆè€Œé€æ¸å‡çº§ã€‚æ³¨æ„é”å¯ä»¥å‡çº§ä¸å¯é™çº§ï¼Œè¿™ç§ç­–ç•¥æ˜¯ä¸ºäº†æé«˜è·å¾—é”å’Œé‡Šæ”¾é”çš„æ•ˆç‡ã€‚

å…³äºè¿™å‡ ç§ä¼˜åŒ–çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥æŸ¥çœ‹ä¸‹é¢è¿™ç¯‡æ–‡ç« ï¼š[Java6 åŠä»¥ä¸Šç‰ˆæœ¬å¯¹ synchronized çš„ä¼˜åŒ–](https://www.cnblogs.com/wuqinglong/p/9945618.html)

#### synchronized å’Œ volatile çš„åŒºåˆ«ï¼Ÿ

`synchronized` å…³é”®å­—å’Œ `volatile` å…³é”®å­—æ˜¯ä¸¤ä¸ªäº’è¡¥çš„å­˜åœ¨ï¼Œè€Œä¸æ˜¯å¯¹ç«‹çš„å­˜åœ¨ï¼

- `volatile` å…³é”®å­—æ˜¯çº¿ç¨‹åŒæ­¥çš„è½»é‡çº§å®ç°ï¼Œæ‰€ä»¥ `volatile`æ€§èƒ½è‚¯å®šæ¯”`synchronized`å…³é”®å­—è¦å¥½ ã€‚ä½†æ˜¯ `volatile` å…³é”®å­—åªèƒ½ç”¨äºå˜é‡è€Œ `synchronized` å…³é”®å­—å¯ä»¥ä¿®é¥°æ–¹æ³•ä»¥åŠä»£ç å— ã€‚
- `volatile` å…³é”®å­—èƒ½ä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯æ•°æ®çš„åŸå­æ€§ã€‚`synchronized` å…³é”®å­—ä¸¤è€…éƒ½èƒ½ä¿è¯ã€‚
- `volatile`å…³é”®å­—ä¸»è¦ç”¨äºè§£å†³å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼Œè€Œ `synchronized` å…³é”®å­—è§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥æ€§ã€‚

#### synchronized å’Œ ReentrantLock çš„åŒºåˆ«

###### ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”

**â€œå¯é‡å…¥é”â€** æŒ‡çš„æ˜¯è‡ªå·±å¯ä»¥å†æ¬¡è·å–è‡ªå·±çš„å†…éƒ¨é”ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†æŸä¸ªå¯¹è±¡çš„é”ï¼Œæ­¤æ—¶è¿™ä¸ªå¯¹è±¡é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œå½“å…¶å†æ¬¡æƒ³è¦è·å–è¿™ä¸ªå¯¹è±¡çš„é”çš„æ—¶å€™è¿˜æ˜¯å¯ä»¥è·å–çš„ï¼Œå¦‚æœæ˜¯ä¸å¯é‡å…¥é”çš„è¯ï¼Œå°±ä¼šé€ æˆæ­»é”ã€‚åŒä¸€ä¸ªçº¿ç¨‹æ¯æ¬¡è·å–é”ï¼Œé”çš„è®¡æ•°å™¨éƒ½è‡ªå¢ 1ï¼Œæ‰€ä»¥è¦ç­‰åˆ°é”çš„è®¡æ•°å™¨ä¸‹é™ä¸º 0 æ—¶æ‰èƒ½é‡Šæ”¾é”ã€‚

###### synchronized ä¾èµ–äº JVM è€Œ ReentrantLock ä¾èµ–äº API

`synchronized` æ˜¯ä¾èµ–äº JVM å®ç°çš„ï¼Œå‰é¢æˆ‘ä»¬ä¹Ÿè®²åˆ°äº† è™šæ‹Ÿæœºå›¢é˜Ÿåœ¨ JDK1.6 ä¸º `synchronized` å…³é”®å­—è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œä½†æ˜¯è¿™äº›ä¼˜åŒ–éƒ½æ˜¯åœ¨è™šæ‹Ÿæœºå±‚é¢å®ç°çš„ï¼Œå¹¶æ²¡æœ‰ç›´æ¥æš´éœ²ç»™æˆ‘ä»¬ã€‚`ReentrantLock` æ˜¯ JDK å±‚é¢å®ç°çš„ï¼ˆä¹Ÿå°±æ˜¯ API å±‚é¢ï¼Œéœ€è¦ lock() å’Œ unlock() æ–¹æ³•é…åˆ try/finally è¯­å¥å—æ¥å®Œæˆï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹å®ƒçš„æºä»£ç ï¼Œæ¥çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚

###### ReentrantLock æ¯” synchronized å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½

ç›¸æ¯”`synchronized`ï¼Œ`ReentrantLock`å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½ã€‚ä¸»è¦æ¥è¯´ä¸»è¦æœ‰ä¸‰ç‚¹ï¼š

- **ç­‰å¾…å¯ä¸­æ–­** : `ReentrantLock`æä¾›äº†ä¸€ç§èƒ½å¤Ÿä¸­æ–­ç­‰å¾…é”çš„çº¿ç¨‹çš„æœºåˆ¶ï¼Œé€šè¿‡ `lock.lockInterruptibly()` æ¥å®ç°è¿™ä¸ªæœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œæ”¹ä¸ºå¤„ç†å…¶ä»–äº‹æƒ…ã€‚
- **å¯å®ç°å…¬å¹³é”** : `ReentrantLock`å¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚è€Œ`synchronized`åªèƒ½æ˜¯éå…¬å¹³é”ã€‚æ‰€è°“çš„å…¬å¹³é”å°±æ˜¯å…ˆç­‰å¾…çš„çº¿ç¨‹å…ˆè·å¾—é”ã€‚`ReentrantLock`é»˜è®¤æƒ…å†µæ˜¯éå…¬å¹³çš„ï¼Œå¯ä»¥é€šè¿‡ `ReentrantLock`ç±»çš„`ReentrantLock(boolean fair)`æ„é€ æ–¹æ³•æ¥åˆ¶å®šæ˜¯å¦æ˜¯å…¬å¹³çš„ã€‚
- **å¯å®ç°é€‰æ‹©æ€§é€šçŸ¥ï¼ˆé”å¯ä»¥ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼‰**: `synchronized`å…³é”®å­—ä¸`wait()`å’Œ`notify()`/`notifyAll()`æ–¹æ³•ç›¸ç»“åˆå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚`ReentrantLock`ç±»å½“ç„¶ä¹Ÿå¯ä»¥å®ç°ï¼Œä½†æ˜¯éœ€è¦å€ŸåŠ©äº`Condition`æ¥å£ä¸`newCondition()`æ–¹æ³•ã€‚

> `Condition`æ˜¯ JDK1.5 ä¹‹åæ‰æœ‰çš„ï¼Œå®ƒå…·æœ‰å¾ˆå¥½çš„çµæ´»æ€§ï¼Œæ¯”å¦‚å¯ä»¥å®ç°å¤šè·¯é€šçŸ¥åŠŸèƒ½ä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ª`Lock`å¯¹è±¡ä¸­å¯ä»¥åˆ›å»ºå¤šä¸ª`Condition`å®ä¾‹ï¼ˆå³å¯¹è±¡ç›‘è§†å™¨ï¼‰ï¼Œ**çº¿ç¨‹å¯¹è±¡å¯ä»¥æ³¨å†Œåœ¨æŒ‡å®šçš„`Condition`ä¸­ï¼Œä»è€Œå¯ä»¥æœ‰é€‰æ‹©æ€§çš„è¿›è¡Œçº¿ç¨‹é€šçŸ¥ï¼Œåœ¨è°ƒåº¦çº¿ç¨‹ä¸Šæ›´åŠ çµæ´»ã€‚ åœ¨ä½¿ç”¨`notify()/notifyAll()`æ–¹æ³•è¿›è¡Œé€šçŸ¥æ—¶ï¼Œè¢«é€šçŸ¥çš„çº¿ç¨‹æ˜¯ç”± JVM é€‰æ‹©çš„ï¼Œç”¨`ReentrantLock`ç±»ç»“åˆ`Condition`å®ä¾‹å¯ä»¥å®ç°â€œé€‰æ‹©æ€§é€šçŸ¥â€** ï¼Œè¿™ä¸ªåŠŸèƒ½éå¸¸é‡è¦ï¼Œè€Œä¸”æ˜¯ Condition æ¥å£é»˜è®¤æä¾›çš„ã€‚è€Œ`synchronized`å…³é”®å­—å°±ç›¸å½“äºæ•´ä¸ª Lock å¯¹è±¡ä¸­åªæœ‰ä¸€ä¸ª`Condition`å®ä¾‹ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ³¨å†Œåœ¨å®ƒä¸€ä¸ªèº«ä¸Šã€‚å¦‚æœæ‰§è¡Œ`notifyAll()`æ–¹æ³•çš„è¯å°±ä¼šé€šçŸ¥æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹è¿™æ ·ä¼šé€ æˆå¾ˆå¤§çš„æ•ˆç‡é—®é¢˜ï¼Œè€Œ`Condition`å®ä¾‹çš„`signalAll()`æ–¹æ³• åªä¼šå”¤é†’æ³¨å†Œåœ¨è¯¥`Condition`å®ä¾‹ä¸­çš„æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚

**å¦‚æœä½ æƒ³ä½¿ç”¨ä¸Šè¿°åŠŸèƒ½ï¼Œé‚£ä¹ˆé€‰æ‹© ReentrantLock æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚æ€§èƒ½å·²ä¸æ˜¯é€‰æ‹©æ ‡å‡†**

### ThreadLocal

#### ThreadLocal æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºçš„å˜é‡æ˜¯å¯ä»¥è¢«ä»»ä½•ä¸€ä¸ªçº¿ç¨‹è®¿é—®å¹¶ä¿®æ”¹çš„ã€‚**å¦‚æœæƒ³å®ç°æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸“å±æœ¬åœ°å˜é‡è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ**

JDK ä¸­è‡ªå¸¦çš„`ThreadLocal`ç±»æ­£æ˜¯ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚ **`ThreadLocal`ç±»ä¸»è¦è§£å†³çš„å°±æ˜¯è®©æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼ï¼Œå¯ä»¥å°†`ThreadLocal`ç±»å½¢è±¡çš„æ¯”å–»æˆå­˜æ”¾æ•°æ®çš„ç›’å­ï¼Œç›’å­ä¸­å¯ä»¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€‚**

å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ª`ThreadLocal`å˜é‡ï¼Œé‚£ä¹ˆè®¿é—®è¿™ä¸ªå˜é‡çš„æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è¿™ä¸ªå˜é‡çš„æœ¬åœ°å‰¯æœ¬ï¼Œè¿™ä¹Ÿæ˜¯`ThreadLocal`å˜é‡åçš„ç”±æ¥ã€‚ä»–ä»¬å¯ä»¥ä½¿ç”¨ `getï¼ˆï¼‰` å’Œ `setï¼ˆï¼‰` æ–¹æ³•æ¥è·å–é»˜è®¤å€¼æˆ–å°†å…¶å€¼æ›´æ”¹ä¸ºå½“å‰çº¿ç¨‹æ‰€å­˜çš„å‰¯æœ¬çš„å€¼ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

å†ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼šä¸¤ä¸ªäººå»å®å±‹æ”¶é›†å®ç‰©ï¼Œè¿™ä¸¤ä¸ªå…±ç”¨ä¸€ä¸ªè¢‹å­çš„è¯è‚¯å®šä¼šäº§ç”Ÿäº‰æ‰§ï¼Œä½†æ˜¯ç»™ä»–ä»¬ä¸¤ä¸ªäººæ¯ä¸ªäººåˆ†é…ä¸€ä¸ªè¢‹å­çš„è¯å°±ä¸ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ã€‚å¦‚æœæŠŠè¿™ä¸¤ä¸ªäººæ¯”ä½œçº¿ç¨‹çš„è¯ï¼Œé‚£ä¹ˆ ThreadLocal å°±æ˜¯ç”¨æ¥é¿å…è¿™ä¸¤ä¸ªçº¿ç¨‹ç«äº‰çš„ã€‚

#### å¦‚ä½•ä½¿ç”¨ ThreadLocalï¼Ÿ

ç›¸ä¿¡çœ‹äº†ä¸Šé¢çš„è§£é‡Šï¼Œå¤§å®¶å·²ç»ææ‡‚ `ThreadLocal` ç±»æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿äº†ã€‚ä¸‹é¢ç®€å•æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•åœ¨é¡¹ç›®ä¸­å®é™…ä½¿ç”¨ `ThreadLocal` ã€‚

```java
import java.text.SimpleDateFormat;
import java.util.Random;

public class ThreadLocalExample implements Runnable{

     // SimpleDateFormat ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æ¯ä¸ªçº¿ç¨‹éƒ½è¦æœ‰è‡ªå·±ç‹¬ç«‹çš„å‰¯æœ¬
    private static final ThreadLocal<SimpleDateFormat> formatter = ThreadLocal.withInitial(() -> new SimpleDateFormat("yyyyMMdd HHmm"));

    public static void main(String[] args) throws InterruptedException {
        ThreadLocalExample obj = new ThreadLocalExample();
        for(int i=0 ; i<10; i++){
            Thread t = new Thread(obj, ""+i);
            Thread.sleep(new Random().nextInt(1000));
            t.start();
        }
    }

    @Override
    public void run() {
        System.out.println("Thread Name= "+Thread.currentThread().getName()+" default Formatter = "+formatter.get().toPattern());
        try {
            Thread.sleep(new Random().nextInt(1000));
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        //formatter pattern is changed here by thread, but it won't reflect to other threads
        formatter.set(new SimpleDateFormat());

        System.out.println("Thread Name= "+Thread.currentThread().getName()+" formatter = "+formatter.get().toPattern());
    }

}

```

è¾“å‡ºç»“æœ :

```
Thread Name= 0 default Formatter = yyyyMMdd HHmm
Thread Name= 0 formatter = yy-M-d ah:mm
Thread Name= 1 default Formatter = yyyyMMdd HHmm
Thread Name= 2 default Formatter = yyyyMMdd HHmm
Thread Name= 1 formatter = yy-M-d ah:mm
Thread Name= 3 default Formatter = yyyyMMdd HHmm
Thread Name= 2 formatter = yy-M-d ah:mm
Thread Name= 4 default Formatter = yyyyMMdd HHmm
Thread Name= 3 formatter = yy-M-d ah:mm
Thread Name= 4 formatter = yy-M-d ah:mm
Thread Name= 5 default Formatter = yyyyMMdd HHmm
Thread Name= 5 formatter = yy-M-d ah:mm
Thread Name= 6 default Formatter = yyyyMMdd HHmm
Thread Name= 6 formatter = yy-M-d ah:mm
Thread Name= 7 default Formatter = yyyyMMdd HHmm
Thread Name= 7 formatter = yy-M-d ah:mm
Thread Name= 8 default Formatter = yyyyMMdd HHmm
Thread Name= 9 default Formatter = yyyyMMdd HHmm
Thread Name= 8 formatter = yy-M-d ah:mm
Thread Name= 9 formatter = yy-M-d ah:mm
```

ä»è¾“å‡ºä¸­å¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶ `Thread-0` å·²ç»æ”¹å˜äº† `formatter` çš„å€¼ï¼Œä½† `Thread-1` é»˜è®¤æ ¼å¼åŒ–å€¼ä¸åˆå§‹åŒ–å€¼ç›¸åŒï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿä¸€æ ·ã€‚

ä¸Šé¢æœ‰ä¸€æ®µä»£ç ç”¨åˆ°äº†åˆ›å»º `ThreadLocal` å˜é‡çš„é‚£æ®µä»£ç ç”¨åˆ°äº† Java8 çš„çŸ¥è¯†ï¼Œå®ƒç­‰äºä¸‹é¢è¿™æ®µä»£ç ï¼Œå¦‚æœä½ å†™äº†ä¸‹é¢è¿™æ®µä»£ç çš„è¯ï¼ŒIDEA ä¼šæç¤ºä½ è½¬æ¢ä¸º Java8 çš„æ ¼å¼(IDEA çœŸçš„ä¸é”™ï¼)ã€‚å› ä¸º ThreadLocal ç±»åœ¨ Java 8 ä¸­æ‰©å±•ï¼Œä½¿ç”¨ä¸€ä¸ªæ–°çš„æ–¹æ³•`withInitial()`ï¼Œå°† Supplier åŠŸèƒ½æ¥å£ä½œä¸ºå‚æ•°ã€‚

```java
private static final ThreadLocal<SimpleDateFormat> formatter = new ThreadLocal<SimpleDateFormat>(){
    @Override
    protected SimpleDateFormat initialValue(){
        return new SimpleDateFormat("yyyyMMdd HHmm");
    }
};
```

#### ThreadLocal åŸç†äº†è§£å—ï¼Ÿ

ä» `Thread`ç±»æºä»£ç å…¥æ‰‹ã€‚

```java
public class Thread implements Runnable {
    //......
    //ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„ThreadLocalå€¼ã€‚ç”±ThreadLocalç±»ç»´æŠ¤
    ThreadLocal.ThreadLocalMap threadLocals = null;

    //ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„InheritableThreadLocalå€¼ã€‚ç”±InheritableThreadLocalç±»ç»´æŠ¤
    ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
    //......
}
```

ä»ä¸Šé¢`Thread`ç±» æºä»£ç å¯ä»¥çœ‹å‡º`Thread` ç±»ä¸­æœ‰ä¸€ä¸ª `threadLocals` å’Œ ä¸€ä¸ª `inheritableThreadLocals` å˜é‡ï¼Œå®ƒä»¬éƒ½æ˜¯ `ThreadLocalMap` ç±»å‹çš„å˜é‡,æˆ‘ä»¬å¯ä»¥æŠŠ `ThreadLocalMap` ç†è§£ä¸º`ThreadLocal` ç±»å®ç°çš„å®šåˆ¶åŒ–çš„ `HashMap`ã€‚é»˜è®¤æƒ…å†µä¸‹è¿™ä¸¤ä¸ªå˜é‡éƒ½æ˜¯ nullï¼Œåªæœ‰å½“å‰çº¿ç¨‹è°ƒç”¨ `ThreadLocal` ç±»çš„ `set`æˆ–`get`æ–¹æ³•æ—¶æ‰åˆ›å»ºå®ƒä»¬ï¼Œå®é™…ä¸Šè°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨çš„æ˜¯`ThreadLocalMap`ç±»å¯¹åº”çš„ `get()`ã€`set()`æ–¹æ³•ã€‚

`ThreadLocal`ç±»çš„`set()`æ–¹æ³•

```java
public void set(T value) {
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    if (map != null)
        map.set(this, value);
    else
        createMap(t, value);
}
ThreadLocalMap getMap(Thread t) {
    return t.threadLocals;
}
```

é€šè¿‡ä¸Šé¢è¿™äº›å†…å®¹ï¼Œæˆ‘ä»¬è¶³ä»¥é€šè¿‡çŒœæµ‹å¾—å‡ºç»“è®ºï¼š**æœ€ç»ˆçš„å˜é‡æ˜¯æ”¾åœ¨äº†å½“å‰çº¿ç¨‹çš„ `ThreadLocalMap` ä¸­ï¼Œå¹¶ä¸æ˜¯å­˜åœ¨ `ThreadLocal` ä¸Šï¼Œ`ThreadLocal` å¯ä»¥ç†è§£ä¸ºåªæ˜¯`ThreadLocalMap`çš„å°è£…ï¼Œä¼ é€’äº†å˜é‡å€¼ã€‚** `ThrealLocal` ç±»ä¸­å¯ä»¥é€šè¿‡`Thread.currentThread()`è·å–åˆ°å½“å‰çº¿ç¨‹å¯¹è±¡åï¼Œç›´æ¥é€šè¿‡`getMap(Thread t)`å¯ä»¥è®¿é—®åˆ°è¯¥çº¿ç¨‹çš„`ThreadLocalMap`å¯¹è±¡ã€‚

**æ¯ä¸ª`Thread`ä¸­éƒ½å…·å¤‡ä¸€ä¸ª`ThreadLocalMap`ï¼Œè€Œ`ThreadLocalMap`å¯ä»¥å­˜å‚¨ä»¥`ThreadLocal`ä¸º key ï¼ŒObject å¯¹è±¡ä¸º value çš„é”®å€¼å¯¹ã€‚**

```java
ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {
    //......
}
```

æ¯”å¦‚æˆ‘ä»¬åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å£°æ˜äº†ä¸¤ä¸ª `ThreadLocal` å¯¹è±¡çš„è¯ï¼Œ `Thread`å†…éƒ¨éƒ½æ˜¯ä½¿ç”¨ä»…æœ‰çš„é‚£ä¸ª`ThreadLocalMap` å­˜æ”¾æ•°æ®çš„ï¼Œ`ThreadLocalMap`çš„ key å°±æ˜¯ `ThreadLocal`å¯¹è±¡ï¼Œvalue å°±æ˜¯ `ThreadLocal` å¯¹è±¡è°ƒç”¨`set`æ–¹æ³•è®¾ç½®çš„å€¼ã€‚

`ThreadLocal` æ•°æ®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ThreadLocal æ•°æ®ç»“æ„](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/java/concurrent/threadlocal-data-structure.png)

`ThreadLocalMap`æ˜¯`ThreadLocal`çš„é™æ€å†…éƒ¨ç±»ã€‚

![ThreadLocalå†…éƒ¨ç±»](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/java/concurrent/thread-local-inner-class.png)

#### ThreadLocal å†…å­˜æ³„éœ²é—®é¢˜æ˜¯æ€ä¹ˆå¯¼è‡´çš„ï¼Ÿ

`ThreadLocalMap` ä¸­ä½¿ç”¨çš„ key ä¸º `ThreadLocal` çš„å¼±å¼•ç”¨ï¼Œè€Œ value æ˜¯å¼ºå¼•ç”¨ã€‚æ‰€ä»¥ï¼Œå¦‚æœ `ThreadLocal` æ²¡æœ‰è¢«å¤–éƒ¨å¼ºå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œkey ä¼šè¢«æ¸…ç†æ‰ï¼Œè€Œ value ä¸ä¼šè¢«æ¸…ç†æ‰ã€‚

è¿™æ ·ä¸€æ¥ï¼Œ`ThreadLocalMap` ä¸­å°±ä¼šå‡ºç° key ä¸º null çš„ Entryã€‚å‡å¦‚æˆ‘ä»¬ä¸åšä»»ä½•æªæ–½çš„è¯ï¼Œvalue æ°¸è¿œæ— æ³•è¢« GC å›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯èƒ½ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚`ThreadLocalMap` å®ç°ä¸­å·²ç»è€ƒè™‘äº†è¿™ç§æƒ…å†µï¼Œåœ¨è°ƒç”¨ `set()`ã€`get()`ã€`remove()` æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ¸…ç†æ‰ key ä¸º null çš„è®°å½•ã€‚ä½¿ç”¨å®Œ `ThreadLocal`æ–¹æ³•å æœ€å¥½æ‰‹åŠ¨è°ƒç”¨`remove()`æ–¹æ³•

```java
static class Entry extends WeakReference<ThreadLocal<?>> {
    /** The value associated with this ThreadLocal. */
    Object value;

    Entry(ThreadLocal<?> k, Object v) {
        super(k);
        value = v;
    }
}
```

**å¼±å¼•ç”¨ä»‹ç»ï¼š**

> å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰å¼±å¼•ç”¨ï¼Œé‚£å°±ç±»ä¼¼äº**å¯æœ‰å¯æ— çš„ç”Ÿæ´»ç”¨å“**ã€‚å¼±å¼•ç”¨ä¸è½¯å¼•ç”¨çš„åŒºåˆ«åœ¨äºï¼šåªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡æ‹¥æœ‰æ›´çŸ­æš‚çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨åƒåœ¾å›æ”¶å™¨çº¿ç¨‹æ‰«æå®ƒ æ‰€ç®¡è¾–çš„å†…å­˜åŒºåŸŸçš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°äº†åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦ï¼Œéƒ½ä¼šå›æ”¶å®ƒçš„å†…å­˜ã€‚ä¸è¿‡ï¼Œç”±äºåƒåœ¾å›æ”¶å™¨æ˜¯ä¸€ä¸ªä¼˜å…ˆçº§å¾ˆä½çš„çº¿ç¨‹ï¼Œ å› æ­¤ä¸ä¸€å®šä¼šå¾ˆå¿«å‘ç°é‚£äº›åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ã€‚
>
> å¼±å¼•ç”¨å¯ä»¥å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨ï¼Œå¦‚æœå¼±å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼ŒJava è™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ªå¼±å¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚

### çº¿ç¨‹æ± 

çº¿ç¨‹æ± ç›¸å…³çš„çŸ¥è¯†ç‚¹å’Œé¢è¯•é¢˜æ€»ç»“è¯·çœ‹è¿™ç¯‡æ–‡ç« ï¼š[Java çº¿ç¨‹æ± è¯¦è§£](https://javaguide.cn/java/concurrent/java-thread-pool-summary.html) ï¼ˆç”±äºå†…å®¹æ¯”è¾ƒå¤šå°±ä¸æ”¾åœ¨ PDF é‡Œé¢äº†ï¼‰ã€‚

### AQS

AQS ç›¸å…³çš„çŸ¥è¯†ç‚¹å’Œé¢è¯•é¢˜æ€»ç»“è¯·çœ‹è¿™ç¯‡æ–‡ç« ï¼š[AQS è¯¦è§£](https://javaguide.cn/java/concurrent/aqs.html) ï¼ˆç”±äºå†…å®¹æ¯”è¾ƒå¤šå°±ä¸æ”¾åœ¨ PDF é‡Œé¢äº†ï¼‰ã€‚

<div align="center">   
    <img src="https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/gongzhonghaoxuanchuan.png" style="margin: 0 auto;" />  
</div>
